import { Button, Checkbox, FormContainer, Input } from 'components/ui'
import { Field } from 'formik'
import React, { useEffect, useState } from 'react'
import CustomFormItem from 'views/Controls/CustomFormItem'
import SelectXs from 'views/Controls/SelectXs/SelectXs'
import { getCityOptions, getStateOptions } from 'views/Creditcontrol/AgencyMaster/utils'

/* CONSTANTS */
const DEFAULT_REQUIRED_MSG_STATE = {
  fullAddress: false,
  country: false,
  state: false,
  city: false,
  postalCode: false,
  erpCode: false,
  gstNumber: false,
}

function AddressDetailsForm({ countryOptions, stateOptions, cityOptions, setStateOptions, setCityOptions }) {

  /* STATES */
  const [fullAddress, setFullAddress] = useState('')
  const [country, setCountry] = useState(null)
  const [state, setState] = useState(null)
  const [city, setCity] = useState(null)
  const [postalCode, setPostalCode] = useState('')
  const [erpCode, setErpCode] = useState('')
  const [isGstRegistered, setIsGstRegistered] = useState(false)
  const [gstNumber, setGstNumber] = useState('')
  const [showRequiredMsg, setShowRequiredMsg] = useState(DEFAULT_REQUIRED_MSG_STATE)

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        if (country?.CountryCode)
          setStateOptions(await getStateOptions(country.CountryCode))
      }
      catch (error) {
        console.error(error)
      }
    })()
  }, [country])

  useEffect(() => {
    (async () => {
      try {
        if (state?.StateCode)
          setCityOptions(await getCityOptions(state.StateCode))
      }
      catch (error) {
        console.error(error)
      }
    })()
  }, [state])

  /* EVENT HANDLERS */
  const handleFieldsBlur = (field, value) => {
    if (!value) setShowRequiredMsg((prev) => ({ ...prev, [field]: true }))
    else setShowRequiredMsg((prev) => ({ ...prev, [field]: false }))
  }

  const isAllFieldsValid = () => {
    const newRequiredMsgState = DEFAULT_REQUIRED_MSG_STATE;
    const allFieldsValid = true;
    if (!fullAddress) { newRequiredMsgState.fullAddress = true; allFieldsValid = false }
    if (!country) newRequiredMsgState.country = true;
    if (!state) newRequiredMsgState.state = true;
    if (!postalCode) newRequiredMsgState.postalCode = true;
    if (!erpCode) newRequiredMsgState.erpCode = true;
    if (isGstRegistered && !gstNumber) newRequiredMsgState.gstNumber = true;
  }

  return (
    <FormContainer size="sm" className='grid grid-cols-12 gap-x-3 gap-y-5'>
      <CustomFormItem label="Address" className="col-span-12" asterisk={true}>
        <Field
          type="text"
          placeholder="Full Address"
          textArea={true}
          component={Input}
          className="min-h-0"
          rows={2}
          value={fullAddress}
          onChange={(event) => setFullAddress(event.target.value)}
          onBlur={(event) => handleFieldsBlur('fullAddress', event.target.value)}
        />
        {showRequiredMsg.fullAddress && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <CustomFormItem label="Country" className="col-span-6" asterisk={true}>
        <Field
          placeholder="Select"
          component={SelectXs}
          options={countryOptions}
          value={country}
          onChange={setCountry}
          onBlur={() => handleFieldsBlur('country', country)}
        />
        {showRequiredMsg.country && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <CustomFormItem label="State" className="col-span-6" asterisk={true}>
        <Field
          placeholder="Select"
          component={SelectXs}
          options={stateOptions}
          value={state}
          onChange={setState}
          onBlur={() => handleFieldsBlur('state', state)}
        />
        {showRequiredMsg.state && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <CustomFormItem label="City" className="col-span-6" asterisk={true}>
        <Field
          placeholder="Select"
          component={SelectXs}
          options={cityOptions}
          value={city}
          onChange={setCity}
          onBlur={() => handleFieldsBlur('city', city)}
        />
        {showRequiredMsg.city && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <CustomFormItem label="Postal Code" className="col-span-6" asterisk={true}>
        <Field
          placeholder="Postal Code"
          component={Input}
          value={postalCode}
          onChange={(event) => setPostalCode(event.target.value)}
          onBlur={(event) => handleFieldsBlur('postalCode', event.target.value)}
        />
        {showRequiredMsg.postalCode && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <CustomFormItem label="ERP Code" className="col-span-6" asterisk={true}>
        <Field
          placeholder="ERP Code"
          component={Input}
          value={erpCode}
          onChange={(event) => setErpCode(event.target.value)}
          onBlur={(event) => handleFieldsBlur('erpCode', event.target.value)}
        />
        {showRequiredMsg.erpCode && <span className='text-red-500'>Required</span>}
      </CustomFormItem>
      <div className='col-span-6'>
        <Field
          component={Checkbox}
          className='text-gray-300'
          name="isGSTRegistered"
          checked={isGstRegistered}
          onChange={setIsGstRegistered}
        >GST Registered</Field>
        <Field
          placeholder="GST Number"
          component={Input}
          disabled={true}
          value={gstNumber}
          onChange={(event) => setGstNumber(event.target.value)}
          onBlur={(event) => handleFieldsBlur('gstNumber', event.target.value)}
        />
        {showRequiredMsg.gstNumber && <span className='text-red-500'>Required</span>}
      </div>
      <div className='col-span-12 flex justify-end'>
        <Button size="sm">Add</Button>
      </div>
    </FormContainer>
  )
}

export default AddressDetailsForm