import { Button, Dialog, Input } from 'components/ui';
import React, { useContext, useState } from 'react';
import {
  autoCompleteTime,
  getFormattedTime,
  openNotification,
  subtractTimes,
} from 'views/Controls/GLOBALFUNACTION';
import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';
import {
  operationTypesEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { addTimes } from '../../../../Summary/utils';
import { getNTCParentRow } from 'views/Scheduling/Scheduler/context/utils';
import { updateOffsetStartTimeOfNTCs } from 'views/Scheduling/Scheduler/context/utils/ntcOperations/utils';

function EditNTCDialog({ isDialogOpen, setIsDialogOpen, row, editRowInfo }) {
  /* CONTEXT */
  const { schedulingTableData, executeOperation, isAutoCalcNtcOffsetTime } =
    useContext(SchedulerContext);

  /* STATES */
  const [offsetTime, setOffsetTime] = useState(row.OffsetStartTime);
  const [offsetTimeErrorMsg, setOffsetTimeErrorMsg] = useState('');
  const [gap, setGap] = useState(row.DefaultGAP);

  /* CONSTANTS */
  const ntcParentRow = getNTCParentRow(row.rowIndex, schedulingTableData);

  /* EVENT HANDLERS */
  const handleClose = () => {
    setIsDialogOpen(false);
  };

  const handleOffsetTimeChange = (event) => {
    const formattedOffsetTime = getFormattedTime(event, offsetTime);
    if (formattedOffsetTime.length === 11) {
      validateOffsetTime(formattedOffsetTime);
    } else {
      setOffsetTimeErrorMsg('');
    }
    setOffsetTime(formattedOffsetTime);
  };

  const handleInputKeyDown = (event) => {
    if (
      event.key === 'Enter' &&
      offsetTime.length === 11 &&
      gap.length === 11
    ) {
      handleSubmit();
    }
  };

  const handleSubmit = async () => {
    try {
      let newTableData;
      if (isAutoCalcNtcOffsetTime) {
        newTableData = getTableDataWithAutoNtcOffsetTimeCalc();
      } else {
        newTableData = [...schedulingTableData];
        newTableData[row.rowIndex] = {
          ...row,
          OffsetStartTime: offsetTime,
          DefaultGAP: gap,
        };
      }
      await executeOperation({
        operation: operationTypesEnum.UPDATE_TABLE,
        newSchTableData: newTableData,
      });
      openNotification('success', 'Changes saved successfully');
      handleClose();
    } catch (error) {
      openNotification('danger', 'Something went wrong while saving changes');
      console.error(error);
    }
  };

  /* HELPER FUNCTIONS */
  const getTableDataWithAutoNtcOffsetTimeCalc = () => {
    let newTableData = [...schedulingTableData];
    const prevRow = schedulingTableData[row.rowIndex - 1];
    const isPrevRowNTC = prevRow.F_C_S_P === rowDataTypesEnum.NTC;
    if (
      !isAutoCalcNtcOffsetTime ||
      !isPrevRowNTC ||
      prevRow.NTCGroupCode !== row.NTCGroupCode
    ) {
      newTableData[row.rowIndex] = {
        ...row,
        OffsetStartTime: offsetTime,
        Start_Time: offsetTime,
        Tel_Time: offsetTime,
        DefaultGAP: gap,
      };
    } else {
      const prevRowEndTime = addTimes(prevRow.Start_Time, prevRow.Duration);
      const newPrevRowGap = subtractTimes(offsetTime, prevRowEndTime);
      newTableData[row.rowIndex - 1] = {
        ...prevRow,
        DefaultGAP: newPrevRowGap,
      };
    }
    newTableData = updateOffsetStartTimeOfNTCs(newTableData);
    return newTableData;
  };

  const validateOffsetTime = (offsetTime) => {
    const prevRow = schedulingTableData[row.rowIndex - 1];
    const isPrevRowNTC = prevRow.F_C_S_P === rowDataTypesEnum.NTC;
    const ntcEndTime = addTimes(offsetTime, row.Duration);
    if (
      !isAutoCalcNtcOffsetTime ||
      !isPrevRowNTC ||
      prevRow.NTCGroupCode !== row.NTCGroupCode
    ) {
      if (ntcEndTime > ntcParentRow.Duration) {
        setOffsetTimeErrorMsg(
          `NTC end time should not exceed its parent's end time`,
        );
        return false;
      }
      return true;
    }
    const prevRowEndTime = getEventEndTime(prevRow, true);
    const ntcStartTime = addTimes(prevRow.Start_Time, offsetTime);
    if (ntcStartTime < prevRowEndTime) {
      setOffsetTimeErrorMsg(
        `NTC start time should not overlap with its previous NTC`,
      );
      return false;
    }
    if (ntcEndTime > ntcParentRow.Duration) {
      setOffsetTimeErrorMsg(
        `NTC end time should not exceed its parent's end time`,
      );
      return false;
    }
    return true;
  };

  const getEventEndTime = (row, isIncludeGap) => {
    return isIncludeGap
      ? addTimes(row.Start_Time, row.Duration, row.DefaultGAP)
      : addTimes(row.Start_Time, row.Duration);
  };

  return (
    <>
      {editRowInfo && (
        <Dialog
          isOpen={isDialogOpen}
          onClose={handleClose}
          onRequestClose={handleClose}
          className="z-[1000]"
          width={'40%'}
        >
          <h5 className="mb-4">Edit NTC</h5>
          <div className="max-h-96 overflow-y-auto flex flex-col gap-8">
            <div className="grid grid-cols-3 gap-4">
              <div className="col-span-2">
                <p className="text-white mb-1">NTC Name</p>
                <Input size="sm" value={row.Event_Name} disabled={true} />
              </div>
              <div>
                <p className="text-white mb-1">NTC Duration</p>
                <Input size="sm" value={row.Duration} disabled={true} />
              </div>
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <p className="text-white mb-1">Parent Start Time</p>
                <Input
                  size="sm"
                  value={ntcParentRow.Start_Time}
                  disabled={true}
                />
              </div>
              <div>
                <p className="text-white mb-1">Parent End Time</p>
                <Input
                  size="sm"
                  value={getEventEndTime(ntcParentRow)}
                  disabled={true}
                />
              </div>
              <div>
                <p className="text-white mb-1">Parent Duration</p>
                <Input
                  size="sm"
                  value={ntcParentRow.Duration}
                  disabled={true}
                />
              </div>
            </div>
            <div className="grid grid-cols-3 gap-4">
              <div>
                <p className="text-white mb-1">
                  Offset Time <span className="text-red-500">*</span>
                </p>
                <Input
                  size="sm"
                  value={offsetTime}
                  placeholder="HH:FF:SS:FF"
                  onChange={handleOffsetTimeChange}
                  onBlur={() => {
                    setOffsetTime(autoCompleteTime(offsetTime));
                    setOffsetTimeErrorMsg('');
                  }}
                  onKeyDown={handleInputKeyDown}
                />
                {offsetTimeErrorMsg && (
                  <p className="text-red-500 mt-1.5 leading-tight">
                    {offsetTimeErrorMsg}
                  </p>
                )}
              </div>
              <div>
                <p className="text-white mb-1">
                  Gap <span className="text-red-500">*</span>
                </p>
                <Input
                  size="sm"
                  value={gap}
                  placeholder="HH:FF:SS:FF"
                  onChange={(event) => setGap(getFormattedTime(event, gap))}
                  onBlur={() => setGap(autoCompleteTime(gap))}
                  onKeyDown={handleInputKeyDown}
                />
              </div>
              <div>
                <p className="text-white mb-1">NTC End Time</p>
                <Input
                  size="sm"
                  value={
                    offsetTime.length === 11
                      ? addTimes(
                          ntcParentRow.Start_Time,
                          offsetTime,
                          row.Duration,
                        )
                      : 'HH:MM:SS:FF'
                  }
                  disabled={true}
                />
              </div>
            </div>
          </div>
          <div className="text-right mt-6">
            <Button
              variant="solid"
              onClick={handleSubmit}
              disabled={
                offsetTime.length < 11 || gap.length < 11 || offsetTimeErrorMsg
              }
            >
              Submit
            </Button>
          </div>
        </Dialog>
      )}
    </>
  );
}

export default EditNTCDialog;
