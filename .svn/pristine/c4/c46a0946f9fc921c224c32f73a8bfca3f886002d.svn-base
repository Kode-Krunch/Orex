import { useState } from 'react';
import Input from 'components/ui/Input';
import { CalendarView } from 'components/shared';
import { Button } from 'components/ui';
import { FaPlus } from 'react-icons/fa6';
import { FaMinus } from 'react-icons/fa6';
import { FaRegTrashCan } from "react-icons/fa6";
import Tooltip from 'components/ui/Tooltip'

const Calendar = (props) => {

    const generateCounterKey = (date, index) => {
        try {
            return `${date.getTime()}-${index}`;
        } catch (error) {
            console.error(error);
        }
    };

    const decrementCounter = (key) => {
        try {
            props.setCounter((oldCounter) => {
                let newCounter = Object.assign({}, oldCounter);
                if (key in newCounter.data) {
                    if (newCounter.data[key] > 0) {
                        newCounter.data[key] = newCounter.data[key] - 1;
                        newCounter.total = newCounter.total - 1;
                    }
                }
                else {
                    newCounter.data[key] = 0;
                }
                return newCounter;
            });
        } catch (error) {
            console.error(error);
        }
    };

    const incrementCounter = (key) => {
        try {
            props.setCounter((oldCounter) => {
                let newCounter = Object.assign({}, oldCounter);
                if (key in newCounter.data) {
                    if (newCounter.data[key] < 10) {
                        newCounter.data[key] = newCounter.data[key] + 1;
                        newCounter.total = newCounter.total + 1;
                    }
                }
                else {
                    newCounter.data[key] = 1
                    newCounter.total = newCounter.total + 1;
                }
                return newCounter;
            });
        } catch (error) {
            console.error(error);
        }
    };

    const resetCounter = (key) => {
        try {
            props.setCounter((oldCounter) => {
                let newCounter = Object.assign({}, oldCounter);
                if (key in newCounter.data) {
                    newCounter.total = newCounter.total - newCounter.data[key];
                    newCounter.data[key] = 0;
                }
                else {
                    newCounter.data[key] = 0
                }
                return newCounter;
            });
        } catch (error) {
            console.error(error);
        }
    }

    const renderCounter = (arg) => {
        try {
            const startDate = arg.view.currentStart;
            const endDate = arg.view.currentEnd;
            const isCurrentMonth = arg.date >= startDate && arg.date <= endDate - 1;

            if (!isCurrentMonth) {
                return <></>;
            }

            let counters = [];

            for (let index = 0; index < props.noOfCommercials; index++) {

                counters.push(
                    <>
                        <div data-key={generateCounterKey(arg.date, index)} className='rounded dark:bg-gray-700 flex items-center'>
                            <Tooltip title="Remove" placement="top">
                                <Button
                                    onClick={(event) => {
                                        event.stopPropagation();
                                        decrementCounter(generateCounterKey(arg.date, index));
                                    }}
                                    size="xs"
                                    icon={<FaMinus className='text-xs' />}
                                    className="counter-button"
                                />
                            </Tooltip>
                            <span className="mx-1 text-sm">
                                {props.counter.data[generateCounterKey(arg.date, index)]
                                    ? props.counter.data[generateCounterKey(arg.date, index)]
                                    : 0}
                            </span>
                            <Tooltip title="Add" placement="top">
                                <Button
                                    onClick={(event) => {
                                        event.stopPropagation();
                                        incrementCounter(generateCounterKey(arg.date, index));
                                    }}
                                    size="xs"
                                    icon={<FaPlus className='text-xs' />}
                                    className="counter-button"
                                />
                            </Tooltip>
                            <div>
                                <Tooltip title="Clear All" placement="top">
                                    <Button
                                        onClick={(event) => {
                                            event.stopPropagation();
                                            resetCounter(generateCounterKey(arg.date, index));
                                        }}
                                        size="xs"
                                        variant="plain"
                                        icon={<FaRegTrashCan className='text-sm' />}
                                    />
                                </Tooltip></div>
                        </div>

                    </>
                );
            }

            return <div className="absolute bottom-3 right-0 w-full flex justify-end gap-1 pr-2">{counters}</div>;
        } catch (error) {
            console.error(error);
        }
    };

    const getDate = (date, position) => {
        try {
            let year = "";
            let month = "";
            let day = "";

            if (position === "start") {
                year = date.getFullYear();
                month = String(date.getMonth() + 1).padStart(2, '0');
                day = String(date.getDate()).padStart(2, '0');
            }
            else {
                const endDateInclusive = new Date(date.getTime());
                const endDate = new Date(endDateInclusive.setDate(date.getDate() + 1));
                year = endDate.getFullYear();
                month = String(endDate.getMonth() + 1).padStart(2, '0');
                day = String(endDate.getDate()).padStart(2, '0');
            }
            return `${year}-${month}-${day}`;
        }

        catch (error) {
            console.error(error)
        }
    }

    return (
        <CalendarView
            dayCellContent={(arg) => {
                return (
                    <>
                        <p className='text-right text-md'>{arg.dayNumberText}</p>
                        {renderCounter(arg)}
                    </>
                );
            }}
            height={props.height}
            validRange={{
                start: getDate(props.dateRange[0], "start"),
                end: getDate(props.dateRange[1], "end")
            }}
        ></CalendarView>
    );
};

export default Calendar;
