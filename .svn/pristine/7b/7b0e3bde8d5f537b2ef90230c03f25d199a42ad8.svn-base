import { Button, Card, Tooltip } from 'components/ui';
import React, { useContext, useEffect, useState } from 'react';
import { IoMdClose } from 'react-icons/io';
import { handleFeatureClose } from '../../utils/utils';
import {
  featuresEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import RotationInfoTable from './RotationInfoTable';
import BottomToolbar from './BottomToolbar';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

function RotationInfo() {
  /* CONTEXT */
  const {
    schedulingTableData,
    schedulingTableSelectedRows,
    setLeftClickedSchTableRow,
    setActiveFeatures,
    isScheduleAllowedToEdit,
    secondaryAreaZindexRef,
  } = useContext(SchedulerContext);

  /* STATES */
  const [rotationInfoTableData, setRotationInfoTableData] = useState([]);
  const [curSelectedEventRow, setCurSelectedEventRow] = useState(null);

  /* USE EFFECTS */
  useEffect(() => {
    try {
      let selectedRow = null;
      if (schedulingTableSelectedRows.length === 1) {
        setCurSelectedEventRow(schedulingTableSelectedRows[0]);
        setLeftClickedSchTableRow(schedulingTableSelectedRows[0]);
        selectedRow = schedulingTableSelectedRows[0];
      } else {
        selectedRow = curSelectedEventRow;
      }
      if (selectedRow) {
        let rotationRows = [];
        if (selectedRow.F_C_S_P !== rowDataTypesEnum.NTC) {
          rotationRows = schedulingTableData.filter(
            (row) =>
              row.F_C_S_P === selectedRow.F_C_S_P &&
              row.Event_Name === selectedRow.Event_Name,
          );
        } else {
          if ('BookingDetailID' in selectedRow) {
            rotationRows = schedulingTableData.filter(
              (row) =>
                row.F_C_S_P === rowDataTypesEnum.NTC &&
                row.Event_Name === selectedRow.Event_Name &&
                'BookingDetailID' in row,
            );
          } else {
            rotationRows = schedulingTableData.filter(
              (row) =>
                row.F_C_S_P === rowDataTypesEnum.NTC &&
                row.Event_Name === selectedRow.Event_Name &&
                !('BookingDetailID' in row),
            );
          }
        }
        setRotationInfoTableData(rotationRows);
      }
    } catch (error) {
      openNotification(
        'danger',
        'Something went wrong while loading rotation info',
      );
    }
  }, [schedulingTableData, schedulingTableSelectedRows]);

  return (
    <div
      className="h-full w-full flex flex-col bg-gray-800 p-3 pt-2 rounded-lg absolute top-0 left-0"
      style={{
        zIndex: secondaryAreaZindexRef.current[featuresEnum.ROTATION_INFO],
      }}
    >
      <div className="flex justify-between items-center mb-2">
        <h5>Rotation Info</h5>
        <div className="flex  items-center">
          <span className="p-1 rounded-full  text-sm font-black bg-emerald-600 text-white mr-2 w-8 text-center">
            {rotationInfoTableData?.length}
          </span>
          <Tooltip title="Close">
            <Button
              size="xs"
              icon={<IoMdClose />}
              onClick={() => {
                handleFeatureClose(
                  setActiveFeatures,
                  featuresEnum.ROTATION_INFO,
                );
              }}
            />
          </Tooltip>
        </div>
      </div>
      <div className="h-[92%] flex flex-col gap-3">
        {rotationInfoTableData.length > 0 ? (
          <>
            <div className="grow overflow-y-scroll no-scrollbar">
              <RotationInfoTable tableData={rotationInfoTableData} />
            </div>
            {isScheduleAllowedToEdit && (
              <BottomToolbar rotationInfoTableData={rotationInfoTableData} />
            )}
          </>
        ) : (
          <Card
            className="h-full w-full"
            bodyClass="h-full w-full flex justify-center items-center p-2"
          >
            Please select an event
          </Card>
        )}
      </div>
    </div>
  );
}

export default RotationInfo;
