import { Button, Dialog, Select, TimeInput } from 'components/ui';
import React, { useContext, useEffect, useRef, useState } from 'react';
import { useSelector } from 'react-redux';
import {
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import { getTemplateOptions } from './utils';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
import { operationTypesEnum } from 'views/Scheduling/SchedulerOld/enum';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

function AutoShuffleDialog({ isDialogOpen, setIsDialogOpen }) {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* CONTEXT */
  const { setShowLoader, executeOperation } =
    useContext(SchedulerContext);

  /* STATES */
  const [templateOptions, setTemplateOptions] = useState([]);
  const [promoShuffleTemplate, setPromoShuffleTemplate] = useState(null);
  const [time, setTime] = useState({ start: null, end: null });

  /* HOOKS */
  const durationInputRef = useRef(null);

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        if (isDialogOpen && templateOptions.length === 0) {
          setShowLoader(true);
          setTemplateOptions(await getTemplateOptions(channel));
          setShowLoader(false);
        }
      } catch (error) {
        openNotification(
          'danger',
          'Something went wrong while retrieving Auto Shuffle Template',
        );
        setShowLoader(false);
        console.error(error);
      }
    })();
  }, [isDialogOpen]);

  useEffect(() => {
    try {
      if (durationInputRef.current === null) return;
      const selectionFunction = () =>
      (durationInputRef.current.selectionStart =
        durationInputRef.current.selectionEnd);
      durationInputRef.current.addEventListener(
        'select',
        selectionFunction,
        false,
      );
    } catch (error) {
      console.error(error);
    }
  }, [durationInputRef.current]);

  /* EVENT HANDLERS */
  const handleDialogClose = () => {
    try {
      setPromoShuffleTemplate(null);
      setTime({ start: null, end: null });
      setIsDialogOpen(false);
    } catch (error) {
      console.error(error);
    }
  };

  const handleShuffle = async () => {
    try {
      setShowLoader(true);
      await executeOperation({
        operation: operationTypesEnum.PROMO_AUTO_SHUFFLE,
        time: time,
        promoShuffleTemplate: promoShuffleTemplate
      });
      handleDialogClose();
      setShowLoader(false);
      openNotification('success', 'Auto shuffled events successfully');
    } catch (error) {
      console.log(error);
      openNotification('danger', 'Something went wrong while shuffling');
      setShowLoader(false);
    }
  };

  return (
    <Dialog
      isOpen={isDialogOpen}
      onClose={handleDialogClose}
      onRequestClose={handleDialogClose}
    >
      <h5 className="mb-4">Auto Shuffle</h5>
      <div className="flex flex-col gap-6">
        <div>
          <p className="mb-1 text-white">
            Template <span className="text-red-500">*</span>
          </p>
          <Select
            placeholder="Select"
            options={templateOptions}
            size="sm"
            onChange={(option) => setPromoShuffleTemplate(option)}
            value={promoShuffleTemplate}
          ></Select>
        </div>
        <div className="grid grid-cols-2 gap-3">
          <div>
            <p className="mb-1 text-white">
              Start Time <span className="text-red-500">*</span>
            </p>
            <TimeInput
              size="sm"
              onChange={(date) => setTime({ ...time, start: date })}
              disabled={!promoShuffleTemplate}
            />
          </div>
          <div>
            <p className="mb-1 text-white">
              End Time <span className="text-red-500">*</span>
            </p>
            <TimeInput
              size="sm"
              onChange={(date) => setTime({ ...time, end: date })}
              disabled={!promoShuffleTemplate || !time.start}
            />
          </div>
        </div>

      </div>
      <div className="text-right mt-6">
        <Button
          variant="solid"
          disabled={
            !promoShuffleTemplate || !time.start || !time.end
          }
          onClick={handleShuffle}
        >
          Shuffle
        </Button>
      </div>
    </Dialog>
  );
}

export default AutoShuffleDialog;
