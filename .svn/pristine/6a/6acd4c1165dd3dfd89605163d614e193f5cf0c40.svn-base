import { useState, useEffect } from 'react';
import { Button, Card } from 'components/ui';
import { HiPlusCircle } from 'react-icons/hi';
import HeaderExtra from 'views/Controls/HeaderExtra';
import { Link } from 'react-router-dom';
import { useDispatch, useSelector } from 'react-redux';
import { setContent } from 'store/base/commonSlice';
import InputwithVoice from 'components/ui/Input/InputwithVoice';
import { COLOR_3, COLOR_4, COLOR_5, COLOR_8 } from 'constants/chart.constant';
import StatisticCardwithfigure from 'components/common/StatisticCardwithfigure';
import { TbSpeakerphone } from 'react-icons/tb';
import { VscVmActive } from 'react-icons/vsc';
import { MdAddCard, MdOutlineDesktopAccessDisabled } from 'react-icons/md';
import {
  ButtonShowCommercialMaster,
  ButtonShowCopyCommercial,
} from 'views/Controls/ButtonShow';
import ReportsTable from 'views/Controls/ReportsTable/ReportsTable';
import DatePickerRange from 'components/ui/DatePicker/DatePickerRange';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import { format } from 'date-fns';
import { apiGetCommercialmaster } from 'services/SalesAdminService';

const headerExtraContent = (globalFilter, setGlobalFilter, Path, selectDateRange, setselectDateRange) => {
  return (
    <div className="flex items-center">
      <div className='w-64 mr-1 '>
        <DatePickerRange placeholder="Select dates range" size='sm' value={selectDateRange} onChange={setselectDateRange} />
      </div>
      <span className="mr-1   font-semibold">
        <InputwithVoice
          value={globalFilter ?? ''}
          className=" solid"
          placeholder="Search all columns..."
          size="sm"
          onChange={(e) => {
            const regex = /^[0-9a-zA-Z\s\-\(\)\.&_+]*$/;
            if (regex.test(e.target.value)) {
              setGlobalFilter(e.target.value);
            }
          }}
        />
      </span>
      <span className="mr-1 font-semibold">
        <Link
          to={
            Path == '/NTCCommercialMaster'
              ? '/NTCCommercialMasterEdit'
              : '/CommercialMasterEdit'
          }
        >
          <Button block variant="solid" size="sm" icon={<HiPlusCircle />}>
            {Path == '/NTCCommercialMaster'
              ? 'Add NTC Commercial'
              : 'Add Commercial'}
          </Button>
        </Link>
      </span>
    </div>
  );
};

const CommercialMaster = () => {
  function getTableColumnsWithActions(columns) {
    try {
      return [
        {
          header: 'Action',
          accessorKey: 'action',
          actions: [
            {
              action: (rowindex, rowData) => (
                <ButtonShowCommercialMaster row={rowData} />
              ),
            },
            {
              action: (rowindex, rowData) => (
                <ButtonShowCopyCommercial row={rowData} />
              ),
            },
          ],
        },
        ...columns,
      ];
    } catch (error) {
      console.error(error);
    }
  }
  const [CommercialDataColumns, setCommercialDataColumns] = useState([]);

  const dispatch = useDispatch();
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const Path = useSelector((state) => state.base.common.Path);

  const [globalFilter, setGlobalFilter] = useState('');
  const [countThisMonth, setcountThisMonth] = useState(0);
  const [managedColumns, setManagedColumns] = useState([]);
  const [tableData, setTableData] = useState(['']);
  const [tableDataFilter, setTableDataFilter] = useState(['']);
  const [selectDateRange, setselectDateRange] = useState([
    new Date(new Date().setDate(new Date().getDate() - 60)),
    new Date()
  ]);

  useEffect(() => {
    if (selectDateRange[0]) {
      if (selectDateRange[0] && selectDateRange[1]) {
        Getcommercials(Path == '/NTCCommercialMaster' ? 1 : 0);
        dispatch(setContent([]));
      }
    } else {
      openNotification('warning', 'Please Select Date Range');
    }
  }, [Path, Channel, selectDateRange]);

  const Getcommercials = (NTC) => {
    if (Path == '' || Path == undefined) {
      return;
    }
    (async (values) => {
      let Parameters = {
        LocationCode: Channel.LocationCode,
        ChannelCode: Channel.ChannelCode,
        FromDate: format(selectDateRange[0], 'yyyy-MM-dd'),
        ToDate: format(selectDateRange[1], 'yyyy-MM-dd'),
        IsNTC: NTC,
      };

      const resp = await apiGetCommercialmaster(Parameters);

      if (resp.data) {
        const columns = [];
        Object.keys(resp.data[0]).forEach((key, index) => {
          if (
            !Array.isArray(resp.data[0][key]) &&
            typeof resp.data[0][key] !== 'object'
          ) {
            columns.push({
              accessorKey: key,
              header: key,
            });
          }
        });
        setCommercialDataColumns(getTableColumnsWithActions(columns));

        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();

        setTableData(resp.data);
        setTableDataFilter(resp.data);
        const countThisMonth = resp.data.filter((commercial) => {
          const addedOnDate = new Date(commercial.AddedOn);
          return (
            addedOnDate.getFullYear() === currentYear &&
            addedOnDate.getMonth() === currentMonth
          );
        });
        setcountThisMonth(countThisMonth);
      } else {
        setTableData([]);
        setTableDataFilter([]);
      }
    })();
  };

  const FilterTableData_On_Card = (CardName) => {
    console.log('FilterTableData_On_Card', CardName);
    switch (CardName) {
      case 'Total Commercial':
        setTableDataFilter(tableData);
        break;
      case 'Active Commercial':
        setTableDataFilter(tableData.filter((item) => item.IsActive == 1));
        break;
      case 'InActive Commercial':
        setTableDataFilter(tableData.filter((item) => item.IsActive == 0));
        break;
      case 'Added This Month':
        setTableDataFilter(countThisMonth);
        break;
      default:
        break;
    }
  };

  return (
    <>
      <Card
        header={<HeaderExtra Component={'Commercial Master'} />}
        headerExtra={headerExtraContent(globalFilter, setGlobalFilter, Path, selectDateRange, setselectDateRange)}
        bodyClass="dark:bg-slate-800 bg-slate-100"
      >
        <div
          className={`grid grid-cols-1 gap-4 mb-4 mt-2 lg:grid-cols-4 xl:grid-cols-4`}
        >
          <StatisticCardwithfigure
            CardHeight={180}
            AnimateColorClass="order3"
            Icon={<TbSpeakerphone style={{ fontSize: 35, color: COLOR_3 }} />}
            CardName="Total Commercial"
            CardNote="Commercials are short advertisements aired during breaks in programming."
            CardFigure={tableData.length}
            COLOR="bg-emerald-500"
            Function={FilterTableData_On_Card}
            IsFunction={true}
            cursor={true}
          ></StatisticCardwithfigure>

          <StatisticCardwithfigure
            CardHeight={180}
            AnimateColorClass="order2"
            Icon={<VscVmActive style={{ fontSize: 35, color: COLOR_4 }} />}
            CardName="Active Commercial"
            CardNote=" refers to an advertisement currently scheduled for broadcast."
            CardFigure={tableData.filter((item) => item.IsActive == 1).length}
            COLOR="bg-amber-500"
            Function={FilterTableData_On_Card}
            IsFunction={true}
            cursor={true}
          ></StatisticCardwithfigure>

          <StatisticCardwithfigure
            CardHeight={180}
            AnimateColorClass="order1"
            Icon={
              <MdOutlineDesktopAccessDisabled
                style={{ fontSize: 35, color: COLOR_5 }}
              />
            }
            CardName="InActive Commercial"
            CardNote=" refers to an advertisement that is not currently running."
            CardFigure={tableData.filter((item) => item.IsActive == 0).length}
            COLOR="bg-red-500"
            Function={FilterTableData_On_Card}
            IsFunction={true}
            cursor={true}
          ></StatisticCardwithfigure>

          <StatisticCardwithfigure
            CardHeight={180}
            AnimateColorClass="order8"
            Icon={<MdAddCard style={{ fontSize: 35, color: COLOR_8 }} />}
            CardName="Added This Month"
            CardNote="refers to advertisements that were added for broadcast in the current month."
            CardFigure={countThisMonth.length}
            COLOR="bg-yellow-500"
            Function={FilterTableData_On_Card}
            IsFunction={true}
            cursor={true}
          ></StatisticCardwithfigure>
        </div>


        <ReportsTable
          tableData={tableDataFilter}
          tableName={`CommercialMaster`}
          originalColumns={CommercialDataColumns}
          externalGlobalFilter={globalFilter}
          managedColumns={managedColumns}
          setManagedColumns={setManagedColumns}
          exportFileName={`Commercial Master`}
          columnsToFormatInINR={[]}
        />
      </Card>
    </>
  );
};

export default CommercialMaster;
