import { Button, Dialog } from 'components/ui';
import { useContext, useEffect, useState } from 'react';
import { useSelector } from 'react-redux';
import { CLIENT } from 'views/Controls/clientListEnum';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import {
  bulkInsertPositionEnum,
  ntcDescriptionTypesEnum,
  ntcDurationTypesEnum,
  operationTypesEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import Description from './components/Description';
import InsertPosition from './components/InsertPosition';
import StartEndTime from './components/StartEndTime';
import Breaks from './components/Breaks';
import Events from './components/Events';
import { getBreaks } from '../../utils';
import Duration from './components/Duration';
import OffsetStartTime from './components/OffsetStartTime';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

function BulkInsertDialog({ isDialogOpen, setIsDialogOpen, insertType }) {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* CONTEXT */
  const { schedulingTableData, secondaryTableSelectedRows, executeOperation } =
    useContext(SchedulerContext);

  /* STATES */
  const [selectedBreaks, setSelectedBreaks] = useState([]);
  const [time, setTime] = useState({ start: null, end: null });
  const [insertPosition, setInsertPosition] = useState(
    bulkInsertPositionEnum.START,
  );
  const [descriptionType, setDescriptionType] = useState(
    ntcDescriptionTypesEnum.ORIGINAL,
  );
  const [description, setDescription] = useState('');
  const [durationType, setDurationType] = useState(
    ntcDurationTypesEnum.ORIGINAL,
  );
  const [duration, setDuration] = useState('');
  const [bulkNTCInsOffsetTime, setBulkNTCInsOffsetTime] =
    useState('00:00:00:00');

  /* USE EFFECTS */
  useEffect(() => {
    if (isDialogOpen) {
      if (channel && channel.label === CLIENT.USA_Forbes)
        setSelectedBreaks(
          getBreaks(schedulingTableData).map((breakNum) => breakNum.value),
        );
      if (
        secondaryTableSelectedRows.length > 0 &&
        insertType === rowDataTypesEnum.NTC
      ) {
        setBulkNTCInsOffsetTime(secondaryTableSelectedRows[0].OffsetStartTime);
      }
    }
  }, [channel, isDialogOpen, secondaryTableSelectedRows]);

  /* EVENT HANDLERS */
  const handleClose = () => {
    try {
      setSelectedBreaks([]);
      setTime({ start: null, end: null });
      setInsertPosition(bulkInsertPositionEnum.START);
      setDescriptionType(ntcDescriptionTypesEnum.ORIGINAL);
      setDescription('');
      setDurationType(ntcDurationTypesEnum.ORIGINAL);
      setDuration('');
      setBulkNTCInsOffsetTime('00:00:00:00');
      setIsDialogOpen(false);
    } catch (error) {
      openNotification('danger', 'Something went wrong');
      console.error(error);
    }
  };

  const handleBulkInsert = () => {
    try {
      executeOperation({
        operation: operationTypesEnum.BULK_INSERT_ROW,
        insertPosition,
        time,
        selectedBreaks,
        descriptionType,
        bulkNTCInsDesc: description,
        durationType,
        bulkNTCInsDuration: duration,
        bulkNTCInsOffsetTime,
      });
      handleClose();
      openNotification('success', 'Events inserted successfully');
    } catch (error) {
      openNotification('danger', 'Something went wrong while inserting events');
      console.error(error);
    }
  };

  /* CONSTANTS */
  const isChannelForbes = channel.label === CLIENT.USA_Forbes;

  return (
    <Dialog
      isOpen={isDialogOpen}
      onClose={handleClose}
      onRequestClose={handleClose}
      width={'40%'}
      contentClassName={'mt-8'}
    >
      <div className="flex flex-col h-full">
        <h4 className="border-b border-b-gray-700 pb-2 mb-3">Bulk Insert</h4>
        <div className="max-h-[60vh] overflow-y-auto flex flex-col gap-6 pr-2 text-white">
          <Events />
          {!isChannelForbes && (
            <Breaks
              selectedBreaks={selectedBreaks}
              setSelectedBreaks={setSelectedBreaks}
            />
          )}
          <StartEndTime time={time} setTime={setTime} />
          {secondaryTableSelectedRows.length > 0 && (
            <>
              {insertType === rowDataTypesEnum.NTC && (
                <>
                  <Description
                    descriptionType={descriptionType}
                    setDescriptionType={setDescriptionType}
                    description={description}
                    setDescription={setDescription}
                  />
                  <Duration
                    durationType={durationType}
                    setDurationType={setDurationType}
                    duration={duration}
                    setDuration={setDuration}
                  />
                  <OffsetStartTime
                    offsetStartTime={bulkNTCInsOffsetTime}
                    setOffsetStartTime={setBulkNTCInsOffsetTime}
                  />
                </>
              )}
            </>
          )}
          {!isChannelForbes && (
            <InsertPosition
              insertPosition={insertPosition}
              setInsertPosition={setInsertPosition}
            />
          )}
        </div>
        <div className="text-right mt-6">
          <Button
            variant="solid"
            disabled={
              selectedBreaks.length === 0 ||
              !time.start ||
              !time.end ||
              !insertPosition ||
              (durationType === ntcDurationTypesEnum.CUSTOM &&
                duration.length !== 11) ||
              bulkNTCInsOffsetTime.length !== 11
            }
            onClick={handleBulkInsert}
          >
            Insert
          </Button>
        </div>
      </div>
    </Dialog>
  );
}

export default BulkInsertDialog;
