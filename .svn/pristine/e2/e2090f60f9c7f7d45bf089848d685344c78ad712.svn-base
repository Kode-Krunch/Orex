import React, { useState, useEffect } from 'react';
import { Button, Card, Dialog, RangeCalendar, Tabs } from 'components/ui';
import DatePickerRange from 'components/ui/DatePicker/DatePickerRange';
import { hideStackedSideNav_secondary } from 'views/Scheduling/general';
import { useSelector } from 'react-redux';
import { convertDateToYMD } from 'components/validators';
import { apiCallstoreprocedure } from 'services/CommonService';
import { GrClose } from 'react-icons/gr';
import TabContent from 'components/ui/Tabs/TabContent';
import TabList from 'components/ui/Tabs/TabList';
import TabNav from 'components/ui/Tabs/TabNav';
import { HiOutlineSearch } from 'react-icons/hi';
import { IoMdArrowForward } from 'react-icons/io';
import { apiGetInvoice, apiGetInvoiceNTC } from 'services/BillingService';
import SelectableTable from './components/SelectableTable';
import BillsDashboard from './BillsDashboard';
import {
  isChannelSelected,
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import DebouncedInput from 'views/Controls/DebouncedInput';
import { AxiosError } from 'axios';
import './billDelete.css';
import Loader from 'views/Controls/Loader';
import SelectChannelDialog from 'views/Controls/SelectChannelDialog';
import {
  billPrintingRouteTitle,
  ntcBillPrintingRouteTitle,
} from 'configs/routes.config';

function BillDelete() {
  /* REDUX STATES */
  const channel = useSelector((state) => state.locale.selectedChannel);
  const loginId = useSelector((state) => state.auth.session.LoginId);
  const token = useSelector((state) => state.auth.session.token);
  const currentRouteTitle = useSelector(
    (state) => state.base.common.currentRouteTitle,
  );

  /* STATES */
  const [initialLoad, setInitialLoad] = useState(true);
  const [datesRange, setDatesRange] = useState([null, null]);
  const [baseFilterTables, setBaseFilterTables] = useState(null);
  const [globalFilter, setGlobalFilter] = useState('');
  const [selectedRows, setSelectedRows] = useState([]);
  const [bills, setBills] = useState(null);

  // UI States
  const [showLoader, setShowLoader] = useState(false);
  const [curTab, setCurTab] = useState('tab1');

  useEffect(() => {
    try {
      (async () => {
        if (datesRange && datesRange[0] && datesRange[1]) {
          hideStackedSideNav_secondary();
          setInitialLoad(false);
          setShowLoader(true);
          setBaseFilterTables({
            agencyTable: await getBaseFilterTableData('agency'),
            clientTable: await getBaseFilterTableData('client'),
            bookingTable: await getBaseFilterTableData('booking'),
          });
          setShowLoader(false);
        }
      })();
    } catch (error) {
      console.error(error);
      resetState();
    }
  }, [datesRange]);

  useEffect(() => {
    try {
      resetState();
    } catch (error) {
      console.error(error);
    }
  }, [channel]);

  /* HELPER FUNCTIONS */
  const handleInitialDialogClose = () => {
    try {
      setInitialLoad(false);
    } catch (error) {
      console.error(error);
    }
  };

  const getBaseFilterTableData = async (type) => {
    try {
      let param = {
        location: channel.LocationCode,
        channel: channel.ChannelCode,
        fromDate: convertDateToYMD(datesRange[0]),
        todate: convertDateToYMD(datesRange[1]),
        Flag: null,
        IsNTC: 0,
      };

      if (type === 'agency') {
        param.Flag = 1;
      } else if (type === 'client') {
        param.Flag = 2;
      } else if (type === 'booking') {
        param.Flag = 3;
      }

      let response = await apiCallstoreprocedure(
        'usp_BillingPrinting_List', //TODO: Change this stored procedure to usp_BillingPrinting_List
        param,
      );

      if (response.status === 200) {
        return response.data;
      } else if (response.status === 204) {
        return [];
      } else {
        openNotification(
          'danger',
          `Something went wrong. Server responded with status code ${response.status}.`,
        );
        throw new Error(
          `Response status code: ${response.status}. Response: ${response}`,
        );
      }
    } catch (error) {
      if (error instanceof AxiosError) {
        openNotification(
          'danger',
          `Something went wrong. Server responded with status code ${error.response.status}`,
        );
      }
      throw error;
    }
  };

  const getBills = async () => {
    try {
      setShowLoader(true);
      let param = {
        loginCode: loginId,
        locationCode: channel.LocationCode,
        fromDate: convertDateToYMD(datesRange[0]),
        uptoDate: convertDateToYMD(datesRange[1]),
        channelCode: channel.ChannelCode,
      };
      if ('BookingCode' in selectedRows[0]) {
        param.filter = selectedRows.map((row) => row.BookingNumber).join(',');
        param.id = 2;
      } else if ('AgencyCode' in selectedRows[0]) {
        param.filter = selectedRows.map((row) => row.AgencyCode).join(',');
        param.id = 3;
      } else if ('ClientCode' in selectedRows[0]) {
        param.filter = selectedRows.map((row) => row.ClientCode).join(',');
        param.id = 4;
      }
      let response = null;
      if (currentRouteTitle === billPrintingRouteTitle) {
        response = await apiGetInvoice(param, token);
      } else if (currentRouteTitle === ntcBillPrintingRouteTitle) {
        response = await apiGetInvoiceNTC(param, token);
      }

      if (response) {
        if (response.status === 200) {
          setBills(response.data);
        } else if (response.status === 204) {
          setBills([]);
        } else {
          openNotification(
            'danger',
            `Something went wrong. Server responded with status code ${response.status}.`,
            'Error',
          );
        }
      } else {
        openNotification('danger', `Something went wrong`);
      }
      setShowLoader(false);
    } catch (error) {
      if ('message' in error) {
        openNotification('danger', `${error.message}`, 'Error');
      } else {
        openNotification('danger', `Something went wrong.`, 'Error');
      }
    }
  };

  const resetState = () => {
    try {
      setInitialLoad(true);
      setDatesRange([null, null]);
      setBaseFilterTables(null);
      setGlobalFilter('');
      setSelectedRows([]);
      setBills(null);
      setShowLoader(false);
      setCurTab('tab1');
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <>
      <div className="flex items-center justify-between mb-4">
        <h3>Bill Delete</h3>
        <div id="bill-printing-dpr-container">
          <DatePickerRange
            placeholder="Select dates range"
            size="sm"
            onChange={(e) => {
              if (e[0] === null && e[1] === null) {
                resetState();
              } else {
                setDatesRange(e);
              }
            }}
            value={datesRange}
            clearable={true}
            disabled={
              !isChannelSelected(channel) || (datesRange[0] && datesRange[1])
            }
            onDropdownOpen={() => resetState()}
          />
        </div>
      </div>
      {isChannelSelected(channel) ? (
        <>
          {datesRange && datesRange[0] && datesRange[1] ? (
            <>
              {baseFilterTables && !bills && (
                <Card className="h-full" bodyClass="h-full" bordered={false}>
                  <Tabs
                    variant="pill"
                    defaultValue="tab1"
                    onChange={(event) => {
                      setCurTab(event);
                      setGlobalFilter('');
                      setSelectedRows([]);
                    }}
                    className="h-full flex flex-col"
                  >
                    <div className="flex justify-between">
                      <TabList>
                        <TabNav value="tab1">Agency</TabNav>
                        <TabNav value="tab2">Client</TabNav>
                        <TabNav value="tab3">Booking</TabNav>
                      </TabList>
                      <DebouncedInput
                        value={globalFilter ?? ''}
                        className="lg:w-52"
                        size="sm"
                        prefix={<HiOutlineSearch className="text-lg" />}
                        placeholder="Search"
                        onChange={(value) => setGlobalFilter(String(value))}
                        showSearchLabel={false}
                      />
                    </div>
                    <hr className="mt-2" />
                    <div className="mt-3 grow">
                      {curTab === 'tab1' && (
                        <TabContent value="tab1" className="h-full">
                          {baseFilterTables.agencyTable.length > 0 ? (
                            <SelectableTable
                              tableColumns={[
                                {
                                  header: 'Agency Name',
                                  accessorKey: 'AgencyName',
                                },
                              ]}
                              data={baseFilterTables.agencyTable}
                              globalFilter={globalFilter}
                              setGlobalFilter={setGlobalFilter}
                              setSelectedRows={setSelectedRows}
                              footerAction={
                                <Button
                                  variant="solid"
                                  icon={<IoMdArrowForward />}
                                  size="sm"
                                  disabled={selectedRows.length === 0}
                                  onClick={getBills}
                                >
                                  Delete Bills
                                </Button>
                              }
                              type="home"
                            />
                          ) : (
                            <div className="h-full flex justify-center items-center">
                              No agencies found
                            </div>
                          )}
                        </TabContent>
                      )}
                      {curTab === 'tab2' && (
                        <TabContent value="tab2" className="h-full">
                          {baseFilterTables.clientTable.length > 0 ? (
                            <SelectableTable
                              tableColumns={[
                                {
                                  header: 'Client Name',
                                  accessorKey: 'ClientName',
                                },
                              ]}
                              data={baseFilterTables.clientTable}
                              globalFilter={globalFilter}
                              setGlobalFilter={setGlobalFilter}
                              selectedRows={selectedRows}
                              setSelectedRows={setSelectedRows}
                              footerAction={
                                <Button
                                  variant="solid"
                                  icon={<IoMdArrowForward />}
                                  size="sm"
                                  disabled={selectedRows.length === 0}
                                  onClick={getBills}
                                >
                                  Delete Bills
                                </Button>
                              }
                              type="home"
                            />
                          ) : (
                            <div className="h-full flex justify-center items-center">
                              No clients found
                            </div>
                          )}
                        </TabContent>
                      )}
                      {curTab === 'tab3' && (
                        <TabContent value="tab3" className="h-full">
                          {baseFilterTables.bookingTable.length > 0 ? (
                            <SelectableTable
                              tableColumns={[
                                {
                                  header: 'Booking Number',
                                  accessorKey: 'BookingCode',
                                },
                              ]}
                              data={baseFilterTables.bookingTable}
                              globalFilter={globalFilter}
                              setGlobalFilter={setGlobalFilter}
                              selectedRows={selectedRows}
                              setSelectedRows={setSelectedRows}
                              footerAction={
                                <Button
                                  variant="solid"
                                  icon={<IoMdArrowForward />}
                                  size="sm"
                                  disabled={selectedRows.length === 0}
                                  onClick={getBills}
                                >
                                  Delete Bills
                                </Button>
                              }
                              type="home"
                            />
                          ) : (
                            <div className="h-full flex justify-center items-center">
                              No bookings found
                            </div>
                          )}
                        </TabContent>
                      )}
                    </div>
                  </Tabs>
                </Card>
              )}
              {baseFilterTables && bills ? (
                <BillsDashboard bills={bills} setShowLoader={setShowLoader} />
              ) : baseFilterTables && bills && bills.length === 0 ? (
                <Card
                  className="h-[80vh]"
                  bodyClass="h-full flex justify-center items-center"
                  bordered={false}
                >
                  No bills to show
                </Card>
              ) : (
                <></>
              )}
            </>
          ) : (
            <Card
              className="h-[80vh]"
              bodyClass="h-full flex justify-center items-center"
              bordered={false}
            >
              Please select date range to view bills.
            </Card>
          )}
        </>
      ) : (
        <>
          <Card
            className="h-[80vh]"
            bodyClass="h-full flex justify-center items-center"
            bordered={false}
          >
            Please select a channel to view bills
          </Card>
        </>
      )}

      <Dialog
        isOpen={isChannelSelected(channel) && initialLoad}
        bodyOpenClassName="overflow-hidden"
        closable={false}
        onClose={handleInitialDialogClose}
      >
        <div className="flex justify-between relative items-center border-b border-gray-200 dark:border-gray-600 pb-4 mb-4">
          <h5>Select Date Range</h5>
          <Button
            shape="circle"
            variant="plain"
            icon={<GrClose className="text-gray-600" />}
            onClick={handleInitialDialogClose}
            className="absolute -top-4 -right-4"
          />
        </div>
        <div className="mx-auto">
          <RangeCalendar
            value={datesRange}
            maxDate={new Date(new Date().setDate(new Date().getDate() + 30))}
            onChange={(e) => setDatesRange(e)}
          />
        </div>
      </Dialog>
      <SelectChannelDialog />
      <Loader showLoader={showLoader} />
    </>
  );
}

export default BillDelete;
