import React, { useEffect, useState } from 'react';

import { apiCallstoreprocedure } from 'services/CommonService';
import { convertDateToYMD } from 'components/validators';
import { useSelector } from 'react-redux';
import CalendarWeekly from 'components/shared/CalendarWeekly';
import { hideStackedSideNav_secondary } from 'views/Scheduling/general';
import { Button, Tooltip, Upload } from 'components/ui';
import { handleExportToExcel } from 'views/Controls/DisplayTable';
import { StickyFooter } from 'components/shared';
import { useNavigate } from 'react-router-dom';
import {
  HiOutlineCloudDownload,
  HiOutlineCloudUpload,
  HiOutlineDownload,
} from 'react-icons/hi';
import UploadingLoaderDialog from 'views/Controls/UploadingLoaderDialog';
import FileSummaryDialog from './components/UploadWeeklyFPC/FileSummaryDialog';
import {
  formatDurationHHMM,
  formatDurationHHMMSSFF,
  openNotification,
  parseDuration,
} from 'views/Controls/GLOBALFUNACTION';
import appConfig from 'configs/app.config';
import { saveAs } from 'file-saver';
import { js2xml } from 'xml-js';
import {
  GREEN_700,
  RED_700,
} from 'views/Controls/Dashboard/constants/tw_colors';

/* CONSTANTS */
const COLUMNS = [
  {
    header: 'Start Time',
    accessorKey: 'startlabel',
  },
  {
    header: 'End Time',
    accessorKey: 'endLabel',
  },
  {
    header: 'Telecast Date',
    accessorKey: 'start',
  },
  {
    header: 'Content Name',
    accessorKey: 'title',
  },
];

const EPGMaster = () => {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);
  const token = useSelector((state) => state.auth.session.token);
  const ChannelSetting = useSelector(
    (state) => state.auth.session.ChannelSetting,
  );
  const [currentDate, setCurrentDate] = useState({
    start: '',
    end: '',
  });
  const [eventsData, seteventsData] = useState([]);
  const [selectedFile, setSelectedFile] = useState(null);
  const [fileArray, setFileArray] = useState(null);
  const [fileArrayExportXML, setFileArrayExportXML] = useState([]);
  const [isFileUploadingLoaderOpen, setIsFileUploadingLoaderOpen] =
    useState(false);
  const [isFileSummaryDialogOpen, setIsFileSummaryDialogOpen] = useState(false);
  const [uploadPercent, setUploadPercent] = useState(0);

  /* HOOKS */
  const navigate = useNavigate();

  /* USE EFFECTS */
  useEffect(() => {
    const fetchData2 = async () => {
      try {
        console.log(currentDate.end);

        const resp = await apiCallstoreprocedure('USP_PG_GetWeeklyFPC', {
          Locationcode: channel.LocationCode,
          ChannelCode: channel.ChannelCode,
          FromDate: currentDate.start,
          Todate: currentDate.end,
        });
        if (resp.status == 204) {
          seteventsData([]);
          return;
        }
        const mr = resp.data.map((item, key) => ({
          id: key,
          title: ` ${item.ContentName} `,
          start: `${item.TelecastDate}T${item.TelecastStartTime}:00`,
          startlabel: `${item.TelecastStartTime}`,
          end: `${item.TelecastDate}T${item.TelecastEndTime}:00`,
          endLabel: `${item.TelecastEndTime}`,
          eventColor: `${item.Colour}`,
        }));
        const mr2 = resp.data.map((item, key) => ({
          ChannelCode: channel.ChannelCode,
          Program_Duration2: `${item.TelecastDate.replace(
            /-/g,
            '',
          )}${item.TelecastEndTime.replace(/:/g, '')}00`,

          Program_Duration: `${item.TelecastDate.replace(
            /-/g,
            '',
          )}${item.TelecastStartTime.replace(/:/g, '')}00`,
          Short_Synopsis: item.Synopsis,
          Release_Date: item.TelecastDate,
          Unique_program_ID: item.ShortName,
          Long_Synopsis: item.Synopsis,
          Casting: 'None',
          Program_Title: item.ContentName,
          Tags: item.ContentTypeName,
          Director: 'None',
          Program_Description: item.Synopsis,
          Type: 'video',
          Language: item.LanguageName,
          Asset_ID: 'None',
          Other_Language: 'None',
          Program_Rating: 'PG',
          Run_Time: formatDurationHHMMSSFF(Number(ChannelSetting[0].FramePerSec), item.SlotDuration * 60),
          AddedBy: 64,
          Program_Genre: item.GenreName,
          Episode_Title: 'NA',
          AddedOn: item.AddedOn,
          LocationCode: channel.LocationCode,
          Thumbnail_Poster:
            'https://d2956h8w040x83.cloudfront.net/THUMBNAILS/STVP_Logo_1920x1080.jpg',
          Episode_Number: 'NA',
          bgColor: '#15803d',
          fontColor: 'white',
        }));
        seteventsData(mr);
        setFileArrayExportXML(mr2);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    };
    if (currentDate.start && currentDate.end) {
      fetchData2();
    }
  }, [currentDate, channel]);

  useEffect(() => {
    (async () => {
      try {
        if (selectedFile) {
          const Data = await getFileResponse();
          setFileArray(
            Data.map((item) => ({
              ...item,
              TelecastDate: item.Release_Date,
              Statuscode: 1,
              StartTime: formatDurationHHMM(item.Run_Time),
              EndTime: formatDurationHHMM(item.Run_Time),
              ContentName: item.Program_Title,
              Episode: item.Program_Title,
              Season: 1,
              EpisodeNumber: item.Episode_Number,
              orginaldate: item.Release_Date,
              Duration: formatDurationHHMMSSFF(Number(ChannelSetting[0].FramePerSec), item.Program_Duration),
            })),
          );
          setFileArrayExportXML(await getFileResponse());
          setUploadPercent(100);
          await new Promise((resolve) => setTimeout(resolve, 1000));
          setSelectedFile(null);
          setIsFileUploadingLoaderOpen(false);
          setIsFileSummaryDialogOpen(true);
        }
      } catch (error) {
        console.error(error);
        setSelectedFile(null);
        setIsFileUploadingLoaderOpen(false);
        setIsFileSummaryDialogOpen(false);
        openNotification('danger', 'Something went wrong while uploading file');
      }
    })();
  }, [selectedFile]);

  useEffect(() => {
    let interval;
    if (isFileUploadingLoaderOpen) {
      interval = setInterval(() => {
        if (uploadPercent >= 90) clearInterval(interval);
        else if (uploadPercent < 100) setUploadPercent((prev) => prev + 1);
      }, 1000);
    } else setUploadPercent(0);
    return () => clearInterval(interval);
  }, [isFileUploadingLoaderOpen, uploadPercent]);
  // handleExportToExcel = (columns, table, ExportName);

  /* EVENT HANDLERS */
  const handleBeforeUpload = async (files, fileList) => {
    const allowedFileType = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    ];
    let selectedFile;

    if (files.length > 0) {
      selectedFile = files[0];
    } else {
      openNotification('danger', 'Please select a file!');
      return;
    }
    if (!allowedFileType.includes(selectedFile.type)) {
      openNotification('danger', 'Please upload an XLSX file!');
      return;
    }
    setSelectedFile(selectedFile);
  };

  /* HELPER FUNCTIONS */
  const getFileResponse = async () => {
    try {
      const bodyContent = new FormData();
      setIsFileUploadingLoaderOpen(true);
      const arrayBuffer = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsArrayBuffer(selectedFile);
        reader.onload = function (event) {
          resolve(event.target.result);
        };
        reader.onerror = function (error) {
          reject(error);
        };
      });

      const blob = new Blob([arrayBuffer], { type: selectedFile.type });
      bodyContent.append('file', blob, selectedFile.name);

      let response = await fetch(
        appConfig.apiPrefix +
        `/epgupload/upload/?LocationCode=${channel.LocationCode}&ChannelCode=${channel.ChannelCode}`,
        {
          method: 'POST',
          body: bodyContent,
          headers: {
            Accept: '*/*',
            Authorization: `Bearer ${token}`,
          },
        },
      );
      response = await response.json();
      console.log(response);

      if (Array.isArray(response)) {
        response = response.map((row) =>
          row.Statuscode === 0
            ? { ...row, bgColor: RED_700, fontColor: 'white' }
            : { ...row, bgColor: GREEN_700, fontColor: 'white' },
        );
        return response;
      } else {
        throw new Error('Something went wrong while uploading file');
      }
    } catch (error) {
      setIsFileUploadingLoaderOpen(false);
      throw error;
    }
  };

  hideStackedSideNav_secondary();

  const convertToXml = () => {
    const tvData = {
      tv: {
        _attributes: {
          'xmlns:xsi': 'http://www.w3.org/2001/XMLSchema-instance',
          'xmlns:xsd': 'http://www.w3.org/2001/XMLSchema',
        },
        channel: {
          _attributes: { id: channel.ChannelName },
          'display-name': { _text: channel.ChannelName },
          url: {},
          icon: {
            _attributes: {
              // src: 'https://drive.google.com/file/d/1ZiZ_54KO6MhupqiAjs5lZPdHgoWelpBs/view?usp=sharing',
              src: 'https://s3.ca-central-1.wasabisys.com/logoswise/CHANNEL_LOGO%20640X360%20/MASTIII%20TV%20LOGO%20(640X360)%20transparent.png'
            },
          },
        },
        programme: fileArrayExportXML.map((program, index) => {
          return {
            _attributes: {
              channel: channel.ChannelName,
              start: program['Program_Duration'] + ' +0000',
              stop: program['Program_Duration2'] + ' +0000',
            },
            programId: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
              _text: program['Unique_program_ID'],
            },
            title: {
              _text: program['Program_Title'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            ThumbnailUrl: { _text: program['Thumbnail_Poster'] },
            desc: {
              _text: program['Program_Description'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            type: {
              _text: program['Type'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            assetId: {
              _text: program['Unique_program_ID'] + '.mp4',
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            tmsId: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            licenseStart: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            licenseEnd: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            shortSynopsis: {
              _text: program['Short_Synopsis'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            longSynopsis: {
              _text: program['Long_Synopsis'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            runtime: {
              _text: program['Run_Time'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            rating: {
              _text: program['Program_Rating'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            cuepoints: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            releaseDate: {
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            genre: {
              _text: program['Program_Genre'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            tags: {
              _text: program['Tags'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            episodeNumber: {
              _text: program['Episode_Number'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            episodeTitle: {
              _text: program['Episode_Title'],
              _attributes: {
                lang: program['Language'].toLowerCase().substring(0, 2),
              },
            },
            castList: {
              cast:
                program['Casting'] === 'None'
                  ? {
                    name: {
                      _attributes: {
                        lang: program['Language']
                          .toLowerCase()
                          .substring(0, 2),
                      },
                    },
                    character: {
                      _text: 'CAST 1',
                      _attributes: {
                        lang: program['Language']
                          .toLowerCase()
                          .substring(0, 2),
                      },
                    },
                  }
                  : program['Casting']
                    .split(',') // Assuming the cast list is comma-separated
                    .map((cast, index) => ({
                      name: {
                        _text: cast.trim(),
                        _attributes: {
                          lang: program['Language']
                            .toLowerCase()
                            .substring(0, 2),
                        },
                      },
                      character: {
                        _text: `cast ${index + 1}`,
                        _attributes: {
                          lang: program['Language']
                            .toLowerCase()
                            .substring(0, 2),
                        },
                      },
                    })),
            },
            crewList: {
              crew:
                program['Director'] === 'None'
                  ? {
                    name: {
                      _attributes: {
                        lang: program['Language']
                          .toLowerCase()
                          .substring(0, 2),
                      },
                    },
                    role: {
                      _text: 'DIRECTOR',
                      _attributes: {
                        lang: program['Language']
                          .toLowerCase()
                          .substring(0, 2),
                      },
                    },
                  }
                  : program['Director']
                    .split(',') // Assuming the director list is comma-separated
                    .map((director) => ({
                      name: {
                        _text: director.trim(),
                        _attributes: {
                          lang: program['Language']
                            .toLowerCase()
                            .substring(0, 2),
                        },
                      },
                      role: {
                        _text: 'DIRECTOR',
                        _attributes: {
                          lang: program['Language']
                            .toLowerCase()
                            .substring(0, 2),
                        },
                      },
                    })),
            },
            seasonsList: {
              season: {
                id: {
                  _attributes: {
                    lang: program['Language'].toLowerCase().substring(0, 2),
                  },
                },
                seasonNumber: {
                  _attributes: {
                    lang: program['Language'].toLowerCase().substring(0, 2),
                  },
                },
              },
            },
          };
        }),
      },
    };

    const xmlOptions = { compact: true, spaces: 4 };
    const xmlString = js2xml(tvData, xmlOptions);

    const blob = new Blob([xmlString], { type: 'application/xml' });
    saveAs(blob, 'tv_programs.xml');
  };

  return (
    <>
      {' '}
      <CalendarWeekly
        initialView="timeGridWeek"
        headerToolbar={{
          left: '',
          center: 'title',
          right: 'prev,next',
        }}
        selectable
        events={eventsData}
        datesSet={(dateInfo) => {
          console.log(dateInfo.end);
          const newDate = new Date(dateInfo.end); // Create a copy of the selected date
          newDate.setDate(newDate.getDate() - 1); // Decrease the day by 1         
          setCurrentDate({
            start: convertDateToYMD(dateInfo.start),
            end: convertDateToYMD(newDate),
          });
        }}
        contentHeight="auto"
      />{' '}
      <StickyFooter
        className="-mx-8 px-8 flex items-center justify-start py-4 z-10"
        stickyClass="border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
      >
        <Button
          onClick={() => {
            navigate('/Programming');
          }}
          className="mr-2"
        >
          Back
        </Button>
        <Button
          variant="solid"
          className="mr-2"
          icon={<HiOutlineDownload />}
          onClick={() => {
            const formatDate = (dateString) => {
              const options = {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
              };
              const date = new Date(dateString);
              return date.toLocaleDateString('en-US', options).replace(',', '');
            };
            const formattedEvents = eventsData.map((event) => ({
              ...event,
              start: formatDate(event.start),
              end: formatDate(event.end),
              startlabel: event.startlabel,
              endLabel: event.endLabel,
              title: event.title,
            }));
            handleExportToExcel(COLUMNS, formattedEvents, 'WeeklyFPC');
          }}
        >
          Export
        </Button>
        {/* <Tooltip title="Upload Weekly FPC" placement="top">
          <Upload
            beforeUpload={handleBeforeUpload}
            uploadLimit={1}
            accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel"
            showList={false}
          >
            <Button
              variant="solid"
              icon={<HiOutlineCloudUpload />}
              className="mr-2"
            >
              Upload
            </Button>
          </Upload>
        </Tooltip> */}
        {/* <Tooltip title="Download XML Weekly FPC" placement="top"> */}
        <Button
          variant="twoTone"
          icon={<HiOutlineCloudDownload />}
          onClick={() => {

            if (fileArrayExportXML.length > 0) {
              convertToXml();
            }
          }}
        >
          Download XML
        </Button>
        {/* </Tooltip> */}
      </StickyFooter>
      <UploadingLoaderDialog
        title="Uploading File"
        isOpen={isFileUploadingLoaderOpen}
        uploadPercent={uploadPercent}
      />
      {Array.isArray(fileArray) && (
        <FileSummaryDialog
          fileArray={fileArray}
          setFileArray={setFileArray}
          isOpen={isFileSummaryDialogOpen}
          setIsOpen={setIsFileSummaryDialogOpen}
        />
      )}
    </>
  );
};

export default EPGMaster;
