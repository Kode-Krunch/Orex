import appConfig from 'configs/app.config';
import { useEffect, useRef } from 'react';
import { useDispatch, useSelector } from 'react-redux';
// import { io } from 'socket.io-client';
import { Avatar, Notification, toast } from 'components/ui';
import { HiOutlineBell } from 'react-icons/hi';
import { setNodeJsNotifications } from 'store/locale/localeSlice';

// const socket = io(appConfig.nodeJsServerHost);

function NodeJsNotificationListener() {
  /* REDUX */
  const userId = useSelector((state) => state.auth.session.LoginId);
  const nodeJsNotifications = useSelector(
    (state) => state.locale.nodeJsNotifications,
  );
  const dispatch = useDispatch();

  /* HOOKS */
  // const socket = useRef(null);

  /* USE EFFECTS */
  useEffect(() => {
    if (!userId) return;
    const socket = new WebSocket(`ws://localhost:8080/notification/ws/notification:new/${userId}`);
    socket.onopen = () => {
      console.log("✅ Connected to FastAPI WebSocket: notification:new");
    };

    socket.onmessage = (message) => {
      const notification = JSON.parse(message.data);
      toast.push(
        <Notification
          title={notification.notification_metadata.locationLabel || "Bats"}
          type={notification.notification_metadata.severity}
          customIcon={
            <Avatar
              shape="circle"
              className=" bg-yellow-100 text-yellow-600 dark:bg-yellow-500/20 dark:text-yellow-100 "
              {...(notification.notification_metadata.icon
                ? { src: notification.notification_metadata.icon }
                : {
                  icon: <HiOutlineBell />,
                })}
            />
          }
          duration={3000}
          closable={true}
        >
          {notification.message}
        </Notification>,
      );
      dispatch(setNodeJsNotifications([notification, ...nodeJsNotifications]));
    }

    socket.onclose = () => {
      console.log("❌ WebSocket disconnected");
    };

    socket.onerror = (error) => {
      console.error("⚠️ WebSocket error:", error);
    };

    return () => {
      socket.current?.close();
    };

    // // Register userId once connected
    // socket.emit('register', userId);

    // // Listen for notifications and display toast notification
    // socket.on('notification:new', (notification) => {
    //   toast.push(
    //     <Notification
    //       title="Bats"
    //       type={notification.notification_metadata.severity}
    //       customIcon={
    //         <Avatar
    //           shape="circle"
    //           className=" bg-yellow-100 text-yellow-600 dark:bg-yellow-500/20 dark:text-yellow-100 "
    //           {...(notification.notification_metadata.icon
    //             ? { src: notification.notification_metadata.icon }
    //             : {
    //                 icon: <HiOutlineBell />,
    //               })}
    //         />
    //       }
    //       duration={3000}
    //       closable={true}
    //     >
    //       {notification.notification}
    //     </Notification>,
    //   );
    //   dispatch(setNodeJsNotifications([notification, ...nodeJsNotifications]));
    // });

    // return () => {
    //   socket.off('notification:new');
    // };
  }, [userId, nodeJsNotifications, dispatch]);

  return null;
}

export default NodeJsNotificationListener;
