import React, { useContext, useEffect, useState } from 'react';
import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';
import { Button, Card, Spinner, Tooltip } from 'components/ui';
import { IoMdClose } from 'react-icons/io';
import { handleFeatureClose } from '../../utils/utils';
import {
  droppableIdsEnum,
  featuresEnum,
  rowDataTypesEnum,
  secondaryTableTypesEnum,
  tableTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { getProgramsWithSegment } from './utils';
import { useSelector } from 'react-redux';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import {
  INSERT_PROGRAM_COLUMNS,
  TABLE_NAMES,
} from 'views/Scheduling/Scheduler/constants';
import DraggableTable from '../DraggableTable/DraggableTable';

function InsertProgram() {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* CONTEXT */
  const {
    date,
    secondaryTableData,
    setSecondaryTableData,
    setActiveFeatures,
    resetSecondaryTableStates,
    secondaryTableSelectedRows,
    setSecondaryTableSelectedRows,
    secondaryTableOffset,
    secondaryTableRef,
    setSecondaryTableType,
  } = useContext(SchedulerContext);

  /* STATES */
  const [showLoader, setShowLoader] = useState(false);

  /* CONSTANTS */
  const programs = secondaryTableData.filter(
    (row) => row.F_C_S_P === rowDataTypesEnum.CONTENT_TERMINATION,
  );

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        setShowLoader(true);
        setSecondaryTableType(secondaryTableTypesEnum.PROGRAMS);
        const programsWithSegment = await getProgramsWithSegment(channel, date);
        setSecondaryTableData(programsWithSegment);
        setShowLoader(false);
      } catch (error) {
        setShowLoader(false);
        openNotification(
          'danger',
          'Something went wrong while fetching programs',
        );
        console.error(error);
      }
    })();
    return resetSecondaryTableStates;
  }, []);

  return (
    <div className="h-full w-full flex flex-col overflow-auto no-scrollbar bg-gray-800 p-3 pt-2 rounded-lg">
      <div className="flex justify-between items-center mb-2">
        <div className="flex items-center gap-3">
          <h5>Programs</h5>
          {programs.length > 0 && (
            <h6 className="rounded-md px-1.5 py-0.5 bg-gray-600 flex items-center justify-center">
              {programs.length}
            </h6>
          )}
        </div>
        <div className="flex gap-1.5">
          <Tooltip title="Close">
            <Button
              size="xs"
              icon={<IoMdClose />}
              onClick={() =>
                handleFeatureClose(
                  setActiveFeatures,
                  featuresEnum.MANAGE_SEGMENT,
                )
              }
            />
          </Tooltip>
        </div>
      </div>
      <div className="h-[92%] flex flex-col gap-3">
        {programs.length > 0 ? (
          <>
            <div className="grow">
              <DraggableTable
                tableName={TABLE_NAMES.SECONDARY_TABLE_NAMES.INSERT_PROGRAMS}
                tableType={tableTypesEnum.SECONDARY}
                tableData={secondaryTableData}
                columns={INSERT_PROGRAM_COLUMNS}
                droppableId={droppableIdsEnum.SECONDARY}
                selectedRows={secondaryTableSelectedRows}
                setSelectedRows={setSecondaryTableSelectedRows}
                scrolledOffset={secondaryTableOffset}
                tableRef={secondaryTableRef}
              />
            </div>
          </>
        ) : (
          <Card
            className="h-full"
            bodyClass="h-full flex justify-center items-center"
          >
            {showLoader ? <Spinner size="45px" /> : 'No programs to show'}
          </Card>
        )}
      </div>
    </div>
  );
}

export default InsertProgram;
