import React, { useContext, useEffect, useState } from 'react';
import {
  featuresEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { handleFeatureClose } from '../../utils/utils';
import {
  openNotification,
  timeToSeconds,
} from 'views/Controls/GLOBALFUNACTION';
import HourwiseInventoryTable from './HourwiseInventoryTable';
import { Button, Card, Tooltip } from 'components/ui';
import { IoMdClose } from 'react-icons/io';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

/* CONSTANTS */
const maxDuration = 720;

function HourwiseInventory() {
  /* CONTEXTS */
  const { schedulingTableData, setActiveFeatures, secondaryAreaZindexRef } =
    useContext(SchedulerContext);

  /* STATES */
  const [hourwiseTableData, setHourwiseTableData] = useState([]);

  /* USE EFFECTS */
  useEffect(() => {
    try {
      setHourwiseTableData(getHourwiseTableData());
    } catch (error) {
      openNotification(
        'danger',
        'Something went wrong while fetching hourwise inventory',
      );
      console.error(error);
    }
  }, [schedulingTableData]);

  /* HELPER FUNCTIONS */
  const getHourwiseTableData = () => {
    try {
      let hourWiseTableData = [];
      let curHour = '';
      let curHourIndex = null;
      let curHourTotalCommDuration = 0;
      let curHourTotalPromoDuration = 0;
      let curHourTotalSongDuration = 0;
      schedulingTableData.forEach((row, index) => {
        if (curHour !== row.Tel_Time.substr(0, 2)) {
          if (curHour === '') {
            curHour = row.Tel_Time.substr(0, 2);
            curHourIndex = 0;
          } else {
            hourWiseTableData.push({
              hour: `${curHour}:00`,
              hourIndex: curHourIndex,
              availableDuration: maxDuration,
              commDuration: curHourTotalCommDuration,
              promoDuration: curHourTotalPromoDuration,
              songDuration: curHourTotalSongDuration,
            });
            curHour = row.Tel_Time.substr(0, 2);
            curHourIndex = index - 1;
            curHourTotalCommDuration = 0;
            curHourTotalPromoDuration = 0;
            curHourTotalSongDuration = 0;
          }
        } else {
          if (row.F_C_S_P === rowDataTypesEnum.COMMERCIAL) {
            curHourTotalCommDuration += timeToSeconds(row.Duration);
          } else if (row.F_C_S_P === rowDataTypesEnum.PROMO) {
            curHourTotalPromoDuration += timeToSeconds(row.Duration);
          } else if (row.F_C_S_P === rowDataTypesEnum.SONG) {
            curHourTotalSongDuration += timeToSeconds(row.Duration);
          }
        }
      });
      return hourWiseTableData;
    } catch (error) {
      throw error;
    }
  };

  return (
    <div
      className="h-full w-full flex flex-col bg-gray-800 p-3 pt-2 rounded-lg absolute top-0 left-0"
      style={{
        zIndex: secondaryAreaZindexRef.current[featuresEnum.HOURWISE_INVENTORY],
      }}
    >
      <div className="flex justify-between items-center mb-2">
        <h5>Hourwise Inventory</h5>
        <div className="flex gap-1.5">
          <Tooltip title="Close">
            <Button
              size="xs"
              icon={<IoMdClose />}
              onClick={() =>
                handleFeatureClose(
                  setActiveFeatures,
                  featuresEnum.HOURWISE_INVENTORY,
                )
              }
            />
          </Tooltip>
        </div>
      </div>
      <div className="h-[92%] flex flex-col gap-3">
        {hourwiseTableData.length > 0 ? (
          <div className="grow overflow-auto no-scrollbar">
            <HourwiseInventoryTable
              tableData={hourwiseTableData}
              maxDuration={maxDuration}
            />
          </div>
        ) : (
          <Card
            className="h-full"
            bodyClass="h-full flex justify-center items-center"
          >
            No inventory to show
          </Card>
        )}
      </div>
    </div>
  );
}

export default HourwiseInventory;
