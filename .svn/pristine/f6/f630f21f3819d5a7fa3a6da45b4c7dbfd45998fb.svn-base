import { Button, Tooltip } from 'components/ui';
import React, { useContext, useEffect, useState } from 'react';
import { RiBox3Line, RiDeleteBin6Line } from 'react-icons/ri';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';
import DeleteMultipleRowsDialog from '../DraggableTable/Cell/components/DeleteMultipleRowsDialog';
import {
  operationTypesEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import DropMultipleRowsDialog from '../DraggableTable/Cell/components/DropMultipleRowsDialog';
import SelectAllButton from './SelectAllButton';

function BottomToolbar({ rotationInfoTableData }) {
  /* CONTEXT */
  const {
    schedulingTableSelectedRows,
    setSchedulingTableSelectedRows,
    executeOperation,
  } = useContext(SchedulerContext);

  /* STATES */
  const [isAllRowsSelected, setIsAllRowsSelected] = useState(false);
  const [isDeleteMultipleRowsDialogOpen, setIsDeleteMultipleRowsDialogOpen] =
    useState(false);
  const [isDropMultipleRowsDialogOpen, setIsDropMultipleRowsDialogOpen] =
    useState(false);

  /* EVENT HANDLERS */
  const handleDelete = () => {
    try {
      if (schedulingTableSelectedRows.length === 1) {
        executeOperation({
          operation: operationTypesEnum.DELETE_ROW,
          selectedRowsToDelete: schedulingTableSelectedRows,
        });
        openNotification('success', 'Events deleted successfully');
      } else setIsDeleteMultipleRowsDialogOpen(true);
    } catch (error) {
      openNotification('danger', 'Something went wrong while deleting events');
      console.error(error);
    }
  };

  const handleDrop = () => {
    try {
      if (schedulingTableSelectedRows.length === 1) {
        executeOperation({
          operation: operationTypesEnum.DROP_ROW,
          selectedRowsToDrop: schedulingTableSelectedRows,
        });
        openNotification('success', 'Events dropped successfully');
      } else setIsDropMultipleRowsDialogOpen(true);
    } catch (error) {
      openNotification('danger', 'Something went wrong while dropping events');
      console.error(error);
    }
  };

  const handleSelectAll = () => {
    try {
      if (schedulingTableSelectedRows.length === rotationInfoTableData.length) {
        setSchedulingTableSelectedRows([]);
        setIsAllRowsSelected(false);
      } else {
        setSchedulingTableSelectedRows(rotationInfoTableData);
        setIsAllRowsSelected(true);
      }
    } catch (error) {
      openNotification(
        'danger',
        'Something went wrong while selecting all events',
      );
      console.error(error);
    }
  };

  /* USE EFFECTS */
  useEffect(() => {
    try {
      if (schedulingTableSelectedRows.length === rotationInfoTableData.length) {
        setIsAllRowsSelected(true);
      } else {
        setIsAllRowsSelected(false);
      }
    } catch (error) {
      console.error(error);
    }
  }, [rotationInfoTableData, schedulingTableSelectedRows]);

  return (
    <div className="bg-gray-700 bg-opacity-50 flex gap-0.5 p-0.5 rounded-lg border border-gray-600">
      {(rotationInfoTableData[0].F_C_S_P === rowDataTypesEnum.PROMO ||
        rotationInfoTableData[0].F_C_S_P === rowDataTypesEnum.SONG ||
        (rotationInfoTableData[0].F_C_S_P === rowDataTypesEnum.NTC &&
          !('BookingDetailID' in rotationInfoTableData[0]))) && (
        <>
          <Tooltip title="Delete">
            <Button
              className="hover:!bg-red-700 transition-all !h-8 !w-8"
              variant="plain"
              size="sm"
              icon={<RiDeleteBin6Line className="text-[1.1rem] -mt-[0.2rem]" />}
              disabled={schedulingTableSelectedRows.length === 0}
              onClick={handleDelete}
            />
          </Tooltip>
          <SelectAllButton
            isAllRowsSelected={isAllRowsSelected}
            handleSelectAll={handleSelectAll}
          />
          <DeleteMultipleRowsDialog
            isDialogOpen={isDeleteMultipleRowsDialogOpen}
            setIsDialogOpen={setIsDeleteMultipleRowsDialogOpen}
            selectedRows={schedulingTableSelectedRows}
            setSelectedRows={setSchedulingTableSelectedRows}
          />
        </>
      )}
      {rotationInfoTableData[0].F_C_S_P === rowDataTypesEnum.COMMERCIAL && (
        <>
          <Tooltip title="Drop Spot">
            <Button
              className="hover:!bg-red-700 transition-all !h-8 !w-8"
              variant="plain"
              size="sm"
              icon={<RiBox3Line className="text-[1.1rem] -mt-[0.2rem]" />}
              disabled={schedulingTableSelectedRows.length === 0}
              onClick={handleDrop}
            />
          </Tooltip>
          <SelectAllButton
            isAllRowsSelected={isAllRowsSelected}
            handleSelectAll={handleSelectAll}
          />
          <DropMultipleRowsDialog
            isDialogOpen={isDropMultipleRowsDialogOpen}
            setIsDialogOpen={setIsDropMultipleRowsDialogOpen}
            selectedRows={schedulingTableSelectedRows}
            setSelectedRows={setSchedulingTableSelectedRows}
          />
        </>
      )}
    </div>
  );
}

export default BottomToolbar;
