import {
  FormItemcompact,
  Button,
  Switcher,
  Input,
  FormContainer,
  Select,
  Upload,
  Card,
  FormItem,
  Radio,
  Checkbox,
  DatePicker,
} from 'components/ui';
import { Field, Form, Formik } from 'formik';
import * as Yup from 'yup';
import {
  AddAgencyPaymentapi,
  UpdateAgencyPayment,
  apiGetagencymasterDrop,
  apiGetclientasperagency,
  apiGetdealasperagencyclient,
} from 'services/CreditcontrolService';
import { useSelector } from 'react-redux';
import React, { forwardRef, useEffect } from 'react';
import { useState } from 'react';
import { FcImageFile } from 'react-icons/fc';
import { convertDateToYMD } from 'components/validators';
import PromoTypeDropNew from 'views/Controls/PromoTypeDropNew';
import {
  apiGetAgencyCity,
  apiGetAgencyCityIDCITY,
  apiGetagencyplace,
} from 'services/MasterService';

const validationSchema = Yup.object().shape({
  AgencyMaster: Yup.string().required('Agency Required'),
  ClientMaster: Yup.string().required('Client Required'),
  AgencyCity: Yup.string().required('AgencyCity Required'),
  DealNo: Yup.string().required('AgencyCity Required'),
  BankName: Yup.string()
    .matches(/^[A-Za-z ]+$/, 'Only alphabetic characters are allowed')
    .min(1, 'Too Short!')
    .max(20, 'Too Long!'),
  NetValue: Yup.string()
    .matches(/^[0-9]+$/, 'Only numeric characters are allowed')
    .min(1, 'Too Short!')
    .max(7, 'Too Long!')
    .required('NetValue Required'),
  rememberMe: Yup.bool(),
});
const options = [
  { value: 'foo', label: 'Foo' },
  { value: 'bar', label: 'Bar' },
];

const AgencyPaymentEdit = forwardRef((props, ref) => {
  const { setMessage, setlog } = props;
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const token = useSelector((state) => state.auth.session.token);
  const [previewSource, setPreviewSource] = useState('');
  const [Checkboxcon, setCheckboxcon] = useState(false);
  const [Checkboxcon1, setCheckboxcon1] = useState(false);
  const [Checkboxcon2, setCheckboxcon2] = useState(false);
  const [AgencyMaster, setAgencyMaster] = useState([]);
  const [ClientMaster, setClientMaster] = useState([]);
  const [AgencyCity, setAgencyCity] = useState([]);
  const [DealNo, setDealNo] = useState([]);
  const AddAgencyPayment = async (values, token) => {
    try {
      const resp = await AddAgencyPaymentapi(values, token, Channel);
      if (resp.data.msg === 'success') {
        setlog('success');
        setMessage('Data Inserted Successfully.');
        return;
      } else if (resp.data.msg === 'Server Error.') {
        setlog('error');
        setMessage('Server Error.');
        return;
      }
    } catch (errors) {
      return {};
    }
  };
  const UpdateAgencyPayment = async (values, token) => {
    try {
      const resp = await UpdateAgencyPayment(values, token);
      //console.log(resp)
      if (resp.data.msg === 'Updated') {
        setlog('success');
        setMessage('Data Updated Successfully');
        return;
      } else if (resp.data.msg === 'Data Already Exists.') {
        setlog('warning');
        setMessage(resp.data.msg);
        return;
      }
    } catch (errors) {
      return {};
    }
  };
  const onCheck = (e) => {
    setCheckboxcon(true);
  };
  const onCheck1 = (e) => {
    setCheckboxcon(true);
  };
  const onCheck2 = (e) => {
    setCheckboxcon(true);
  };
  const { Content } = useSelector((state) => state.base.common);

  const dropagencycity = async (values) => {
    try {
      const Content = await apiGetagencyplace(values);

      const formattedOptions2 = Content.data.map((option) => ({
        value: option.Place?.PlaceCode,
        label: option.Place?.PlaceName,
      }));
      setAgencyCity(formattedOptions2);
    } catch (error) {
      setAgencyCity([]);
    }
  };

  const dropclient = async (values) => {
    try {
      const Content = await apiGetclientasperagency(values);

      const formattedOptions2 = Content.data.map((option) => ({
        value: option.ClientCode,
        label: option.ClientName,
      }));
      setClientMaster(formattedOptions2);
    } catch (error) {
      setClientMaster([]);
    }
  };

  const dropdeal = async (id, values) => {
    try {
      const Content = await apiGetdealasperagencyclient(id, values);

      const formattedOptions2 = Content.data.map((option) => ({
        value: option.DealNumber,
        label: option.DealCode,
      }));
      setDealNo(formattedOptions2);
    } catch (error) {
      setDealNo([]);
    }
  };
  useEffect(() => {
    (async (values) => {
      const AgencyMaster = await apiGetagencymasterDrop(values);

      const formattedOptions = AgencyMaster.data.map((option) => ({
        value: option.AgencyCode,
        label: option.AgencyName,
      }));
      setAgencyMaster(formattedOptions);
    })();
  }, []);
  console.log(Channel);
  return (
    <div>
      <Formik
        innerRef={ref}
        initialValues={{
          PayId: '', //
          LocationCode: Channel.LocationCode, //
          ChannelCode: Channel.ChannelCode, //
          AgencyMaster: Content.AgencyCode || '',
          AgencyCity: Content.PlaceCode || '',
          ClientMaster: Content.ClientCode || '',
          DealNo: Content.DealNumber || '', //
          PaymentType: Content.PaymentModeCode || '',
          DDChqNo: Content.DDChqNo || '',
          DDChqDate: Content.ChqueDate || '', //
          BankName: Content.BankName || '',
          GrossAmount: Content.GrossAmount || '',
          GSTTAX: 18, //
          TaxPer: 0 || '', //
          TaxAmt: Content.TaxAmt || '',
          NetValue: Content.NetAmount || '',
          ReceivedDDChequeAmount: Content.RecdAmt || '',
          TDS: Content.TDSYN || '', //
          TDSval: Content.TDSAmt || '', //
          Remark: Content.Remarks || '',
          IsActive: 1, //
        }}
        validationSchema={validationSchema}
        onSubmit={(values, { resetForm, setSubmitting }) => {
          setTimeout(() => {
            console.log(values);
            if (!Content.PayId) {
              alert('hello');
              new Promise((resolve, reject) => {
                AddAgencyPayment(values, token)
                  .then((response) => {
                    resolve(response);
                  })
                  .catch((errors) => {
                    reject(errors);
                  });
              });
            } else {
              new Promise((resolve, reject) => {
                setSubmitting(false);
                UpdateAgencyPayment(values, token)
                  .then((response) => {
                    resolve(response);
                  })
                  .catch((errors) => {
                    reject(errors);
                  });
              });
            }

            resetForm();
          }, 400);
        }}
      >
        {({ values, touched, errors }) => (
          <Form>
            <Card header="Agency Payment Master">
              <div className="grid grid-cols-2 gap-4">
                <Card>
                  <div className="inline-flex flex-wrap xl:flex gap-2">
                    <FormContainer>
                      <div className="grid grid-cols-2 md:grid-cols-2 gap-4">
                        <FormItem
                          asterisk
                          label="Agency"
                          invalid={errors.AgencyMaster && touched.AgencyMaster}
                          errorMessage={errors.AgencyMaster}
                        >
                          <Field name="AgencyMaster">
                            {({ field, form }) => (
                              <Select
                                field={field}
                                form={form}
                                options={AgencyMaster}
                                value={AgencyMaster?.filter(
                                  (option) =>
                                    option.value === values.AgencyMaster,
                                )}
                                onChange={(option) => {
                                  form.setFieldValue(field.name, option?.value);
                                  dropagencycity(option?.value);
                                  dropclient(option?.value);
                                }}
                              />
                            )}
                          </Field>
                        </FormItem>

                        <FormItem
                          asterisk
                          label="AgencyCity"
                          invalid={errors.AgencyCity && touched.AgencyCity}
                          errorMessage={errors.AgencyCity}
                        >
                          <Field name="AgencyCity">
                            {({ field, form }) => (
                              <Select
                                field={field}
                                form={form}
                                options={AgencyCity}
                                value={AgencyCity?.filter(
                                  (option) =>
                                    option.value === values.AgencyCity,
                                )}
                                onChange={(option) =>
                                  form.setFieldValue(field.name, option?.value)
                                }
                              />
                            )}
                          </Field>
                        </FormItem>

                        <FormItem
                          asterisk
                          label="Client"
                          invalid={errors.ClientMaster && touched.ClientMaster}
                          errorMessage={errors.ClientMaster}
                        >
                          <Field name="ClientMaster">
                            {({ field, form }) => (
                              <Select
                                field={field}
                                form={form}
                                options={ClientMaster}
                                value={ClientMaster?.filter(
                                  (option) =>
                                    option.value === values.ClientMaster,
                                )}
                                onChange={(option) => {
                                  form.setFieldValue(field.name, option?.value);
                                  dropdeal(values.AgencyMaster, option?.value);
                                }}
                              />
                            )}
                          </Field>
                        </FormItem>

                        <FormItem
                          asterisk
                          label="Deal No."
                          invalid={errors.DealNo && touched.DealNo}
                          errorMessage={errors.DealNo}
                        >
                          <Field name="DealNo">
                            {({ field, form }) => (
                              <Select
                                field={field}
                                form={form}
                                options={DealNo}
                                value={DealNo?.filter(
                                  (option) => option.value === values.DealNo,
                                )}
                                onChange={(option) =>
                                  form.setFieldValue(field.name, option?.value)
                                }
                              />
                            )}
                          </Field>
                        </FormItem>
                        <FormItemcompact label="Bank Name">
                          <Field
                            size="sm"
                            type="text"
                            autoComplete="off"
                            name="BankName"
                            placeholder="Bank Name"
                            component={Input}
                          />
                        </FormItemcompact>
                        <FormItemcompact label="Gross Amount">
                          <Field
                            size="sm"
                            type="text"
                            autoComplete="off"
                            name="NetValue"
                            disabled
                            placeholder="Gross Amount"
                            component={Input}
                          />
                        </FormItemcompact>
                        <FormItemcompact asterisk label="Net Value">
                          {/* <Field
                            size="sm"
                            type="text"

                            autoComplete="off"
                            name="NetValue"
                            placeholder="Net Value"
                            component={Input}
                          /> */}
                          <Field name="NetValue">
                            {({ field, form }) => (
                              <Input
                                field={field}
                                form={form}
                                value={values.NetValue}
                                onChange={(option) => {
                                  {
                                    form.setFieldValue(
                                      field.name,
                                      option.target.value,
                                    );
                                    form.setFieldValue(
                                      'PayableAmount',
                                      (Number(option.target.value) * 18) / 100 +
                                        Number(option.target.value),
                                    );

                                    form.setFieldValue(
                                      'ReceivedDDChequeAmount',
                                      (Number(option.target.value) * 18) / 100 +
                                        Number(option.target.value),
                                    );
                                    form.setFieldValue(
                                      'TaxAmt',
                                      (Number(option.target.value) * 18) / 100,
                                    );
                                    form.setFieldValue(
                                      'PayableAmount',
                                      (Number(option.target.value) * 18) / 100 +
                                        Number(option.target.value),
                                    );
                                    console.log(option.target.value);
                                  }
                                }}
                              />
                            )}
                          </Field>
                        </FormItemcompact>
                        <div className="flex">
                          <FormItemcompact label="TDS">
                            <Field name="TDS" className="mt-2">
                              {({ field, form }) => (
                                <Radio.Group
                                  value={values.radio}
                                  onChange={(val) =>
                                    form.setFieldValue(field.name, val)
                                  }
                                >
                                  <Radio value={1}>Yes</Radio>
                                  <Radio value={0}>No</Radio>
                                </Radio.Group>
                              )}
                            </Field>
                          </FormItemcompact>
                          {values.TDS == 1 && (
                            <FormItemcompact label="TDS %">
                              {/* <Field
                              size="sm"
                              type="text"
                              maxlength="2"
                              autoComplete="off"
                              name="TDSval"
                              placeholder="TDS"
                              component={Input}
                            /> */}
                              <Field name="TDSval">
                                {({ field, form }) => (
                                  <Input
                                    field={field}
                                    form={form}
                                    value={values.TDSval}
                                    onChange={(option) => {
                                      {
                                        form.setFieldValue(
                                          field.name,
                                          option.target.value,
                                        );
                                        form.setFieldValue(
                                          'PayableAmount',
                                          (Number(values.PayableAmount) *
                                            option.target.value) /
                                            100 -
                                            Number(values.PayableAmount) +
                                            10,
                                        );

                                        console.log(option.target.value);
                                      }
                                    }}
                                  />
                                )}
                              </Field>
                            </FormItemcompact>
                          )}
                        </div>

                        <FormItemcompact label="Payable Amount">
                          <Field name="PayableAmount">
                            {({ field, form }) => (
                              <Input
                                field={field}
                                form={form}
                                disabled
                                value={values.PayableAmount}
                                onChange={(option) => {
                                  {
                                    form.setFieldValue(
                                      field.name,
                                      option.target.value,
                                    );

                                    console.log(option.target.value);
                                  }
                                }}
                              />
                            )}
                          </Field>
                        </FormItemcompact>
                        <div className="col-span-1"></div>
                        <Card
                          header={
                            <div className="text-white">Payment Type</div>
                          }
                          headerClass="bg-sky-600"
                        >
                          {/* <FormItemcompact>
                            <Field name="PaymentType">
                              {({ field, form }) => (
                                <Radio.Group
                                  value={values.radio}
                                  onChange={(val) =>
                                    form.setFieldValue(
                                      field.name,
                                      val
                                    )
                                  }
                                >
                                  <Radio value={1}>DD</Radio>
                                  <Radio value={2}>Cheque</Radio>
                                  <Radio value={3}>RTGS</Radio>
                                </Radio.Group>
                              )}
                            </Field>
                          </FormItemcompact> */}
                          <FormItemcompact>
                            <Field name="PaymentType">
                              {({ field, form }) => (
                                <Radio.Group
                                  value={values.PaymentType}
                                  onChange={(e) => {
                                    const val = e;
                                    console.log(val);
                                    const paymentValue = val === 3;
                                    if (e == 'R') {
                                      form.setFieldValue('DDChqNo', '');
                                      form.setFieldValue('DDChqDate', '');
                                    }
                                    form.setFieldValue('PaymentType', val);
                                  }}
                                >
                                  <Radio
                                    defaultChecked
                                    name="simpleRadioExample"
                                    value={'2'}
                                  >
                                    DD
                                  </Radio>
                                  <Radio value={'1'}>Cheque</Radio>
                                  <Radio value={'3'}>RTGS</Radio>
                                </Radio.Group>
                              )}
                            </Field>
                          </FormItemcompact>

                          <FormItemcompact className="mt-2" label="DD/Chq No.">
                            <Field name="DDChqNo">
                              {({ field, form }) => (
                                <Input
                                  {...field}
                                  size="sm"
                                  type="text"
                                  maxLength="10"
                                  autoComplete="off"
                                  placeholder="DD/Chq No."
                                  disabled={values.PaymentType === '3'}
                                />
                              )}
                            </Field>
                          </FormItemcompact>

                          <FormItemcompact label="DD/Chq Date" className="mt-2">
                            {/* <Field name="DDChqDate">
                              {({ form }) => (
                                <DatePicker
                                  placeholder="Pick a date"
                                  disabled={form.values.PaymentType === 'R'}
                                />
                              )}
                            </Field> */}

                            <Field name="DDChqDate">
                              {({ field, form }) => (
                                <DatePicker
                                  field={field}
                                  form={form}
                                  value={values.DDChqDate}
                                  disabled={values.PaymentType === '3'}
                                  onChange={(option) => {
                                    {
                                      console.log(option);
                                      form.setFieldValue(field.name, option);
                                    }
                                  }}
                                />
                              )}
                            </Field>
                          </FormItemcompact>
                        </Card>

                        <Card
                          header={
                            <div className="text-white">Payment Terms</div>
                          }
                          headerClass="bg-green-500"
                        >
                          <div className="flex">
                            <FormItemcompact label="GST TAX">
                              <Field
                                size="sm"
                                type="text"
                                maxlength="2"
                                autoComplete="off"
                                name="GSTTAX"
                                placeholder="18 %"
                                disabled
                                component={Input}
                              />
                            </FormItemcompact>
                          </div>
                          <FormItemcompact
                            className="mt-2"
                            label="Received DD/Cheque Amount"
                          >
                            <Field name="ReceivedDDChequeAmount">
                              {({ field, form }) => (
                                <Input
                                  field={field}
                                  form={form}
                                  value={values.ReceivedDDChequeAmount}
                                  onChange={(option) => {
                                    {
                                      form.setFieldValue(
                                        field.name,
                                        option.target.value,
                                      );

                                      console.log(option.target.value);
                                    }
                                  }}
                                />
                              )}
                            </Field>
                          </FormItemcompact>
                        </Card>

                        <FormItemcompact label="Remark">
                          <Field
                            size="sm"
                            type="textArea"
                            maxlength="100"
                            autoComplete="off"
                            name="Remark"
                            placeholder="Remark"
                            component={Input}
                            textArea
                          />
                        </FormItemcompact>
                      </div>

                      <FormItem>
                        <div className="flex gap-2 justify-end">
                          <Button
                            type="reset"
                            // onClick={() => resetForm()}
                          >
                            Reset
                          </Button>
                          <Button
                            variant="solid"
                            type="submit"
                            // loading={isSubmitting}
                          >
                            Submit
                          </Button>
                        </div>
                      </FormItem>
                    </FormContainer>
                  </div>
                </Card>
                <Card></Card>
              </div>
            </Card>
          </Form>
        )}
      </Formik>
    </div>
  );
});

export default AgencyPaymentEdit;
