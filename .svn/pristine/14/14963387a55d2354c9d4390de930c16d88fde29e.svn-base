import React, { lazy, Suspense, useContext, useEffect, useState } from 'react';
import './styles.css';
import SummaryItem from './SummaryItem';
import { pagesEnum, rowDataTypesEnum } from 'views/Scheduling/Scheduler/enum';
import {
  getContentIndexes,
  getSelectedRowSummary,
  getSlotDuration,
  getTotalContentDuration,
  getTotalDurationInContentForRowType,
} from './utils';
import { handleSaveSchedule } from '../Toolbar/utils/utils';
import { useDispatch, useSelector } from 'react-redux';
import { Tooltip } from 'components/ui';
import Legend from 'views/Controls/Legend';
import { convertDateToYMD } from 'components/validators';
import { apiGetSongschedulDetails } from 'services/SchedulingService';
import {
  FORMATDATE_FOR_EVERY,
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import { CLIENT } from 'views/Controls/clientListEnum';
import { FiHelpCircle } from 'react-icons/fi';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
import CheckSongUsedBefore from './CheckSongUsedBefore';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

/* CODE SPLITTING */
const AutoExecuteFunctionCounter = lazy(() =>
  import(
    'views/Controls/AutoExecuteFunctionCounter/AutoExecuteFunctionCounter'
  ),
);

function BottomSummary() {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);
  const token = useSelector((state) => state.auth.session.token);
  const unsavedWork = useSelector((state) => state.auth.scheduling.unsavedWork);
  const dispatch = useDispatch();

  /* CONTEXT */
  const {
    page,
    schedulingTableData,
    schedulingTableSelectedRows,
    leftClickedSchTableRow,
    setShowLoader,
    date,
    resetAllSelectedRows,
    isScheduleAllowedToEdit,
  } = useContext(SchedulerContext);
  /* STATES */
  const [contentIndexes, setContentIndexes] = useState({
    startIndex: null,
    endIndex: null,
  });
  const [isSongSelected, setIsSongSelected] = useState(false);
  const [isSongAlreadyScheduledDetails, setIsSongAlreadyScheduledDetails] = useState([]);
  const [eventTypeLegends, setEventTypeLegends] = useState({
    Program: null,
    Segment: null,
    Promo: null,
    Commercial: null,
    Song: null,
    NTC: null,
  });

  /* USE EFFECTS */
  useEffect(() => {
    try {
      setEventTypeLegends(getEventTypeLegends());
    } catch (error) {
      openNotification('danger', 'Something went wrong while fetching legends');
      console.error(error);
    }
  }, [schedulingTableData]);

  useEffect(() => {
    if (!leftClickedSchTableRow?.SongCode) return;
    SongschedulDetailsApi(
      Number(leftClickedSchTableRow.SongCode),
      convertDateToYMD(date),
      1,
    );
  }, [leftClickedSchTableRow]);

  useEffect(() => {
    if (isSongSelected) {
      ScrollOnId(date);
    }
  }, [isSongSelected]);

  useEffect(() => {
    try {
      const contentIndexes = getContentIndexes(
        schedulingTableData,
        leftClickedSchTableRow,
      );
      if (
        contentIndexes.startIndex === 1 &&
        contentIndexes.endIndex === schedulingTableData.length - 1 &&
        schedulingTableData.filter(
          (row) => row.F_C_S_P === rowDataTypesEnum.CONTENT_TERMINATION,
        ).length > 1
      ) {
        // Note: This if logic is written to fix bug where contentIndexes are not getting updated properly on multi delete/multi drop operation
        resetAllSelectedRows();
        setContentIndexes({ startIndex: null, endIndex: null });
      } else setContentIndexes(contentIndexes);
    } catch (error) {
      console.error(error);
    }
  }, [schedulingTableData, leftClickedSchTableRow]);

  /* CONSTANTS */
  const totalContentDuration = getTotalContentDuration(
    contentIndexes,
    schedulingTableData,
    leftClickedSchTableRow,
  );
  const slotDuration = getSlotDuration(
    contentIndexes,
    schedulingTableData,
    leftClickedSchTableRow,
  );
  const isChannelForbes = channel.label === CLIENT.USA_Forbes;

  // API CALL FUNTIONS //

  const SongschedulDetailsApi = async (SongCode, TelecastDate, InHour) => {
    const SongschedulDetailsList = await apiGetSongschedulDetails(
      SongCode,
      TelecastDate,
      InHour,
    );
    const filteredData = filterDataByDate(SongschedulDetailsList.data);
    setIsSongSelected(true);
    setIsSongAlreadyScheduledDetails(filteredData);
  };

  // HELPER FUNTIONS //
  const filterDataByDate = (data) => {
    return data.map((dayData) => {
      const date = Object.keys(dayData)[0]; // Get the date
      const labelIndex = date;
      const label = FORMATDATE_FOR_EVERY(new Date(date)); // Use special labels or fallback to the date itself

      return { date, hoursData: dayData[date], label, labelIndex }; // Add label for rendering
    });
  };

  const ScrollOnId = (value) => {
    const SongschedulDetailsDiv = document.getElementById('SongschedulDetails');
    let targetElement = SongschedulDetailsDiv.querySelector(
      `.SongschedulDetails-${convertDateToYMD(value)}`,
    );
    if (targetElement == null) return;
    targetElement.scrollIntoView({
      behavior: 'smooth',
      block: 'center',
    });
  };

  const getEventTypeLegends = () => {
    try {
      let legends = {
        ...eventTypeLegends,
        'Back To Back': 'rgb(234 88 12)',
      };
      for (let index = 0; index < schedulingTableData.length; index++) {
        const row = schedulingTableData[index];
        if (
          row.F_C_S_P === rowDataTypesEnum.CONTENT_TERMINATION &&
          !legends.Program
        ) {
          legends.Program = row.EventDefaultBackColor;
        } else if (
          row.F_C_S_P === rowDataTypesEnum.SEGMENT &&
          !legends.Segment
        ) {
          legends.Segment = row.EventDefaultBackColor;
        } else if (row.F_C_S_P === rowDataTypesEnum.PROMO && !legends.Promo) {
          legends.Promo = row.EventDefaultBackColor;
        } else if (
          row.F_C_S_P === rowDataTypesEnum.COMMERCIAL &&
          !legends.Commercial
        ) {
          legends.Commercial = row.EventDefaultBackColor;
        } else if (row.F_C_S_P === rowDataTypesEnum.SONG && !legends.Song) {
          legends.Song = row.EventDefaultBackColor;
        } else if (row.F_C_S_P === rowDataTypesEnum.NTC && !legends.NTC) {
          legends.NTC = row.EventDefaultBackColor;
        }
        let isAllLegendColorsFound = true;
        Object.keys(legends).forEach((key) => {
          if (legends[key] === null) {
            isAllLegendColorsFound = false;
            return;
          }
        });
        if (isAllLegendColorsFound) break;
      }
      if (page === pagesEnum.FINAL_LOG || page === pagesEnum.COMMERCIAL) {
        legends['Multi Spot'] = 'rgb(244 114 182)';
        legends['Out Of Timeband'] = 'rgb(185 28 28)';
      }
      if (isChannelForbes) {
        legends.Content = legends.Program;
        delete legends.Program;
      }
      return legends;
    } catch (error) {
      throw error;
    }
  };

  return (
    <Suspense>
      <div className="h-full flex flex-col">
        <CheckSongUsedBefore details={isSongAlreadyScheduledDetails} isSongSelected={isSongSelected} />
        <div className="bg-gray-700 bg-opacity-50 flex justify-between items-center py-1.5 px-3 rounded-lg border border-gray-600">
          <div className="flex items-center">
            {schedulingTableData[contentIndexes.startIndex] &&
              schedulingTableData[contentIndexes.startIndex].F_C_S_P ===
              rowDataTypesEnum.CONTENT_TERMINATION && (
                <Tooltip
                  title={
                    schedulingTableData[contentIndexes.startIndex].Event_Name
                  }
                >
                  <SummaryItem
                    label={'Program'}
                    value={
                      schedulingTableData[contentIndexes.startIndex].Event_Name
                        .length > 15
                        ? `${schedulingTableData[
                          contentIndexes.startIndex
                        ].Event_Name.substr(0, 15)}...`
                        : schedulingTableData[contentIndexes.startIndex]
                          .Event_Name
                    }
                  />
                </Tooltip>
              )}
            {page === pagesEnum.PROMO && (
              <>
                <SummaryItem
                  label={'Selected Promos'}
                  value={getSelectedRowSummary(schedulingTableSelectedRows)}
                />
                <SummaryItem
                  label={'Commercials'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.COMMERCIAL,
                  )}
                />
                <SummaryItem
                  label={'Promos'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.PROMO,
                  )}
                />
              </>
            )}
            {page === pagesEnum.SONG && (
              <>
                <SummaryItem
                  label={'Selected Songs'}
                  value={getSelectedRowSummary(schedulingTableSelectedRows)}
                />
                <SummaryItem
                  label={'Promos'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.PROMO,
                  )}
                />
                <SummaryItem
                  label={'Commercials'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.COMMERCIAL,
                  )}
                />
                <SummaryItem
                  label={'Songs'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.SONG,
                  )}
                />
              </>
            )}
            {page === pagesEnum.COMMERCIAL && (
              <>
                <SummaryItem
                  label={'Selected Commercials'}
                  value={getSelectedRowSummary(schedulingTableSelectedRows)}
                />
                <SummaryItem
                  label={'Commercials'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.COMMERCIAL,
                  )}
                />
              </>
            )}
            {page === pagesEnum.NTC && (
              <>
                <SummaryItem
                  label={'Selected NTCs'}
                  value={getSelectedRowSummary(schedulingTableSelectedRows)}
                />
                <SummaryItem
                  label={'NTCs'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.NTC,
                  )}
                />
              </>
            )}
            {page === pagesEnum.FINAL_LOG && (
              <>
                <SummaryItem
                  label={'Selected Events'}
                  value={getSelectedRowSummary(schedulingTableSelectedRows)}
                />
                <SummaryItem
                  label={'Commercials'}
                  value={getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.COMMERCIAL,
                  )}
                />
                {(() => {
                  const totalDuration = getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.PROMO,
                  );
                  return (
                    totalDuration !== '00:00:00:00' && (
                      <SummaryItem label={'Promos'} value={totalDuration} />
                    )
                  );
                })()}
                {(() => {
                  const totalDuration = getTotalDurationInContentForRowType(
                    contentIndexes,
                    schedulingTableData,
                    leftClickedSchTableRow,
                    rowDataTypesEnum.SONG,
                  );
                  return (
                    totalDuration !== '00:00:00:00' && (
                      <SummaryItem label={'Songs'} value={totalDuration} />
                    )
                  );
                })()}
              </>
            )}
            <SummaryItem
              label={'Segments'}
              value={getTotalDurationInContentForRowType(
                contentIndexes,
                schedulingTableData,
                leftClickedSchTableRow,
                rowDataTypesEnum.SEGMENT,
              )}
            />
            <SummaryItem label={'Slot Duration'} value={slotDuration} />
            <SummaryItem
              label={'Total'}
              value={totalContentDuration}
              color={totalContentDuration > slotDuration ? 'red' : 'teal'}
            />
          </div>
          <div className="flex items-center gap-3">
            <Legend
              legends={eventTypeLegends}
              renderTitle={
                <div
                  className={`flex flex-col items-center gap-1 text-gray-300 opacity-90
                            ${isScheduleAllowedToEdit &&
                    'pr-3 border-r border-r-gray-700'
                    }
                            `}
                >
                  <FiHelpCircle className="text-lg" />
                  <div>Legends</div>
                </div>
              }
            />
            {isScheduleAllowedToEdit && (
              <AutoExecuteFunctionCounter
                width={53}
                strokeWidth={6}
                color="teal-400"
                maxDurationInSec={900}
                dependencies={[schedulingTableData]}
                executeFunction={() =>
                  handleSaveSchedule({
                    setShowLoader,
                    page,
                    schedulingTableData,
                    channel,
                    date,
                    token,
                    unsavedWork,
                    dispatch,
                    isAutoSave: true,
                  })
                }
              />
            )}
          </div>
        </div>
      </div>
    </Suspense>
  );
}

export default BottomSummary;
