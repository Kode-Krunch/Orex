import { Button, Dialog, Tabs, Tooltip } from 'components/ui';
import React, { memo, useEffect, useMemo, useState } from 'react';
import {
  defaultContentsFormState,
  defaultMoviesFormState,
  defaultSongsFormState,
} from '../../constants';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import {
  getBulkEditDialogSaveBtnStatus,
  getEventTypewiseContents,
  convertLicensedContDataToFormState,
  convertFormStateToLicensedContData,
  getSeasonWithEpOptions,
} from './utils';
import { bulkEditDialogFieldsEnum, eventTypesEnum } from '../../enum';
import TabList from 'components/ui/Tabs/TabList';
import TabNav from 'components/ui/Tabs/TabNav';
import TabContent from 'components/ui/Tabs/TabContent';
import MoviesTab from './components/MoviesTab/MoviesTab';
import ShowsTab from './components/ShowsTab/ShowsTab';
import SongsTab from './components/SongsTab/SongsTab';

function BulkEditDialog({
  isOpen,
  setIsOpen,
  newContents,
  setNewContents,
  newContentsColumns,
  newContSelRowIds,
  licensedContents,
  setLicensedContents,
  licensedContSelRowIds,
  clearSelections,
  operationMode,
  countryOptions,
  amortisationTypeOptions,
  selectedCurrency,
}) {
  /* CONSTANTS */
  const CUR_CONTENTS = operationMode === 'add' ? newContents : licensedContents;
  const SELECTED_ROW_IDS =
    operationMode === 'add' ? newContSelRowIds : licensedContSelRowIds;
  const COLUMNS = newContentsColumns;
  const EVENT_TYPEWISE_CONTENTS = getEventTypewiseContents(
    SELECTED_ROW_IDS,
    CUR_CONTENTS,
  );
  const SHOW_MOVIES_TAB = EVENT_TYPEWISE_CONTENTS?.Movie?.length > 0;
  const SHOW_CONTENTS_TAB = EVENT_TYPEWISE_CONTENTS?.Content?.length > 0;
  const SHOW_SONGS_TAB = EVENT_TYPEWISE_CONTENTS?.Song?.length > 0;

  /* STATES */
  const [moviesFormState, setMoviesFormState] = useState(
    operationMode === 'add' || !EVENT_TYPEWISE_CONTENTS[eventTypesEnum.MOVIE]
      ? defaultMoviesFormState
      : convertLicensedContDataToFormState(
          EVENT_TYPEWISE_CONTENTS[eventTypesEnum.MOVIE][0],
        ),
  );
  const [contentsFormState, setContentsFormState] = useState(
    operationMode === 'add' || !EVENT_TYPEWISE_CONTENTS[eventTypesEnum.CONTENT]
      ? defaultContentsFormState
      : convertLicensedContDataToFormState(
          EVENT_TYPEWISE_CONTENTS[eventTypesEnum.CONTENT][0],
        ),
  );
  const [songsFormState, setSongsFormState] = useState(
    operationMode === 'add' || !EVENT_TYPEWISE_CONTENTS[eventTypesEnum.SONG]
      ? defaultSongsFormState
      : convertLicensedContDataToFormState(
          EVENT_TYPEWISE_CONTENTS[eventTypesEnum.SONG][0],
        ),
  );
  const [activeTab, setActiveTab] = useState(
    SHOW_MOVIES_TAB
      ? eventTypesEnum.MOVIE
      : SHOW_CONTENTS_TAB
      ? eventTypesEnum.CONTENT
      : eventTypesEnum.SONG,
  );
  const [seasonOptions, setSeasonOptions] = useState([]);
  const [episodeOptions, setEpisodeOptions] = useState([]);

  /* HOOKS - MEMOS */
  const applyBtnStatus = useMemo(
    () =>
      getBulkEditDialogSaveBtnStatus(
        EVENT_TYPEWISE_CONTENTS,
        moviesFormState,
        contentsFormState,
        songsFormState,
      ),
    [
      contentsFormState,
      moviesFormState,
      songsFormState,
      EVENT_TYPEWISE_CONTENTS,
    ],
  );

  useEffect(() => {
    /* SET SEASON OPTIONS ON SHOWS TAB CLICK */
    (async () => {
      try {
        if (activeTab !== eventTypesEnum.CONTENT || seasonOptions.length > 0)
          return;
        setSeasonOptions(
          await getSeasonWithEpOptions(
            EVENT_TYPEWISE_CONTENTS.Content[0].ContentCode,
          ),
        );
      } catch (error) {
        console.log(error);
        openNotification();
      }
    })();
  }, [activeTab, seasonOptions, EVENT_TYPEWISE_CONTENTS]);

  useEffect(
    /* SET EPISODE OPTIONS ON SEASON SELECTION */
    () => {
      if (
        isOpen &&
        contentsFormState[bulkEditDialogFieldsEnum.SEASONS] &&
        seasonOptions.length > 0
      ) {
        setEpisodeOptions(
          seasonOptions.filter(
            (option) =>
              option.value ===
              contentsFormState[bulkEditDialogFieldsEnum.SEASONS].value,
          )[0]?.episodeOptions,
        );
      }
    },
    [
      isOpen,
      contentsFormState[bulkEditDialogFieldsEnum.SEASONS],
      seasonOptions,
    ],
  );

  /* EVENT HANDLERS */
  const onDialogClose = () => setIsOpen(false);

  const handleApply = () => {
    let selectedMovies = EVENT_TYPEWISE_CONTENTS?.Movie
        ? EVENT_TYPEWISE_CONTENTS.Movie
        : [],
      selectedShows = EVENT_TYPEWISE_CONTENTS?.Content
        ? EVENT_TYPEWISE_CONTENTS.Content
        : [],
      selectedSongs = EVENT_TYPEWISE_CONTENTS?.Song
        ? EVENT_TYPEWISE_CONTENTS.Song
        : [],
      updatedNewContents = [...newContents],
      newLicensedContents = [...licensedContents];
    // Selected contents status
    const isMoviesSelected = selectedMovies.length > 0;
    const isShowsSelected = selectedShows.length > 0;
    const isSongsSelected = selectedSongs.length > 0;
    // Convert form values to licensed content data
    let newMoviesData = isMoviesSelected
      ? convertFormStateToLicensedContData(moviesFormState)
      : [];
    let newShowsData = isShowsSelected
      ? convertFormStateToLicensedContData(contentsFormState)
      : [];
    let newSongsData = isSongsSelected
      ? convertFormStateToLicensedContData(songsFormState)
      : [];
    if (operationMode === 'add') {
      // Apply form values to selected new contents
      if (isMoviesSelected)
        newMoviesData = selectedMovies.map((movie) => ({
          ...movie,
          ...newMoviesData,
        }));
      if (isShowsSelected)
        newShowsData = selectedShows.map((content) => ({
          ...content,
          ...newShowsData,
        }));
      if (isSongsSelected)
        newSongsData = selectedSongs.map((song) => ({
          ...song,
          ...newSongsData,
        }));
      // Add contents to licensed contents data
      newLicensedContents.push(
        ...newMoviesData,
        ...newShowsData,
        ...newSongsData,
      );
      // Remove selected contents from new contents table
      const selectedContentCodes = Object.keys(SELECTED_ROW_IDS).map(
        (selRowIndex) => updatedNewContents[selRowIndex].ContentCode,
      );
      updatedNewContents = updatedNewContents.filter(
        (content) => !selectedContentCodes.includes(content.ContentCode),
      );
      setNewContents(updatedNewContents);
    } else {
      // Apply form values to selected licensed contents
      Object.keys(SELECTED_ROW_IDS).forEach((index) => {
        if (newLicensedContents[index].EventType === eventTypesEnum.MOVIE) {
          newLicensedContents[index] = {
            ...newLicensedContents[index],
            ...newMoviesData,
          };
        } else if (
          newLicensedContents[index].EventType === eventTypesEnum.CONTENT
        ) {
          newLicensedContents[index] = {
            ...newLicensedContents[index],
            ...newShowsData,
          };
        } else if (
          newLicensedContents[index].EventType === eventTypesEnum.SONG
        ) {
          newLicensedContents[index] = {
            ...newLicensedContents[index],
            ...newSongsData,
          };
        }
      });
    }
    // Update licensed contents
    setLicensedContents(newLicensedContents);
    clearSelections();
    onDialogClose();
    openNotification('success', 'Changes applied successfully');
  };

  return (
    <Dialog
      isOpen={isOpen}
      width={'85vw'}
      height={'90vh'}
      onClose={onDialogClose}
      onRequestClose={onDialogClose}
      className="-mt-8 max-w-[85vw]"
      contentClassName="pt-3"
      bodyOpenClassName="overflow-hidden"
    >
      <div className="flex flex-col h-full justify-between">
        <div className="grow -ml-2">
          <Tabs
            value={activeTab}
            onChange={setActiveTab}
            className="h-full flex flex-col gap-3"
            variant="pill"
          >
            <TabList className="border-b !border-b-gray-600 pb-1">
              {SHOW_MOVIES_TAB && (
                <TabNav
                  value={eventTypesEnum.MOVIE}
                  className={`${
                    activeTab === eventTypesEnum.MOVIE &&
                    '!text-white !bg-teal-700'
                  }`}
                >
                  Movies ({EVENT_TYPEWISE_CONTENTS.Movie.length})
                </TabNav>
              )}
              {SHOW_CONTENTS_TAB && (
                <TabNav
                  value={eventTypesEnum.CONTENT}
                  className={`${
                    activeTab === eventTypesEnum.CONTENT &&
                    '!text-white !bg-teal-700'
                  }`}
                >
                  Contents ({EVENT_TYPEWISE_CONTENTS.Content.length})
                </TabNav>
              )}
              {SHOW_SONGS_TAB && (
                <TabNav
                  value={eventTypesEnum.SONG}
                  className={`${
                    activeTab === eventTypesEnum.SONG &&
                    '!text-white !bg-teal-700'
                  }`}
                >
                  Songs ({EVENT_TYPEWISE_CONTENTS.Song.length})
                </TabNav>
              )}
            </TabList>
            <div className="grow h-0">
              {activeTab === eventTypesEnum.MOVIE && SHOW_MOVIES_TAB && (
                <TabContent
                  value={eventTypesEnum.MOVIE}
                  className="grid grid-cols-3 gap-3 h-full"
                >
                  <MoviesTab
                    countryOptions={countryOptions}
                    amortisationTypeOptions={amortisationTypeOptions}
                    formState={moviesFormState}
                    setFormState={setMoviesFormState}
                    tableData={
                      EVENT_TYPEWISE_CONTENTS?.Movie
                        ? EVENT_TYPEWISE_CONTENTS.Movie
                        : []
                    }
                    columns={COLUMNS}
                    eventType={eventTypesEnum.MOVIE}
                    selectedCurrency={selectedCurrency}
                  />
                </TabContent>
              )}
              {activeTab === eventTypesEnum.CONTENT && SHOW_CONTENTS_TAB && (
                <TabContent
                  value={eventTypesEnum.CONTENT}
                  className="grid grid-cols-12 gap-3 h-full"
                >
                  <ShowsTab
                    countryOptions={countryOptions}
                    amortisationTypeOptions={amortisationTypeOptions}
                    tableData={
                      EVENT_TYPEWISE_CONTENTS?.Content
                        ? EVENT_TYPEWISE_CONTENTS.Content
                        : []
                    }
                    columns={COLUMNS}
                    formState={contentsFormState}
                    setFormState={setContentsFormState}
                    eventType={eventTypesEnum.CONTENT}
                    seasonOptions={seasonOptions}
                    episodeOptions={episodeOptions}
                    selectedCurrency={selectedCurrency}
                  />
                </TabContent>
              )}
              {activeTab === eventTypesEnum.SONG && SHOW_SONGS_TAB && (
                <TabContent
                  value={eventTypesEnum.SONG}
                  className="grid grid-cols-2 gap-3 h-full"
                >
                  <SongsTab
                    countryOptions={countryOptions}
                    amortisationTypeOptions={amortisationTypeOptions}
                    tableData={
                      EVENT_TYPEWISE_CONTENTS?.Song
                        ? EVENT_TYPEWISE_CONTENTS.Song
                        : []
                    }
                    columns={COLUMNS}
                    formState={songsFormState}
                    setFormState={setSongsFormState}
                    eventType={eventTypesEnum.SONG}
                    selectedCurrency={selectedCurrency}
                  />
                </TabContent>
              )}
            </div>
          </Tabs>
        </div>
        <div className="text-right mt-3">
          {applyBtnStatus !== true ? (
            <Tooltip title={applyBtnStatus}>
              <Button variant="solid" disabled={true}>
                Apply
              </Button>
            </Tooltip>
          ) : (
            <Button variant="solid" onClick={handleApply}>
              Apply
            </Button>
          )}
        </div>
      </div>
    </Dialog>
  );
}

export default memo(BulkEditDialog);
