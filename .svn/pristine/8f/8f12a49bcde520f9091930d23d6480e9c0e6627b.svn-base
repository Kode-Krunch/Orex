import React, { useEffect, useState } from 'react';
import { Card } from 'components/ui';
import { useDispatch, useSelector } from 'react-redux';
import { apiGetDailyFPCStatus } from 'services/SchedulingService';
import { FPC, convertDateToYMD, transformData } from 'components/validators';
import { CalendarView, Container } from 'components/shared';
import { openDialog, setSelected } from './Calendar/store/stateSlice';
import { useNavigate } from 'react-router-dom';
import SelectChannelDialog from 'views/Controls/SelectChannelDialog';
import { isChannelSelected } from 'views/Controls/GLOBALFUNACTION';
import {
  setdateForm,
  setIsSelectChannelDialogOpen,
} from 'store/locale/localeSlice';
import { apiCallstoreprocedure } from 'services/CommonService';
import HeaderExtra from 'views/Controls/HeaderExtra';

const DailyFPCApproval = () => {
  /* REDUX */
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const dispatch = useDispatch();

  /* STATES */

  const [events, setevents] = useState(null);
  const [currentDate, setCurrentDate] = useState(convertDateToYMD(new Date()));

  /* HOOKS */
  const navigate = useNavigate();

  /* USE EFFECTS */

  useEffect(() => {
    let data = {};
    data.par_LocationCode = Channel.LocationCode;
    data.par_ChannelCode = Channel.ChannelCode;
    data.par_FPCDate = currentDate;
    data.par_Flag = 'DAILYFPC';

    apiCallstoreprocedure('USP_Calender_Dashboard', data)
      .then((response) => {
        console.log(response.data);
        setevents(FPC(response.data));
      })
      .catch((error) => {
        if (error.response.status) {
          setevents(null);
        }
      });
  }, [currentDate, Channel]);
  useEffect(() => {
    const gboxElement = document.getElementsByClassName('Gbox2')[0];
    const gboxElementchild =
      document.getElementsByClassName('Gbox2')[0].children[1];
    dispatch(setdateForm(['', 'Daily FPC Approval']));
    if (gboxElement) {
      gboxElement.style.display = 'block';
      gboxElementchild.style.display = 'none';
    } // Optionally, you might want to revert the change when the component unmounts
    return () => {
      if (gboxElement) {
        gboxElement.style.display = 'none';
        gboxElementchild.style.display = 'none';
      }
    };
  }, []);
  return (
    <>
      <h1>Sanket</h1>
      <Card>
        <div className="flex flex-col h-full justify-between">
          <Container style={{ height: 550 }}>
            <CalendarView
              events={events}
              select={(event) => {
                if (isChannelSelected(Channel)) {
                  const isPresent = events.some(
                    (row) => row.start === event.startStr,
                  );
                  // if (isPresent) {
                  openDialog(event);
                  const { start, end } = event;
                  dispatch(
                    setSelected({
                      type: 'NEW',
                      start,
                      end,
                    }),
                  );
                  const channelQueryParam = encodeURIComponent(
                    JSON.stringify(Channel),
                  );
                  navigate(
                    '/DailyFPCApp?dt=' +
                    event.startStr +
                    '&chl=' +
                    channelQueryParam,
                  );
                } else {
                  dispatch(setIsSelectChannelDialogOpen(true));
                }
              }}
              datesSet={(dateInfo) => {
                setCurrentDate(convertDateToYMD(dateInfo.view.currentStart));
              }}
              selectable
            />
          </Container>
        </div>
      </Card>

      <SelectChannelDialog />
    </>
  );
};

export default DailyFPCApproval;
