import {
  Button,
  Switcher,
  Input,
  FormContainer,
  Select,
  DatePicker,
  FormItem,
  Card,
  Alert,
  Dialog,
  Upload,
  Tooltip,
} from 'components/ui';
import { apiGetLanguagemaster } from 'services/MasterService';
import { Field, Form, Formik } from 'formik';
import * as Yup from 'yup';
import CreatableSelect from 'react-select/creatable';
import {
  PostContent,
  apiGetContentTypemaster,
  apiGetCensorshipmaster,
  apiGetGenremaster,
  apiGetSubGenremaster,
  apiGetTXVersionmasterDrop,
  apiGetRatingcompanymaster,
  apiGetviewmasterdrop,
  apiGetAspectratiomasterdrop,
  apiGetSuppliermaster,
  apisendnotification,
} from 'services/ProgrammingService';
import { useSelector } from 'react-redux';
import { HiOutlineSearch } from 'react-icons/hi';
import React, { useState, useEffect } from 'react';
import { Link, useLocation, useNavigate } from 'react-router-dom';
import SeasonMapping from '../../Controls/SeasonMapping';
import MapChannel from '../../Controls/MapChannel';
import axios from 'axios';
import Index from 'views/MovieShowPage/Index';
import Contentdetail from './Contentdetail';
import { FcImageFile } from 'react-icons/fc';
import MapStarcast from '../../Controls/MapStarcast';
import useTimeOutMessage from 'utils/hooks/useTimeOutMessage';
import { validate } from 'components/validators';
import {
  abbreviateNumberE,
  formatDurationHHMMSSFF,
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import { GrClose } from 'react-icons/gr';
import { TbArrowBigRightLine } from 'react-icons/tb';
import { HiOutlineClipboardDocumentList } from 'react-icons/hi2';
import Loader from 'views/Controls/Loader';
import { CLIENT } from 'views/Controls/clientListEnum';
import { Galleria } from 'primereact/galleria';
import { apiCallstoreprocedure } from 'services/CommonService';

let DefaultImage = 'https://cloudbats.planetcast.in/download.jpg'

const validationSchema = Yup.object().shape({
  ContentName: Yup.string()
    .min(1, 'Too Short!')
    .max(50, 'Too Long!')
    .required('Content Name Required'),
  ShortName: Yup.string().required('ShortName Required '),
  ContentTypeCode: Yup.string().required('ContentType Required '),
  Audience: Yup.string().required('Audience Required '),
  ClassificationCode: Yup.string().required('Classification Required '),
  LanguageCode: Yup.string().required('Language Required '),
  FPCReleaseDate: Yup.string().required('ReleaseDate Required '),
  SlotDuration: Yup.string().required('Dur in mins Required '),
  GenreCode: Yup.string().required('Genre Required'),
  SubGenreCode: Yup.string().required('SubGenre Required'),
  CensorshipCode: Yup.string().required('Censorship Required '),
  ERPCode: Yup.string().min(1, 'Too Short!').max(20, 'Too Long!'),
  IsActive: Yup.string().required('IsActives Required'),
});

const options2 = [
  { value: 1, label: 'EPISODIC' },
  { value: 2, label: 'NONEPISODIC' },
];

const ContentDemo = [{ value: '', label: 'Data Not Found' }];

const colorClasses = [
  'bg-rose-500',
  'bg-indigo-500',
  'bg-blue-500',
  'bg-amber-400',
];
const ContentEdit = () => {
  const navigate = useNavigate();
  const { state } = useLocation();
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const path = useSelector((state) => state.base.common.Path);
  const token = useSelector((state) => state.auth.session.token);
  const Username = useSelector((state) => state.auth.session.Username);
  const ChannelSetting = useSelector((state) => state.auth.session.ChannelSetting);
  const [ContentType, setContentType] = useState([]);
  const [ContentTypeValue, setContentTypeValue] = useState();
  const [Language, setLanguage] = useState([]);
  const [Genre, setGenre] = useState([]);
  const [SubGenre, setSubGenre] = useState([]);
  const [TXVersion, setTXVersion] = useState([]);
  const [SupplierList, setSupplierList] = useState([]);
  const [Censorship, setCensorship] = useState([]);
  const [dialogIsOpen, setIsOpen] = useState(false);
  const [dialogIsOpen1, setIsOpen1] = useState(false);
  const [LOADERCHECK, setLOADERCHECK] = useState(false);
  const [first, setfirst] = useState([]);
  const [eroroshwo, seteroroshwo] = useState('');
  const [detail, setContentdetail] = useState([]);
  const [Season, setSeason] = useState([]);
  const [Rating, setRating] = useState([]);
  const [AspectRatio, setAspectRatio] = useState([]);
  const [parentingDetails, setParentingDetails] = useState({});

  const [ticketData, setTicketData] = useState(
    [Channel].map((item, i) => ({
      ColorClass: colorClasses[i % colorClasses.length],
      LocationCode: item.LocationCode,
      LocationName: item.LocationName,
      ChannelName: item.ChannelName,
      ChannelCode: item.ChannelCode,
    })),
  );
  const [sMapStarcast, setMapStarcast] = useState([]);
  const [Addseasionerror, setAddseasionerror] = useTimeOutMessage();
  const [AddSynopsiserror, setAddSynopsiserror] = useTimeOutMessage();
  const [contentratings, setcontentratings] = useState([]);
  const [averageRating, setaverageRating] = useState(false);
  const [options3, setoptions3] = useState([]);
  const [previewSource, setPreviewSource] = useState(DefaultImage);


  const AddContent = async (values, token) => {
    setLOADERCHECK(true);


    if (values.Content_Image && Channel.label == CLIENT.MASST_INDIA) {
      const formData = new FormData();
      formData.append("image", values.Content_Image);
      formData.append("folderName", Channel.ChannelName)

      try {
        const response = await axios.post("http://103.14.97.155:3050/upload", formData, {
          headers: {
            'Content-Type': 'multipart/form-data'
          }
        });

        console.log("Upload successful:", response.data.url);
        DefaultImage = response.data.url;

      } catch (error) {
        openNotification('warning', error.response?.data.message || 'Image upload failed');
        return; // exit early on error
      }

    }

    const isDataValid = ticketData.length > 0 || detail.length > 0 || Season.length > 0 || sMapStarcast.length > 0;
    if (!isDataValid) {
      setLOADERCHECK(false);
      openNotification('danger', 'Kindly Enter Required Field');
      return;
    }

    if (values.InHouse && values.SupplierName.length === 0) {
      setLOADERCHECK(false);
      openNotification('danger', 'Kindly Enter Supplier Name');
      return;
    }


    try {
      const isUSAForbes = CLIENT.USA_Forbes === Channel.label;

      const mergedData = {
        content: {
          ContentName: values.ContentName || '',
          ShortName: values.ShortName || '',
          ERPCode: values.ERPCode || '',
          ContentTypeCode: values.ContentTypeCode || '',
          ClassificationCode: values.ClassificationCode || '',
          ViewCode: values.Audience || '',
          LanguageCode: values.LanguageCode || '',
          CensorshipCode: values.CensorshipCode || '',
          BlackWhite: values.Colored ? 1 : 0,
          InHouseOutHouse: values.InHouse ? 1 : 0,
          FPCReleaseDate: values.FPCReleaseDate || null,
          SlotDuration: Number(values.SlotDuration || 0),
          Synopsis: values.Synopsis || '',
          GroupName: path === '/addEventTeamPlaner' ? 1 : values.IsGroup ? 1 : 0,
          IsSubProgram: 0,
          IsEpRestriction: 0,
          IsRecorded: isUSAForbes ? 0 : values.Recorded ? 1 : 0,
          AllowOverBooking: values.AllowOverBooking ? 1 : 0,
          IgnoreRODPSpots: values.IsRODP ? 1 : 0,
          GenreCode: values.GenreCode || '',
          SubGenreCode: values.SubGenreCode || '',
          AspectRatio: values.AspectRatio?.toString() || '',
          SD: 0,
          HD: 0,
          UHD: 0,
          IsGeneric: 0,
          EPGContentName: values.ERPContentName || values.ContentName || '',
          GenericSynopsis: values.GenericSynopsis || '',
          ApprovedStatus: values.IsActive ? 1 : 0,
          AppRejRemark: values.DefaultSeg || '',
          Content_Image: Channel.label == CLIENT.MASST_INDIA ? DefaultImage : previewSource,
          MetaData: values.MetaData || '',
          TxMasterCode: values.TxTypeName[0]?.value,
          VideoTypeCode: values.VideoType || '',
          IsActive: values.IsActive ? 1 : 0,
          DefaultSegDur: isUSAForbes
            ? formatDurationHHMMSSFF(Number(ChannelSetting[0].FramePerSec), Number(values.SlotDuration) * 60)
            : values.DefaultSegDur || '',
          DefaultSeg: isUSAForbes ? 1 : values.DefaultSeg || 0,
          PromoCode: values.PromoCode ? values.PromoCode : 0
        },
        ...(sMapStarcast.length > 0 && {
          starcast: sMapStarcast.map((item) => ({
            StarCastTypeCode: item.StarCastTypeCode,
            StarCastCode: item.StarCastCode,
          })),
        }),
        contenttxversion: values.TxTypeName.map((item) => ({
          TxVersionCode: item.value,
          IsActive: 1,
        })),
        contentepsrestriction: detail.map((item) => ({
          ContentTypeCode: values.ContentTypeCode,
          SeasonNo: Number(item.Season),
          EpisodeNo: Number(item.Start),
          Reason: item.End,
          IsActive: 1,
        })),
        contentlocchnlmap: ticketData.map((item) => ({
          LocationCode: item.LocationCode,
          ChannelCode: item.ChannelCode,
          IsActive: 1,
        })),
        cepsmapping: ContentTypeValue?.EpisodeSpecific === 0
          ? [
            {
              SeasonNo: 1,
              StartEpisode: 1,
              EndEpisodes: 1,
              IsActive: 1,
            },
          ]
          : Season.map((item) => ({
            SeasonNo: Number(item.Season),
            StartEpisode: Number(item.Start),
            EndEpisodes: Number(item.End),
            IsActive: 1,
          })),
        contentratings,
        ...((values.SupplierName.length > 0) && {
          CntentSuppliermap: values.SupplierName.map((item) => ({
            SupplierCode: item.value,
            IsActive: 1,
          })),
        }),
      };

      console.log('mergedData', mergedData);

      const response = await PostContent(mergedData, token);

      // Handle response
      if (response.status === 204) {
        openNotification('danger', 'Data Already Exists.');
      } else if (response.status === 200) {
        openNotification('success', 'Data Added Successfully');
        const navigatePath = CLIENT.USA_Forbes === Channel.label
          ? '/templatemaster'
          : path === '/addEventTeamPlaner'
            ? '/EventTeamPlaner'
            : '/ContentMaster';

        await apisendnotification({
          NotificationId: (Math.random() + 1).toString(36).substring(7),
          user_ids: [10],
          message: values.ContentName + ' Content Added.',
          image: '',
          type: '1',
          location: 'Content Added.',
          locationLabel: Username,
          Status: '1',
          isGroup: 1,
          Ispriority: 1,
          readed: 0,
        });

        navigate(navigatePath);
      }
    } catch (error) {
      // Handle server error
      if (error.response?.status === 500) {
        openNotification('danger', 'Server Error.');
      }
    } finally {
      // Ensure loader is turned off
      setLOADERCHECK(false);
    }
  };
  const openDialog = () => {
    setIsOpen(true);
  };
  const openDialog1 = () => {
    setIsOpen1(true);
  };
  const onDialogClose = (e, values) => {
    setIsOpen(false);
  };
  const onDialogClose1 = (e, values) => {
    setIsOpen1(false);
  };

  useEffect(() => {
    const filteredRatings = contentratings.filter(
      (item) => item.OutofRatingScale === 10 && item.Rating !== 0,
    );
    const sumOfRatings = filteredRatings.reduce(
      (acc, curr) => acc + curr.Rating,
      0,
    );
    const averageRating =
      filteredRatings.length > 0 ? sumOfRatings / filteredRatings.length : 0; // Handle division by zero
    const roundedAverage = Number(averageRating.toFixed(1));
    setaverageRating(roundedAverage);
  }, [contentratings]);

  const mapOptions = (data, valueKey, labelKey) =>
    data.map((option) => ({
      value: option[valueKey],
      label: option[labelKey],
    }));

  useEffect(() => {
    const fetchData = async () => {
      setLOADERCHECK(true);

      try {
        const [
          ratingCompanyResponse,
          aspectRatioResponse,
          contentTypeResponse,
          viewResponse,
          txVersionResponse,
          languageResponse,
          censorshipResponse,
          genreResponse,
          subGenreResponse,
          supplierResponse, // Moved out for conditional check
          // parentingDetails
        ] = await Promise.all([
          apiGetRatingcompanymaster(),
          apiGetAspectratiomasterdrop(),
          apiGetContentTypemaster(),
          apiGetviewmasterdrop(),
          apiGetTXVersionmasterDrop(),
          apiGetLanguagemaster(),
          apiGetCensorshipmaster(),
          apiGetGenremaster(),
          apiGetSubGenremaster(),
          // apiCallstoreprocedure('USP_GetPromosListusingPromotype', {
          //   ChannelCode: '19',
          //   LocationCode: '1',
          //   PromoTypeCode: '19',
          // }),
          CLIENT.USA_Forbes !== Channel.label ? apiGetSuppliermaster() : Promise.resolve({ data: [] }), // Conditionally fetch supplier data
        ]);

        // Batch State Updates to Reduce Re-renders
        setRating(ratingCompanyResponse.data);

        // Process Data
        const aspectRatioOptions = mapOptions(aspectRatioResponse.data, "AspectRatioCode", "AspectRatio");
        setAspectRatio(aspectRatioOptions);

        const contentTypeOptions = contentTypeResponse.data
          .sort((a, b) => a.ContentTypeName.localeCompare(b.ContentTypeName))
          .map((option) => ({
            value: option.ContentTypeCode,
            label: option.ContentTypeName,
            EpisodeSpecific: option.EpisodeSpecific,
          }));

        console.log('contentTypeOptions', contentTypeOptions);
        setContentType(contentTypeOptions);


        const viewOptions = mapOptions(viewResponse.data, "ViewCode", "ViewName");
        setoptions3(viewOptions);

        const txVersionOptions = mapOptions(txVersionResponse.data, "TXVersionCode", "TXVersionName");
        setTXVersion(txVersionOptions);

        const supplierOptions = supplierResponse.data.length
          ? mapOptions(supplierResponse.data, "SupplierCode", "SupplierName")
          : [];
        setSupplierList(supplierOptions);

        const languageOptions = languageResponse.data
          .sort((a, b) => a.LanguageName.localeCompare(b.LanguageName))
          .map((option) => ({
            value: option.LanguageCode,
            label: option.LanguageName,
          }));
        setLanguage(languageOptions);

        const censorshipOptions = mapOptions(censorshipResponse.data, "CensorshipCode", "CensorshipName");
        setCensorship(censorshipOptions);


        const genreOptions = genreResponse.data
          .sort((a, b) => a.GenreName.localeCompare(b.GenreName))
          .map((option) => ({
            value: option.GenreCode,
            label: option.GenreName,
          }));
        setGenre(genreOptions);


        const subGenreOptions = subGenreResponse.data
          .sort((a, b) => a.SubGenreName.localeCompare(b.SubGenreName))
          .map((option) => ({
            value: option.SubGenreCode,
            label: option.SubGenreName,
          }));
        setSubGenre(subGenreOptions);
        console.log(Channel);

        if (Channel.ChannelName !== CLIENT.USA_Forbes) {
          const parentingDetails = await apiCallstoreprocedure('USP_GetPromosListusingPromotype', {
            ChannelCode: Channel.ChannelCode,
            LocationCode: Channel.LocationCode,
            PromoTypeCode: '19',
          });

          if (
            parentingDetails &&
            Array.isArray(parentingDetails.data) &&
            parentingDetails.data.length > 0
          ) {
            const parentingOptions = parentingDetails.data
              .sort((a, b) => a.PromoCaption.localeCompare(b.PromoCaption))
              .map((option) => ({
                value: option.PromoCode,
                label: option.PromoCaption,
              }));
            setParentingDetails(parentingOptions);
          }
        }

        console.log('channel', Channel.label);







        // fetchStorageDetails();

      } catch (error) {
        console.error("Error fetching data:", error);
      } finally {
        setLOADERCHECK(false);
      }
    };

    fetchData();
  }, []);

  // const fetchStorageDetails = async () => {
  //   try {
  //     const CurrentDBSize = await apiCallstoreprocedure('USP_GetPromosListusingPromotype', {
  //       ChannelCode: '19',
  //       LocationCode: '1',
  //       PromoTypeCode: '19',
  //     });

  //     console.log('CurrentDBSize', CurrentDBSize);

  //     setParentingDetails(CurrentDBSize.data[0])

  //   } catch (error) {
  //     console.error('Error fetching storage details:', error);
  //   }
  // };


  const contentdetailview = () => {
    openDialog1();
  };

  // const GetMovie = (value) => {
  //   let config = {
  //     method: 'get',
  //     maxBodyLength: Infinity,
  //     url: `https://www.omdbapi.com/?t=${value.ContentName}&apikey=4374994a`,
  //     headers: {},
  //   };
  //   axios
  //     .request(config)
  //     .then((response) => {
  //       if (response.data.Response == 'False') {
  //         seteroroshwo(true);
  //         setTimeout(() => seteroroshwo(false), 3000);
  //       } else {
  //         setfirst(response.data);
  //         openDialog();
  //         seteroroshwo(false);
  //       }
  //     })
  //     .catch((error) => { });  

  // };

  const GetMovie = async (value) => {
    try {
      let searchConfig = {
        method: 'get',
        maxBodyLength: Infinity,
        url: `https://www.omdbapi.com/?s=${value.ContentName}&apikey=4374994a`,
        headers: {},
      };

      const response = await axios.request(searchConfig);

      if (response.data.Response === 'False') {
        seteroroshwo(true);
        setTimeout(() => seteroroshwo(false), 3000);
        return;
      }

      const searchResults = response.data.Search;
      const allMovieDetails = [];

      // Use Promise.all to fetch all details in parallel
      const detailRequests = searchResults.map((movie) => {
        const detailConfig = {
          method: 'get',
          maxBodyLength: Infinity,
          url: `https://www.omdbapi.com/?i=${movie.imdbID}&apikey=4374994a`,
          headers: {},
        };
        return axios.request(detailConfig);
      });

      const detailResponses = await Promise.all(detailRequests);

      for (const detailResponse of detailResponses) {
        if (detailResponse.data.Response !== 'False') {
          allMovieDetails.push(detailResponse.data);
        }
      }
      console.log("allMovieDetails", allMovieDetails)
      setfirst(allMovieDetails);
      openDialog();
      seteroroshwo(false);

    } catch (error) {
      console.error('Error fetching movie data:', error);
      seteroroshwo(true);
      setTimeout(() => seteroroshwo(false), 3000);
    }
  };

  const beforeUpload = (file, fileList) => {
    let valid = true;
    const allowedFileType = ['image/jpeg', 'image/png'];
    const MAX_FILE_SIZE = 5000000;
    if (file) {
      for (const f of file) {
        if (!allowedFileType.includes(f.type)) {
          valid = 'Please upload a .jpeg or .png file!';
        }
        if (f.size >= MAX_FILE_SIZE) {
          valid = 'Uploaded image cannot more than 500kb!';
        }
      }
    }
    return valid;
  };

  return (

    <div>

      <Loader showLoader={LOADERCHECK} />
      {eroroshwo ? (
        <Alert type="info" title="Alert!" showIcon>
          Movie not Found
        </Alert>
      ) : null}
      <Formik
        initialValues={{
          ContentCode: '',
          ContentName: '',
          ShortName: '',
          ERPCode: '',
          ContentTypeCode: '',
          LanguageCode: '',
          ClassificationCode: '',
          FPCReleaseDate: '',
          SlotDuration: '',
          GenreCode: '',
          SubGenreCode: '',
          CensorshipCode: '',
          TxTypeName: [],
          SupplierName: [],
          DefaultSeg: '',
          Audience: '',
          Synopsis: '',
          GenericSynopsis: '',
          ERPContentName: '',
          MetaData: '',
          VideoType: 2,
          AspectRatio: 1,
          DefaultSegDur: '',
          InHouse: '',
          Colored: '',
          Recorded: '',
          IsGroup: path == '/addEventTeamPlaner' && true,
          IsRODP: '',
          Content_Image: previewSource,
          AllowOverBooking: '',
          PromoCode: '',
          IsActive: state?.editData.IsActive === 1 ? true : false || true,
        }}
        validationSchema={validationSchema}
        onSubmit={(values) => {
          setTimeout(() => {
            if (!state?.editData.ContentCode) {
              new Promise((resolve, reject) => {
                AddContent(values, token)
                  .then((response) => {
                    // onDrawerClose(0, 0)

                    resolve(response);
                  })
                  .catch((errors) => {
                    reject(errors);
                  });
              });
            }
          }, 400);
        }}
      >
        {({ values, touched, errors }) => (
          <Form>
            <Dialog
              isOpen={dialogIsOpen}
              width={800}
              contentClassName="mt-6"
              onClose={onDialogClose}
              onRequestClose={onDialogClose}
            >
              <Galleria
                value={first}
                numVisible={5}
                showThumbnails={true}
                thumbnailsPosition="top"
                className='h-full '
                item={(item) => (
                  <div className="flex flex-row md:flex-row gap-4 items-start ">
                    <div className="flex-1">
                      <Index
                        first={item}
                        values={values}
                        onDialogClose={onDialogClose}
                        setPreviewSource={setPreviewSource}
                        setcontentratings={setcontentratings}
                        Rating={Rating}
                      />
                    </div>
                  </div>
                )}
                thumbnail={(item) => (
                  <div className="text-sm">
                    <img
                      src={item.Poster}
                      alt={item.Title}
                      style={{ width: 120 }}
                    />
                  </div>
                )}
              />
            </Dialog>


            <Card
              header={
                CLIENT.USA_Forbes == Channel.label
                  ? 'Template Master'
                  : 'Content Master'
              }
            >
              <div className="inline-flex flex-wrap xl:flex gap-2">
                <FormContainer>
                  <div className="grid grid-cols-2 gap-2">
                    <Card>
                      <Field
                        size="sm"
                        type="ContentCode"
                        autoComplete="off"
                        name="ContentCode"
                        placeholder="ContentCode name"
                        component={Input}
                        hidden
                      />
                      <div className="grid grid-cols-6 md:grid-cols-6 gap-2">
                        <div className="col-span-4">

                          <FormItem
                            asterisk
                            label={
                              Channel.label == CLIENT.USA_Forbes
                                ? 'Template'
                                : 'Content'
                            }
                            invalid={errors.ContentName && touched.ContentName}
                            errorMessage={errors.ContentName}
                          >
                            <Field
                              type="text"
                              autoComplete="off"
                              name="ContentName"
                              size="sm"
                              maxLength="50"
                              placeholder={
                                Channel.label == CLIENT.USA_Forbes
                                  ? 'Template'
                                  : 'Content'
                              }
                              component={Input}
                            />
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <Button
                            className="mt-7"
                            variant="solid"
                            size="sm"
                            disabled={values.ContentName == ''}
                            icon={<HiOutlineSearch />}
                            type="button"
                            onClick={() => GetMovie(values)}
                          >
                            Search In IMDb
                          </Button>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Short Name"
                            invalid={errors.ShortName && touched.ShortName}
                            errorMessage={errors.ShortName}
                          >
                            <Field
                              type="ShortName"
                              autoComplete="off"
                              name="ShortName"
                              size="sm"
                              placeholder="Short Name"
                              component={Input}
                              maxLength="8"
                            />
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Content Type"
                            invalid={
                              errors.ContentTypeCode && touched.ContentTypeCode
                            }
                            errorMessage={errors.ContentTypeCode}
                          >
                            <Field size="sm" name="ContentTypeCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={ContentType}
                                  value={
                                    ContentType.length > 0
                                      ? ContentType.filter(
                                        (option) =>
                                          option.value ===
                                          values.ContentTypeCode,
                                      )
                                      : ContentDemo.filter(
                                        (option) =>
                                          option.value === values.ReportingTo,
                                      )
                                  }
                                  onChange={(option) => {
                                    setContentTypeValue(option);
                                    if (option?.EpisodeSpecific == 0) {
                                      form.setFieldValue(
                                        'ClassificationCode',
                                        2,
                                      );
                                    } else {
                                      form.setFieldValue(
                                        'ClassificationCode',
                                        1,
                                      );
                                    }
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    );
                                  }}
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            label="ERP Code"
                            invalid={errors.ERPCode && touched.ERPCode}
                            errorMessage={errors.ERPCode}
                          >
                            <Field name="ERPCode">
                              {({ field, form }) => (
                                <Input
                                  size="sm"
                                  placeholder="ERPCode"
                                  maxLength="20"
                                  field={field}
                                  form={form}
                                  value={values.ERPCode}
                                  onChange={(event) => {
                                    const regex = /^[a-zA-Z0-9]*$/;
                                    const input = event.target.value;

                                    if (regex.test(input)) {
                                      form.setFieldValue(field.name, input);
                                    }
                                  }}
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Classification"
                            invalid={
                              errors.ClassificationCode &&
                              touched.ClassificationCode
                            }
                            errorMessage={errors.ClassificationCode}
                          >
                            <Field name="ClassificationCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  isDisabled
                                  options={options2}
                                  value={options2.filter(
                                    (option) =>
                                      option.value ===
                                      values.ClassificationCode,
                                  )}
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Audience"
                            invalid={errors.Audience && touched.Audience}
                            errorMessage={errors.Audience}
                          >
                            <Field name="Audience">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={options3}
                                  value={options3.filter(
                                    (option) =>
                                      option.value === values.Audience,
                                  )}
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Dur In Mins."
                            invalid={
                              errors.SlotDuration && touched.SlotDuration
                            }
                            errorMessage={errors.SlotDuration}
                          >
                            <Field name="SlotDuration">
                              {({ field, form }) => (
                                <Input
                                  size="sm"
                                  placeholder="SlotDuration"
                                  field={field}
                                  form={form}
                                  value={values.SlotDuration}
                                  onChange={(event) => {
                                    const limit = 3;
                                    const regex = /^[0-9]*$/;
                                    const input = event.target.value;

                                    if (regex.test(input)) {
                                      form.setFieldValue(
                                        field.name,
                                        input.slice(0, limit),
                                      );
                                    }
                                  }}
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Censorship"
                            invalid={
                              errors.CensorshipCode && touched.CensorshipCode
                            }
                            errorMessage={errors.CensorshipCode}
                          >
                            <Field name="CensorshipCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={Censorship}
                                  value={
                                    Censorship.length > 0
                                      ? Censorship.filter(
                                        (option) =>
                                          option.value ===
                                          values.CensorshipCode,
                                      )
                                      : ContentDemo.filter(
                                        (option) =>
                                          option.value === values.ReportingTo,
                                      )
                                  }
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Release Date"
                            invalid={
                              errors.FPCReleaseDate && touched.FPCReleaseDate
                            }
                            errorMessage={errors.FPCReleaseDate}
                          >
                            <Field name="FPCReleaseDate">
                              {({ field, form }) => (
                                <DatePicker
                                  size="sm"
                                  field={field}
                                  form={form}
                                  name="FPCReleaseDate"
                                  value={
                                    validate(values.FPCReleaseDate)
                                      ? new Date(values.FPCReleaseDate)
                                      : ''
                                  }
                                  placeholder="Select Date"
                                  onChange={(date) => {
                                    form.setFieldValue('FPCReleaseDate', date);
                                  }}
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Language"
                            invalid={
                              errors.LanguageCode && touched.LanguageCode
                            }
                            errorMessage={errors.LanguageCode}
                          >
                            <Field size="sm" name="LanguageCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={Language}
                                  value={
                                    Language.length > 0
                                      ? Language.filter(
                                        (option) =>
                                          option.value ===
                                          values.LanguageCode,
                                      )
                                      : ContentDemo.filter(
                                        (option) =>
                                          option.value === values.ReportingTo,
                                      )
                                  }
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="Genre"
                            invalid={errors.GenreCode && touched.GenreCode}
                            errorMessage={errors.GenreCode}
                          >
                            <Field size="sm" name="GenreCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={Genre}
                                  value={
                                    Genre.length > 0
                                      ? Genre.filter(
                                        (option) =>
                                          option.value === values.GenreCode,
                                      )
                                      : ContentDemo.filter(
                                        (option) =>
                                          option.value === values.ReportingTo,
                                      )
                                  }
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            asterisk
                            label="SubGenre"
                            invalid={
                              errors.SubGenreCode && touched.SubGenreCode
                            }
                            errorMessage={errors.SubGenreCode}
                          >
                            <Field size="sm" name="SubGenreCode">
                              {({ field, form }) => (
                                <Select
                                  field={field}
                                  form={form}
                                  options={SubGenre}
                                  value={
                                    SubGenre.length > 0
                                      ? SubGenre.filter(
                                        (option) =>
                                          option.value ===
                                          values.SubGenreCode,
                                      )
                                      : ContentDemo.filter(
                                        (option) =>
                                          option.value === values.ReportingTo,
                                      )
                                  }
                                  onChange={(option) =>
                                    form.setFieldValue(
                                      field.name,
                                      option?.value,
                                    )
                                  }
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-2">
                          <FormItem
                            label="TX Type Name"
                            asterisk
                            invalid={errors.TxTypeName && touched.TxTypeName}
                            errorMessage={errors.TxTypeName}
                          >
                            <Field name="TxTypeName">
                              {({ field, form }) => (
                                <Select
                                  isMulti
                                  componentAs={CreatableSelect}
                                  field={field}
                                  form={form}
                                  options={TXVersion}
                                  value={values.TxTypeName}
                                  onChange={(option) => {
                                    console.log(field.name, option);
                                    form.setFieldValue(field.name, option);
                                  }}
                                />
                              )}
                            </Field>
                          </FormItem>
                        </div>
                        <div className="col-span-1">
                          <FormItem
                            label="Is OutHouse"
                            invalid={errors.InHouse && touched.InHouse}
                            errorMessage={errors.InHouse}
                          >
                            <Field name="InHouse" component={Switcher} />
                          </FormItem>
                        </div>
                        <div className="col-span-5">
                          {values.InHouse && CLIENT.USA_Forbes !== Channel.label &&

                            <div >
                              <FormItem
                                label="Supplier Name"
                                asterisk
                                invalid={errors.SupplierName && touched.SupplierName}
                                errorMessage={errors.SupplierName}
                              >
                                <Field name="SupplierName">
                                  {({ field, form }) => (
                                    <Select
                                      isMulti
                                      componentAs={CreatableSelect}
                                      field={field}
                                      form={form}
                                      options={SupplierList}
                                      value={values.SupplierName}
                                      onChange={(option) => {
                                        form.setFieldValue(field.name, option);
                                      }}
                                    />
                                  )}
                                </Field>
                              </FormItem>
                            </div>}</div>
                        {/* 
                        <div className="col-span-1">
                          <FormItem
                            label="Is Parenting"
                            invalid={errors.InParenting && touched.InParenting}
                            errorMessage={errors.InParenting}
                          >
                            <Field name="InParenting" component={Switcher} />
                          </FormItem>
                        </div> */}

                        <div className="col-span-6">
                          {CLIENT.ANI_PLUS === Channel.label && <div >
                            <FormItem
                              label="Parenting Rating Disclaimers "
                              asterisk
                              invalid={errors.PromoCode && touched.PromoCode}
                              errorMessage={errors.PromoCode}
                            >
                              <Field name="PromoCode">
                                {({ field, form }) => (
                                  <Select
                                    field={field}
                                    form={form}
                                    value={
                                      SubGenre.length > 0
                                        ? SubGenre.filter(
                                          (option) =>
                                            option.value ===
                                            values.PromoCode,
                                        )
                                        : ContentDemo.filter(
                                          (option) =>
                                            option.value === values.ReportingTo,
                                        )
                                    }

                                    options={parentingDetails}
                                    onChange={(option) => {
                                      form.setFieldValue(field.name, option.value);
                                    }}
                                  />
                                )}
                              </Field>
                            </FormItem>
                          </div>}
                        </div>

                        <div className="col-span-3">
                          <FormItem
                            label="Content Image"
                            invalid={
                              errors.Content_Image && touched.Content_Image
                            }
                            errorMessage={errors.Content_Image}
                          >
                            <Field name="Content_Image">
                              {({ field, form }) => (
                                <div style={{ display: 'grid' }}>
                                  <Upload
                                    uploadLimit={1}
                                    beforeUpload={beforeUpload}
                                    // accept=".jpg, .jpeg, .png, .bmp, .svg"
                                    showList={false}
                                    onChange={(files) => {
                                      const file = files[0];

                                      if (file) {
                                        const reader = new FileReader();
                                        reader.readAsDataURL(file);

                                        reader.onloadend = () => {
                                          form.setFieldValue(field.name, file);
                                          form.setFieldValue(field.name, Channel.label == CLIENT.MASST_INDIA ? file : reader.result);
                                        };
                                      } else {
                                        form.setFieldValue(field.name, '');
                                        setPreviewSource('');
                                      }
                                    }}
                                  >
                                    <div className="border-dashed border-gray-500 border-2 p-3 rounded-lg w-full hover:cursor-pointer mt-1">
                                      {previewSource ? (
                                        <div className="flex items-center justify-center w-full">
                                          <div className="relative">
                                            <Tooltip title="Click to upload logo">
                                              <img
                                                src={previewSource}
                                                alt="Preview"
                                                className="hover:opacity-80"
                                                style={{ height: '150px', width: 'auto' }}
                                              />
                                            </Tooltip>
                                            <Tooltip
                                              title="Remove Logo"
                                              className="relative"
                                              wrapperClass="absolute -top-3 -right-3"
                                            >
                                              <Button
                                                shape="circle"
                                                size="xs"
                                                variant="solid"
                                                color="red-500"
                                                icon={<GrClose />}
                                                type="button"
                                                onClick={(e) => {
                                                  e.stopPropagation();
                                                  form.setFieldValue(field.name, '');
                                                  setPreviewSource('');
                                                }}
                                              />
                                            </Tooltip>
                                          </div>
                                        </div>
                                      ) : (
                                        <div className="h-28 flex items-center justify-center w-full">
                                          <Tooltip
                                            title="Click to upload logo"
                                            wrapperClass="flex flex-col items-center justify-center"
                                          >
                                            <FcImageFile size={25} />
                                            <p className="text-xs mt-1 opacity-60 dark:text-white">
                                              Support: jpeg, png, bmp, svg
                                            </p>
                                            <p className=" text-xs mt-1 opacity-60 dark:text-white">
                                              (Max 1MB)
                                            </p>
                                          </Tooltip>
                                        </div>
                                      )}
                                    </div>
                                  </Upload>
                                </div>
                              )}
                            </Field>
                          </FormItem>
                        </div>


                      </div>
                    </Card>

                    <Card>
                      {AddSynopsiserror && (
                        <Alert className="mb-4" type="danger" showIcon>
                          Please Select Video Type and Aspect Ratio
                        </Alert>
                      )}
                      <div className="flex items-center justify-between mb-2 mr-2 ml-2">
                        <h6>Add Synopsis</h6>
                        <TbArrowBigRightLine size={25} />
                        <Button
                          onClick={() => contentdetailview()}
                          variant="solid"
                          size="xs"
                          icon={<HiOutlineClipboardDocumentList />}
                          type="button"
                        >
                          Add Synopsis{' '}
                        </Button>
                      </div>

                      {Addseasionerror && (
                        <Alert className="mb-4" type="danger" showIcon>
                          Kindly Select Channel
                        </Alert>
                      )}
                      {/* {Ratinglll} */}
                      <div className="grid grid-cols-1 gap-2">
                        <div className="col-span-1">
                          <Card
                            header={<p className="contentmasthead">Rating</p>}
                          >
                            <div className="flex justify-start items-center">
                              <p
                                style={{
                                  color: 'white',
                                  fontSize: 16,
                                  fontWeight: 600,
                                }}
                                className="flex"
                              >
                                Average Rating{' '}
                                <p className="flex ml-2">
                                  {averageRating}{' '}
                                  <p className={`ml-1 filled`}></p>
                                </p>
                              </p>
                            </div>
                            <div style={{ height: '150px', overflow: 'auto' }}>
                              <div
                                style={{
                                  height: 1,
                                  width: '100%',
                                  background: '#e6dcdc7a',
                                }}
                                className="mt-5"
                              ></div>
                              {Rating &&
                                Rating.map((item, index) => {
                                  const filteredRatings = contentratings.filter(
                                    (itemr) =>
                                      itemr.RatingCompanyCode ===
                                      item.RatingCompanyCode,
                                  );
                                  const hasMatchingCode =
                                    filteredRatings.length > 0;
                                  console.log(filteredRatings[0]?.TotalVoters);
                                  return (
                                    <div key={index}>
                                      <div className="grid grid-cols-2 gap-2 mt-2">
                                        <div className="flex justify-left ml-5 items-center">
                                          {/* {hasMatchingCode && <><FaRegCircleCheck color='rgb(19, 187, 169)' className='mr-2' size={24} /></>} */}
                                          <img
                                            src={item.RatingCompanyLogo}
                                            height={60}
                                            width={60}
                                            alt={item.RatingCompanyName}
                                          />
                                          <p className="ml-2 font-xl font-extrabold">
                                            {' '}
                                            {item.RatingCompanyName}
                                          </p>
                                        </div>
                                        <div className="flex justify-end items-center">
                                          <div className="mr-10 flex items-center">
                                            <h5
                                              className="mr-1"
                                              style={{
                                                color: 'gold',
                                                marginTop: '-5',
                                              }}
                                            >
                                              
                                            </h5>
                                            <span
                                              className="mr-2"
                                              style={{ color: 'gold' }}
                                            >
                                              {hasMatchingCode &&
                                                filteredRatings[0].Rating}
                                            </span>
                                            {hasMatchingCode && (
                                              <span>
                                                {' '}
                                                (
                                                {abbreviateNumberE(
                                                  filteredRatings[0]
                                                    .TotalVoters,
                                                )}
                                                )
                                              </span>
                                            )}
                                          </div>
                                          {/* {contentratings?.RatingCompanyCode !==
                                          2 && (
                                          <Tooltip title="Sync Rating">
                                            <Button
                                              size="xs"
                                              className="mr-2"
                                              variant="solid"
                                              type="button"
                                              // disabled={hasMatchingCode}
                                              onClick={() =>
                                                openNotification(
                                                  'info',
                                                  'Data Not Found',
                                                )
                                              }
                                              icon={
                                                <Icon
                                                  path={mdiSync}
                                                  size={0.8}
                                                  style={{ color: '#fff' }}
                                                />
                                              }
                                            />
                                          </Tooltip>
                                        )} */}
                                        </div>
                                      </div>
                                      <div
                                        style={{
                                          height: 1,
                                          width: '100%',
                                          background: '#e6dcdc7a',
                                        }}
                                        className="mt-2 mb-2"
                                      ></div>
                                    </div>
                                  );
                                })}
                            </div>
                          </Card>
                        </div>

                        <div className="col-span-1">
                          <Card
                            style={{
                              border: Addseasionerror ? '1px solid red' : '',
                            }}
                            header={
                              <p className="contentmasthead">
                                {' '}
                                Channel & Season Mapping
                              </p>
                            }
                          >
                            <div className="col-span-2">
                              <MapChannel
                                ticketData={ticketData}
                                setTicketData={setTicketData}
                              />
                            </div>
                            <div className="col-span-2">
                              <SeasonMapping
                                setSeason={setSeason}
                                Season={Season}
                                ContentTypeValue={ContentTypeValue}
                              ></SeasonMapping>
                            </div>
                          </Card>
                        </div>
                        <div className="col-span-1">
                          <Card
                            header={
                              <p className="contentmasthead"> StarCast</p>
                            }
                          >
                            <MapStarcast
                              setMapStarcast={setMapStarcast}
                              sMapStarcast={sMapStarcast}
                              isEditMode={false} GetContents={''} path={''}
                            />
                          </Card>
                        </div>
                      </div>
                    </Card>

                    <Dialog
                      isOpen={dialogIsOpen1}
                      width={1000}
                      onClose={(e) => onDialogClose1(e, values)}
                      onRequestClose={(e) => onDialogClose1(e, values)}
                    >
                      <div>
                        <Contentdetail
                          editData={state?.editData}
                          touched={touched}
                          errors={errors}
                          values={values}
                          setContentdetail={setContentdetail}
                          detail={detail}
                          AspectRatio={AspectRatio}
                          onDialogClose1={onDialogClose1}
                        />
                      </div>
                    </Dialog>
                  </div>
                  <div
                    style={{
                      display: 'flex',
                      justifyContent: 'space-between',
                    }}
                  >
                    <FormItem
                      label="IsActive"
                      invalid={errors.IsActive && touched.IsActive}
                      errorMessage={errors.IsActive}
                    >
                      <div>
                        <Field name="IsActive" component={Switcher} />
                      </div>
                    </FormItem>
                  </div>

                  <br></br>

                  <FormItem>
                    <div className="flex ">
                      {ticketData.length > 0 && values.VideoType > 0 ? (
                        <Button variant="solid" type="submit">
                          Submit
                        </Button>
                      ) : (
                        <Button
                          variant="solid"
                          type="button"
                          onClick={() => {
                            if (ticketData.length == 0) {
                              setAddseasionerror(true);
                            } else {
                              setAddseasionerror(false);
                            }

                            if (values.VideoType == 0) {
                              setAddSynopsiserror(true);
                            } else {
                              setAddSynopsiserror(false);
                            }
                          }}
                        >
                          Save
                        </Button>
                      )}
                      &nbsp;
                      <Link to={CLIENT.USA_Forbes == Channel.label ? '/templatemaster' : path == '/addEventTeamPlaner' ? '/EventTeamPlaner' : '/ContentMaster'}>
                        <Button type="button">Discard</Button>
                      </Link>
                    </div>
                  </FormItem>
                </FormContainer>
              </div>
            </Card>
          </Form>
        )}
      </Formik>
    </div>
  );
};

export default ContentEdit;
