import React, { useContext, useEffect, useState } from 'react';
import { Button, Card, Spinner, Tooltip } from 'components/ui';
import { IoMdClose } from 'react-icons/io';
import { handleFeatureClose } from '../../utils/utils';
import {
  featuresEnum,
  rowDataTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { getProgramsWithSegment } from './utils';
import { useSelector } from 'react-redux';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import AutoScrollTable from '../AutoScrollTable/AutoScrollTable';
import { CHANGE_PROGRAM_COLUMNS } from 'views/Scheduling/Scheduler/constants';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

function ChangeProgram() {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* CONTEXT */
  const {
    date,
    schedulingTableData,
    setSecondaryTableData,
    setActiveFeatures,
    schedulingTableRef,
    resetSecondaryTableStates,
  } = useContext(SchedulerContext);

  /* STATES */
  const [programsTableData, setProgramsTableData] = useState([]);
  const [showLoader, setShowLoader] = useState(false);

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        setShowLoader(true);
        const programsWithSegment = await getProgramsWithSegment(
          channel,
          date,
          schedulingTableData,
        );
        setSecondaryTableData(programsWithSegment);
        setProgramsTableData(
          programsWithSegment.filter(
            (row) => row.F_C_S_P === rowDataTypesEnum.CONTENT_TERMINATION,
          ),
        );
        setShowLoader(false);
      } catch (error) {
        setShowLoader(false);
        openNotification(
          'danger',
          'Something went wrong while fetching programs',
        );
        console.error(error);
      }
    })();
  }, [schedulingTableData]);

  /* EVENT HANDLERS */
  const handleRowClick = (row) => {
    try {
      let matchedFPCTimeRowIndex = schedulingTableData.findIndex(
        (schTableRow) => schTableRow.FPC_Time === row.FPC_Time,
      );
      if (matchedFPCTimeRowIndex !== -1) {
        schedulingTableRef.current?.scrollToItem(
          schedulingTableData.findIndex(
            (schTableRow) => schTableRow.FPC_Time === row.FPC_Time,
          ),
          'center',
        );
      } else openNotification('danger', 'Program not present in schedule');
    } catch (error) {
      openNotification('danger', 'Something went wrong while auto scrolling');
      console.error(error);
    }
  };

  return (
    <div className="h-full w-full flex flex-col overflow-auto no-scrollbar bg-gray-800 p-3 pt-2 rounded-lg">
      <div className="flex justify-between items-center mb-2">
        <div className="flex items-center gap-3">
          <h5>Programs</h5>
          {programsTableData.length > 0 && (
            <h6 className="rounded-md px-1.5 py-0.5 bg-gray-600 flex items-center justify-center">
              {programsTableData.length}
            </h6>
          )}
        </div>
        <div className="flex gap-1.5">
          <Tooltip title="Close">
            <Button
              size="xs"
              icon={<IoMdClose />}
              onClick={() =>
                handleFeatureClose(
                  setActiveFeatures,
                  featuresEnum.CHANGE_PROGRAM,
                  resetSecondaryTableStates,
                )
              }
            />
          </Tooltip>
        </div>
      </div>
      <div className="h-[92%] flex flex-col gap-3">
        {programsTableData.length > 0 ? (
          <div className="grow">
            <AutoScrollTable
              tableData={programsTableData}
              columns={CHANGE_PROGRAM_COLUMNS}
              scrollFunction={(row) => handleRowClick(row)}
            />
          </div>
        ) : (
          <Card
            className="h-full"
            bodyClass="h-full flex justify-center items-center"
          >
            {showLoader ? <Spinner size="45px" /> : 'No programs to show'}
          </Card>
        )}
      </div>
    </div>
  );
}

export default ChangeProgram;
