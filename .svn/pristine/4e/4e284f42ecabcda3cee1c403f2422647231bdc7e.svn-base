import { useState, forwardRef, useRef, useEffect } from 'react';
import { useSelector } from 'react-redux';
import { useNavigate } from 'react-router-dom';
import { Formik, Form, Field } from 'formik';
import * as Yup from 'yup';
import {
  Button,
  Input,
  FormContainer,
  FormItem,
  Upload,
  Tooltip,
  Select,
  DatePicker,
} from 'components/ui';
import { PutContentsports, apisendnotification } from 'services/ProgrammingService';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import { CLIENT } from 'views/Controls/clientListEnum';
import Loader from 'views/Controls/Loader';
import axios from 'axios';
import { FcImageFile } from 'react-icons/fc';
import { GrClose } from 'react-icons/gr';
import { convertDateToYMD } from 'components/validators';
import { apiGetLocalEventMasterDropBySubGenre, apiPostTeamMaster, apiPutTeamMaster } from 'services/EventServices';
import { stringify } from 'postcss';

const DefaultImage = 'https://cloudbats.planetcast.in/download.jpg';

const validationSchema = Yup.object().shape({
  TeamName: Yup.string().min(1, 'Too Short!').max(50, 'Too Long!').required('Team Name Required'),
  ShortName: Yup.string().min(1, 'Too Short!').max(10, 'Too Long!').required('Short Name Required'),
  CategoryCode: Yup.string().required('Category Required'),
  CountryCode: Yup.string().required('Country Required'),
  //ocalEventCode: Yup.string().required('Local Event Required'),
  LocalEventCode: Yup.array()
    .of(Yup.string().required())
    .min(1, 'At least one local event must be selected')
    .required('Local Event is required'),
  SubGenerCode: Yup.string().required('Sport Type Required'),
  IsActive: Yup.boolean().required('Status Required'),
});

const TeamEdit = forwardRef(({ onDrawerClose, editData, country, subGenres, category }, ref) => {
  const { selectedChannel: channel, auth: { session: { token, Username } } } = useSelector((state) => state);
  const [loading, setLoading] = useState(false);
  const [localEvent, setLocalEvent] = useState([]);
  const [previewSource, setPreviewSource] = useState(editData?.Team_Image || '');
  console.log('editData', editData);

  useEffect(() => {
    if (editData?.TeamCode) {
      GetLocalEvent(editData?.SubGenerCode)
    }
  }, [editData])


  const handleAddSubmit = async (values) => {
    setLoading(true);
    try {
      const payload = {
        TeamCode: editData?.TeamCode,
        TeamName: values.TeamName,
        ShortName: values.ShortName,
        CategoryCode: values.CategoryCode,
        CountryCode: values.CountryCode,
        SubGenerCode: values.SubGenerCode,
        LocalEventmap: values.LocalEventCode || [],
        //LocalEventmap: (values.LocalEventCode || []).map(code => ({ LocalEventCode: code })),
        Team_Image: previewSource,
        IsActive: 1
      };

      console.log('payload', payload);

      if (editData[0] === "") {
        console.log('Add Team');

        const res = await apiPostTeamMaster(payload);
        if (res.status === 204) {
          openNotification('danger', 'Event Already Exists');
        }

        else if (res.status === 200) {
          await apisendnotification({
            NotificationId: (Math.random() + 1).toString(36).substring(7),
            user_ids: [10],
            message: `${values.TeamName} Event Updated`,
            image: '',
            type: '1',
            location: 'Event Updated',
            locationLabel: Username,
            Status: '1',
            isGroup: 1,
            Ispriority: 1,
            readed: 0,
          });
          openNotification('success', 'Team Added Successfully');
          onDrawerClose(0, 0);
        }
      }
      else {
        console.log('Edit Team');

        const response = await apiPutTeamMaster(payload);
        if (response.status === 204) {
          openNotification('danger', 'Event Already Exists');
        } else if (response.status === 200) {
          await apisendnotification({
            NotificationId: (Math.random() + 1).toString(36).substring(7),
            user_ids: [10],
            message: `${values.TeamName} Event Updated`,
            image: '',
            type: '1',
            location: 'Event Updated',
            locationLabel: Username,
            Status: '1',
            isGroup: 1,
            Ispriority: 1,
            readed: 0,
          });
          openNotification('success', 'Team Updated Successfully');
          onDrawerClose(0, 0);
        }
      }

    } catch (error) {
      openNotification('danger', error.response?.status === 500 ? 'Server Error' : 'Failed to add event');
    } finally {
      setLoading(false);
    }
  };


  const beforeUpload = (file) => {
    const allowedFileType = ['image/jpeg', 'image/png'];
    const maxFileSize = 5000000;
    if (!allowedFileType.includes(file.type)) return 'Please upload a .jpeg or .png file!';
    if (file.size > maxFileSize) return 'Image cannot exceed 5MB!';
    return true;
  };

  const GetLocalEvent = (SubGenreCode) => {
    (async () => {
      console.log('Sanket');
      const LocalEvent = await apiGetLocalEventMasterDropBySubGenre(SubGenreCode);
      const formattedOptions = LocalEvent.data.map((option) => ({
        value: option.LocalEventCode,
        label: option.LocalEventName,
      }));
      setLocalEvent(formattedOptions);
    })();
  }

  return (
    <div>
      <Loader showLoader={loading} />
      {/* ${JSON.stringify(editData)} */}
      <Formik
        innerRef={ref}
        initialValues={{
          TeamCode: editData?.TeamCode || '',
          TeamName: editData?.TeamName || '',
          ShortName: editData?.ShortName || '',
          CategoryCode: editData?.CategoryCode || '',
          CountryCode: editData?.CountryCode || '',
          LocalEventCode:
            editData?.LocalEventmap?.map(event => event.LocalEventCode) || [],
          SubGenerCode: editData?.SubGenerCode || '',
          Team_Image: previewSource || '',
          IsActive: editData?.IsActive || false,
        }}
        validationSchema={validationSchema}
        onSubmit={(values, { resetForm, setSubmitting }) => {
          handleAddSubmit(values)
            .then(() => {
              resetForm();
              setSubmitting(false);
            })
            .catch(() => {
              setSubmitting(false);
            });
        }}
      >
        {({ values, touched, errors, setFieldValue }) => (
          <Form>
            {/* ${JSON.stringify(values)} */}
            <FormContainer>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <FormItem label="Team Name" asterisk invalid={errors.TeamName && touched.TeamName} errorMessage={errors.TeamName}>
                  <Field type="text" name="TeamName" placeholder="Team Name" component={Input} size="sm" maxLength={50} />
                </FormItem>
                <FormItem label="Short Name" asterisk invalid={errors.ShortName && touched.ShortName} errorMessage={errors.ShortName}>
                  <Field type="text" name="ShortName" placeholder="Event Name" component={Input} size="sm" maxLength={50} />
                </FormItem>

                <FormItem label="Category" asterisk invalid={errors.CategoryCode && touched.CategoryCode} errorMessage={errors.CategoryCode}>
                  <Field name="CategoryCode">
                    {({ field, form }) => (
                      <Select
                        {...field}
                        options={category}
                        value={category.find((opt) => opt.value === values.CategoryCode)}
                        onChange={(opt) => form.setFieldValue('CategoryCode', opt?.value)}
                        size="sm"
                      />
                    )}
                  </Field>
                </FormItem>
                <FormItem label="Country" asterisk invalid={errors.CountryCode && touched.CountryCode} errorMessage={errors.CountryCode}>
                  <Field name="CountryCode">
                    {({ field, form }) => (
                      <Select
                        {...field}
                        options={country}
                        value={country.find((opt) => opt.value === values.CountryCode)}
                        onChange={(opt) => form.setFieldValue('CountryCode', opt?.value)}
                        size="sm"
                      />
                    )}
                  </Field>
                </FormItem>
                <FormItem label="Sport Type" asterisk invalid={errors.SubGenerCode && touched.SubGenerCode} errorMessage={errors.SubGenerCode}>
                  <Field name="SubGenerCode">
                    {({ field, form }) => (
                      <Select
                        {...field}
                        options={subGenres}
                        value={subGenres.find((opt) => opt.value === values.SubGenerCode)}
                        //onChange={(opt) => form.setFieldValue('SubGenerCode', opt?.value)}
                        onChange={
                          (opt) => {
                            form.setFieldValue('SubGenerCode', opt?.value || '')
                            GetLocalEvent(opt?.value)
                          }
                        }

                        size="sm"
                      />
                    )}
                  </Field>
                </FormItem>

                {/* <FormItem label="Local Event" asterisk invalid={errors.LocalEventCode && touched.LocalEventCode} errorMessage={errors.LocalEventCode}>
                  <Field name="LocalEventCode">
                    {({ field, form }) => (
                      <Select
                        {...field}
                        options={localEvent}
                        value={localEvent.find((opt) => opt.value === values.LocalEventCode)}
                        onChange={(opt) => form.setFieldValue('LocalEventCode', opt?.value)}
                        size="sm"
                      />
                    )}
                  </Field>
                </FormItem> */}

                <FormItem
                  label="Local Event"
                  asterisk
                  invalid={errors.LocalEventCode && touched.LocalEventCode}
                  errorMessage={errors.LocalEventCode}
                >
                  <Field name="LocalEventCode">
                    {({ field, form }) => {
                      const selectedValues = localEvent.filter(opt =>
                        (form.values.LocalEventCode || []).includes(opt.value)
                      );
                      return (
                        <Select
                          isMulti
                          placeholder="Select"
                          options={localEvent}
                          value={selectedValues}
                          onChange={(selectedOptions) => {
                            const values = selectedOptions
                              ? selectedOptions.map(opt => opt.value)
                              : [];
                            form.setFieldValue('LocalEventCode', values);
                          }}
                          size="sm"
                          styles={{
                            valueContainer: (base) => ({
                              ...base,
                              padding: '5px 8px',
                            }),
                            multiValue: (base) => ({
                              ...base,
                              marginRight: '8px',
                              marginBlock: '5px',
                              color: 'white',
                              fontWeight: '400',
                            }),
                            multiValueLabel: (base) => ({
                              ...base,
                              fontWeight: '400',
                            }),
                            input: (base) => ({
                              ...base,
                              color: 'white',
                            }),
                          }}
                        />
                      );
                    }}
                  </Field>
                </FormItem>

                <FormItem label="Team Image" invalid={errors.Team_Image && touched.Team_Image} errorMessage={errors.Team_Image}>
                  <Field name="Team_Image">
                    {({ field, form }) => (
                      <Upload
                        uploadLimit={1}
                        beforeUpload={beforeUpload}
                        showList={false}
                        onChange={(files) => {
                          const file = files[0];
                          if (file) {
                            const reader = new FileReader();
                            reader.onloadend = () => {
                              setPreviewSource(reader.result);
                              form.setFieldValue('Team_Image', file);
                            };
                            reader.readAsDataURL(file);
                          } else {
                            setPreviewSource(DefaultImage);
                            form.setFieldValue('Team_Image', '');
                          }
                        }}
                      >
                        <div className="border-dashed border-gray-500 border-2 p-3 rounded-lg hover:cursor-pointer">
                          {previewSource ? (
                            <div className="flex items-center justify-center relative">
                              <Tooltip title="Click to upload image">
                                <img src={previewSource} alt="Preview" className="hover:opacity-80" style={{ height: '150px', width: 'auto' }} />
                              </Tooltip>
                              <Tooltip title="Remove Image" wrapperClass="absolute -top-3 -right-3">
                                <Button
                                  shape="circle"
                                  size="xs"
                                  variant="solid"
                                  color="red-500"
                                  icon={<GrClose />}
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    setPreviewSource(DefaultImage);
                                    form.setFieldValue('Team_Image', '');
                                  }}
                                />
                              </Tooltip>
                            </div>
                          ) : (
                            <div className="h-28 flex flex-col items-center justify-center">
                              <Tooltip title="Click to upload image">
                                <FcImageFile size={25} />
                                <p className="text-xs mt-1 opacity-60">Support: jpeg, png (Max 5MB)</p>
                              </Tooltip>
                            </div>
                          )}
                        </div>
                      </Upload>
                    )}
                  </Field>
                </FormItem>
              </div>
            </FormContainer>
          </Form>
        )}
      </Formik>
    </div>
  );
});

export default TeamEdit;