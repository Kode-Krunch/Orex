import {
  Button,
  Card,
  Checkbox,
  DatePicker,
  Dropdown,
  Input,
  Select,
  Tabs,
  Tooltip,
  Upload,
} from 'components/ui';
import React, { useEffect, useMemo, useRef, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { apiGetBrandasperclient } from 'services/CreditcontrolService';
import {
  DealDeatilsGlobel,
  DealMasterGlobel,
} from 'views/Controls/DealDeatilsGlobel';
import { useDispatch, useSelector } from 'react-redux';
import CommercialTypeDropNew from 'views/Controls/CommercialTypeDropNew';
import {
  apiGetCommercialClientBrandwisedrop,
  apiGetPositionDrop,
  apiGetSpotPositionDrop,
  apiGetTrafficDayCloseByDateRange,
  apiUSP_SA_RO_SpotSchedule,
} from 'services/SalesAdminService';
import DatePickerRange from 'components/ui/DatePicker/DatePickerRange';
import DateRangeInputs from './DateRangeInputs';
import { Container, StickyFooter } from 'components/shared';
import { setdateForm } from 'store/locale/localeSlice';
import SearchInputBooking from 'views/Controls/SearchInputBooking';
import { apiGetdealsearchdrop } from 'services/BookingService';
import {
  apiCallforbookdeatil,
  apiGetdealdetailId,
  apibookingattachmentBYID,
  apidealmasterBYBookingNumber,
  apidealmasterBYID,
} from 'services/DealServices';
import { setDealData, setDealDataDetails } from 'store/auth/userSlice';
import { convertDateToYMD } from 'components/validators';
import {
  FORMATDATE_FOR_EVERY,
  formatDateToDDMMMYYYY,
  generateMultiYearMonthOptions,
  hideCursorLoader,
  numberToINRFormat,
  openNotification,
  SEND_NOTIFICATION,
  showCursorLoader,
} from 'views/Controls/GLOBALFUNACTION';
import dayjs from 'dayjs';
import ReportsTable from 'views/Controls/ReportsTable/ReportsTable';
import appConfig from 'configs/app.config';
import { VscRecord } from 'react-icons/vsc';
import HeaderExtra from 'views/Controls/HeaderExtra';
import { apiCallstoreprocedure } from 'services/CommonService';
import Loader from 'views/Controls/Loader';
import {
  HiOutlineHome,
  HiOutlineUser,
  HiOutlineArrowNarrowLeft,
} from 'react-icons/hi';
import { Dialog as Dialogg } from 'primereact/dialog';
import { FaFileExcel, FaFilePdf, FaRegSave } from 'react-icons/fa';
import { CLIENT } from 'views/Controls/clientListEnum';
import { MdAddCircle } from 'react-icons/md';
import AttachmentRow from 'views/Deal/DealMaster/AttachmentRow';
import { REQUEST_HEADER_AUTH_KEY, TOKEN_TYPE } from 'constants/api.constant';
import RoImportCalendar from './RoImportCalendar/RoImportCalendar';
import { endOfMonth, startOfMonth } from 'date-fns';
import { hideStackedSideNav_secondary } from 'views/Scheduling/general';
import SelectXs from 'views/Controls/SelectXs/SelectXs';
import ShowBookingFooter from './ShowBookingFooter';
import {
  convertRoCalendarDataToExcel,
  generateCustomArray,
  getDataForAddDealLine,
  getDataForRoCalendar,
  isAllDealLineHaveSpots,
  isAllFieldsValid,
} from './utils';
import {
  ALLOWED_EXCEL_FILE_TYPES,
  ALLOWED_FILE_TYPES,
  ALLOWED_PDF_FILE_TYPES,
  daysOfWeek,
} from './constants';
import Lottie from 'lottie-react';
import documentOcrScanAnimation from './Document_OCR_Scan.json';
import { IoMdInformationCircleOutline } from 'react-icons/io';
import AdvancedBreakupDialog from './AdvancedBreakupDialog';
const { TabNav, TabList, TabContent } = Tabs;
const ToolbarOptionsBooking = { groupBy: true, manageColumns: true };
const { apiPrefix } = appConfig;

const PdfButton = ({ disabled }) => (
  <Button
    variant="solid"
    color="red-500"
    size="sm"
    className="!px-2 !py-1"
    icon={<FaFilePdf className="text-base" />}
    disabled={disabled}
  >
    PDF
  </Button>
);

const XlsButton = ({ disabled }) => (
  <Button
    variant="solid"
    color="green-700"
    size="sm"
    className="!px-2 !py-1"
    icon={<FaFileExcel className="text-base" />}
    disabled={disabled}
  >
    XLS
  </Button>
);

const BookingMaster = () => {
  // Pre-Processing
  const currentHref = window.location.href; // Get the full URL
  const hashPart = currentHref.split('#')[1]; // Get the part after the '#'
  const spotBooking = hashPart ? hashPart.split('/')[1] : ''; // Extract "SpotBooking"
  const Path =
    spotBooking === 'RoImportDetails'
      ? 0
      : spotBooking === 'BookingDetails'
        ? 0
        : 1;

  console.log('Path', Path);
  console.log('spotBooking', spotBooking);

  /* REDUX */
  const { Content } = useSelector((state) => state.base.common);
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const { DealDataDetails, DealData } = useSelector((state) => state.auth.user);
  const token = useSelector((state) => state.auth.session.token);
  const dispatch = useDispatch();
  const channelSettings = useSelector(
    (state) => state.auth.session.ChannelSetting,
  );
  const curChannelSettings = channelSettings?.filter(
    (channel) =>
      channel.Channel.ChannelCode === Channel.ChannelCode &&
      channel.locations.LocationCode === Channel.LocationCode,
  )[0];

  /* STATES */
  const [bookingAttachment, setBookingAttachment] = useState(null);
  const [AvailableAmt, setAvailableAmt] = useState(0);

  const [currentTab, setCurrentTab] = useState('tab1');
  const [IsNTCPage, setIsNTCPage] = useState();
  const [ManagedColumnBookings, setManagedColumnBookings] = useState([]);
  const [ManagedColumnBookings2, setManagedColumnBookings2] = useState([]);
  const [The_data_I_want_To_Upload, setThe_data_I_want_To_Upload] = useState();
  const [SelectedItem, setSelectedItem] = useState(Content ? Content : []);
  const [TableColumns, setTableColumns] = useState([]);
  const [checkedItems, setCheckedItems] = useState([]);
  const [brandOptions, setBrandOptions] = useState([]);
  const [position, setposition] = useState([]);
  const [trafficDayList, setTrafficDayList] = useState([]);
  const [dialogIsOpen, setIsOpen] = useState(false);
  const [dialogIsOpen2, setIsOpen2] = useState(false);
  const [showLoader, setShowLoader] = useState(false);
  const [ScheduleButton, setScheduleButton] = useState(false);
  const [spotposition, setspotposition] = useState([]);
  const [commercial, setcommercial] = useState([]);
  const [Dealdata2, setDealdata2] = useState([]);
  const [checkboxList, setCheckboxList] = useState([]);
  const [checkboxListDay, setCheckboxListDay] = useState([]);
  const [checkboxListDD, setCheckboxListDD] = useState([]);
  const [checkboxListDDCom, setCheckboxListDDCom] = useState([]);
  const [checkboxListCommercial, setCheckboxListCommercial] = useState([]);
  const [valueInsert, setValueInsert] = useState('');
  const [valueInsertDateRange, setValueInsertDateRange] = useState([
    null,
    null,
  ]);
  const [checkedAlternateDays, setCheckedAlternateDays] = useState(false);
  const [formState, setFormState] = useState({
    MID: 2,
    position: 3,
    brand: Content?.BrandMaster?.BrandCode,
    datesrange: [],
    Commercial: [],
    date: new Date(),
    BookingRefNumber: Content?.BookingRefNumber
      ? Content?.BookingRefNumber
      : '',
  });
  const [showSpotdata, setshowSpotdata] = useState({
    BONUS: 0,
    PAID: 0,
    Drop: 0,
    Cancelled: 0,
    spotAmountSum: 0,
    lengthof: 0,
  });
  const [collapse, setCollapse] = useState(false);
  const [Data, setData] = useState([]);
  const [myid, setmyid] = useState();
  const [Deatils, setDeatils] = useState([]);
  const [newBookSpotDeatils, setnewBookSpotDeatils] = useState([]);
  const [ShowBookingSpots, setShowBookingSpots] = useState([]);
  const [SpotCopy, setSpotCopy] = useState([]);
  const [checked, setChecked] = useState(false);
  const [InputValue, setInputValue] = useState('');
  const [selectedFile, setSelectedFile] = useState('');
  const [SelectMonth, setSelectMonth] = useState(null);
  const [fileExtension, setFileExtension] = useState('');
  const [roCalendarData, setRoCalendarData] = useState([]); // State for blank dialog
  const [storePDFData, setStorePDFData] = useState([]); // State for blank dialog
  const [isAdvancedBreakupDialogOpen, setIsAdvancedBreakupDialogOpen] =
    useState(false);

  /* HOOKS */
  const columns = useMemo(
    () => [
      {
        header: 'Commercial',
        accessorKey: 'Commercial',
      },
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',
      },
      {
        header: 'Schedule Time',
        accessorKey: 'ScheduleTime',
      },
      {
        header: 'Content',
        accessorKey: 'ContentName',
      },
      {
        header: 'Break',
        accessorKey: 'BreakNumber',
      },
      {
        header: 'Position',
        accessorKey: 'PositionNumber',
      },
      {
        header: 'Spot',
        accessorKey: 'SpotPosition',
      },
      {
        header: 'Time Band',
        accessorKey: 'TimeBand',
      },
      {
        header: 'Spot Type',
        accessorKey: 'SpotType',
      },
      {
        header: 'Commercial',
        accessorKey: 'Commercial',
      },
      {
        header: 'VideoID',
        accessorKey: 'VideoID',
      },
      {
        header: 'Duration',
        accessorKey: 'Duration',
      },
      {
        header: 'Spot Rate',
        accessorKey: 'SpotRate',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}{' '}
                {row.SpotRate.toLocaleString('en-IN')}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Spot Amount',
        accessorKey: 'SpotAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}{' '}
                {row.SpotAmount.toLocaleString('en-IN')}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Status',
        accessorKey: 'BookingStatus',
      },
      {
        header: 'SpotStatus',
        accessorKey: 'SpotStatus',
      },
    ],
    [],
  );
  const BookingDetailsColumn = useMemo(
    () => [
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',
      },
      {
        header: 'Commercial Caption',
        accessorKey: 'CommercialCaption',
      },
      {
        header: 'Commercial Dur',
        accessorKey: 'CommercialDuration',
      },
      {
        header: 'Amount',
        accessorKey: 'TotalAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(
                  Number(row.TotalAmount || row.TotalSpot * row.Rate),
                )}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Schedule Spot',
        accessorKey: 'AddedSpotCount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {row.AddedSpotCount || row.SpotCount}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Total Spot',
        accessorKey: 'SpotCount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {row.SpotCount || row.TotalSpot}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Remark',
        accessorKey: 'Remark',
      },
    ],
    [],
  );
  const BookingDetailsColumnSummary = useMemo(
    () => [
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',
      },
      {
        header: 'Schedule Time',
        accessorKey: 'ScheduleTime',
      },
      {
        header: 'Content Name',
        accessorKey: 'ContentName',
      },
      {
        header: 'Commercial Caption',
        accessorKey: 'CommercialCaption',
      },
      {
        header: 'Brk',
        accessorKey: 'BreakNumber',
      },
      {
        header: 'BookingStatus',
        accessorKey: 'BookingStatus',
      },
      {
        header: 'SpotStatus',
        accessorKey: 'SpotStatus',
      },
      {
        header: 'TimeBand',
        accessorKey: 'TimeBandName',
      },
      {
        header: 'House ID',
        accessorKey: 'HouseID',
      },
      {
        header: 'Spot Rate',
        accessorKey: 'SpotRate',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(Number(row.SpotRate))}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Spot Amount',
        accessorKey: 'SpotAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(Number(row.SpotAmount))}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Billed',
        accessorKey: 'IsBilled',
      },
    ],
    [],
  );
  const navigate = useNavigate();
  const roImportCalendarContainerRef = useRef(null);

  /* USE EFFECTS */
  useEffect(() => {
    hideStackedSideNav_secondary();
    setTableColumns(columns);
    (async (values) => {
      const resp = await apiGetPositionDrop(values);
      const formattedOptions = resp.data.map((option) => ({
        value: option.PositionCode,
        label: option.PositionName,
      }));
      setposition(formattedOptions);
    })();
    (async (values) => {
      const resp = await apiGetSpotPositionDrop(values);
      const formattedOptions = resp.data.map((option) => ({
        value: option.SpotPositionTypeCode,
        label: option.SpotPositionTypeName,
      }));
      setspotposition(formattedOptions);
    })();
    (async (values) => {
      let Parameters = {
        LocationCode: Channel.LocationCode,
        ChannelCode: Channel.ChannelCode,
        isNTC:
          spotBooking === 'NTCBookingDetails' ||
            spotBooking === 'NTCRoImportDetails'
            ? 1
            : 0,
      };
      const resp = await apiGetdealsearchdrop(Parameters, '%20');
      const formattedOptions = resp.data.map((option) => ({
        value: option.DealNumber,
        label:
          option.DealCode +
          ' | ' +
          option.ClientName +
          ' | ' +
          option.AgencyName +
          ' [' +
          formatDateToDDMMMYYYY(option.DealPeriodFromDate) +
          ' To ' +
          formatDateToDDMMMYYYY(option.DealPeriodToDate) +
          '] ',
      }));
      setDealdata2(formattedOptions);
    })();
    dispatch(setDealData([]));
    dispatch(setDealDataDetails([]));
    dispatch(
      setdateForm([
        '',
        spotBooking === 'RoImportDetails'
          ? 'RO Import'
          : spotBooking === 'NTCRoImportDetails'
            ? 'NTC RO Import'
            : spotBooking === 'BookingDetails'
              ? 'Spot Booking'
              : 'Spot NTC Booking',
      ]),
    );
    const gboxElement2 = document.getElementsByClassName('Gbox19')[0];
    const gboxElement1 = document.getElementsByClassName('Gbox10')[0];
    const gboxElement = document.getElementsByClassName('Gbox2')[0];
    gboxElement.style.display = 'block';
    gboxElement1.style.display = 'flex';
    gboxElement2.style.display = 'none';
    return () => {
      gboxElement.style.display = 'none';
      gboxElement1.style.display = 'none';
      gboxElement2.style.display = 'flex';
    };
  }, []);

  useEffect(() => {
    setIsNTCPage(Path);
    if (DealData?.DealPeriodFromDate) {
      (async () => {
        const resp = await apiGetTrafficDayCloseByDateRange(
          DealData?.DealPeriodFromDate,
          DealData?.DealPeriodToDate,
          Channel,
          token,
        );
        if (resp.status == 204) {
          setTrafficDayList([]);
          return;
        }
        setTrafficDayList(resp.data);
      })();
    }
    setAvailableAmt(DealData?.RecdAmt);
  }, [Path, DealData]);

  useEffect(() => {
    if (Content.Channel?.ChannelCode) {
      if (
        !(
          Content.Channel?.ChannelCode == Channel.ChannelCode &&
          Content.locations?.LocationCode == Channel.LocationCode
        )
      ) {
        navigate(
          spotBooking === 'RoImportDetails'
            ? '/RoImport'
            : spotBooking === 'NTCRoImportDetails'
              ? '/NTCRoImport'
              : spotBooking === 'BookingDetails'
                ? '/SpotBooking'
                : '/NtcSpotBooking',
        );
      }
    }
  }, [Channel]);

  useEffect(() => {
    (async (values) => {
      const resp = await apiCallforbookdeatil(
        'GetBookingDetail',
        Content?.BookingNumber,
      );

      //const resp = await apiGetclientmasterdropmaster(values)

      const BONUS = resp.data.filter(
        (item) => item.SpotType.toUpperCase() === 'BONUS',
      ).length;
      const PAID = resp.data.filter((item) =>
        item.SpotType.toUpperCase() === 'PAID' && myid
          ? item.DealLineItemNo === myid
          : true,
      ).length;
      const Drop = resp.data.filter(
        (item) => item.BookingStatus.toUpperCase() === 'E',
      ).length;
      const Cancelled = resp.data.filter(
        (item) => item.BookingStatus.toUpperCase() === 'C',
      ).length;
      // Convert the result to a JSON string for better logging output

      const result = resp.data
        .filter((item) => (myid ? item.DealLineItemNo === myid : true))
        .reduce(
          (acc, item) => {
            if (item.BookingStatus) {
              acc.bookingStatusCount++;
              acc.spotAmountSum +=
                Number(item.SpotRate) * Number(parseDurationE(item.Duration));
            }
            return acc;
          },
          { bookingStatusCount: 0, spotAmountSum: 0 },
        );

      setshowSpotdata({
        BONUS: BONUS,
        PAID: PAID,
        Drop: Drop,
        Cancelled: Cancelled,
        spotAmountSum: result?.spotAmountSum,
        lengthof: resp.data.filter((item) =>
          myid ? item.DealLineItemNo === myid : true,
        ).length,
      });

      setDeatils(resp.data);

      setSpotCopy(resp.data);
    })();
  }, [Content, myid]);

  useEffect(() => {
    (async (values) => {
      try {
        const Brand = await apiGetBrandasperclient(DealData?.ClientCode);
        if (Brand.status == 200) {
          const brandOptions =
            Brand.data != ''
              ? Brand.data.map((option) => ({
                value: option.BrandMaster.BrandCode,
                label: option.BrandMaster.BrandName,
              }))
              : [];
          setBrandOptions(brandOptions);
        }
      } catch (error) {
        if (error.response.status == 404) {
          openNotification('warning', 'Brand Not Found');
        }
        if (error.response.status == 500) {
          openNotification('danger', 'Server Error.');
        }
      }
    })();
  }, [DealData?.ClientCode]);

  useEffect(() => {
    resetRoCalendar();
    if (DealData?.ClientCode && formState?.brand) {
      setcommercial([]);
      (async () => {
        const resp = await apiGetCommercialClientBrandwisedrop(
          formState.brand,
          DealData?.ClientCode,
          Channel.LocationCode,
          Channel.ChannelCode,
          IsNTCPage,
        );

        if (resp.status == 204) {
          setcommercial([]);
          return;
        }

        const clients = resp.data
          .filter((item) => {
            const startDate = item.StartDate ? new Date(item.StartDate) : null;
            const killDate = item.KillDate ? new Date(item.KillDate) : null;

            const rangeStartDate = new Date(formState.datesrange[0]);
            const rangeEndDate = new Date(formState.datesrange[1]);
            if (startDate) {
              if (startDate > rangeStartDate) {
                //||  24-21 startDate < rangeEndDate) {
                return false;
              }
            }

            if (killDate) {
              if (killDate < rangeEndDate) {
                return false;
              }
            }
            return true;
          })
          .map((commercial) => {
            let res = {};
            res.label = `[${commercial.VideoID}] ${commercial.CommercialCaption}`;
            res.value = commercial.CommercialCode;
            res.CommercialCaption = commercial.CommercialCaption;
            res.DurInSec = commercial.DurInSec;
            res.VideoID = commercial.VideoID;

            return res;
          });
        setcommercial(clients);
      })();
    }
  }, [DealData?.ClientCode, formState.brand]);

  useEffect(() => {
    if (Object.keys(SelectedItem).length > 0) {
      (async (values) => {
        try {
          if (SelectedItem?.BookingNumber) {
            const dealmaster = await apidealmasterBYBookingNumber(
              SelectedItem.BookingNumber,
              SelectedItem.value,
            );
            dispatch(setDealData(dealmaster.data));
          } else {
            const dealmaster = await apidealmasterBYID(SelectedItem.value);
            dispatch(setDealData(dealmaster.data));
          }
        } catch (error) { }
      })();
      (async (values) => {
        try {
          const dealdetail = await apiGetdealdetailId(SelectedItem.value);
          dispatch(setDealDataDetails(dealdetail.data));
        } catch (error) { }
      })();
    } else {
      dispatch(setDealData({}));
      dispatch(setDealDataDetails([]));
    }
  }, [SelectedItem]);

  useEffect(() => {
    if (DealData?.BookingNumber) {
      handleBookingAttachmentClick(DealData?.BookingNumber);
    }
  }, [DealData]);

  useEffect(() => {
    setShowLoader(true);
    if (myid) {
      const filteredData =
        myid !== 'Y'
          ? Deatils.filter((i) => i.DealLineItemNo === myid)
          : Deatils;

      const formattedData = filteredData.map((item) => ({
        ...item,
        ScheduleDate: FORMATDATE_FOR_EVERY(item?.ScheduleDate),
      }));

      setShowBookingSpots(formattedData);
    }
    setShowLoader(false);
  }, [myid, Deatils]);

  /* FUNCTIONS */
  const disableCertainDate = (date) => {
    if (trafficDayList.length !== 0) {
      const formattedDate = dayjs(date).format('YYYY-MM-DD');
      const dateObj = trafficDayList.find(
        (item) => item.date === formattedDate,
      );
      if (dateObj && dateObj.IsActive === 1) {
        return false; // Enable date
      }
      return true;
    }
  };

  const onCheckboxChangeDay = (options) => {
    setCheckboxListDay(options);
  };

  const onCheckboxChange = (options) => {
    setCheckboxList(options);
    setCheckboxListDD((previous) => {
      const filteredPrevious = previous.filter((item) =>
        options.includes(item.DealLineItemNo),
      );
      const newItems = DealDataDetails.filter(
        (item) =>
          options.includes(item.DealLineItemNo) &&
          !filteredPrevious.some(
            (existing) => existing.DealLineItemNo === item.DealLineItemNo,
          ),
      );

      // Return a single flat array of objects
      return [...filteredPrevious, ...newItems];
    });
  };

  const onCheckboxChangeCommercial = (options) => {
    setCheckboxListCommercial(options);
    setCheckboxListDDCom((previous) => {
      const filteredPrevious = previous.filter((item) =>
        options.includes(item.value),
      );
      const newItems = formState?.Commercial.filter(
        (item) =>
          options.includes(item.value) &&
          !filteredPrevious.some(
            (existing) => existing[0]?.value === item.value,
          ),
      );
      return [...filteredPrevious, ...newItems];
    });
  };

  const handleApply = () => {
    if (
      !checkboxList.length ||
      !checkboxListCommercial.length ||
      !valueInsertDateRange[0] ||
      !valueInsertDateRange[1] ||
      !valueInsert
    ) {
      return openNotification('warning', 'Please Select All Fields');
    }

    const {
      MID,
      position,
      brand,
      datesrange,
      BookingRefNumber,
      Commercial,
      ...filteredArray
    } = formState;
    const generateDateRange = (start, end) => {
      let dates = [];
      while (start <= end) {
        dates.push(
          start
            .toLocaleDateString('en-GB', {
              day: '2-digit',
              month: 'short',
              year: 'numeric',
            })
            .replace(/ /g, '-'),
        );
        start.setDate(start.getDate() + 1);
      }
      return dates;
    };

    const dateList = generateDateRange(
      valueInsertDateRange[0],
      valueInsertDateRange[1],
    );
    const result = { ...filteredArray };

    checkboxListDD.forEach((deal) => {
      let combinedTotal = 0;
      const weekendNames = (deal.weekendsdetail || []).map(
        (item) => daysOfWeek[item.Day],
      );

      checkboxListDDCom.forEach((commercial) => {
        dateList.forEach((dateStr, i) => {
          const currentDate = new Date(dateStr);
          const dayOfWeek = currentDate.toLocaleString('en-GB', {
            weekday: 'long',
          });
          if (
            !weekendNames.includes(dayOfWeek) ||
            (checkboxListDay.length && !checkboxListDay.includes(dayOfWeek))
          )
            return;
          if (checkedAlternateDays && i % 2 !== 0) return;

          const formattedDate = dateStr.split('-').slice(0, 2).join('-');
          const key = `${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;
          const valueKey = `Y${key}`;

          const newTotal = valueInsert * commercial.DurInSec;
          const maxAllowed =
            deal.DealLineItemTypeCode === 4
              ? deal.NTCBalanceSpots
              : deal.BalancedSpots || deal.BalancedSeconds || 0;

          if (combinedTotal + newTotal > maxAllowed) {
            result[key] = 0;
            result[valueKey] = { value: 0, date: dateStr, total: 0 };
          } else {
            result[key] = valueInsert;
            result[valueKey] = {
              value: valueInsert,
              date: dateStr,
              total: newTotal,
            };
            combinedTotal += newTotal;
          }
        });
      });
    });

    const totals = Object.keys(result).reduce((acc, key) => {
      if (typeof result[key] === 'object') {
        const newKey =
          key.replace(/^Y/, '').split('|').slice(0, 2).join('|') + '|total';
        acc[newKey] = (acc[newKey] || 0) + result[key].value;
      }
      return acc;
    }, {});

    const finalData = {
      MID,
      position,
      brand,
      datesrange,
      BookingRefNumber,
      Commercial,
      ...totals,
      ...result,
    };
    setFormState(finalData);
    setThe_data_I_want_To_Upload(
      generateCustomArray(finalData)
        .map((obj) => `"${Object.keys(obj)[0]}":"${Object.values(obj)[0]}"`)
        .join(','),
    );
    setValueInsertDateRange({});
  };

  const onCollapse = () => {
    setCollapse(!collapse);
  };

  const handleDelete = async (BookingCode) => {
    try {
      setIsOpen2(false);
      const reps = await apiCallstoreprocedure('USP_DELETE_TEMPBooking', {
        par_BookingNumber: BookingCode,
      });

      setData((prevData) =>
        prevData.filter((item) => item.BookingCode !== BookingCode),
      );
    } catch (error) {
      console.error('Error calling stored procedure:', error);
    }
  };

  const handleCheckboxChange = (item, isChecked, index) => {
    if (
      item.BalancedSeconds > 0 ||
      item.NTCBalanceSpots > 0 ||
      item.BalancedSpots > 0
    ) {
      if (isChecked) {
        // If checkbox is checked, add item to checkedItems array with reft: 1
        setCheckedItems((prevItems) => [...prevItems, { ...item, Id: index }]);
      } else {
        // If checkbox is unchecked, remove item from checkedItems array
        setCheckedItems((prevItems) =>
          prevItems.filter((prevItem) => prevItem.Id !== index),
        );
      }
    } else {
      openNotification('warning', 'Over Booking Not Allowed');
      setCheckedItems([]);
    }
  };

  const handleBookingAttachmentClick = async (bookingNumber) => {
    try {
      showCursorLoader();
      const response = await apibookingattachmentBYID(bookingNumber);
      if (response.status === 200) {
        setBookingAttachment(response.data);
      } else if (response.status === 204) {
        setBookingAttachment([]);
      } else {
        setBookingAttachment([]);
        openNotification(
          'danger',
          `Something went wrong while fetching deal attachment. Server responded with status code ${response.status}`,
        );
      }
    } catch (error) {
      openNotification(
        'danger',
        `Something went wrong while fetching deal attachment`,
      );
      console.error(error);
    } finally {
      hideCursorLoader();
    }
  };

  const handleDownloadAndView = async (filename) => {
    try {
      const response = await fetch(
        `${apiPrefix}/bookingattachment/readuploadedfile/${filename}`,
        {
          method: 'GET',
          headers: {
            [REQUEST_HEADER_AUTH_KEY]: `${TOKEN_TYPE}${token}`,
            'Content-Type': 'application/json',
          },
        },
      );
      if (response.status == 204) {
        throw new Error(`Server Error: ${response.status}`);
      }
      if (!response.headers || typeof response.headers.get !== 'function') {
        throw new Error('Invalid response format, expected Response object');
      }

      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const data = await response.json();
        alert(`Text File Content:\n${data.content}`);
      } else {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }
    } catch (error) {
      console.error('Error downloading file:', error);
    }
  };

  const openDialog = (e) => {
    setmyid(e);
    setIsOpen(true);
  };

  const onDialogClose = (e) => {
    setIsOpen(false);
  };

  const onDialogOk = (e) => {
    setIsOpen(false);
  };

  const beforeUpload = (files, fileList) => {
    const invalidFileTypeMessage = 'Please upload an XLSX file!';
    if (fileList.length > 1) {
      return `You can only upload 1 file(s)`;
    }
    const selectedFile = files[0];
    if (!ALLOWED_FILE_TYPES.includes(selectedFile.type)) {
      return invalidFileTypeMessage;
    }
    const fileExt = selectedFile.name.split('.').pop().toLowerCase();
    setSelectedFile(selectedFile);
    setFileExtension(fileExt); // Store file extension in state
    return true; // Allow upload to proceed
  };

  const beforePdfRoFileUpload = (files, fileList) => {
    if (fileList.length > 1) {
      return 'You can only upload 1 file(s)';
    }
    const selectedFile = files[0];
    if (!ALLOWED_PDF_FILE_TYPES.includes(selectedFile.type)) {
      return 'Please upload a pdf file!';
    }
    const fileExt = selectedFile.name.split('.').pop().toLowerCase();
    setSelectedFile(selectedFile);
    setFileExtension(fileExt);
    return true;
  };

  const beforeXlsRoFileUpload = (files, fileList) => {
    if (fileList.length > 1) {
      return 'You can only upload 1 file(s)';
    }
    const selectedFile = files[0];
    if (!ALLOWED_EXCEL_FILE_TYPES.includes(selectedFile.type)) {
      return 'Please upload a xls file!';
    }
    const fileExt = selectedFile.name.split('.').pop().toLowerCase();
    setSelectedFile(selectedFile);
    setFileExtension(fileExt);
    return true;
  };

  const monthOptions2024 = generateMultiYearMonthOptions(
    new Date(DealData?.DealPeriodFromDate),
    new Date(DealData?.DealPeriodToDate),
  );

  const handleRoImportScheduleSpot = async () => {
    try {
      let file;
      if (ALLOWED_EXCEL_FILE_TYPES.includes(selectedFile?.type)) {
        file = selectedFile;
      } else {
        file = convertRoCalendarDataToExcel(
          roCalendarData,
          brandOptions.filter((option) => option.value === formState.brand)[0]
            .label,
        );
      }
      if (SelectMonth[0] && formState?.BookingRefNumber) {
        try {
          const headersList = {
            Accept: '*/*',
            Authorization: `Bearer ${token}`,
          };
          const bodyContent = new FormData();
          // Read the selected file as an ArrayBuffer
          const reader = new FileReader();
          reader.onload = async (event) => {
            const arrayBuffer = event.target.result;
            const blob = new Blob([arrayBuffer], { type: file.type });
            bodyContent.append('file', blob, file.name);
            try {
              setShowLoader(true);
              const response = await fetch(
                `${appConfig.apiPrefix
                }/spotschedule/USP_SA_RO_SpotSchedule_import/?DealNumber=${SelectedItem.value
                }&LocationCode=${Channel.LocationCode}&ChannelCode=${Channel.ChannelCode
                }&month=${SelectMonth}&IsMakeGoodRO=${checked ? 1 : 0
                }${`&BookingNumber=${Content?.BookingNumber ? Content?.BookingNumber : 0
                }`}&BookingRefNumber=${formState?.BookingRefNumber
                }&IsNTC=${IsNTCPage}`,
                {
                  method: 'POST',
                  body: bodyContent,
                  headers: headersList,
                },
              );
              const data = await response.json();
              if (response.status === 204) {
                setShowLoader(false);
                openNotification('warning', 'Data Already Exist');
              } else if (response.status === 200) {
                openNotification('success', 'Ro Imported Successfully');
                setIsOpen2(true);
                setShowLoader(false);
                const formattedData = data.map((item) => ({
                  ...item,
                  ScheduleDate: FORMATDATE_FOR_EVERY(item?.ScheduleDate),
                }));
                setData(formattedData); // Assuming resp.data contains the relevant data
              } else {
                setShowLoader(false);
                openNotification(
                  'danger',
                  `Unexpected Response: ${response.status}`,
                );
              }
            } catch (error) {
              setShowLoader(false);
              console.error('Error during API call:', error);
              openNotification('danger', 'Server Error during file upload.');
            }
          };
          // Read the file as an ArrayBuffer
          reader.readAsArrayBuffer(file);
          setShowLoader(false);
        } catch (error) {
          console.error('Error during file processing:', error);
          openNotification('danger', 'File processing failed.');
        }
      }
    } catch (error) {
      console.error(error);
      openNotification('danger', 'Something went wrong while saving RO');
    } finally {
      setShowLoader(false);
    }
  };

  function parseDurationE(duration) {
    const [hours, minutes, seconds, milliseconds] = duration
      .split(':')
      .map(Number);
    return hours * 3600 + minutes * 60 + seconds;
  }

  function calculateTotal(items) {
    return items?.reduce(
      (sum, item) =>
        sum + Number(item?.TotalAmount || item.Rate * item.SpotCount),
      0,
    );
  }

  function sumAddedSpotCount(items) {
    return items.reduce(
      (sum, item) => sum + Number(item.AddedSpotCount || item.TotalSpot),
      0,
    );
  }

  const processDays = (days) => {
    return Object.entries(days)
      .filter(
        ([key, value]) => value && key !== 'Tape ID' && key !== 'Program/Time',
      )
      .map(([day, value]) => `${day}: ${value}`)
      .join(', ');
  };

  const uploadAttachmentFolder = async (BookingNumber, BookingCode) => {
    const headersList = {
      Accept: '*/*',
      Authorization: `Bearer ${token}`,
    };
    const bodyContent = new FormData();
    try {
      const arrayBuffer = await selectedFile.arrayBuffer();
      const blob = new Blob([arrayBuffer], { type: selectedFile.type });
      bodyContent.append('files', blob, selectedFile.name);

      const response = await fetch(
        `${appConfig.apiPrefix}/bookingattachment/uploadattachment/?BookingNumber=${BookingNumber}?BookingCode=${BookingCode}`,
        {
          method: 'POST',
          body: bodyContent,
          headers: headersList,
        },
      );

      if (response.status == 200) {
        //closeAfter2000ms();
      } else {
        console.error('Error uploading file:', response.statusText);
      }
    } catch (error) {
      console.error('Error uploading file:', error);
    }
  };

  const handleRoImportFileChange = async (files) => {
    try {
      const selectedFile = files[0];
      if (ALLOWED_PDF_FILE_TYPES.includes(selectedFile.type)) {
        setShowLoader(true);
        const bodyContent = new FormData();
        const arrayBuffer = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsArrayBuffer(selectedFile);
          reader.onload = function (event) {
            resolve(event.target.result);
          };
          reader.onerror = function (error) {
            reject(error);
          };
        });
        const blob = new Blob([arrayBuffer], { type: selectedFile.type });
        bodyContent.append('file', blob, selectedFile.name);
        let response = await fetch(
          appConfig.apiPrefix + `/callstoreprocedure/ReadPDFTablesOnly/`,
          {
            method: 'POST',
            body: bodyContent,
            headers: {
              Accept: '*/*',
              Authorization: `Bearer ${token}`,
            },
          },
        );
        response = await response.json();
        setRoCalendarData(
          await getDataForRoCalendar(
            response,
            formState,
            DealData,
            Channel,
            IsNTCPage,
            DealDataDetails,
          ),
        );
      } else if (ALLOWED_EXCEL_FILE_TYPES.includes(selectedFile.type))
        setRoCalendarData([]);
    } catch (error) {
      console.error(error);
    } finally {
      setShowLoader(false);
    }
  };

  const handleAddDealLine = async () => {
    try {
      if (ALLOWED_EXCEL_FILE_TYPES.includes(selectedFile?.type)) {
        setSelectedFile('');
        setFileExtension('');
      }
      setShowLoader(true);
      const newRowData = await getDataForAddDealLine(
        formState,
        DealData,
        Channel,
        IsNTCPage,
        DealDataDetails,
      );
      setRoCalendarData((prev) => [...prev, newRowData]);
    } catch (error) {
      console.error(error);
    } finally {
      setShowLoader(false);
    }
  };

  /* CONSTANTS */
  const currentDate = dayjs();
  const dealPeriodFrom = dayjs(DealData?.DealPeriodFromDate);
  const dealPeriodTo = dayjs(DealData?.DealPeriodToDate);
  // Check if current month is within the deal period
  const isCurrentMonthInDealPeriod =
    currentDate.isAfter(dealPeriodFrom.startOf('month')) &&
    currentDate.isBefore(dealPeriodTo.endOf('month'));
  const defaultMonth = isCurrentMonthInDealPeriod
    ? currentDate.startOf('month').toDate()
    : dealPeriodTo.toDate();
  const tableData =
    storePDFData?.rows?.map((item) => ({
      SPOTTYPE: item.SPOTTYPE,
      Title: item.Days['Title'],
      ProgramTime: item.Days['Program/Time'],
      SpotDur: item.Days['Spot\nDur'],
      PmtType: item.Days['Pmt\nType'],
      Position: item.Days['Position'],
      TotalFCT: item.Days['Total\nFCT'],
      NetSpotRate: item.Days['Net Spot\nRate Per\n10 sec'],
      NoOfSpots: item.Days['No of\nSpots'],
      NetCost: item.Days['Net Cost'],
      Days: processDays(item.Days), // Process Days object into a single string
    })) || [];
  const isAllFieldsValidResult = isAllFieldsValid(
    roCalendarData,
    SelectMonth,
    formState?.BookingRefNumber,
  );
  const isAllDealLineHaveSpotsResult = isAllDealLineHaveSpots(roCalendarData);

  /* HELPER FUNCTIONS */
  const resetRoCalendar = () => {
    setSelectedFile('');
    setFileExtension('');
    setRoCalendarData([]);
  };

  const isPaymentCheck = curChannelSettings?.PaymentCheck === 1 ? true : false;
  const consumedAmt =
    isPaymentCheck && DealDataDetails?.length > 0
      ? DealDataDetails.reduce((sum, item) => sum + item.ConsumedAmount, 0)
      : 0;

  return (
    <Card header={<HeaderExtra Component={'Booking Master'} />}>
      <Container className="h-100">
        <div className="mb-2">
          <div>
            <div className="">
              <div className="m-2 ">
                <SearchInputBooking
                  setCheckedItems={setCheckedItems}
                  SelectedItem={SelectedItem}
                  setSelectedItem={setSelectedItem}
                  data={Dealdata2}
                  placeholder="Search Deal Here..."
                  DealData={DealData}
                  length={The_data_I_want_To_Upload?.length}
                  setFormState={setFormState}
                  setThe_data_I_want_To_Upload={setThe_data_I_want_To_Upload}
                  InputValue={InputValue}
                  setInputValue={setInputValue}
                  Deatils={Deatils}
                ></SearchInputBooking>
                {DealData?.DealNumber ? (
                  <DealMasterGlobel
                    DealData={DealData}
                    onCollapse={onCollapse}
                    collapse={collapse}
                  />
                ) : null}
              </div>
            </div>
          </div>
          <div>
            {SelectedItem ? (
              <DealDeatilsGlobel
                DealData={DealData}
                DealDataDetails={DealDataDetails}
                handleCheckboxChange={handleCheckboxChange}
                setmyid={setmyid}
                openDialog={openDialog}
                Deatils={Deatils}
                checkedItems={checkedItems}
                IsNTCPage={IsNTCPage}
              />
            ) : null}
          </div>
          {isPaymentCheck && DealData && DealDataDetails.length > 0 && (
            <div className="flex justify-end gap-5 mb-2">
              <div className="border-r border-r-gray-700 pr-5">
                <p className="text-base flex items-center gap-1 -mr-2">
                  Advanced Received{' '}
                  <Tooltip title="Amount Breakup">
                    <Button
                      shape="circle"
                      variant="plain"
                      size="xs"
                      icon={<IoMdInformationCircleOutline />}
                      onClick={() => setIsAdvancedBreakupDialogOpen(true)}
                    />
                  </Tooltip>
                  {isAdvancedBreakupDialogOpen && (
                    <AdvancedBreakupDialog
                      isOpen={isAdvancedBreakupDialogOpen}
                      setIsOpen={setIsAdvancedBreakupDialogOpen}
                      dealNo={DealData.DealNumber}
                      currencySymbol={DealData.CurrencySymbol}
                    />
                  )}
                </p>
                <p className="text-gray-200 font-semibold text-lg text-end">
                  {DealData.CurrencySymbol}{' '}
                  {DealData.RecdAmt?.toLocaleString('en-IN')}
                </p>
              </div>
              <div>
                <p className="text-base">Consumed Amount</p>
                <p className="text-gray-200 font-semibold text-lg text-end">
                  {DealData.CurrencySymbol}{' '}
                  {consumedAmt.toLocaleString('en-IN')}
                </p>
              </div>
            </div>
          )}
          <div className="mb-3">
            {DealDataDetails?.length > 0 ? (
              <div className="flex justify-between items-end gap-4">
                <div className="flex items-start gap-4">
                  <div className="mt-[10px]">
                    <Checkbox
                      className="mr-4 lbale"
                      checked={checked}
                      onChange={setChecked}
                      name="IsMakeGoodRO"
                      style={{ marginTop: '-10px' }}
                    >
                      <div>
                        <p className=" lbale" style={{ marginTop: '-10px' }}>
                          Is MakeGood RO
                        </p>
                      </div>
                    </Checkbox>
                    <p className="font-medium text-[12px] text-[red]">
                      (Check for RO Re-airing )
                    </p>
                  </div>
                  <div>
                    <p className="lbale">
                      Booking Ref Number <span style={{ color: 'red' }}>*</span>
                    </p>
                    <Input
                      value={formState?.BookingRefNumber}
                      size="sm"
                      maxLength="20"
                      onChange={(e) => {
                        if (
                          Channel.label !== CLIENT.SATHIYAM_TV &&
                          !/^[a-zA-Z0-9@_\/\\\-&$#()*\[\]\s]*$/.test(
                            e.target.value,
                          )
                        ) {
                          return;
                        }
                        setFormState((prevFormState) => ({
                          ...prevFormState,
                          BookingRefNumber: e.target.value,
                        }));
                      }}
                    />
                  </div>
                  {(spotBooking === 'RoImportDetails' ||
                    spotBooking === 'NTCRoImportDetails') && (
                      <>
                        <div>
                          <p className="lbale">
                            Select Month <span style={{ color: 'red' }}>*</span>
                          </p>
                          <SelectXs
                            placeholder="Select"
                            options={monthOptions2024}
                            onChange={(e) => {
                              setSelectMonth(e.value);
                              resetRoCalendar();
                            }}
                            styles={{
                              menu: (baseStyles) => ({
                                ...baseStyles,
                                zIndex: 10,
                              }),
                            }}
                          ></SelectXs>
                        </div>
                        <div className="w-56">
                          <p className="lbale">
                            Select Brand <span style={{ color: 'red' }}>*</span>
                          </p>
                          <CommercialTypeDropNew
                            selected={formState.brand}
                            setSelected={setFormState}
                            List={brandOptions}
                            name={'brand'}
                          />
                        </div>
                        <div className="flex gap-2 items-end">
                          <div>
                            <p className="lbale">
                              Upload File <span style={{ color: 'red' }}>*</span>
                            </p>
                            {SelectMonth && formState.brand ? (
                              <div className="flex items-center gap-2">
                                <Upload
                                  beforeUpload={beforePdfRoFileUpload}
                                  uploadLimit={1}
                                  showList={false}
                                  onChange={handleRoImportFileChange}
                                  accept=".pdf"
                                >
                                  <PdfButton />
                                </Upload>
                                <Upload
                                  beforeUpload={beforeXlsRoFileUpload}
                                  uploadLimit={1}
                                  showList={false}
                                  onChange={handleRoImportFileChange}
                                  accept=".xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                >
                                  <XlsButton />
                                </Upload>
                              </div>
                            ) : (
                              <div className="flex items-center gap-1">
                                <Tooltip title="Please select month and brand to upload pdf">
                                  <PdfButton disabled={true} />
                                </Tooltip>
                                <Tooltip title="Please select month and brand to upload xls">
                                  <XlsButton disabled={true} />
                                </Tooltip>
                              </div>
                            )}
                          </div>
                          {selectedFile && (
                            <div>
                              {selectedFile.name
                                .split('.')[0]
                                ?.match(/.{1,25}/g)
                                .map((str, index) => (
                                  <p className="text-sm m-0">
                                    {str}
                                    {index ===
                                      selectedFile.name
                                        .split('.')[0]
                                        ?.match(/.{1,25}/g).length -
                                      1
                                      ? `.${selectedFile.name.split('.')[1]}`
                                      : ''}
                                  </p>
                                ))}
                            </div>
                          )}
                        </div>
                      </>
                    )}
                </div>
                <div className="flex justify-end gap-4">
                  {Deatils.length > 0 && (
                    <Button
                      variant="solid"
                      size="sm"
                      onClick={() => openDialog('Y')}
                    >
                      Show Booking
                    </Button>
                  )}
                  {(spotBooking === 'RoImportDetails' ||
                    spotBooking === 'NTCRoImportDetails') && (
                      <>
                        {!SelectMonth || !formState?.brand ? (
                          <Tooltip title="Please select month and brand to add deal line">
                            <Button
                              variant="solid"
                              size="sm"
                              disabled={true}
                              icon={<MdAddCircle />}
                              onClick={handleAddDealLine}
                            >
                              Add Deal Line
                            </Button>
                          </Tooltip>
                        ) : (
                          <Button
                            variant="solid"
                            size="sm"
                            icon={<MdAddCircle />}
                            onClick={handleAddDealLine}
                          >
                            Add Deal Line
                          </Button>
                        )}
                      </>
                    )}
                </div>
              </div>
            ) : null}
          </div>
          {(spotBooking === 'RoImportDetails' ||
            spotBooking === 'NTCRoImportDetails') &&
            SelectedItem.value && (
              <>
                <div ref={roImportCalendarContainerRef} className="mb-3">
                  <RoImportCalendar
                    containerRef={roImportCalendarContainerRef}
                    dateRange={[
                      startOfMonth(new Date(SelectMonth)),
                      endOfMonth(new Date(SelectMonth)),
                    ]}
                    calendarData={roCalendarData}
                    setCalendarData={setRoCalendarData}
                  />
                </div>
                <div className="flex justify-end">
                  {isAllFieldsValidResult &&
                    (selectedFile
                      ? ALLOWED_PDF_FILE_TYPES.includes(selectedFile.type)
                        ? roCalendarData.length > 0
                        : true
                      : roCalendarData.length > 0) &&
                    isAllDealLineHaveSpotsResult ? (
                    <Button
                      onClick={() => handleRoImportScheduleSpot()}
                      variant="solid"
                      type="button"
                      size="sm"
                      icon={<FaRegSave />}
                    >
                      Schedule Spot
                    </Button>
                  ) : (
                    <Tooltip
                      title={
                        !isAllFieldsValidResult
                          ? 'Please fill all mandatory fields'
                          : !selectedFile && roCalendarData.length === 0
                            ? 'Please upload RO File or add deal line'
                            : ALLOWED_PDF_FILE_TYPES.includes(
                              selectedFile.type,
                            ) && roCalendarData.length === 0
                              ? 'Please add atleast 1 deal line'
                              : !isAllDealLineHaveSpotsResult
                                ? 'Please add atleast 1 spot in each deal line'
                                : 'Schedule Spot'
                      }
                    >
                      <Button
                        variant="solid"
                        type="button"
                        size="sm"
                        icon={<FaRegSave />}
                        disabled={true}
                      >
                        Schedule Spot
                      </Button>
                    </Tooltip>
                  )}
                </div>
              </>
            )}
          {checkedItems.length > 0 &&
            (spotBooking === 'BookingDetails' ||
              spotBooking === 'NTCBookingDetails') ? (
            <div>
              <div className="grid grid-cols-4 gap-2">
                <div className=" col-span-1">
                  <p className="lbale">Booking Date</p>
                  <DatePicker
                    value={formState.date}
                    inputFormat="DD-MM-YYYY"
                    defaultMonth={dayjs(new Date())
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    minDate={dayjs(new Date(DealData?.DealPeriodFromDate))
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    maxDate={dayjs(new Date(DealData?.DealPeriodToDate))
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    onChange={(e) => {
                      setFormState((prevFormState) => ({
                        ...prevFormState,
                        date: e,
                      }));
                    }}
                  />
                </div>
                <div className=" col-span-1">
                  <p className="lbale">Date Range</p>
                  <DatePickerRange
                    placeholder="Select date range"
                    defaultMonth={defaultMonth}
                    inputFormat="DD-MM-YYYY"
                    minDate={
                      trafficDayList.length == 0 &&
                      dayjs(
                        new Date(DealData?.DealPeriodFromDate).getDate() >
                          new Date().getDate()
                          ? new Date(DealData?.DealPeriodFromDate)
                          : new Date(),
                      )
                        .subtract(0, 'day')
                        .startOf('day')
                        .toDate()
                    }
                    maxDate={
                      trafficDayList.length == 0 &&
                      dayjs(new Date(DealData?.DealPeriodToDate))
                        .subtract(0, 'day')
                        .startOf('day')
                        .toDate()
                    }
                    disableDate={disableCertainDate}
                    onChange={(e) => {
                      setFormState({
                        MID: 2,
                        position: 3,
                        brand: Content?.BrandMaster?.BrandCode,
                        datesrange: [],
                        BookingRefNumber: Content?.BookingRefNumber
                          ? Content?.BookingRefNumber
                          : '',
                      });
                      setFormState((prevFormState) => ({
                        ...prevFormState,
                        datesrange: e,
                      }));
                    }}
                  />
                </div>
                <div className=" col-span-2">
                  {!Content.BrandMaster?.BrandCode &&
                    formState.datesrange[0] &&
                    formState.datesrange[1] && (
                      <div>
                        {' '}
                        <p className="lbale">Brand </p>
                        <CommercialTypeDropNew
                          selected={formState.brand}
                          setSelected={setFormState}
                          List={brandOptions}
                          name={'brand'}
                        />
                      </div>
                    )}
                  {Content.BrandMaster?.BrandCode && (
                    <div>
                      <p className="lbale">Brand</p>
                      <Input value={Content.BrandMaster?.BrandName} disabled />
                    </div>
                  )}
                </div>
              </div>
              <div className="grid grid-cols-5 gap-2">
                <div className=" col-span-1">
                  <p className="lbale"> MID-OCL-CCL</p>
                  <CommercialTypeDropNew
                    selected={formState.MID}
                    setSelected={setFormState}
                    List={spotposition}
                    name={'MID'}
                  />
                </div>
                <div className=" col-span-1">
                  <p className="lbale"> Position</p>
                  <CommercialTypeDropNew
                    selected={formState.position}
                    setSelected={setFormState}
                    List={position}
                    name={'position'}
                  />
                </div>

                <div
                  className={` ${formState.brand ? 'col-span-2' : 'hidden'} `}
                >
                  <p className="lbale flex">Commercial</p>
                  <Select
                    isMulti
                    options={commercial}
                    value={formState.Commercial}
                    onChange={(e) => {
                      setFormState((prevFormState) => {
                        const filteredData = Object.entries(
                          prevFormState,
                        ).reduce((acc, [key, value]) => {
                          const preservedKeys = [
                            'MID',
                            'position',
                            'brand',
                            'datesrange',
                            'BookingRefNumber',
                            'Commercial',
                          ];
                          if (preservedKeys.includes(key)) {
                            acc[key] = value;
                          } else {
                            const [, id] = key.split('|');
                            if (e.some((item) => item.value === Number(id))) {
                              acc[key] = value;
                            }
                          }
                          return acc;
                        }, {});

                        return { ...filteredData, Commercial: e };
                      });
                      try {
                        const RK = JSON.parse(`{${The_data_I_want_To_Upload}}`);
                        const filteredData2 = Object.entries(RK).reduce(
                          (acc, [key, value]) => {
                            const [, id] = key.split('|');
                            if (e.some((item) => item.value === Number(id))) {
                              acc[key] = value;
                            }
                            return acc;
                          },
                          {},
                        );
                        setThe_data_I_want_To_Upload(
                          JSON.stringify(filteredData2, null, 2)
                            .replace(/^{|}$/g, '') // Remove curly braces
                            .trim(),
                        );
                      } catch (error) {
                        console.error('Error parsing JSON:', error);
                      }
                    }}
                  />
                </div>

                <div
                  className={` ${formState.brand && formState.Commercial?.length != 0
                    ? 'col-span-1'
                    : 'hidden'
                    } `}
                >
                  <Dropdown
                    title={
                      <Button className="mt-5" size="sm" variant="solid">
                        Copy Pattern
                      </Button>
                    }
                    className="mr-2"
                    placement="top-end"
                  >
                    <div className="p-5 ">
                      <div className="mb-2">
                        <h6>
                          Select Date Range{' '}
                          <span className="text-red-500">*</span>
                        </h6>
                        <DatePickerRange
                          size="sm"
                          inputFormat="DD-MM-YYYY"
                          minDate={dayjs(
                            new Date(formState?.datesrange[0]).getDate() >
                              new Date().getDate()
                              ? new Date(formState?.datesrange[0])
                              : new Date(),
                          )
                            .subtract(0, 'day')
                            .startOf('day')
                            .toDate()}
                          maxDate={dayjs(new Date(formState?.datesrange[1]))
                            .subtract(0, 'day')
                            .startOf('day')
                            .toDate()}
                          // disableDate={disableCertainDate}
                          value={valueInsertDateRange}
                          onChange={(e) => {
                            setValueInsertDateRange(e);
                          }}
                        />
                      </div>
                      <div className="mb-2">
                        <h6>Select Days </h6>
                        <Checkbox.Group
                          value={checkboxListDay}
                          onChange={onCheckboxChangeDay}
                        >
                          <Checkbox value="Sunday">Sun </Checkbox>
                          <Checkbox value="Monday">Mon</Checkbox>
                          <Checkbox value="Tuesday">Tue</Checkbox>
                          <Checkbox value="Wednesday">Wed</Checkbox>
                          <Checkbox value="Thursday">Thu</Checkbox>
                          <Checkbox value="Friday">Fri</Checkbox>
                          <Checkbox value="Saturday">Sat</Checkbox>
                        </Checkbox.Group>
                      </div>
                      <div className="mb-2">
                        <h6>
                          Select DealLine Line{' '}
                          <span className="text-red-500">*</span>
                        </h6>
                        <Checkbox.Group
                          vertical
                          value={checkboxList}
                          onChange={onCheckboxChange}
                        >
                          {checkedItems.map((item, key) => (
                            <Checkbox value={item.DealLineItemNo}>
                              {' '}
                              {item.TimeBandCode != 0 && item.TimeBandName}
                              {item.ContentCode != 0 && item.ContentName}{' '}
                            </Checkbox>
                          ))}
                        </Checkbox.Group>
                      </div>
                      <div className="mb-2">
                        <h6> Alternate Days </h6>
                        <Checkbox
                          checked={checkedAlternateDays}
                          onChange={setCheckedAlternateDays}
                        >
                          Alternate Days
                        </Checkbox>
                      </div>
                      <div className="mb-2">
                        <h6>
                          Select Commercial{' '}
                          <span className="text-red-500">*</span>
                        </h6>
                        <Checkbox.Group
                          vertical
                          value={checkboxListCommercial}
                          onChange={onCheckboxChangeCommercial}
                        >
                          {formState?.Commercial &&
                            formState.Commercial.map((item, key) => (
                              <Checkbox value={item.value}>
                                {item.CommercialCaption}{' '}
                              </Checkbox>
                            ))}
                        </Checkbox.Group>
                      </div>
                      <div className="mb-2">
                        <h6>
                          Select Value <span className="text-red-500">*</span>
                        </h6>
                        <Input
                          size="sm"
                          value={valueInsert}
                          onChange={(e) => {
                            setValueInsert(Number(e.target.value));
                          }}
                        />
                      </div>
                      <Button
                        size="xs"
                        variant="solid"
                        onClick={() => {
                          if (
                            checkboxList.length === 0 ||
                            checkboxListCommercial.length === 0 ||
                            valueInsertDateRange[0] == null ||
                            valueInsertDateRange[1] == null ||
                            !valueInsert
                          ) {
                            openNotification(
                              'warning',
                              'Please Select All Fields',
                            );
                            return;
                          }

                          const {
                            MID,
                            position,
                            brand,
                            datesrange,
                            BookingRefNumber,
                            Commercial,
                            ...filteredArray
                          } = formState;

                          const generateDateRange = (startDate, endDate) => {
                            const dates = [];
                            let current = new Date(startDate);
                            while (current <= endDate) {
                              dates.push(
                                current
                                  .toLocaleDateString('en-GB', {
                                    day: '2-digit',
                                    month: 'short',
                                    year: 'numeric',
                                  })
                                  .replace(/ /g, '-'),
                              );
                              current.setDate(current.getDate() + 1);
                            }
                            return dates;
                          };

                          const dateList = generateDateRange(
                            new Date(valueInsertDateRange[0]),
                            new Date(valueInsertDateRange[1]),
                          );

                          const result = { ...filteredArray };
                          let netDeltaCost = 0;
                          const dealTotals = {}; // Track cumulative totals per deal for balance checking

                          console.log('Starting netDeltaCost calculation', {
                            valueInsert,
                            AvailableAmt,
                            dateList,
                          });

                          for (const deal of checkboxListDD) {
                            let weekendDetails = [];
                            if (
                              [1, 2, 4, 5, 6].includes(
                                deal.DealLineItemTypeCode,
                              )
                            ) {
                              weekendDetails = deal.weekendsdetail || [];
                            }
                            const weekendNames = weekendDetails.map(
                              (item) => daysOfWeek[item.Day],
                            );
                            dealTotals[deal.DealLineItemNo] =
                              dealTotals[deal.DealLineItemNo] || 0;

                            for (const commercial of checkboxListDDCom) {
                              for (const date of dateList) {
                                const currentDate = new Date(date);
                                const dayOfWeek = currentDate.toLocaleString(
                                  'en-GB',
                                  { weekday: 'long' },
                                );
                                const isWeekendAllowed =
                                  weekendNames.includes(dayOfWeek);
                                const isCheckboxSelectedValid =
                                  checkboxListDay.length > 0
                                    ? checkboxListDay.includes(dayOfWeek)
                                    : true;
                                const isDaysInsert =
                                  !isWeekendAllowed ||
                                  (checkboxListDay.length > 0 &&
                                    !isCheckboxSelectedValid);
                                const isAlternateDay =
                                  checkedAlternateDays &&
                                  dateList.indexOf(date) % 2 !== 0;

                                const formattedDate = currentDate
                                  .toLocaleDateString('en-GB', {
                                    day: '2-digit',
                                    month: 'short',
                                  })
                                  .replace(/ /g, '-');
                                const key = `${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;
                                const valueKey = `Y${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;

                                const oldValue =
                                  formState[valueKey]?.value || 0;
                                const oldTotal =
                                  formState[valueKey]?.total || 0;
                                let newValue, newTotal;

                                if (isAlternateDay || isDaysInsert) {
                                  newValue = oldValue; // Preserve existing value
                                  newTotal = oldTotal; // Preserve existing total
                                } else {
                                  newValue = valueInsert;
                                  newTotal =
                                    deal.DealLineItemTypeCode === 4
                                      ? valueInsert
                                      : deal.DealLineItemTypeCode === 5 ||
                                        deal.DealLineItemTypeCode === 6
                                        ? valueInsert
                                        : deal.DealLineItemTypeCode === 1 ||
                                          deal.DealLineItemTypeCode === 2
                                          ? valueInsert * commercial.DurInSec
                                          : valueInsert * commercial.DurInSec;
                                }

                                const deltaValue = newValue - oldValue;
                                const deltaTotal = newTotal - oldTotal;

                                // Update cumulative total for the deal
                                dealTotals[deal.DealLineItemNo] += newTotal;

                                // Check balance before applying cost
                                const maxAllowed =
                                  deal.DealLineItemTypeCode === 4
                                    ? deal.NTCBalanceSpots
                                    : deal.DealLineItemTypeCode === 5 ||
                                      deal.DealLineItemTypeCode === 6
                                      ? deal.BalancedSpots
                                      : deal.DealLineItemTypeCode === 1 ||
                                        deal.DealLineItemTypeCode === 2
                                        ? deal.BalancedSeconds
                                        : 0;

                                if (
                                  dealTotals[deal.DealLineItemNo] > maxAllowed
                                ) {
                                  openNotification(
                                    'info',
                                    `Booking not allowed for deal ${deal.DealLineItemNo} due to exceeding balance.`,
                                  );
                                  return;
                                }

                                // Calculate cost only if there's a change
                                if (deltaValue !== 0) {
                                  const cost =
                                    ((deltaValue * commercial.DurInSec) / 10) *
                                    deal.Rate;
                                  netDeltaCost += cost;

                                  // Debugging log
                                  console.log({
                                    key,
                                    dealLineItemNo: deal.DealLineItemNo,
                                    commercial: commercial.value,
                                    date,
                                    oldValue,
                                    newValue,
                                    deltaValue,
                                    oldTotal,
                                    newTotal,
                                    deltaTotal,
                                    rate: deal.Rate,
                                    durInSec: commercial.DurInSec,
                                    cost,
                                    netDeltaCost,
                                  });
                                }

                                result[key] = newValue;
                                result[valueKey] = {
                                  value: newValue,
                                  date: currentDate
                                    .toLocaleDateString('en-GB', {
                                      day: '2-digit',
                                      month: 'short',
                                      year: 'numeric',
                                    })
                                    .replace(/ /g, '-'),
                                  total: newTotal,
                                };
                              }
                            }
                          }

                          console.log('Total netDeltaCost:', netDeltaCost);

                          if (netDeltaCost > AvailableAmt) {
                            openNotification(
                              'info',
                              `Booking not allowed due to insufficient available amount. Need ${netDeltaCost}, Available ${AvailableAmt}`,
                            );
                            return;
                          }

                          const filteredDataresult = Object.fromEntries(
                            Object.entries(result).filter(
                              ([key]) => !key.includes('total'),
                            ),
                          );

                          function processArray(data) {
                            const result = {};
                            Object.keys(data).forEach((key) => {
                              const newKey =
                                key
                                  .replace(/^Y/, '')
                                  .split('|')
                                  .slice(0, 2)
                                  .join('|') + '|total';
                              if (
                                typeof data[key] === 'object' &&
                                data[key] !== null
                              ) {
                                result[newKey] =
                                  (result[newKey] || 0) + data[key].value;
                              }
                            });
                            return result;
                          }

                          const totals = processArray(filteredDataresult);
                          const finalData = {
                            MID,
                            position,
                            brand,
                            datesrange,
                            BookingRefNumber,
                            Commercial,
                            ...totals,
                            ...filteredDataresult,
                          };
                          console.log(finalData);

                          setFormState(finalData);
                          const formattedString = generateCustomArray(finalData)
                            .map((obj) => {
                              const key = Object.keys(obj)[0];
                              return `"${key}":"${obj[key]}"`;
                            })
                            .join(',');

                          setThe_data_I_want_To_Upload(formattedString);
                          console.log('Final netDeltaCost:', netDeltaCost);
                          setAvailableAmt((prev) => {
                            const newAmt = prev - netDeltaCost;
                            console.log('Updating AvailableAmt:', {
                              prev,
                              netDeltaCost,
                              newAmt,
                            });
                            return newAmt;
                          });
                          setValueInsertDateRange({});
                        }}
                      >
                        Apply
                      </Button>
                    </div>
                  </Dropdown>
                </div>
                <div
                  className={` ${formState.brand && formState.Commercial?.length != 0
                    ? 'col-span-5'
                    : 'hidden'
                    } `}
                >
                  <div
                    className={` ${formState.brand && formState.Commercial?.length != 0
                      ? 'col-span-5'
                      : 'hidden'
                      } `}
                  >
                    {bookingAttachment && (
                      <div className="w-[100%]  mb-2">
                        <AttachmentRow
                          Attachment={bookingAttachment}
                          setAttachment={setBookingAttachment}
                          handleDownloadAndView={handleDownloadAndView}
                        />
                      </div>
                    )}
                    <Upload beforeUpload={beforeUpload} />
                  </div>
                </div>
              </div>{' '}
            </div>
          ) : null}
          {(formState?.datesrange[0] || formState?.datesrange[1]) && (
            <div>
              <DateRangeInputs
                date1={formState?.datesrange[0]}
                date2={formState?.datesrange[1]}
                formState={formState}
                setFormState={setFormState}
                checkedItems={checkedItems}
                CommercialMasterData={formState.Commercial}
                setThe_data_I_want_To_Upload={setThe_data_I_want_To_Upload}
                IsNTCPage={IsNTCPage}
                trafficDayList={trafficDayList}
                generateCustomArray={generateCustomArray}
                isPaymentCheck={isPaymentCheck}
                consumedAmt={consumedAmt}
                DealData={DealData}
                setAvailableAmt={setAvailableAmt}
                AvailableAmt={AvailableAmt}
              />
            </div>
          )}
          <StickyFooter
            className="-mx-8 px-8 flex items-center justify-between py-4 pt-2 pb-2 z-10"
            stickyClass="border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
          >
            <div className="md:flex items-center">
              {(formState?.datesrange[0] || formState?.datesrange[1]) && (
                <Button
                  disabled={ScheduleButton}
                  icon={<FaRegSave />}
                  onClick={() => {
                    if (DealData?.ChannelCode) {
                      (async (values) => {
                        if (formState?.BookingRefNumber == '') {
                          openNotification(
                            'warning',
                            'Please Select Booking Ref Number   ',
                          );
                          return;
                        }
                        try {
                          setShowLoader(true);
                          setScheduleButton(true);
                          const USP_SA_RO_SpotSchedule =
                            await apiUSP_SA_RO_SpotSchedule(
                              convertDateToYMD(formState?.datesrange[0]),
                              convertDateToYMD(formState?.datesrange[1]),
                              DealData?.DealNumber,
                              Content?.BookingNumber
                                ? Content?.BookingNumber
                                : 0,
                              `{${The_data_I_want_To_Upload} } `,
                              DealData?.ChannelCode,
                              DealData?.LocationCode,
                              checked,
                              formState?.BookingRefNumber,
                              IsNTCPage,
                              formState?.brand,
                            );
                          if (USP_SA_RO_SpotSchedule.status == 200) {
                            const data = USP_SA_RO_SpotSchedule.data.map(
                              (item) => ({
                                ...item,
                                ScheduleDate: FORMATDATE_FOR_EVERY(
                                  item?.ScheduleDate,
                                ),
                              }),
                            );
                            setData(data);
                            setIsOpen2(true);
                            setShowLoader(false);
                            // navigate('/BookingMaster')
                          }
                        } catch (error) {
                          if (error.response.status == 500) {
                            setShowLoader(false);
                            openNotification('danger', 'Server  Error');
                            setData([]);
                            setnewBookSpotDeatils([]);
                            setIsOpen2(false);
                          }
                        }
                      })();
                    } else {
                      setShowLoader(false);
                      openNotification(
                        'warning',
                        'Please Select Global Channel',
                      );
                      setData([]);
                    }
                  }}
                  variant="solid"
                  type="submit"
                  size="sm"
                >
                  Schedule Spot
                </Button>
              )}
              &nbsp;
              <Button
                type="button"
                size="sm"
                icon={<HiOutlineArrowNarrowLeft />}
                onClick={() =>
                  navigate(
                    spotBooking === 'RoImportDetails'
                      ? '/RoImport'
                      : spotBooking === 'NTCRoImportDetails'
                        ? '/NTCRoImport'
                        : spotBooking === 'BookingDetails'
                          ? '/SpotBooking'
                          : '/NtcSpotBooking',
                  )
                }
              >
                Back
              </Button>
              &nbsp;&nbsp;
              {isPaymentCheck && (
                <div
                  className="mr-2 w-[200px]"
                  style={{
                    backgroundColor: 'rgb(26, 36, 48)',
                    borderColor: 'rgb(75, 85, 99)',
                    padding: '0.50rem',
                    borderRadius: '10px',
                  }}
                >
                  <div className=" w-full">
                    <div className="flex justify-between">
                      <p>Available Balance</p>
                      <p className="dark:text-sky-500 text-xl font-normal">
                        <VscRecord size={20} className="text-rose-700" />
                      </p>
                    </div>
                    <h3 className="m-1">{AvailableAmt}</h3>
                  </div>
                </div>
              )}
            </div>
          </StickyFooter>
        </div>
        <Dialogg
          visible={dialogIsOpen}
          style={{ width: '100vw', height: '100%' }}
          onHide={onDialogClose}
          footer={
            <ShowBookingFooter
              Deatils={Deatils}
              onDialogOk={onDialogOk}
              onDialogClose={onDialogClose}
              DealData={DealData}
            />
          }
        >
          <div className="flex flex-col h-full ">
            <h4 className="mb-4 ml-5">Show Bookings</h4>
            {Deatils.length > 0 && (
              <Card className=" overflow-scroll">
                <ReportsTable
                  tableData={ShowBookingSpots}
                  originalColumns={columns}
                  managedColumns={TableColumns}
                  setManagedColumns={setTableColumns}
                  tableName="Booked Spots"
                />
              </Card>
            )}
          </div>
        </Dialogg>
        <Dialogg
          visible={dialogIsOpen2}
          style={{ width: '100vw', height: '100%' }}
          onHide={() => setIsOpen2(false)}
          footer={
            <div className=" px-6 py-1 bg-gray-100 dark:bg-gray-700 rounded-bl-lg rounded-br-lg">
              <div className="flex justify-between items-center">
                <div className="flex ">
                  {' '}
                  <div
                    className="mr-2"
                    style={{
                      backgroundColor: 'rgb(26, 36, 48)',
                      borderColor: 'rgb(75, 85, 99)',
                      padding: '0.50rem',
                      borderRadius: '10px',
                    }}
                  >
                    <div className=" w-full">
                      <div className="flex justify-between">
                        <p>Total Amount</p>
                        <p className="dark:text-sky-500 text-xl font-normal">
                          {DealData?.CurrencySymbol}
                        </p>
                      </div>
                      <h3>
                        {DealData?.CurrencySymbol}
                        {numberToINRFormat(calculateTotal(Data))}
                      </h3>
                    </div>
                  </div>
                  <div
                    style={{
                      backgroundColor: 'rgb(26, 36, 48)',
                      borderColor: 'rgb(75, 85, 99)',
                      padding: '0.50rem',
                      borderRadius: '10px',
                      width: 100,
                    }}
                  >
                    <div className=" w-full">
                      <div className="flex justify-between">
                        <p>Spots</p>
                        <p className="dark:text-sky-500 text-xl font-normal">
                          <VscRecord size={20} className="text-rose-700" />
                        </p>
                      </div>
                      <h3 className="m-1">{sumAddedSpotCount(Data)}</h3>
                    </div>
                  </div>
                </div>
                <div>
                  <Button
                    className="ltr:mr-2 rtl:ml-2"
                    onClick={() => handleDelete(Data[0].BookingNumber)}
                  >
                    Discard
                  </Button>
                  <Button
                    variant="solid"
                    onClick={async () => {
                      try {
                        setShowLoader(true);
                        const prams = {
                          Bookingcode: Content?.BookingCode
                            ? Content?.BookingCode.replace('_unsave', '')
                            : Data[0].BookingCode.replace('_unsave', ''),
                          IsNTC: IsNTCPage,
                        };
                        const resp = await apiCallstoreprocedure(
                          'USP_SA_RO_BookingSave',
                          prams,
                        );
                        setShowLoader(false);
                        setIsOpen2(false);
                        if (resp.status == 200) {
                          //Attachmnet Save API Call
                          uploadAttachmentFolder(
                            resp?.data[0]?.BookingNumber,
                            resp?.data[0]?.BookingCode,
                          );

                          SEND_NOTIFICATION(
                            8,
                            `Spot Booking for ${Channel.ChannelName
                            } is confirmed from ${FORMATDATE_FOR_EVERY(
                              formState.datesrange[0],
                            )} to ${FORMATDATE_FOR_EVERY(
                              formState.datesrange[1],
                            )}, total ${sumAddedSpotCount(Data)} Bookings Done.
                          `,
                            '',
                            `Spot Booking for ${Channel.ChannelName
                            } is confirmed from ${FORMATDATE_FOR_EVERY(
                              formState.datesrange[0],
                            )} to ${FORMATDATE_FOR_EVERY(
                              formState.datesrange[1],
                            )}, total ${sumAddedSpotCount(Data)} Bookings Done.
                          `,
                            1,
                            1,
                            'Booking',
                            'Booking',
                          );
                          uploadAttachmentFolder(
                            Data[0]?.BookingNumber,
                            resp?.data[0]?.BookingCode,
                          );
                          openNotification(
                            'success',
                            `Data saved!!! ${resp.data[0]?.BookingCode} `,
                          );
                          setShowLoader(false);
                          setThe_data_I_want_To_Upload();
                          navigate('/RoImport');
                        }
                      } catch (error) {
                        if (error.response.status == 500) {
                          openNotification('danger', 'Server Error.');
                          setShowLoader(false);
                          setIsOpen2(false);
                        }
                      }
                      setShowLoader(false);
                    }}
                  >
                    Save
                  </Button>
                </div>
              </div>
            </div>
          }
        >
          <Tabs value={currentTab} onChange={(val) => setCurrentTab(val)}>
            <TabList>
              <TabNav value="tab1" icon={<HiOutlineHome />}>
                Booking Spots Summary
              </TabNav>
              <TabNav
                value="tab2"
                icon={<HiOutlineUser />}
                onClick={async () => {
                  setShowLoader(true);
                  setCurrentTab('tab2');
                  try {
                    const newBookSpotDetails = await apiCallstoreprocedure(
                      'GetNewBookSpot',
                      {
                        par_BookingCode: Data[0].BookingCode,
                        par_BookingNumber: Data[0].BookingNumber,
                      },
                    );
                    if (newBookSpotDetails.status === 200) {
                      setShowLoader(false);
                      const formatedData = newBookSpotDetails.data.map(
                        (item) => ({
                          ...item,
                          ScheduleDate: FORMATDATE_FOR_EVERY(
                            new Date(item?.ScheduleDate),
                          ),
                        }),
                      );
                      setnewBookSpotDeatils(formatedData);
                    } else if (newBookSpotDetails.status === 204) {
                      setnewBookSpotDeatils([]);
                      setShowLoader(false);
                    }
                  } catch (error) {
                    setnewBookSpotDeatils([]);
                    setShowLoader(false);
                  }
                }}
              >
                Booking Spots Details
              </TabNav>
            </TabList>
            <div className="p-4">
              <TabContent value="tab1">
                <div className="px-3  overflow-scroll">
                  <ReportsTable
                    tableData={Data}
                    toolbarOptions={ToolbarOptionsBooking}
                    originalColumns={BookingDetailsColumn}
                    managedColumns={ManagedColumnBookings}
                    setManagedColumns={setManagedColumnBookings}
                    exportFileName="Booking Master"
                    columnsToFormatInINR={[]}
                    tableName="Booking Spots Summary"
                  />
                </div>
              </TabContent>
              <TabContent value="tab2">
                <div className="px-3  overflow-scroll">
                  <ReportsTable
                    tableData={newBookSpotDeatils}
                    toolbarOptions={ToolbarOptionsBooking}
                    originalColumns={BookingDetailsColumnSummary}
                    managedColumns={ManagedColumnBookings2}
                    setManagedColumns={setManagedColumnBookings2}
                    exportFileName="Booking Master"
                    columnsToFormatInINR={[]}
                    tableName="Booking Spots Details"
                  />
                </div>
              </TabContent>
            </div>
          </Tabs>
        </Dialogg>
      </Container>
      <Loader
        showLoader={showLoader}
        animation={
          <Lottie
            animationData={documentOcrScanAnimation}
            loop={true}
            autoplay={true}
            style={{ width: '700px', height: '700px' }}
          />
        }
      />
    </Card>
  );
};

export default BookingMaster;
