import { Card, Dialog } from 'components/ui';
import React, { useEffect, useState } from 'react';
import { MdChevronRight } from 'react-icons/md';
import {
  apidealattachmentBYID,
  apiGetdealdetailId,
} from 'services/DealServices';
import {
  hideCursorLoader,
  openNotification,
  showCursorLoader,
} from '../GLOBALFUNACTION';
import BookingInfo from './components/BookingInfo';
import { useSelector } from 'react-redux';
import { TOKEN_TYPE, REQUEST_HEADER_AUTH_KEY } from 'constants/api.constant';
import AttachmentList from './components/AttachmentList';
import { apiCallstoreprocedure } from 'services/CommonService';
import DealLineInfo from '../DealLineInfo';

function BookingDetailsDialog({
  isDialogOpen,
  setIsDialogOpen,
  bookingNumber,
  bookingCode,
}) {
  /* REDUX */
  const token = useSelector((state) => state.auth.session.token);

  /* STATES */
  const [bookingDetails, setBookingDetails] = useState(null);
  const [dealLineInfo, setDealLineInfo] = useState(null);
  const [dealAttachment, setDealAttachment] = useState(null);

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        if (isDialogOpen && bookingNumber) {
          showCursorLoader();
          const response = await apiCallstoreprocedure('USP_BookingView', {
            par_BookingNumber: bookingNumber,
          });
          if (response.status === 200) {
            setBookingDetails(response.data[0]);
          } else if (response.status !== 204) {
            openNotification(
              'danger',
              `Something went wrong while fetching deal details. Server responded with status code ${response.status}`,
            );
          }
        }
      } catch (error) {
        openNotification(
          'danger',
          `Something went wrong while fetching deal details`,
        );
        console.error(error);
      } finally {
        hideCursorLoader();
      }
    })();
  }, [isDialogOpen, bookingNumber]);

  /* EVENT HANDLERS */
  const handleDialogClose = () => {
    setIsDialogOpen(false);
    setDealLineInfo(null);
    setDealAttachment(null);
  };

  const handleDealAttachmentClick = async () => {
    try {
      showCursorLoader();
      const response = await apidealattachmentBYID(bookingNumber);
      if (response.status === 200) {
        setDealAttachment(response.data);
      } else if (response.status === 204) {
        setDealAttachment([]);
      } else {
        setDealAttachment([]);
        openNotification(
          'danger',
          `Something went wrong while fetching deal attachment. Server responded with status code ${response.status}`,
        );
      }
    } catch (error) {
      openNotification(
        'danger',
        `Something went wrong while fetching deal attachment`,
      );
      console.error(error);
    } finally {
      hideCursorLoader();
    }
  };

  const handleViewDetailsClick = async () => {
    try {
      showCursorLoader();
      const response = await apiGetdealdetailId(bookingDetails.DealNumber);
      if (response.status === 200) {
        setDealLineInfo(response.data);
      } else if (response.status === 204) {
        setDealLineInfo([]);
      } else {
        setDealLineInfo([]);
        openNotification(
          'danger',
          `Something went wrong while fetching deal line details. Server responded with status code ${response.status}`,
        );
      }
    } catch (error) {
      openNotification(
        'danger',
        `Something went wrong while fetching deal line details`,
      );
      console.error(error);
    } finally {
      hideCursorLoader();
    }
  };

  const handleDownloadAndView = async (filename) => {
    try {
      const response = await fetch(
        `http://103.14.97.155:8080/dealmaster/readuploadedfile/${filename}`,
        {
          method: 'GET',
          headers: {
            [REQUEST_HEADER_AUTH_KEY]: `${TOKEN_TYPE}${token}`,
            'Content-Type': 'application/json',
          },
        },
      );
      if (response.status == 204) {
        throw new Error(`Server Error: ${response.status}`);
      }
      if (!response.headers || typeof response.headers.get !== 'function') {
        throw new Error('Invalid response format, expected Response object');
      }

      const contentType = response.headers.get('content-type');
      if (contentType && contentType.includes('application/json')) {
        const data = await response.json();
        alert(`Text File Content:\n${data.content}`);
      } else {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }
    } catch (error) {
      console.error('Error downloading file:', error);
    }
  };

  return (
    <Dialog
      isOpen={isDialogOpen}
      onClose={handleDialogClose}
      onRequestClose={handleDialogClose}
      className={`transition-all ${
        dealLineInfo || dealAttachment
          ? '!w-[95vw] !max-w-[95vw]'
          : '!w-[80vw] !max-w-[80vw]'
      }`}
      contentClassName="mt-8 pt-4"
    >
      <div className="flex flex-col h-full justify-between">
        <h4 className="mb-4">Booking Info</h4>
        {bookingDetails ? (
          <div className="flex h-full">
            <div
              className={`max-h-[34rem] overflow-y-auto no-scrollbar ${
                dealLineInfo || dealAttachment
                  ? 'border-r border-r-gray-700 pr-4 w-[70%]'
                  : 'w-full'
              }`}
            >
              <div>
                <div className="grid grid-cols-2">
                  <h6 className="mb-2">{bookingCode}</h6>
                  <div className="flex items-center justify-end gap-2">
                    {!dealAttachment && (
                      <div
                        className="font-normal bg-gray-700 pl-3 pr-1.5 py-2 rounded-md mb-2 text-white flex items-center justify-center hover:!bg-gray-600 hover:cursor-pointer transition-all"
                        style={{ backgroundColor: 'rgb(47 58 75)' }}
                        onClick={handleDealAttachmentClick}
                      >
                        <span>View Attachment</span>
                        <MdChevronRight className="text-[20px]" />
                      </div>
                    )}
                    {!dealLineInfo && (
                      <div
                        className="font-normal bg-gray-700 pl-3 pr-1.5 py-2 rounded-md mb-2 text-white flex items-center justify-center hover:!bg-gray-600 hover:cursor-pointer transition-all"
                        style={{ backgroundColor: 'rgb(47 58 75)' }}
                        onClick={handleViewDetailsClick}
                      >
                        <span>View Details</span>
                        <MdChevronRight className="text-[20px]" />
                      </div>
                    )}
                  </div>
                </div>
                <BookingInfo bookingDetails={bookingDetails} />
              </div>
            </div>
            {dealLineInfo && (
              <div className="w-[30%] ml-4">
                <DealLineInfo
                  bookingNumber={bookingDetails.BookingNumber}
                  dealLineInfo={dealLineInfo}
                  setDealLineInfo={setDealLineInfo}
                  currencySymbol={bookingDetails.CurrencySymbol}
                />
              </div>
            )}
            {dealAttachment && (
              <div className="w-[30%] ml-4">
                <AttachmentList
                  dealAttachment={dealAttachment}
                  setDealAttachment={setDealAttachment}
                  handleDownloadAndView={handleDownloadAndView}
                />
              </div>
            )}
          </div>
        ) : (
          <div className="flex h-full">
            <div
              className={`max-h-full overflow-y-auto no-scrollbar ${
                dealLineInfo
                  ? 'border-r border-r-gray-700 pr-4 w-[70%]'
                  : 'w-full'
              }`}
            >
              <h6 className="mb-2">{bookingCode}</h6>
              <Card
                className="h-[75vh]"
                bodyClass="h-full flex justify-center items-center"
              >
                No booking details to show
              </Card>
            </div>
          </div>
        )}
      </div>
    </Dialog>
  );
}

export default BookingDetailsDialog;
