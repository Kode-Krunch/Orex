import { Button, DatePicker, Dialog, Tag } from 'components/ui';
import React, { useState } from 'react';
import { getDistinctSums } from './utils';
import CommSummary from './CommSummary';
import { format } from 'date-fns';
import { apipostbookingdetails } from 'services/DealServices';
import {
  fetchSelectorOptionsFromSp,
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import SelectXs from 'views/Controls/SelectXs/SelectXs';
import { useSelector } from 'react-redux';

function RescheduleSpotsDialog({ isOpen, setIsOpen, selRows, resetData }) {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* STATES */
  const [date, setDate] = useState(null);
  const [time, setTime] = useState(null);
  const [timeOptions, setTimeOptions] = useState([]);

  /* CONSTANTS */
  const distinctSums = getDistinctSums(selRows);

  /* EVENT HANDLERS */
  const handleDateChange = async (date) => {
    setDate(date);
    setTimeOptions(
      await fetchSelectorOptionsFromSp(
        'USP_GetSpotReplaceTime',
        {
          par_LocationCode: channel.LocationCode,
          par_ChannelCode: channel.ChannelCode,
          DealNumber: selRows[0].DealNumber,
          DealLineItemNumber: selRows[0].DealLineItemNo,
          par_SuggestedScheduleDate: format(date, 'yyyy-MM-dd'),
        },
        'SuggestedScheduleTime',
        'SuggestedScheduleTime',
        'No reschedule time found',
        'Something went wrong while fetching reschedule time',
        'Something went wrong while fetching reschedule time',
      ),
    );
  };

  const handleConfirm = async () => {
    const finalData = selRows.map((item) => ({
      Id: item.Id,
      RescheduleDate: format(date, 'yyyy-MM-dd'),
      CommercialCode: item.CommercialCode,
      BookingStatus: item.BookingStatus,
    }));
    try {
      const resp = await apipostbookingdetails('RESCHEDULE', finalData, 0);
      if (resp.status === 200) {
        setIsOpen(false);
        resetData();
        openNotification('success', 'Spot Rescheduled successfully');
        document.getElementById('missedSpots').click();
      }
    } catch (error) {
      console.error(error);
      if (error.response.status === 500)
        openNotification('danger', 'Server Error.');
    }
  };

  return (
    <Dialog isOpen={isOpen} onClose={() => setIsOpen(false)}>
      <h3 className="text-xl font-bold mb-4">Reschedule Spots</h3>
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">
          New Date <span className="text-red-500">*</span>
        </label>
        <DatePicker
          minDate={new Date()}
          maxDate={
            selRows.length > 0
              ? new Date(selRows[0].DealPeriodToDate)
              : undefined
          }
          placeholder="Select"
          value={date}
          onChange={handleDateChange}
          clearable={false}
          size="sm"
        />
      </div>
      <div className="mb-4">
        <label className="block text-sm font-medium mb-1">
          New Time <span className="text-red-500">*</span>
        </label>
        <SelectXs options={timeOptions} value={time} onChange={setTime} />
      </div>
      <div className="mb-6 max-h-[30vh] overflow-auto flex flex-col gap-2">
        {distinctSums.map((item, index) => (
          <CommSummary comm={item} key={index} />
        ))}
      </div>
      <div className="flex justify-end gap-3">
        <Button
          variant="solid"
          onClick={handleConfirm}
          size="sm"
          disabled={!date || !time}
        >
          Confirm
        </Button>
      </div>
    </Dialog>
  );
}

export default RescheduleSpotsDialog;
