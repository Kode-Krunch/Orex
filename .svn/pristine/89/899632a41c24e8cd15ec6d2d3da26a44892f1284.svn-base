import { apiGetNTCtypedropdown } from 'services/NTCService';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import { getDummyRow, getRowId } from '../../utils/utils';
import {
  rowDataTypesEnum,
  tableTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import { apiCallstoreprocedure } from 'services/CommonService';

const selectorStyles = {
  control: (provided) => ({
    ...provided,
    minHeight: '32px',
    height: '32px',
  }),
  valueContainer: (provided) => ({
    ...provided,
    height: '32px',
    padding: '0 6px',
  }),
  input: (provided) => ({
    ...provided,
    margin: '0px',
  }),
  indicatorsContainer: (provided) => ({
    ...provided,
    height: '32px',
  }),
};

const getNTCTypeSelectorOptions = async () => {
  try {
    let options = [];
    const response = await apiGetNTCtypedropdown();
    if (response.status === 200) {
      options = response.data.map((ntcType) => ({
        value: ntcType.NTCTypeCode,
        label: ntcType.NTCTypeName,
      }));
      options = [{ value: 0, label: 'All' }, ...options];
    } else if (response.status === 204) {
      openNotification('info', 'No NTC types found');
    } else {
      openNotification(
        'danger',
        `Something went wrong while fetching NTC types. Server responded with status code ${response.status}`,
      );
    }
    return options;
  } catch (error) {
    throw error;
  }
};

const closeDropDowns = (event, dropdownRef, setSecTableToolbarState) => {
  if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
    setSecTableToolbarState((prevState) => ({
      ...prevState,
      isManageColumnsDropdownVisible: false,
    }));
  }
};

const getNTCs = async (
  channel,
  date,
  ntcType,
  ntcSubType,
  searchInputValue,
) => {
  try {
    let tableData = [];
    const response = await apiCallstoreprocedure('USP_Sch_Get_All_NTC', {
      LocationCode: channel.LocationCode,
      ChannelCode: channel.ChannelCode,
      NTCTypeCode: ntcSubType,
      NTCName: searchInputValue,
      NTCScheduleDate: date,
      NTCMode: ntcType === 'free' ? 0 : 1,
    });
    if (response.status === 200) {
      if (response.data.length === 0) {
        openNotification('info', 'No NTCs found');
      } else {
        tableData = [getDummyRow(response.data[0]), ...response.data].map(
          (row, index) => {
            if (row.F_C_S_P === rowDataTypesEnum.NTC)
              return {
                ...row,
                rowId: getRowId(tableTypesEnum.SECONDARY, row),
                rowIndex: index,
                OffsetStartTime: '00:00:00:00',
              };
            else
              return {
                ...row,
                rowId: getRowId(tableTypesEnum.SECONDARY, row),
                rowIndex: index,
              };
          },
        );
      }
    } else if (response.status === 204) {
      openNotification('info', 'No NTCs found');
    } else {
      openNotification(
        'danger',
        `Something went wrong while fetching NTCs. Server responded with status code ${response.status}`,
      );
    }
    return tableData;
  } catch (error) {
    throw error;
  }
};

export { selectorStyles, getNTCTypeSelectorOptions, closeDropDowns, getNTCs };
