import { Input } from 'components/ui';
import React, { useEffect, useRef, useState } from 'react';
import { CELL_HEIGHT } from './constants';

function InputCell({ getValue, table, index, id }) {
  /* CONSTANTS */
  const initialValue = getValue();

  /* STATES */
  const [value, setValue] = useState(initialValue);

  /* HOOKS */
  const inputRef = useRef(null);

  /* USE EFFECTS */
  useEffect(() => {
    setValue(initialValue);
  }, [initialValue]);

  /* EVENT HANDLERS */
  const onBlur = () => {
    table.options.meta?.updateCell(index, id, value);
  };

  const handleKeyDown = (e) => {
    const input = inputRef.current;
    if (!input) return;
    const caretPos = input.selectionStart;
    if (e.key === 'ArrowLeft' && caretPos === 0) {
      e.preventDefault();
      focusAdjacentCell(index, id, 'left');
    }
    if (e.key === 'ArrowRight' && (!value || caretPos === value.length)) {
      e.preventDefault();
      focusAdjacentCell(index, id, 'right');
    }
    if (e.key === 'ArrowUp') {
      e.preventDefault();
      focusAdjacentCell(index, id, 'up');
    }
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      focusAdjacentCell(index, id, 'down');
    }
  };

  /* HELPER FUNCTIONS */
  const focusAdjacentCell = (rowIndex, columnId, direction) => {
    const flatHeaders = table.getAllLeafColumns();
    const colIndex = flatHeaders.findIndex((col) => col.id === columnId);
    let nextRow = rowIndex;
    let nextCol = colIndex;
    switch (direction) {
      case 'left':
        nextCol = colIndex - 1;
        break;
      case 'right':
        nextCol = colIndex + 1;
        break;
      case 'up':
        nextRow = rowIndex - 1;
        break;
      case 'down':
        nextRow = rowIndex + 1;
        break;
      default:
        break;
    }
    const nextColumn = flatHeaders[nextCol];
    const isValidCell =
      nextRow >= 0 && nextRow < table.getRowModel().rows.length && nextColumn;
    if (!isValidCell) return;
    const nextInput = document.getElementById(`${nextRow}_${nextColumn.id}`);
    nextInput?.focus();
  };

  return (
    <Input
      size="sm"
      className={`p-1 text-center h-[${CELL_HEIGHT}px]`}
      id={`${index}_${id}`}
      ref={inputRef}
      value={value}
      onChange={(e) => {
        alert(['j'])
        const value = e.target.value;
        if (value === '') setValue(value);
        else if (/^[0-9]*$/.test(value) && Number(value) < 100) {
          Number(value) === 0 ? setValue(0) : setValue(value);
        }
      }}
      onBlur={onBlur}
      onKeyDown={handleKeyDown}
    />
  );
}

export default InputCell;
