import React, { useEffect, useMemo, useRef, useState } from "react";
import { useSelector } from "react-redux";
import { useLocation } from "react-router-dom";
import { getPlaylistSummaryData } from "./utils";
import StatisticCardwithfigure from "components/common/StatisticCardwithfigure";
import {
  convertDateFormatyyyyMMdd,
  formatDateToDDMMMYYYY,
  getDateFromDateTime,
  openNotification,
  parseDuration,
} from "views/Controls/GLOBALFUNACTION";
import { Button, Card, DatePicker, Dialog } from "components/ui";
import Loader from "views/Controls/Loader";
import { hideStackedSideNav_secondary } from "views/Scheduling/general";
import { apiCallstoreprocedure } from "services/CommonService";
import ReportsTable from "views/Controls/ReportsTable/ReportsTable";
import { reportsTableEnum } from "views/Controls/ReportsTable/enums/ReportsTableEnums";
import { StickyFooter } from "components/shared";
import { apipostbookingdetails } from "services/DealServices";

const TOOLBAR_OPTIONS = { groupBy: false, manageColumns: false };
const FLAG_INFO = {
  "Booked Spots": { flag: 1, title: "Booked Spots Details" },
  "Missed Spots": { flag: 2, title: "Missed Spots Details" },
  "Total Songs": { flag: 3, title: "Songs Details" },
  "Total Promos": { flag: 4, title: "Promo Details" },
  "Total NTC": { flag: 5, title: "NTC Details" },
  "Logged Spots": { flag: 6, title: "Logged Details" },
  "Telecasted Spots": { flag: 7, title: "Telecasted Details" },
  "Extra Spots": { flag: 8, title: "Extra Details" },
};

const prettifyHeader = (key) =>
  key.replace(/([A-Z])/g, " $1").replace(/_/g, " ").replace(/^./, (s) => s.toUpperCase());

const generateColumnsFromData = (data) =>
  data?.length
    ? Object.keys(data[0]).map((key) => ({
      header: prettifyHeader(key),
      accessorKey: key,
      cell: (info) => {
        const value = info.getValue?.();
        if (value == null) return "";
        if (key.toLowerCase().includes("date")) {
          const d = new Date(value);
          return !isNaN(d) ? d.toISOString().split("T")[0] : value;
        }
        return value;
      },
    }))
    : [];

export default function CloudPlayout() {
  const apiCallInProgress = useRef(false);
  const channel = useSelector((state) => state.locale.selectedChannel);
  const location = useLocation();

  const [date, setDate] = useState(null);
  const [playlistSummary, setPlaylistSummary] = useState([]);
  const [showLoader, setShowLoader] = useState(false);
  const [tableData, setTableData] = useState([]);
  const [managedColumns, setManagedColumns] = useState([]);
  const [tableTitle, setTableTitle] = useState("");
  const [curTable, setCurTable] = useState("");
  const [rowSelection, setRowSelection] = useState({});
  const [selectedRows, setSelectedRows] = useState([]);
  const [summaryData, setSummaryData] = useState({});
  const [firstSelectedBrand, setFirstSelectedBrand] = useState(null);
  const [isFinalSummaryDialogOpen, setIsFinalSummaryDialogOpen] =
    useState(false);
  const [selectDate, setSelectDate] = useState(null)
  hideStackedSideNav_secondary();

  const originalColumns = useMemo(() => generateColumnsFromData(tableData), [tableData]);

  // ðŸ”¹ Fetch Summary
  useEffect(() => {
    if (!location?.state?.date) return;
    setDate(location.state.date);

    const fetchSummary = async () => {
      setShowLoader(true);
      try {
        const summary = await getPlaylistSummaryData(
          channel,
          convertDateFormatyyyyMMdd(location.state.date)
        );
        setPlaylistSummary(summary || []);
      } catch {
        openNotification("danger", "Error retrieving Playlist Summary");
      } finally {
        setShowLoader(false);
      }
    };

    fetchSummary();
  }, [channel, location]);

  // ðŸ”¹ Fetch Playlist Details by Flag
  const getPlaylistDetailsByFlag = async (flag, title) => {
    if (apiCallInProgress.current) return;
    apiCallInProgress.current = true;
    setShowLoader(true);

    try {
      setTableTitle(title);
      setCurTable(title);

      const response = await apiCallstoreprocedure("USP_PlaylistSummary_Showdata", {
        par_LocationCode: channel.LocationCode,
        par_ChannelCode: channel.ChannelCode,
        par_TelecastDate: convertDateFormatyyyyMMdd(date),
        Flag: flag,
      });

      let dataArray = Array.isArray(response)
        ? response
        : Array.isArray(response?.data)
          ? response.data
          : [];

      const telecastDateOnly = new Date(date).setHours(0, 0, 0, 0);

      // Disable selection where DealPeriodToDate < telecast date
      dataArray = dataArray.map((item) => {
        const dealEndOnly = new Date(item.DealPeriodToDate).setHours(0, 0, 0, 0);
        return {
          ...item,
          disableSelection: dealEndOnly > telecastDateOnly, // âœ… fixed condition
        };
      });

      setTableData(dataArray);
      setManagedColumns(generateColumnsFromData(dataArray));
    } catch {
      openNotification("danger", "Error fetching playlist details");
    } finally {
      setShowLoader(false);
      apiCallInProgress.current = false;
    }
  };


  // ðŸ”¹ Update disableSelection based on brand locking
  useEffect(() => {
    if (!tableData.length) return;

    const updated = tableData.map((row) => {
      if (!firstSelectedBrand) return { ...row, disableSelection: false };
      return {
        ...row,
        disableSelection:
          row.Brand !== firstSelectedBrand || row.disableSelection === true,
      };
    });

    setTableData(updated);
  }, [firstSelectedBrand, tableData.length]);

  // ðŸ”¹ Track brand & calculate sums
  useEffect(() => {
    if (!selectedRows.length) {
      setFirstSelectedBrand(null);
    } else {
      setFirstSelectedBrand(selectedRows.at(-1)?.Brand);
    }

    const sums = selectedRows.reduce(
      (acc, item) => {
        acc.spotAmountSum += item?.SpotAmount || 0;
        acc.spotRateSum += item?.SpotRate || 0;
        acc.Duration += parseDuration(item?.CommercialDuration);
        return acc;
      },
      { spotAmountSum: 0, spotRateSum: 0, Duration: 0 }
    );

    setSummaryData(sums);
  }, [selectedRows]);

  const isMissedSpotsTable = curTable === "Missed Spots Details";

  const resetData = () => {
    setSelectedRows([]);
    setRowSelection({});
    setFirstSelectedBrand(null);
    setSelectDate(null)
    setIsFinalSummaryDialogOpen(false)

  };
  const handleConfirm = async () => {
    if (!selectDate) {
      openNotification('danger', 'Please select a date.');
      return;
    }

    const finalData = selectedRows.map(item => ({
      Id: item.Id,
      RescheduleDate: getDateFromDateTime(selectDate),
      CommercialCode: 0,
      BookingStatus: '',
      SpotTypeCode: 1,
    }));

    try {
      const resp = await apipostbookingdetails('MAKEGOODRESCHEDULE', finalData, 0);

      if (resp.status === 200) {
        setIsFinalSummaryDialogOpen(false);
        resetData();
        openNotification('success', 'Spot MakeGood Reschedule Successfully');
      }
    } catch (error) {
      if (error?.response?.status === 500) {
        openNotification('danger', 'Server Error.');
      }
    }
  };
  return (
    <>
      <div className="flex justify-between items-center">
        <h3 className="mb-4">Cloud Playout</h3>
        <h4>{formatDateToDDMMMYYYY(date)}</h4>
      </div>

      <Card bodyClass="p-2 grid grid-cols-8 gap-2" bordered={false}>
        {playlistSummary.map((summary, idx) => {
          const flagData = FLAG_INFO[summary.title];
          if (!flagData) return null;
          return (
            <div
              key={idx}
              role="button"
              tabIndex={0}
              onClick={() =>
                getPlaylistDetailsByFlag(flagData.flag, flagData.title)
              }
            >
              <StatisticCardwithfigure
                CardHeight={200}
                AnimateColorClass={summary.iconBorderColor}
                Icon={summary.icon}
                CardName={summary.title}
                CardNote={summary.description}
                CardFigure={summary.count}
                COLOR={summary.color}
                cursor
              />
            </div>
          );
        })}
      </Card>

      {tableData.length > 0 ? (
        <>
          <h5 className="mb-2">{tableTitle}</h5>
          <ReportsTable
            tableData={tableData}
            tableName={tableTitle}
            originalColumns={originalColumns}
            tableType={
              isMissedSpotsTable
                ? reportsTableEnum.tableTypes.SELECTABLE
                : reportsTableEnum.tableTypes.DEFAULT
            }
            managedColumns={managedColumns}
            exportFile={false}
            setManagedColumns={setManagedColumns}
            columnsToFormatInINR={[]}
            exportFileName="Playlist_Summary"
            toolbarOptions={TOOLBAR_OPTIONS}
            setSelectedRows={setSelectedRows}
            rowSelection={rowSelection}
            setRowSelection={setRowSelection}
          />
        </>
      ) : (
        curTable && <div className="p-4">No data to show for {tableTitle}</div>
      )}

      {isMissedSpotsTable && selectedRows.length > 0 && (
        <StickyFooter
          className="-mx-8 px-8 flex items-center justify-between py-4 pt-2 pb-2"
          stickyClass="border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
        >
          <div className="md:flex items-center">
            <Button variant="solid" type="submit" size="sm" onClick={() => setIsFinalSummaryDialogOpen(true)}>
              Proceed to Reschedule
            </Button>
            &nbsp;
            <Button type="button" onClick={() => resetData()} size="sm">
              Discard
            </Button>
          </div>
          <div
            id="myblock"
            className="grid grid-cols-4 gap-6 p-4 pt-0 pb-1 bg-gray-100 dark:bg-gray-800"
          >
            <div className="flex flex-col">
              <span className="font-medium text-gray-600 text-sm">
                Total Spots
              </span>
              <span className="font-medium text-lg text-teal-500">
                {tableData.length}
              </span>
            </div>
            <div className="flex flex-col">
              <span className="font-medium text-gray-600 text-sm">
                Selected Spots
              </span>
              <span className="font-medium text-lg text-teal-500">
                {selectedRows.length}
              </span>
            </div>
            <div className="flex flex-col">
              <span className="font-medium text-gray-600 text-sm">
                Duration
              </span>
              <span className="font-medium text-lg text-teal-500">
                {summaryData.Duration}
              </span>
            </div>
            <div className="flex flex-col">
              <span className="font-medium text-gray-600 text-sm">
                Spot Amount
              </span>
              <span className="font-medium text-lg text-teal-500">
                {summaryData.spotAmountSum}
              </span>
            </div>
          </div>
        </StickyFooter>
      )}
      <Dialog
        isOpen={isFinalSummaryDialogOpen}
        onClose={() => setIsFinalSummaryDialogOpen(false)}
      >
        <Card className="p-6 rounded-xl shadow-lg bg-white">
          <h3 className="text-xl font-bold mb-4">Reschedule Spot</h3>

          <div className="mb-4">
            <label className="block text-sm font-medium mb-2">
              Select New Date
            </label>
            <DatePicker
              minDate={new Date()}
              placeholder="Pick a date"
              value={selectDate}
              onChange={setSelectDate}
              clearable={false}
              style={{ width: "100%" }}
            />
          </div>

          <div className="flex justify-end gap-3">
            <Button variant="outline-danger" onClick={resetData} size="sm">
              Discard
            </Button>
            <Button variant="solid" onClick={handleConfirm} size="sm">
              Confirm
            </Button>
          </div>
        </Card>
      </Dialog>


      <Loader showLoader={showLoader} />
    </>
  );
}
