import {
  Button,
  Card,
  Checkbox,
  DatePicker,
  Dropdown,
  Input,
  Select,
  Tabs,
  Upload,
} from 'components/ui';
import React, { useEffect, useMemo, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { apiGetBrandasperclient } from 'services/CreditcontrolService';
import {
  DealDeatilsGlobel,
  DealMasterGlobel,
} from 'views/Controls/DealDeatilsGlobel';
import { useDispatch, useSelector } from 'react-redux';
import CommercialTypeDropNew from 'views/Controls/CommercialTypeDropNew';
import {
  apiGetCommercialClientBrandwisedrop,
  apiGetPositionDrop,
  apiGetSpotPositionDrop,
  apiGetTrafficDayCloseByDateRange,
  apiUSP_SA_RO_SpotSchedule,
} from 'services/SalesAdminService';
import DatePickerRange from 'components/ui/DatePicker/DatePickerRange';
import DateRangeInputs from './DateRangeInputs';
import { Container, StickyFooter } from 'components/shared';
import { setdateForm } from 'store/locale/localeSlice';
import SearchInputBooking from 'views/Controls/SearchInputBooking';
import { apiGetdealsearchdrop } from 'services/BookingService';
import {
  apiCallforbookdeatil,
  apiCallstoreprocedure_WithOutParamgg,
  apiGetdealdetailId,
  apidealmasterBYID,
} from 'services/DealServices';
import { setDealData, setDealDataDetails } from 'store/auth/userSlice';
import { convertDateToYMD } from 'components/validators';
import {
  FORMATDATE_FOR_EVERY,
  formatDateToDDMMMYYYY,
  generateMultiYearMonthOptions,
  numberToINRFormat,
  openNotification,
  parseDurationE,
  SEND_NOTIFICATION,
} from 'views/Controls/GLOBALFUNACTION';
import dayjs from 'dayjs';
import ReportsTable from 'views/Controls/ReportsTable/ReportsTable';
import appConfig from 'configs/app.config';
import { VscRecord } from 'react-icons/vsc';
import HeaderExtra from 'views/Controls/HeaderExtra';
import { apiCallstoreprocedure } from 'services/CommonService';
import Loader from 'views/Controls/Loader';
import { HiOutlineHome, HiOutlineUser, HiOutlineArrowNarrowLeft } from 'react-icons/hi';
import { Dialog as Dialogg } from 'primereact/dialog';
import { FaRegSave } from 'react-icons/fa';
const { TabNav, TabList, TabContent } = Tabs;
const ToolbarOptionsBooking = { groupBy: true, manageColumns: true };
const daysOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

function generateCustomArray(data) {
  return Object.keys(data)
    .filter(key => key.startsWith("Y")) // Filter only date-related keys
    .map(key => {
      let [midRaw, commercialId] = key.split("|");
      let mid = midRaw.substring(1); // Extract MID from Yx
      let { date, value } = data[key];

      if (value > 0 && value !== null && value !== undefined) { // Ensure valid value
        let newKey = `${mid}|${commercialId}|${date}|${data.MID}|${data.position}`;
        return { [newKey]: `${newKey}|${value}` };
      }
      return null; // Skip invalid entries
    })
    .filter(Boolean); // Remove null values
}
const ShowBookingFooter = ({ Deatils, onDialogClose, onDialogOk, DealData }) => {
  const ChannelSetting = useSelector((state) => state.auth.session.ChannelSetting);
  let totalDuration = 0;
  let totalSpotAmount = 0;

  Deatils.forEach(item => {
    totalDuration += parseDurationE(Number(ChannelSetting[0].FramePerSec), item.Duration);
    totalSpotAmount += item.SpotAmount;
  });
  return (
    <div className='flex item-center justify-between'>
      <div className="flex">
        {' '}
        <div
          className="mr-2 w-[150px]"
          style={{
            backgroundColor: 'rgb(26, 36, 48)',
            borderColor: 'rgb(75, 85, 99)',
            padding: '0.50rem',
            borderRadius: '10px',
          }}
        >
          <div className=" w-full">
            <div className="flex justify-between">
              <p>Total Amount</p>
              <p className="dark:text-sky-500 text-xl font-normal">
                {DealData?.CurrencySymbol}
              </p>
            </div>
            <h3>
              {DealData?.CurrencySymbol}
              {numberToINRFormat(totalSpotAmount)}
            </h3>
          </div>
        </div>
        <div className='mr-2 w-[150px]'
          style={{
            backgroundColor: 'rgb(26, 36, 48)',
            borderColor: 'rgb(75, 85, 99)',
            padding: '0.50rem',
            borderRadius: '10px',
          }}
        >
          <div className=" w-full">
            <div className="flex justify-between">
              <p>Duration [MIN]</p>
              <p className="dark:text-sky-500 text-xl font-normal">
                <VscRecord size={20} className="text-rose-700" />
              </p>
            </div>
            <h3 className="m-1">{Math.round(totalDuration / 60)}</h3>
          </div>
        </div>
        <div className='mr-2 w-[150px]'
          style={{
            backgroundColor: 'rgb(26, 36, 48)',
            borderColor: 'rgb(75, 85, 99)',
            padding: '0.50rem',
            borderRadius: '10px',
          }}
        >
          <div className=" w-full">
            <div className="flex justify-between">
              <p>Spots Count</p>
              <p className="dark:text-sky-500 text-xl font-normal">
                <VscRecord size={20} className="text-rose-700" />
              </p>
            </div>
            <h3 className="m-1">{Deatils.length}</h3>
          </div>
        </div>
      </div>
      <div className="text-right mt-6">
        <Button
          className="ltr:mr-2 rtl:ml-2"
          variant="plain"
          onClick={onDialogClose}
        >
          Cancel
        </Button>
        <Button variant="solid" onClick={onDialogOk}>
          Okay
        </Button>
      </div></div>
  )
}

const BookingMaster = () => {
  const columns = useMemo(
    () => [
      {
        header: 'Commercial',
        accessorKey: 'Commercial',
      },
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',

      },
      {
        header: 'Schedule Time',
        accessorKey: 'ScheduleTime',
      },
      {
        header: 'Content',
        accessorKey: 'ContentName',
      },
      {
        header: 'Break',
        accessorKey: 'BreakNumber',
      },
      {
        header: 'Position',
        accessorKey: 'PositionNumber',
      },
      {
        header: 'Spot',
        accessorKey: 'SpotPosition',
      },
      {
        header: 'Time Band',
        accessorKey: 'TimeBand',
      },
      {
        header: 'Spot Type',
        accessorKey: 'SpotType',
      },
      {
        header: 'Commercial',
        accessorKey: 'Commercial',
      },
      {
        header: 'VideoID',
        accessorKey: 'VideoID',
      },
      {
        header: 'Duration',
        accessorKey: 'Duration',
      },
      {
        header: 'Spot Rate',
        accessorKey: 'SpotRate',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}{' '}
                {row.SpotRate.toLocaleString('en-IN')}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Spot Amount',
        accessorKey: 'SpotAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}{' '}
                {row.SpotAmount.toLocaleString('en-IN')}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Status',
        accessorKey: 'BookingStatus',
      },
      {
        header: 'SpotStatus',
        accessorKey: 'SpotStatus',
      },
    ],
    [],
  );
  const BookingDetailsColumn = useMemo(
    () => [
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',

      },
      {
        header: 'Commercial Caption',
        accessorKey: 'CommercialCaption',

      },
      {
        header: 'Commercial Dur',
        accessorKey: 'CommercialDuration',
      },
      {
        header: 'Amount',
        accessorKey: 'TotalAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(
                  Number(
                    row.TotalAmount ||
                    row.TotalSpot * row.Rate,
                  ),
                )}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Schedule Spot',
        accessorKey: 'AddedSpotCount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {row.AddedSpotCount || row.SpotCount}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Total Spot',
        accessorKey: 'SpotCount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {row.SpotCount || row.TotalSpot}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Remark',
        accessorKey: 'Remark',

      },
    ],
    [],
  );
  const BookingDetailsColumnSummary = useMemo(
    () => [
      {
        header: 'Schedule Date',
        accessorKey: 'ScheduleDate',

      },
      {
        header: 'Schedule Time',
        accessorKey: 'ScheduleTime',
      },
      {
        header: 'Content Name',
        accessorKey: 'ContentName',
      },
      {
        header: 'Commercial Caption',
        accessorKey: 'CommercialCaption',
      },
      {
        header: 'Brk',
        accessorKey: 'BreakNumber',
      },
      {
        header: 'BookingStatus',
        accessorKey: 'BookingStatus',
      },
      {
        header: 'SpotStatus',
        accessorKey: 'SpotStatus',
      },
      {
        header: 'TimeBand',
        accessorKey: 'TimeBandName',
      },
      {
        header: 'House ID',
        accessorKey: 'HouseID',
      },
      {
        header: 'Spot Rate',
        accessorKey: 'SpotRate',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(Number(row.SpotRate))}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Spot Amount',
        accessorKey: 'SpotAmount',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <span className="ml-2 rtl:mr-2 flex items-center">
                {DealData?.CurrencySymbol}
                {numberToINRFormat(Number(row.SpotAmount))}
              </span>
            </div>
          );
        },
      },
      {
        header: 'Billed',
        accessorKey: 'IsBilled',
      },
    ],
    [],
  );
  const currentHref = window.location.href; // Get the full URL
  const hashPart = currentHref.split('#')[1]; // Get the part after the '#'
  const spotBooking = hashPart ? hashPart.split('/')[1] : ''; // Extract "SpotBooking"
  const [currentTab, setCurrentTab] = useState('tab1');
  const Path =
    spotBooking === 'RoImportDetails'
      ? 0
      : spotBooking === 'BookingDetails'
        ? 0
        : 1;
  const { Content } = useSelector((state) => state.base.common);
  const Channel = useSelector((state) => state.locale.selectedChannel);
  const { DealDataDetails, DealData } = useSelector((state) => state.auth.user);
  console.log(DealDataDetails)
  const currentDate = dayjs();
  const dealPeriodFrom = dayjs(DealData?.DealPeriodFromDate);
  const dealPeriodTo = dayjs(DealData?.DealPeriodToDate);
  const [IsNTCPage, setIsNTCPage] = useState();
  const [ManagedColumnBookings, setManagedColumnBookings] = useState([]);
  const [ManagedColumnBookings2, setManagedColumnBookings2] = useState([]);
  const [The_data_I_want_To_Upload, setThe_data_I_want_To_Upload] = useState();
  const [SelectedItem, setSelectedItem] = useState(Content ? Content : []);
  const [TableColumns, setTableColumns] = useState(columns);
  const [checkedItems, setCheckedItems] = useState([]);
  const [brand, setbrand] = useState([]);
  const [position, setposition] = useState([]);
  const [trafficDayList, setTrafficDayList] = useState([]);
  const [dialogIsOpen, setIsOpen] = useState(false);
  const [dialogIsOpen2, setIsOpen2] = useState(false);
  const [showLoader, setShowLoader] = useState(false);
  const [ScheduleButton, setScheduleButton] = useState(false);
  const [spotposition, setspotposition] = useState([]);
  const [commercial, setcommercial] = useState([]);
  const [Dealdata2, setDealdata2] = useState([]);
  const [checkboxList, setCheckboxList] = useState([])
  const [checkboxListDay, setCheckboxListDay] = useState([])
  const [checkboxListDD, setCheckboxListDD] = useState([])
  const [checkboxListDDCom, setCheckboxListDDCom] = useState([])
  const [checkboxListCommercial, setCheckboxListCommercial] = useState([])
  const [valueInsert, setValueInsert] = useState('')
  const [valueInsertDateRange, setValueInsertDateRange] = useState([null, null])
  const [checkedAlternateDays, setCheckedAlternateDays] = useState(false)
  const [formState, setFormState] = useState({
    MID: 2,
    position: 3,
    brand: Content?.BrandMaster?.BrandCode,
    datesrange: [],
    Commercial: [],
    date: new Date(),
    BookingRefNumber: Content?.BookingRefNumber
      ? Content?.BookingRefNumber
      : '',
  });

  const [showSpotdata, setshowSpotdata] = useState({
    BONUS: 0,
    PAID: 0,
    Drop: 0,
    Cancelled: 0,
    spotAmountSum: 0,
    lengthof: 0,
  });
  const [collapse, setCollapse] = useState(false);
  const [Data, setData] = useState([]);
  // Check if current month is within the deal period
  const isCurrentMonthInDealPeriod =
    currentDate.isAfter(dealPeriodFrom.startOf('month')) &&
    currentDate.isBefore(dealPeriodTo.endOf('month'));

  const defaultMonth = isCurrentMonthInDealPeriod
    ? currentDate.startOf('month').toDate()
    : dealPeriodTo.toDate();

  const disableCertainDate = (date) => {
    if (trafficDayList.length !== 0) {
      const formattedDate = dayjs(date).format('YYYY-MM-DD');
      const dateObj = trafficDayList.find(
        (item) => item.date === formattedDate,
      );
      if (dateObj && dateObj.IsActive === 1) {
        return false; // Enable date
      }
      return true;
    }
  };

  useEffect(() => {
    setIsNTCPage(Path);
    if (DealData?.DealPeriodFromDate) {
      (async () => {
        const resp = await apiGetTrafficDayCloseByDateRange(
          DealData?.DealPeriodFromDate,
          DealData?.DealPeriodToDate,
          Channel,
          token,
        );
        if (resp.status == 204) {
          setTrafficDayList([]);
          return;
        }
        setTrafficDayList(resp.data);
      })();
    }
  }, [Path, DealData]);
  const navigate = useNavigate();

  const onCheckboxChangeDay = (options) => {
    setCheckboxListDay(options);

  }
  const onCheckboxChange = (options) => {
    setCheckboxList(options);
    setCheckboxListDD((previous) => {
      const filteredPrevious = previous.filter((item) =>
        options.includes(item.DealLineItemNo)
      );
      const newItems = DealDataDetails.filter((item) =>
        options.includes(item.DealLineItemNo) &&
        !filteredPrevious.some((existing) => existing.DealLineItemNo === item.DealLineItemNo)
      );

      // Return a single flat array of objects
      return [...filteredPrevious, ...newItems];
    });
  }

  const onCheckboxChangeCommercial = (options) => {
    setCheckboxListCommercial(options);
    setCheckboxListDDCom((previous) => {
      const filteredPrevious = previous.filter((item) =>
        options.includes(item.value)
      );
      const newItems = formState?.Commercial.filter(
        (item) => options.includes(item.value) &&
          !filteredPrevious.some((existing) => existing[0]?.value === item.value)
      );
      return [...filteredPrevious, ...newItems];
    });
  };

  useEffect(() => {
    if (Content.Channel?.ChannelCode) {
      if (
        !(
          Content.Channel?.ChannelCode == Channel.ChannelCode &&
          Content.locations?.LocationCode == Channel.LocationCode
        )
      ) {
        navigate(
          spotBooking === 'RoImportDetails'
            ? '/RoImport'
            : spotBooking === 'BookingDetails'
              ? '/SpotBooking'
              : '/NtcSpotBooking',
        );
      }
    }
  }, [Channel]);


  const handleApply = () => {
    if (!checkboxList.length || !checkboxListCommercial.length || !valueInsertDateRange[0] || !valueInsertDateRange[1] || !valueInsert) {
      return openNotification("warning", "Please Select All Fields");
    }

    const { MID, position, brand, datesrange, BookingRefNumber, Commercial, ...filteredArray } = formState;
    const generateDateRange = (start, end) => {
      let dates = [];
      while (start <= end) {
        dates.push(start.toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" }).replace(/ /g, "-"));
        start.setDate(start.getDate() + 1);
      }
      return dates;
    };

    const dateList = generateDateRange(valueInsertDateRange[0], valueInsertDateRange[1]);
    const result = { ...filteredArray };

    checkboxListDD.forEach(deal => {
      let combinedTotal = 0;
      const weekendNames = (deal.weekendsdetail || []).map(item => daysOfWeek[item.Day]);

      checkboxListDDCom.forEach(commercial => {
        dateList.forEach((dateStr, i) => {
          const currentDate = new Date(dateStr);
          const dayOfWeek = currentDate.toLocaleString("en-GB", { weekday: "long" });
          if (!weekendNames.includes(dayOfWeek) || (checkboxListDay.length && !checkboxListDay.includes(dayOfWeek))) return;
          if (checkedAlternateDays && i % 2 !== 0) return;

          const formattedDate = dateStr.split("-").slice(0, 2).join("-");
          const key = `${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;
          const valueKey = `Y${key}`;

          const newTotal = valueInsert * commercial.DurInSec;
          const maxAllowed = deal.DealLineItemTypeCode === 4 ? deal.NTCBalanceSpots : deal.BalancedSpots || deal.BalancedSeconds || 0;

          if (combinedTotal + newTotal > maxAllowed) {
            result[key] = 0;
            result[valueKey] = { value: 0, date: dateStr, total: 0 };
          } else {
            result[key] = valueInsert;
            result[valueKey] = { value: valueInsert, date: dateStr, total: newTotal };
            combinedTotal += newTotal;
          }
        });
      });
    });

    const totals = Object.keys(result).reduce((acc, key) => {
      if (typeof result[key] === "object") {
        const newKey = key.replace(/^Y/, "").split("|").slice(0, 2).join("|") + "|total";
        acc[newKey] = (acc[newKey] || 0) + result[key].value;
      }
      return acc;
    }, {});

    const finalData = { MID, position, brand, datesrange, BookingRefNumber, Commercial, ...totals, ...result };
    setFormState(finalData);
    setThe_data_I_want_To_Upload(
      generateCustomArray(finalData).map(obj => `"${Object.keys(obj)[0]}":"${Object.values(obj)[0]}"`).join(",")
    );
    setValueInsertDateRange({});
  };
  const onCollapse = () => {
    setCollapse(!collapse);
  };

  const handleDelete = async (BookingCode) => {
    try {
      setIsOpen2(false);
      const reps = await apiCallstoreprocedure('USP_DELETE_TEMPBooking', {
        par_BookingNumber: BookingCode,
      });

      setData((prevData) =>
        prevData.filter((item) => item.BookingCode !== BookingCode),
      );
    } catch (error) {
      console.error('Error calling stored procedure:', error);
    }
  };

  const [myid, setmyid] = useState();
  useEffect(() => {
    (async (values) => {
      const resp = await apiCallforbookdeatil(
        'GetBookingDetail',
        Content?.BookingNumber,
      );

      //const resp = await apiGetclientmasterdropmaster(values)

      const BONUS = resp.data.filter(
        (item) => item.SpotType.toUpperCase() === 'BONUS',
      ).length;
      const PAID = resp.data.filter((item) =>
        item.SpotType.toUpperCase() === 'PAID' && myid
          ? item.DealLineItemNo === myid
          : true,
      ).length;
      const Drop = resp.data.filter(
        (item) => item.BookingStatus.toUpperCase() === 'E',
      ).length;
      const Cancelled = resp.data.filter(
        (item) => item.BookingStatus.toUpperCase() === 'C',
      ).length;
      // Convert the result to a JSON string for better logging output

      const result = resp.data
        .filter((item) => (myid ? item.DealLineItemNo === myid : true))
        .reduce(
          (acc, item) => {
            if (item.BookingStatus) {
              acc.bookingStatusCount++;
              acc.spotAmountSum +=
                Number(item.SpotRate) * Number(parseDurationE(item.Duration));
            }
            return acc;
          },
          { bookingStatusCount: 0, spotAmountSum: 0 },
        );

      setshowSpotdata({
        BONUS: BONUS,
        PAID: PAID,
        Drop: Drop,
        Cancelled: Cancelled,
        spotAmountSum: result?.spotAmountSum,
        lengthof: resp.data.filter((item) =>
          myid ? item.DealLineItemNo === myid : true,
        ).length,
      });

      setDeatils(resp.data);

      setSpotCopy(resp.data);
    })();
  }, [Content, myid]);

  const handleCheckboxChange = (item, isChecked, index) => {

    if (
      item.BalancedSeconds > 0 ||
      item.NTCBalanceSpots > 0 ||
      item.BalancedSpots > 0
    ) {
      if (isChecked) {
        // If checkbox is checked, add item to checkedItems array with reft: 1
        setCheckedItems((prevItems) => [...prevItems, { ...item, Id: index }]);
      } else {
        // If checkbox is unchecked, remove item from checkedItems array
        setCheckedItems((prevItems) =>
          prevItems.filter((prevItem) => prevItem.Id !== index),
        );
      }
    } else {
      openNotification('warning', 'Over Booking Not Allowed');
      setCheckedItems([]);
    }
  };


  useEffect(() => {
    (async (values) => {
      const resp = await apiGetPositionDrop(values);
      const formattedOptions = resp.data.map((option) => ({
        value: option.PositionCode,
        label: option.PositionName,
      }));
      setposition(formattedOptions);
    })();
    (async (values) => {
      const resp = await apiGetSpotPositionDrop(values);
      const formattedOptions = resp.data.map((option) => ({
        value: option.SpotPositionTypeCode,
        label: option.SpotPositionTypeName,
      }));
      setspotposition(formattedOptions);
    })();

    (async (values) => {
      let Parameters = {
        LocationCode: Channel.LocationCode,
        ChannelCode: Channel.ChannelCode,
      };
      const resp = await apiGetdealsearchdrop(Parameters, '%20');
      // {
      //     "DealCode": "SB/2/2024/5/219",
      //     "DealNumber": 225,
      //     "ClientName": "Davis Fernandes",
      //     "AgencyName": "test1"
      //   },
      const formattedOptions = resp.data.map((option) => ({
        value: option.DealNumber,
        label:
          option.DealCode +
          ' | ' +
          option.ClientName +
          ' | ' +
          option.AgencyName +
          ' [' + formatDateToDDMMMYYYY(option.DealPeriodFromDate) + ' To ' + formatDateToDDMMMYYYY(option.DealPeriodToDate) + '] ',
      }));
      setDealdata2(formattedOptions);
    })();
  }, []);

  useEffect(() => {
    (async (values) => {
      try {
        const Brand = await apiGetBrandasperclient(DealData?.ClientCode);
        if (Brand.status == 200) {
          const brandOptions =
            Brand.data != ''
              ? Brand.data.map((option) => ({
                value: option.BrandMaster.BrandCode,
                label: option.BrandMaster.BrandName,
              }))
              : [];
          setbrand(brandOptions);
        }
      } catch (error) {
        if (error.response.status == 404) {
          openNotification('warning', 'Brand Not Found');
        }
        if (error.response.status == 500) {
          openNotification('danger', 'Server Error.');
        }
      }
    })();
  }, [DealData?.ClientCode]);

  useEffect(() => {
    if (DealData?.ClientCode && formState?.brand) {
      setcommercial([]);
      (async () => {
        const resp = await apiGetCommercialClientBrandwisedrop(
          formState.brand,
          DealData?.ClientCode,
          Channel.LocationCode,
          Channel.ChannelCode,
          IsNTCPage,
        );

        if (resp.status == 204) {
          setcommercial([]);
          return;
        }

        const clients = resp.data
          .filter((item) => {
            const startDate = item.StartDate ? new Date(item.StartDate) : null;
            const killDate = item.KillDate ? new Date(item.KillDate) : null;

            const rangeStartDate = new Date(formState.datesrange[0]);
            const rangeEndDate = new Date(formState.datesrange[1]);
            if (startDate) {
              if (startDate > rangeStartDate) {
                //||  24-21 startDate < rangeEndDate) {
                return false;
              }
            }

            if (killDate) {
              if (killDate < rangeEndDate) {
                return false;
              }
            }
            return true;
          })
          .map((commercial) => {
            let res = {};
            res.label = `[${commercial.VideoID}] ${commercial.CommercialCaption}`;
            res.value = commercial.CommercialCode;
            res.CommercialCaption = commercial.CommercialCaption;
            res.DurInSec = commercial.DurInSec;
            res.VideoID = commercial.VideoID;

            return res;
          });


        setcommercial(clients);

      })();
    }
  }, [DealData?.ClientCode, formState.brand]);

  const dispatch = useDispatch();

  useEffect(() => {
    dispatch(setDealData([]));
    dispatch(setDealDataDetails([]));
    dispatch(
      setdateForm([
        '', // This is the first empty string before the comma
        spotBooking === 'RoImportDetails'
          ? 'RO Import'
          : spotBooking === 'BookingDetails'
            ? 'Spot Booking'
            : 'Spot NTC Booking',
      ]),
    );

    // const gboxElement = document.getElementsByClassName('Gbox')[0];
    const gboxElement2 = document.getElementsByClassName('Gbox19')[0];
    const gboxElement1 = document.getElementsByClassName('Gbox10')[0];
    const gboxElement = document.getElementsByClassName('Gbox2')[0];

    // if (gboxElement2) {
    gboxElement.style.display = 'block';
    gboxElement1.style.display = 'flex';
    gboxElement2.style.display = 'none';

    // }    // Optionally, you might want to revert the change when the component unmounts
    return () => {
      // if (gboxElement2) {
      gboxElement.style.display = 'none';
      gboxElement1.style.display = 'none';
      gboxElement2.style.display = 'flex';
      // }
    };
  }, []);
  useEffect(() => {
    if (Object.keys(SelectedItem).length > 0) {

      (async (values) => {
        try {
          const dealmaster = await apidealmasterBYID(SelectedItem.value);
          dispatch(setDealData(dealmaster.data));
        } catch (error) { }
      })();
      (async (values) => {
        try {
          const dealdetail = await apiGetdealdetailId(SelectedItem.value);
          dispatch(setDealDataDetails(dealdetail.data));
        } catch (error) { }
      })();
    } else {
      dispatch(setDealData({}));
      dispatch(setDealDataDetails([]));
    }
  }, [SelectedItem]);


  const openDialog = (e) => {
    setmyid(e);
    setIsOpen(true);
  };

  const onDialogClose = (e) => {
    setIsOpen(false);
  };

  const onDialogOk = (e) => {
    setIsOpen(false);
  };

  const [Deatils, setDeatils] = useState([]);
  const [newBookSpotDeatils, setnewBookSpotDeatils] = useState([]);
  const [ShowBookingSpots, setShowBookingSpots] = useState([]);
  useEffect(() => {
    setShowLoader(true);
    if (myid) {
      const filteredData = myid !== 'Y'
        ? Deatils.filter((i) => i.DealLineItemNo === myid)
        : Deatils;

      const formattedData = filteredData.map((item) => ({
        ...item,
        ScheduleDate: FORMATDATE_FOR_EVERY(item?.ScheduleDate)
      }));

      setShowBookingSpots(formattedData);
    }
    setShowLoader(false);
  }, [myid, Deatils]);


  const [SpotCopy, setSpotCopy] = useState([]);
  const token = useSelector((state) => state.auth.session.token);


  const [checked, setChecked] = useState(false);
  const [InputValue, setInputValue] = useState('');
  const [selectedFile, setSelectedFile] = useState('');
  const [SelectMonth, setSelectMonth] = useState({});
  const beforeUpload = async (files, fileList) => {


    const allowedFileType = [
      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
      'application/vnd.ms-excel',
    ];
    const invalidFileTypeMessage = 'Please upload an XLSX file!';
    if (fileList.length >= 1) {
      return `You can only upload ${1} file(s)`;
    }
    const selectedFile = files[0];

    if (!allowedFileType.includes(selectedFile.type)) {
      return invalidFileTypeMessage;
    }

    setSelectedFile(selectedFile);
  };


  const monthOptions2024 = generateMultiYearMonthOptions(
    new Date(DealData?.DealPeriodFromDate),
    new Date(DealData?.DealPeriodToDate),
  );
  const SENDAPI = async () => {
    if (selectedFile.type) {
      if (SelectMonth[0] && formState?.BookingRefNumber) {
        try {
          const headersList = {
            Accept: '*/*',
            Authorization: `Bearer ${token}`,
          };
          const bodyContent = new FormData();
          // Read the selected file as an ArrayBuffer
          const reader = new FileReader();
          reader.onload = async (event) => {
            const arrayBuffer = event.target.result;
            const blob = new Blob([arrayBuffer], { type: selectedFile.type });
            bodyContent.append('file', blob, selectedFile.name);
            try {
              setShowLoader(true);
              const response = await fetch(
                `${appConfig.apiPrefix
                }/spotschedule/USP_SA_RO_SpotSchedule_import/?DealNumber=${SelectedItem.value
                }&LocationCode=${Channel.LocationCode}&ChannelCode=${Channel.ChannelCode
                }&month=${SelectMonth}&IsMakeGoodRO=${checked ? 1 : 0
                }${`&BookingNumber=${Content?.BookingNumber ? Content?.BookingNumber : 0}`}&BookingRefNumber=${formState?.BookingRefNumber
                }&IsNTC=${IsNTCPage}`,
                {
                  method: 'POST',
                  body: bodyContent,
                  headers: headersList,
                },
              );

              const data = await response.json();

              if (response.status === 204) {
                setShowLoader(false);
                openNotification('warning', 'Data Already Exist');
              } else if (response.status === 200) {
                openNotification('success', 'Ro Imported Successfully');
                setIsOpen2(true);
                setShowLoader(false);
                const formattedData = data.map((item) => ({
                  ...item,
                  ScheduleDate: FORMATDATE_FOR_EVERY(item?.ScheduleDate)
                }));
                setData(formattedData); // Assuming resp.data contains the relevant data
              } else {
                setShowLoader(false);
                openNotification(
                  'danger',
                  `Unexpected Response: ${response.status}`,
                );
              }
            } catch (error) {
              setShowLoader(false);
              console.error('Error during API call:', error);
              openNotification('danger', 'Server Error during file upload.');
            }
          };

          // Read the file as an ArrayBuffer
          reader.readAsArrayBuffer(selectedFile);
          setShowLoader(false);
        } catch (error) {
          console.error('Error during file processing:', error);
          openNotification('danger', 'File processing failed.');
        }
      } else {
        openNotification(
          'warning',
          'Please Select Month And Booking Ref Number ',
        );
        setShowLoader(false);
      }
    } else {
      openNotification('warning', 'Please Select Ro Import File');
      setShowLoader(false);
    }
    setShowLoader(false);
  };

  function parseDurationE(duration) {
    const [hours, minutes, seconds, milliseconds] = duration
      .split(':')
      .map(Number);
    return hours * 3600 + minutes * 60 + seconds;
  }

  function calculateTotal(items) {
    return items?.reduce(
      (sum, item) =>
        sum + Number(item?.TotalAmount || item.Rate * item.SpotCount),
      0,
    );
  }
  function sumAddedSpotCount(items) {
    return items.reduce(
      (sum, item) => sum + Number(item.AddedSpotCount || item.TotalSpot),
      0,
    );
  }


  return (
    <Card header={<HeaderExtra Component={'Booking Master'} />}>
      <Container className="h-100">
        <div className="mb-2">
          <div>
            <div className="">
              <div className="m-2 ">
                <SearchInputBooking
                  setCheckedItems={setCheckedItems}
                  SelectedItem={SelectedItem}
                  setSelectedItem={setSelectedItem}
                  data={Dealdata2}
                  placeholder="Search Deal Here..."
                  DealData={DealData}
                  length={The_data_I_want_To_Upload?.length}
                  setFormState={setFormState}
                  setThe_data_I_want_To_Upload={setThe_data_I_want_To_Upload}
                  InputValue={InputValue}
                  setInputValue={setInputValue}
                  Deatils={Deatils}

                ></SearchInputBooking>

                {DealData?.DealNumber ? (
                  <DealMasterGlobel
                    DealData={DealData}
                    onCollapse={onCollapse}
                    collapse={collapse}
                  />
                ) : null}
              </div>
            </div>
          </div>
          <div className="flex justify-end items-center">
            {DealDataDetails?.length > 0 ? (
              <div className="flex justify-end items-center">
                <div className="mr-2">
                  <div>
                    <Checkbox
                      className="mr-4 lbale"
                      checked={checked}
                      onChange={setChecked}
                      name="IsMakeGoodRO"
                      style={{ marginTop: '-10px' }}
                    >
                      <div>
                        <p className=" lbale" style={{ marginTop: '-10px' }}>
                          Is MakeGood RO
                        </p>
                      </div>
                    </Checkbox>
                    <p className="font-medium text-[12px] text-[red]">
                      (Check for RO Re-airing )
                    </p>
                  </div>
                </div>
                {spotBooking === 'RoImportDetails' && (
                  <div className="mr-4">
                    <p className="lbale">
                      Select Month <span style={{ color: 'red' }}>*</span>
                    </p>
                    <Select
                      placeholder="Please Select Month"
                      options={monthOptions2024}
                      onChange={(e) => setSelectMonth(e.value)}
                    ></Select>
                  </div>
                )}
                <div>
                  <p className="lbale">
                    Booking Ref Number <span style={{ color: 'red' }}>*</span>
                  </p>
                  <Input
                    value={formState?.BookingRefNumber}
                    size="sm"
                    maxLength="20"
                    onChange={(e) => {
                      if (/^[a-zA-Z0-9@_-]*$/.test(e.target.value)) {
                        setFormState((prevFormState) => ({
                          ...prevFormState,
                          BookingRefNumber: e.target.value,
                        }));
                      }
                    }}
                  />
                </div>
              </div>
            ) : null}

            {Deatils.length > 0 && (
              <div className="mt-8 ml-2">
                <Button variant="solid" onClick={() => openDialog('Y')}>
                  Show Booking
                </Button>
              </div>
            )}
          </div>
          <div>
            {SelectedItem ? (
              <DealDeatilsGlobel
                DealData={DealData}
                DealDataDetails={DealDataDetails}
                handleCheckboxChange={handleCheckboxChange}
                setmyid={setmyid}
                openDialog={openDialog}
                Deatils={Deatils}
                checkedItems={checkedItems}
                IsNTCPage={IsNTCPage}
              />
            ) : null}
          </div>
          {spotBooking === 'RoImportDetails' && SelectedItem.value && (
            <div>
              <Upload beforeUpload={beforeUpload} uploadLimit={1} draggable />
              <Button
                onClick={() => SENDAPI()}
                variant="solid"
                type="button"
                size="sm" icon={<FaRegSave />}
              >
                Schedule Spot
              </Button>
            </div>
          )}
          {checkedItems.length > 0 &&
            (spotBooking === 'BookingDetails' ||
              spotBooking === 'NTCBookingDetails') ? (
            <div>
              <div className="grid grid-cols-4 gap-2">
                <div className=" col-span-1">
                  <p className="lbale">Booking Date</p>
                  <DatePicker
                    value={formState.date}
                    inputFormat="DD-MM-YYYY"
                    defaultMonth={dayjs(new Date())
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    minDate={dayjs(new Date(DealData?.DealPeriodFromDate))
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    maxDate={dayjs(new Date(DealData?.DealPeriodToDate))
                      .subtract(0, 'day')
                      .startOf('day')
                      .toDate()}
                    onChange={(e) => {
                      setFormState((prevFormState) => ({
                        ...prevFormState,
                        date: e,
                      }));
                    }}
                  />
                </div>
                <div className=" col-span-1">
                  {/* {JSON.stringify(trafficDayList.length)} */}
                  <p className="lbale">Date Range</p>
                  <DatePickerRange
                    placeholder="Select date range"
                    defaultMonth={defaultMonth}
                    inputFormat="DD-MM-YYYY"
                    minDate={
                      trafficDayList.length == 0 &&
                      dayjs(
                        new Date(DealData?.DealPeriodFromDate).getDate() >
                          new Date().getDate()
                          ? new Date(DealData?.DealPeriodFromDate)
                          : new Date(),
                      )
                        .subtract(0, 'day')
                        .startOf('day')
                        .toDate()
                    }
                    maxDate={
                      trafficDayList.length == 0 &&
                      dayjs(new Date(DealData?.DealPeriodToDate))
                        .subtract(0, 'day')
                        .startOf('day')
                        .toDate()
                    }
                    disableDate={disableCertainDate}
                    onChange={(e) => {
                      setFormState({
                        MID: 2,
                        position: 3,
                        brand: Content?.BrandMaster?.BrandCode,
                        datesrange: [],
                        BookingRefNumber: Content?.BookingRefNumber
                          ? Content?.BookingRefNumber
                          : '',
                      });
                      setFormState((prevFormState) => ({
                        ...prevFormState,
                        datesrange: e,
                      }));
                    }}
                  />
                </div>

                <div className=" col-span-2">
                  {!Content.BrandMaster?.BrandCode &&
                    formState.datesrange[0] &&
                    formState.datesrange[1] && (
                      <div>
                        {' '}
                        <p className="lbale">Brand </p>
                        <CommercialTypeDropNew
                          selected={formState.brand}
                          setSelected={setFormState}
                          List={brand}
                          name={'brand'}
                        />
                      </div>
                    )}

                  {Content.BrandMaster?.BrandCode && (
                    <div>
                      <p className="lbale">Brand</p>
                      <Input value={Content.BrandMaster?.BrandName} disabled />
                    </div>
                  )}
                </div>
              </div>
              <div className="grid grid-cols-5 gap-2">
                <div className=" col-span-1">
                  <p className="lbale"> MID-OCL-CCL</p>

                  <CommercialTypeDropNew
                    selected={formState.MID}
                    setSelected={setFormState}
                    List={spotposition}
                    name={'MID'}
                  />
                </div>
                <div className=" col-span-1">
                  <p className="lbale"> Position</p>

                  <CommercialTypeDropNew
                    selected={formState.position}
                    setSelected={setFormState}
                    List={position}
                    name={'position'}
                  />
                </div>

                <div className={` ${formState.brand ? 'col-span-2' : 'hidden'} `}>
                  <p className="lbale flex">Commercial</p>
                  <Select
                    isMulti
                    options={commercial}
                    value={formState.Commercial}
                    onChange={(e) => {
                      setFormState((prevFormState) => {
                        const filteredData = Object.entries(prevFormState).reduce((acc, [key, value]) => {
                          const preservedKeys = ["MID", "position", "brand", "datesrange", "BookingRefNumber", "Commercial"];
                          if (preservedKeys.includes(key)) {
                            acc[key] = value;
                          } else {
                            const [, id] = key.split("|");
                            if (e.some(item => item.value === Number(id))) {
                              acc[key] = value;
                            }
                          }
                          return acc;
                        }, {});

                        return { ...filteredData, Commercial: e };
                      });

                      try {
                        const RK = JSON.parse(`{${The_data_I_want_To_Upload}}`);

                        const filteredData2 = Object.entries(RK).reduce((acc, [key, value]) => {
                          const [, id] = key.split("|");
                          if (e.some(item => item.value === Number(id))) {
                            acc[key] = value;
                          }
                          return acc;
                        }, {});
                        setThe_data_I_want_To_Upload(JSON.stringify(filteredData2, null, 2)
                          .replace(/^{|}$/g, '')  // Remove curly braces
                          .trim());

                      } catch (error) {
                        console.error("Error parsing JSON:", error);
                      }
                    }}

                  />
                </div>

                <div className={` ${formState.brand && formState.Commercial?.length != 0 ? 'col-span-1' : 'hidden'} `}>
                  <Dropdown title={<Button className='mt-5' size='sm' variant='solid'>Copy Pattern</Button>} className="mr-2" placement="top-end">
                    <div className='p-5 '>
                      <div className='mb-2'>
                        <h6 >Select Date Range <span className='text-red-500'>*</span></h6>
                        <DatePickerRange size='sm'
                          inputFormat="DD-MM-YYYY"
                          minDate={

                            dayjs(
                              new Date(formState?.datesrange[0]).getDate() >
                                new Date().getDate()
                                ? new Date(formState?.datesrange[0])
                                : new Date(),
                            )
                              .subtract(0, 'day')
                              .startOf('day')
                              .toDate()
                          }
                          maxDate={

                            dayjs(new Date(formState?.datesrange[1]))
                              .subtract(0, 'day')
                              .startOf('day')
                              .toDate()
                          }
                          // disableDate={disableCertainDate}
                          value={valueInsertDateRange}
                          onChange={(e) => {
                            setValueInsertDateRange(e)
                          }} />
                      </div>
                      <div className='mb-2'>
                        <h6>Select Days </h6>
                        <Checkbox.Group value={checkboxListDay} onChange={onCheckboxChangeDay}>
                          <Checkbox value="Sunday">Sun </Checkbox>
                          <Checkbox value="Monday">Mon</Checkbox>
                          <Checkbox value="Tuesday">Tue</Checkbox>
                          <Checkbox value="Wednesday">Wed</Checkbox>
                          <Checkbox value="Thursday">Thu</Checkbox>
                          <Checkbox value="Friday">Fri</Checkbox>
                          <Checkbox value="Saturday">Sat</Checkbox>
                        </Checkbox.Group>
                      </div>
                      <div className='mb-2'>
                        <h6>Select DealLine Line <span className='text-red-500'>*</span></h6>
                        <Checkbox.Group vertical value={checkboxList} onChange={onCheckboxChange}>
                          {checkedItems.map((item, key) => (<Checkbox value={item.DealLineItemNo}> {item.TimeBandCode != 0 && item.TimeBandName}
                            {item.ContentCode != 0 && item.ContentName} </Checkbox>))}
                        </Checkbox.Group>
                      </div>
                      <div className='mb-2'>
                        <h6> Alternate Days </h6>
                        <Checkbox checked={checkedAlternateDays} onChange={setCheckedAlternateDays}>
                          Alternate Days
                        </Checkbox>
                      </div>
                      <div className='mb-2'>
                        <h6>Select Commercial <span className='text-red-500'>*</span></h6>
                        <Checkbox.Group vertical value={checkboxListCommercial} onChange={onCheckboxChangeCommercial}>
                          {formState?.Commercial && formState.Commercial.map((item, key) => (<Checkbox value={item.value}>{item.CommercialCaption} </Checkbox>))}
                        </Checkbox.Group>
                      </div>
                      <div className='mb-2'>
                        <h6>Select Value <span className='text-red-500'>*</span></h6>
                        <Input size='sm' value={valueInsert} onChange={(e) => { setValueInsert(Number(e.target.value)) }} />
                      </div>

                      <Button
                        size="xs"
                        variant="solid"
                        onClick={() => {
                          if (
                            checkboxList.length == 0 ||
                            checkboxListCommercial.length == 0 ||
                            valueInsertDateRange[0] == null ||
                            valueInsertDateRange[1] == null ||
                            !valueInsert
                          ) {
                            openNotification("warning", "Please Select All Field");
                          } else {
                            const { MID, position, brand, datesrange, BookingRefNumber, Commercial, ...filteredArray } = formState;

                            const generateDateRange = (startDate, endDate) => {
                              const dates = [];
                              while (startDate <= endDate) {
                                dates.push(
                                  startDate
                                    .toLocaleDateString("en-GB", {
                                      day: "2-digit",
                                      month: "short",
                                      year: "numeric",
                                    })
                                    .replace(/ /g, "-")
                                );
                                startDate.setDate(startDate.getDate() + 1);
                              }
                              return dates;
                            };

                            // Generate the date range
                            const dateList = generateDateRange(valueInsertDateRange[0], valueInsertDateRange[1]);
                            const result = { ...filteredArray };

                            checkboxListDD.forEach((deal) => {
                              let combinedTotalForDeal = 0; // Tracks the accumulated total for the deal.
                              // Select weekendsdetail based on DealLineItemTypeCode
                              let weekendDetails = [];
                              if (deal.DealLineItemTypeCode === 4) {
                                weekendDetails = deal.weekendsdetail || [];
                              } else if (deal.DealLineItemTypeCode === 5 || deal.DealLineItemTypeCode === 6) {
                                weekendDetails = deal.weekendsdetail || [];
                              } else if (deal.DealLineItemTypeCode === 2 || deal.DealLineItemTypeCode === 1) {
                                weekendDetails = deal.weekendsdetail || [];
                              }

                              const weekendNames = weekendDetails.map((item) => daysOfWeek[item.Day]); // Get correct weekend names
                              checkboxListDDCom.forEach((commercial) => {
                                for (let i = 0; i < dateList.length; i++) {
                                  const currentDate = new Date(dateList[i]);
                                  const dayOfWeek = currentDate.toLocaleString("en-GB", { weekday: "long" });

                                  // **Step 1: Check if the day is allowed in `weekendsdetail`**
                                  const isWeekendAllowed = weekendNames.includes(dayOfWeek);

                                  // **Step 2: If `checkboxListDay` is used, ensure it matches `weekendsdetail`**
                                  const isCheckboxSelectedValid =
                                    checkboxListDay.length > 0 ? checkboxListDay.includes(dayOfWeek) : true;

                                  // **Final Check: Only insert if the date is in weekendsdetail and checkboxListDay (if used)**

                                  const isDaysInsert = !isWeekendAllowed || (checkboxListDay.length > 0 && !isCheckboxSelectedValid)
                                  // if (isDaysInsert) {
                                  //   continue; // Skip this date
                                  // }
                                  // Skip alternate days if checkedAlternateDays is true
                                  const isAlternateDay = checkedAlternateDays && i % 2 !== 0;

                                  // **Step 3: If it is an alternate day, replace data with 0 if it exists**
                                  const formattedDate = currentDate
                                    .toLocaleDateString("en-GB", {
                                      day: "2-digit",
                                      month: "short",
                                    })
                                    .replace(/ /g, "-");

                                  const key = `${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;
                                  const valueKey = `Y${deal.DealLineItemNo}|${commercial.value}|${formattedDate}`;

                                  if (isAlternateDay || isDaysInsert) {
                                    // Replace existing data with 0 if it already exists
                                    result[key] = 0;
                                    result[valueKey] = {
                                      value: 0,
                                      date: currentDate
                                        .toLocaleDateString("en-GB", {
                                          day: "2-digit",
                                          month: "short",
                                          year: "numeric",
                                        })
                                        .replace(/ /g, "-"),
                                      total: 0,
                                    };
                                  } else {
                                    // If it's not an alternate day, proceed as normal


                                    const newTotal = deal.DealLineItemTypeCode === 4
                                      ? valueInsert
                                      : deal.DealLineItemTypeCode === 5 || deal.DealLineItemTypeCode === 6
                                        ? valueInsert
                                        : deal.DealLineItemTypeCode === 2 || deal.DealLineItemTypeCode === 1
                                          ? valueInsert * commercial.DurInSec
                                          : valueInsert * commercial.DurInSec;
                                    const projectedTotal = combinedTotalForDeal + newTotal;
                                    const maxAllowed =
                                      deal.DealLineItemTypeCode === 4
                                        ? deal.NTCBalanceSpots
                                        : deal.DealLineItemTypeCode === 5 || deal.DealLineItemTypeCode === 6
                                          ? deal.BalancedSpots
                                          : deal.DealLineItemTypeCode === 2 || deal.DealLineItemTypeCode === 1
                                            ? deal.BalancedSeconds
                                            : 0;
                                    console.log(projectedTotal > maxAllowed);
                                    if (projectedTotal > maxAllowed) {
                                      // If the condition is true, immediately make this date 0
                                      result[key] = 0;
                                      result[valueKey] = {
                                        value: 0,
                                        date: currentDate
                                          .toLocaleDateString("en-GB", {
                                            day: "2-digit",
                                            month: "short",
                                            year: "numeric",
                                          })
                                          .replace(/ /g, "-"),
                                        total: 0,
                                      };
                                    } else {
                                      // If the condition is false, insert the value and update the combined total
                                      result[key] = valueInsert;
                                      result[valueKey] = {
                                        value: valueInsert,
                                        date: currentDate
                                          .toLocaleDateString("en-GB", {
                                            day: "2-digit",
                                            month: "short",
                                            year: "numeric",
                                          })
                                          .replace(/ /g, "-"),
                                        total: newTotal,
                                      };

                                      // Update the combined total
                                      combinedTotalForDeal = projectedTotal;
                                    }
                                  }
                                }
                              });
                            });

                            const filteredDataresult = Object.fromEntries(
                              Object.entries(result).filter(([key]) => !key.includes("total"))
                            );

                            function processArray(data) {
                              const result = {};
                              Object.keys(data).forEach((key) => {
                                // Remove the 'Y' from keys if it exists
                                const newKey = key.replace(/^Y/, "").split("|").slice(0, 2).join("|") + "|total";

                                // Check if the key is an object
                                if (typeof data[key] === "object" && data[key] !== null) {
                                  if (!result[newKey]) {
                                    result[newKey] = 0; // Initialize if not already present
                                  }
                                  // Sum the `value` property
                                  result[newKey] += data[key].value;
                                }
                              });
                              return result;
                            }

                            const totals = processArray(filteredDataresult);
                            setFormState({
                              MID: MID,
                              position: position,
                              brand: brand,
                              datesrange: datesrange,
                              BookingRefNumber: BookingRefNumber,
                              Commercial: Commercial,
                              ...totals,
                              ...filteredDataresult,
                            });

                            const finalData = {
                              MID,
                              position,
                              brand,
                              datesrange,
                              BookingRefNumber,
                              Commercial,
                              ...totals,
                              ...filteredDataresult,
                            };

                            const formattedString = generateCustomArray(finalData)
                              .map((obj) => {
                                let key = Object.keys(obj)[0];
                                return `"${key}":"${obj[key]}"`;
                              })
                              .join(",");
                            console.log(formattedString);

                            setThe_data_I_want_To_Upload(formattedString);

                            setValueInsertDateRange({});
                          }
                        }}
                      >
                        Apply
                      </Button>




                    </div>
                  </Dropdown>
                </div>
              </div> </div>
          ) : null}
          {/* {JSON.stringify(formState)} */}
          {(formState?.datesrange[0] || formState?.datesrange[1]) && (
            // <Card className='mt-2'>

            <div>
              <DateRangeInputs
                date1={formState?.datesrange[0]}
                date2={formState?.datesrange[1]}
                formState={formState}
                setFormState={setFormState}
                checkedItems={checkedItems}
                CommercialMasterData={formState.Commercial}
                setThe_data_I_want_To_Upload={setThe_data_I_want_To_Upload}
                IsNTCPage={IsNTCPage}
                trafficDayList={trafficDayList}
                generateCustomArray={generateCustomArray}
              />


            </div>
          )}
          <StickyFooter
            className="-mx-8 px-8 flex items-center justify-between py-4 pt-2 pb-2"
            stickyClass="border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700"
          >
            <div className="md:flex items-center">
              {(formState?.datesrange[0] || formState?.datesrange[1]) &&
                <Button
                  disabled={ScheduleButton}
                  icon={<FaRegSave />}
                  onClick={() => {
                    if (DealData?.ChannelCode) {
                      (async (values) => {
                        if (formState?.BookingRefNumber == '') {
                          openNotification(
                            'warning',
                            'Please Select Booking Ref Number   ',
                          );
                          return;
                        }
                        try {
                          setShowLoader(true);
                          setScheduleButton(true);
                          const USP_SA_RO_SpotSchedule =
                            await apiUSP_SA_RO_SpotSchedule(
                              convertDateToYMD(formState?.datesrange[0]),
                              convertDateToYMD(formState?.datesrange[1]),
                              DealData?.DealNumber,
                              Content?.BookingNumber
                                ? Content?.BookingNumber
                                : 0,
                              `{${The_data_I_want_To_Upload} } `,
                              DealData?.ChannelCode,
                              DealData?.LocationCode,
                              checked,
                              formState?.BookingRefNumber,
                              IsNTCPage,
                              formState?.brand,
                            );
                          if (USP_SA_RO_SpotSchedule.status == 200) {
                            const data = USP_SA_RO_SpotSchedule.data.map((item) => ({
                              ...item,
                              ScheduleDate: FORMATDATE_FOR_EVERY(item?.ScheduleDate)
                            }));
                            setData(data);
                            setIsOpen2(true);
                            setShowLoader(false);
                            // navigate('/BookingMaster')
                          }
                        } catch (error) {
                          if (error.response.status == 500) {
                            setShowLoader(false);
                            openNotification('danger', 'Server  Error');
                            setData([]);
                            setnewBookSpotDeatils([]);
                            setIsOpen2(false);
                          }
                        }
                      })();
                    } else {
                      setShowLoader(false);
                      openNotification(
                        'warning',
                        'Please Select Global Channel',
                      );
                      setData([]);
                    }
                  }}
                  variant="solid"
                  type="submit"
                  size="sm"
                >
                  Schedule Spot
                </Button>
              }
              &nbsp;<Button
                type="button"
                size="sm"
                icon={<HiOutlineArrowNarrowLeft />}
                onClick={() =>
                  navigate(
                    spotBooking === 'RoImportDetails'
                      ? '/RoImport'
                      : spotBooking === 'BookingDetails'
                        ? '/SpotBooking'
                        : '/NtcSpotBooking',
                  )
                }
              >
                Back
              </Button>
            </div>
          </StickyFooter>
        </div>

        <Dialogg visible={dialogIsOpen} style={{ width: '100vw', height: '100%' }} onHide={onDialogClose} footer={<ShowBookingFooter Deatils={Deatils} onDialogOk={onDialogOk} onDialogClose={onDialogClose} DealData={DealData} />}>
          <div className="flex flex-col h-full ">
            <h4 className="mb-4 ml-5">Show Bookings</h4>
            {Deatils.length > 0 && (
              <Card className=" overflow-scroll">
                <ReportsTable
                  tableData={ShowBookingSpots}
                  originalColumns={columns}
                  managedColumns={TableColumns}
                  setManagedColumns={setTableColumns}

                  tableName='Booked Spots'
                // exportFileName="Imported Spots"
                // columnsToFormatInINR={['BalancedAmount', 'TotalAmount']}
                />
              </Card>
            )}
          </div>
        </Dialogg>
        {/* {parseDurationE('00:00:30:00')} */}

        <Dialogg visible={dialogIsOpen2} style={{ width: '100vw', height: '100%' }} onHide={() => setIsOpen2(false)} footer={<div className=" px-6 py-1 bg-gray-100 dark:bg-gray-700 rounded-bl-lg rounded-br-lg">
          <div className="flex justify-between items-center">
            <div className="flex ">
              {' '}
              <div
                className="mr-2"
                style={{
                  backgroundColor: 'rgb(26, 36, 48)',
                  borderColor: 'rgb(75, 85, 99)',
                  padding: '0.50rem',
                  borderRadius: '10px',
                }}
              >
                <div className=" w-full">
                  <div className="flex justify-between">
                    <p>Total Amount</p>
                    <p className="dark:text-sky-500 text-xl font-normal">
                      {DealData?.CurrencySymbol}
                    </p>
                  </div>
                  <h3>
                    {DealData?.CurrencySymbol}
                    {numberToINRFormat(calculateTotal(Data))}
                  </h3>
                </div>
              </div>
              <div
                style={{
                  backgroundColor: 'rgb(26, 36, 48)',
                  borderColor: 'rgb(75, 85, 99)',
                  padding: '0.50rem',
                  borderRadius: '10px',
                  width: 100,
                }}
              >
                <div className=" w-full">
                  <div className="flex justify-between">
                    <p>Spots</p>
                    <p className="dark:text-sky-500 text-xl font-normal">
                      <VscRecord size={20} className="text-rose-700" />
                    </p>
                  </div>
                  <h3 className="m-1">{sumAddedSpotCount(Data)}</h3>
                </div>
              </div>
            </div>
            <div>
              <Button
                className="ltr:mr-2 rtl:ml-2"
                onClick={() => handleDelete(Data[0].BookingNumber)}
              >
                Discard
              </Button>
              <Button
                variant="solid"
                onClick={async () => {
                  try {
                    setShowLoader(true);
                    const resp = await apiCallstoreprocedure_WithOutParamgg(
                      'USP_SA_RO_BookingSave',
                      Content?.BookingCode
                        ? Content?.BookingCode.replace('_unsave', '')
                        : Data[0].BookingCode.replace('_unsave', ''),
                      IsNTCPage,
                    );
                    setShowLoader(false);
                    setIsOpen2(false);
                    if (resp.status == 200) {
                      SEND_NOTIFICATION(
                        8,
                        `Spot Booking for ${Channel.ChannelName
                        } is confirmed from ${FORMATDATE_FOR_EVERY(
                          formState.datesrange[0],
                        )} to ${FORMATDATE_FOR_EVERY(
                          formState.datesrange[1],
                        )}, total ${sumAddedSpotCount(Data)} Bookings Done.
                          `,
                        '',
                        `Spot Booking for ${Channel.ChannelName
                        } is confirmed from ${FORMATDATE_FOR_EVERY(
                          formState.datesrange[0],
                        )} to ${FORMATDATE_FOR_EVERY(
                          formState.datesrange[1],
                        )}, total ${sumAddedSpotCount(Data)} Bookings Done.
                          `,
                        1,
                        1,
                        'Booking',
                        'Booking',
                      );
                      openNotification(
                        'success',
                        `Data saved!!! ${resp.data[0]?.BookingCode} `,
                      );
                      setShowLoader(false);
                      setThe_data_I_want_To_Upload();
                    }
                  } catch (error) {
                    if (error.response.status == 500) {
                      openNotification('danger', 'Server Error.');
                      setShowLoader(false);
                      setIsOpen2(false);
                    }
                  }
                  setShowLoader(false);
                }}
              >
                Save
              </Button>
            </div>
          </div>
        </div>}>
          <Tabs value={currentTab} onChange={(val) => setCurrentTab(val)}>
            <TabList>
              <TabNav value="tab1" icon={<HiOutlineHome />}>
                Booking Spots Summary
              </TabNav>
              <TabNav
                value="tab2"
                icon={<HiOutlineUser />}
                onClick={async () => {
                  setShowLoader(true);
                  setCurrentTab('tab2');
                  try {
                    const newBookSpotDetails = await apiCallstoreprocedure(
                      'GetNewBookSpot',
                      {
                        par_BookingCode: Data[0].BookingCode,
                        par_BookingNumber: Data[0].BookingNumber,
                      },

                    );
                    console.log(newBookSpotDetails);

                    if (newBookSpotDetails.status === 200) {
                      setShowLoader(false);
                      const formatedData = newBookSpotDetails.data.map((item) => ({
                        ...item,
                        ScheduleDate: FORMATDATE_FOR_EVERY(new Date(item?.ScheduleDate))
                      })); setnewBookSpotDeatils(formatedData);
                    } else if (newBookSpotDetails.status === 204) {
                      setnewBookSpotDeatils([]);
                      setShowLoader(false);
                    }
                  } catch (error) {
                    setnewBookSpotDeatils([]);
                    setShowLoader(false);
                  }
                }}
              >
                Booking Spots Details
              </TabNav>
            </TabList>
            <div className="p-4">
              <TabContent value="tab1">
                <div
                  className="px-3  overflow-scroll"
                >
                  <ReportsTable
                    tableData={Data}
                    toolbarOptions={ToolbarOptionsBooking}
                    originalColumns={BookingDetailsColumn}
                    managedColumns={ManagedColumnBookings}
                    setManagedColumns={setManagedColumnBookings}
                    exportFileName="Booking Master"
                    columnsToFormatInINR={[]}
                    tableName='Booking Spots Summary'
                  />
                </div>
              </TabContent>
              <TabContent value="tab2">
                <div
                  className="px-3  overflow-scroll"
                >
                  <ReportsTable
                    tableData={newBookSpotDeatils}
                    toolbarOptions={ToolbarOptionsBooking}
                    originalColumns={BookingDetailsColumnSummary}
                    managedColumns={ManagedColumnBookings2}
                    setManagedColumns={setManagedColumnBookings2}
                    exportFileName="Booking Master"
                    columnsToFormatInINR={[]}
                    tableName='Booking Spots Details'

                  />
                </div>
              </TabContent>
            </div>
          </Tabs>
        </Dialogg>
      </Container >
      <Loader showLoader={showLoader} />
    </Card >
  );
};

export default BookingMaster;

export const VisableColumns = [
  {
    header: 'Commercial',
    name: 'Commercial',
    code: 'Commercial',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Schedule Date',
    name: 'ScheduleDate',
    code: 'ScheduleDate',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Schedule Time',
    name: 'ScheduleTime',
    code: 'ScheduleTime',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Content',
    name: 'ContentName',
    code: 'ContentName',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },

  {
    header: 'Break',
    name: 'BreakNumber',
    code: 'BreakNumber',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Position',
    name: 'PositionNumber',
    code: 'PositionNumber',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Spot',
    name: 'SpotPosition',
    code: 'SpotPosition',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Time Band',
    name: 'TimeBand',
    code: 'TimeBand',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Spot Type',
    name: 'SpotType',
    code: 'SpotType',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'VideoID',
    name: 'VideoID',
    code: 'VideoID',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Duration',
    name: 'Duration',
    code: 'Duration',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Spot Rate',
    name: 'SpotRate',
    code: 'SpotRate',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Spot Amount',
    name: 'SpotAmount',
    code: 'SpotAmount',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Booking Status',
    name: 'BookingStatus',
    code: 'BookingStatus',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
  {
    header: 'Spot Status',
    name: 'SpotStatus',
    code: 'SpotStatus',
    width: 'auto',
    ScreenType: 'SpotBooking',
    Sequence: 2,
    isvisible: true,
  },
];
