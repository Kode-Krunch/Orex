import { Card, Steps } from 'components/ui';
import React, { useEffect, useState } from 'react'
import AddAgencyForms from './components/AddAgencyForms/AddAgencyForms';
import Footer from './components/Footer';
import { Form, Formik } from 'formik';
import * as Yup from 'yup'
import { BASIC_TEXT_INPUT_REGEX, EMAIL_REGEX, FAX_NO_REGEX, ONLY_ALPHABETS_REGEX, PAN_NUMBER_REGEX, PHONE_NO_REGEX } from './regex';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import { getBusinessTypeOptions, getCountryOptions, getCreditRateLimitOptions } from './utils';

const validationSchema = Yup.object().shape({
    // Agency Details
    agencyName: Yup.string().min(3, 'Too short').matches(BASIC_TEXT_INPUT_REGEX, `Only '-_()' are allowed as special characters`).required('Required'),
    agencyShortName: Yup.string().min(3, 'Too short').matches(BASIC_TEXT_INPUT_REGEX, `Only '-_()' are allowed as special characters`).required('Required'),
    agencyDetailsErpCode: Yup.string().min(3, 'Too short').matches(BASIC_TEXT_INPUT_REGEX, `Only '-_()' are allowed as special characters`),
    pan: Yup.string().matches(PAN_NUMBER_REGEX, 'Invalid PAN Number'),
    tan: Yup.string().matches(PAN_NUMBER_REGEX, 'Invalid TAN Number'),
    barcCode: Yup.string().min(3, 'Too short').matches(BASIC_TEXT_INPUT_REGEX, `Only '-_()' are allowed as special characters`),
    mobile: Yup.string().matches(PHONE_NO_REGEX, `Invalid Mobile Number`).required('Required'),
    phone: Yup.string().matches(PHONE_NO_REGEX, `Invalid Phone Number`),
    fax: Yup.string().matches(FAX_NO_REGEX, `Invalid FAX Number`),
    contactPerson: Yup.string().min(3, 'Too short').matches(ONLY_ALPHABETS_REGEX, `Invalid Name`).required('Required'),
    email: Yup.string().matches(EMAIL_REGEX, `Invalid Email Address`).required('Required'),
    creditDays: Yup.number().max(365, 'Days must be less than or equal to 365').required('Required'),
})

function AddAgency() {
    /* STATES */
    const [step, setStep] = useState(0)
    const [creditRateLimitOptions, setCreditRateLimitOptions] = useState([])
    const [businessTypeOptions, setBusinessTypeOptions] = useState([])
    const [countryOptions, setCountryOptions] = useState([]);
    const [stateOptions, setStateOptions] = useState([]);
    const [cityOptions, setCityOptions] = useState([])

    /* USE EFFECTS */
    useEffect(() => {
        (async () => {
            try {
                document.querySelector('.page-container').classList.add('!py-3');
                setCreditRateLimitOptions(await getCreditRateLimitOptions())
                setBusinessTypeOptions(await getBusinessTypeOptions())
                setCountryOptions(await getCountryOptions())
            }
            catch (error) {
                console.error(error)
                openNotification('danger', 'Something went wrong while loading page')
            }
        })()
        return () =>
            document.querySelector('.page-container').classList.remove('!py-2');
    }, []);

    return (
        <div className='h-full flex flex-col gap-2'>
            <h4>Add Agency</h4>
            <Formik
                initialValues={{
                    agencyName: '',
                    agencyShortName: '',
                    agencyDetailsErpCode: '',
                    pan: '',
                    tan: '',
                    barcCode: '',
                    creditRateLimit: null,
                    businessType: null,
                    agencyFlags: [],
                    status: true,
                    remarks: '',
                    mobile: '',
                    phone: '',
                    fax: '',
                    contactPerson: '',
                    email: '',
                    creditType: '',
                    creditDays: '',
                    multipleAddresses: [],
                    mappedExecutives: [],
                    mappedClients: []
                }}
                validationSchema={validationSchema}
            >
                {() => (
                    <Form className='grow flex flex-col'>
                        <Card bordered={false} className="grow" bodyClass="p-3 pb-4 h-full flex flex-col">
                            <Steps current={step} className="border-b border-b-gray-700 pb-4">
                                <Steps.Item title="Agency Details" />
                                <Steps.Item title="Multiple Addresses" />
                                <Steps.Item title="Map Executive" />
                                <Steps.Item title="Map Client" />
                            </Steps>
                            <div className='grow h-0 overflow-auto pt-3'>
                                <AddAgencyForms step={step} creditRateLimitOptions={creditRateLimitOptions}
                                    businessTypeOptions={businessTypeOptions} countryOptions={countryOptions}
                                    stateOptions={stateOptions} cityOptions={cityOptions} setStateOptions={setStateOptions} setCityOptions={setCityOptions}
                                />
                            </div>
                        </Card>
                        <Footer step={step} setStep={setStep} className='mt-3' />
                    </Form>)}
            </Formik>
        </div>
    )
}

export default AddAgency