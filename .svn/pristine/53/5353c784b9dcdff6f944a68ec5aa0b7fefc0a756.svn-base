import React, { forwardRef, useEffect, useRef, useState } from 'react';
import { Field, Form, Formik } from 'formik';
import * as Yup from 'yup';
import {
  Button,
  Card,
  Checkbox,
  DatePicker,
  Dialog,
  FormContainer,
  FormItem,
  Input,
  Notification,
  Select,
  Steps,
  Switcher,
  Upload,
} from 'components/ui';
import Tabs from 'components/ui/Tabs';
import {
  compareDates,
  formatOnHHMMSSBlur,
  handleChangeWithOutFrameNew,
  hideCursorLoader,
  isTimeBetween,
  showCursorLoader,
} from 'views/Controls/GLOBALFUNACTION';
import { convertDateToYMD, validate } from 'components/validators';
import { StickyFooter } from 'components/shared';
import { useDispatch, useSelector } from 'react-redux';
import {
  apiGetbindstartnendtime,
  apiGetdealdetailId,
  apiGetsponsortypemasterdrop,
  apiGetspottypemasterdrop,
  apiGetExchangeRatesForBaseCurrency,
  apidealmasterBYID,
  apidealattachmentBYID,
} from 'services/DealServices';
import {
  apiGetSpotSpotPreferencedrop,
  apiGetfpcorgrepmasterdrop,
  apiGetweekdaysweekendsmaster,
  apisendnotification,
} from 'services/ProgrammingService';
import { apiGetNTCtypedropdown } from 'services/NTCService';
import {
  apiGetAgencyCityIDCITY,
  apiGetChannelmasterdrop,
  apiGetCurrencymasterdrop,
  apiGetZonemasterDrop,
  apiGetclientcitymasterdropmaster,
  apiGetempmasterdropmaster,
} from 'services/MasterService';
import {
  DealCard,
  DealDetailsComponentAdd,
  DealDetailsComponentEdit,
} from './DealDetailsComponent';
import './App.css';
import { setdateForm } from 'store/locale/localeSlice';
import DealHeader from './DealHeader';
import NotificationToast from 'views/Controls/NotificationToast';
import { toast as toa } from 'components/ui';
import appConfig from 'configs/app.config';
import { useLocation, useNavigate } from 'react-router-dom';
import dayjs from 'dayjs';
import {
  PostDealMaster,
  PostSponsorDealMapping,
  PutDealMaster,
  apiGetAgencygetagencyasperclient,
  apiGetDealtypemasterDrop,
  apiGetPayroutemaster,
  apiGetTimeBandmasterdrop3,
  apiGetclientmasterdropmaster,
  apiGetdeallineItemtypemasterDrop,
} from 'services/CreditcontrolService';
import { HiBackspace, HiOutlineEye, HiOutlineInboxIn, HiPrinter } from 'react-icons/hi';
import { AiOutlineSave } from 'react-icons/ai';
import { IoMdArrowRoundForward } from 'react-icons/io';
import Loader from 'views/Controls/Loader';
import { isMultiChannelSelectionEnabled } from './constants';
import MultiCurrencyDropdown from './MultiCurrencyDropdown';
import { apiCallstoreprocedure, getdefaultFormState } from 'services/CommonService';
import { generateDeal } from './DealPrintPdfGenerator/pdfGenerator';
import pdfMake from 'pdfmake/build/pdfmake';
import pdfFonts from 'pdfmake/build/vfs_fonts';
import { REQUEST_HEADER_AUTH_KEY, TOKEN_TYPE } from 'constants/api.constant';
import AttachmentRow from './AttachmentRow';
import FileItem from 'components/ui/Upload/FileItem';
import DealListShowDialogBox from './DealListShowDialogBox';
import { RiInformationFill } from "react-icons/ri";
import ReportsTable from 'views/Controls/ReportsTable/ReportsTable';

pdfMake.vfs = pdfFonts.pdfMake.vfs;

const { TabNav, TabList, TabContent } = Tabs;
const maxUpload = 1;

const SECONDS_FOR_RATE_OPTIONS = [
  { value: 10, label: '10 Seconds' },
  { value: 20, label: '20 Seconds' },
  { value: 30, label: '30 Seconds' },
  { value: 40, label: '40 Seconds' },
  { value: 50, label: '50 Seconds' },
];

const IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS = true;

const DealMasterAdd = forwardRef(() => {
  const hashPart = window.location.href.split('#')[1];
  const dealMasterFlag = hashPart ? hashPart.split('/')[1] : '';

  const Channel = useSelector((state) => state.locale.selectedChannel);
  const channelOptions = useSelector((state) => state.locale.channelList);
  const LoginId = useSelector((state) => state.auth.session.LoginId);
  const { Content } = useSelector((state) => state.base.common);
  const token = useSelector((state) => state.auth.session.token);
  const Username = useSelector((state) => state.auth.session.Username);
  const dispatch = useDispatch();

  const [defaultFormState, setDefaultFormState] = useState({});
  const [pageMode, setPageMode] = useState('add');
  const [isDealMasterAdd] = useState(dealMasterFlag.toLowerCase() === 'dealmasteradd');
  const [showLoader, setShowLoader] = useState(false);
  const [selectedDealData, setSelectedDealData] = useState(null);
  const [currencySymbol, setCurrencySymbol] = useState('');
  const [sponsorTypes, setSponsorTypes] = useState([]);
  const [contentList, setContentList] = useState([]);
  const [spotTypes, setSpotTypes] = useState([]);
  const [ntcTypes, setNtcTypes] = useState([]);
  const [dealTypes, setDealTypes] = useState([]);
  const [clients, setClients] = useState([]);
  const [clientCities, setClientCities] = useState([]);
  const [agencyCities, setAgencyCities] = useState([]);
  const [currencies, setCurrencies] = useState([]);
  const [payRoutes, setPayRoutes] = useState([]);
  const [executives, setExecutives] = useState([]);
  const [weekdays, setWeekdays] = useState([]);
  const [zones, setZones] = useState([]);
  const [agencies, setAgencies] = useState([]);
  const [timeBands, setTimeBands] = useState([]);
  const [spotPreferences, setSpotPreferences] = useState([]);
  const [rodpOptions, setRodpOptions] = useState([]);
  const [formState, setFormState] = useState({});
  const [secondsForRate, setSecondsForRate] = useState(10);
  const [formStateCopy, setFormStateCopy] = useState({});
  const [editIndex, setEditIndex] = useState(null);
  const [dealDetails, setDealDetails] = useState([]);
  const [startTimes, setStartTimes] = useState([]);
  const [endTimes, setEndTimes] = useState([]);
  const [dealLineItemTypes, setDealLineItemTypes] = useState([]);
  const [selectedFile, setSelectedFile] = useState(null);
  const [isDateValid, setIsDateValid] = useState(true);
  const [currentTab, setCurrentTab] = useState(isDealMasterAdd ? (Content.length !== 0 ? 0 : 2) : 1);
  const [step, setStep] = useState(0);
  const [step2, setStep2] = useState(3);
  const [isCollapsed, setIsCollapsed] = useState(false);
  const [channelsSelectorOptions, setChannelsSelectorOptions] = useState([]);
  const [fetchedExchRatesForBaseCur, setFetchedExchRatesForBaseCur] = useState(null);
  const [actualExchRatesForBaseCur, setActualExchRatesForBaseCur] = useState([]);
  const [dealAttachment, setDealAttachment] = useState(null);
  const [initialValues, setInitialValues] = useState({});
  const [isDialogbox, setisDialogbox] = useState(false);
  const [selectedDeal, setSelectedDeal] = useState([]);
  const [isSponsorDialogOpen, setIsSponsorDialogOpen] = useState(false);
  const [sponsorTableData, setSponsorTableData] = useState([]);
  const [sponsorTableColumns, setSponsorTableColumns] = useState([]);
  const [sponsorTableManagedColumns, setSponsorTableManagedColumns] = useState([]);
  const handleSponsorDialogClose = () => setIsSponsorDialogOpen(false)

  const formikRef = useRef();
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    setShowLoader(true);
    getChannelsSelectorOptions().then(setChannelsSelectorOptions);
    dispatch(setdateForm(['value', isDealMasterAdd ? 'Deal master' : 'Sponsor Deal Master']));

    const gboxElement = document.querySelector('.Gbox2');
    if (gboxElement) gboxElement.style.display = 'block';

    apidealmasterBYID(Content.DealNumber).then((response) => {
      if (response.status === 200) {
        setActualExchRatesForBaseCur(response.data.Currencies);
      } else {
        setActualExchRatesForBaseCur([]);
      }
    });

    setShowLoader(false);

    return () => {
      if (gboxElement) gboxElement.style.display = 'none';
    };
  }, []);

  useEffect(() => {
    if (Content?.DealNumber) {
      handleDealAttachmentClick(Content.DealNumber);
    }
  }, [Content]);

  useEffect(() => {
    if (!isDealMasterAdd) {
      fetchClientCities(59);
      fetchAgenciesByClient(59);
      fetchAgencyCities(66);
      fetchDeafultFormState(Channel);
    }
    fetchDealLineItemTypes();
    getFixedDataFromSP()
  }, [isDealMasterAdd]);

  const getFixedDataFromSP = async () => {
    let dealFixedDataSponsor = {}
    const response = await apiCallstoreprocedure('GetSponsorFixValues', {
    });
    if (isDealMasterAdd) { dealFixedDataSponsor = {} } else {
      dealFixedDataSponsor = response.data[0];

    }
    setInitialValues({
      isRender: true,
      DealCode: Content.DealCode || '',
      CancelStatus: Content.CancelStatus === 1 ? true : false,
      LocationCode: Content.LocationCode || Channel.LocationCode,
      ChannelCode: Content.ChannelCode || Channel.ChannelCode,
      DealReferenceNumber: dealFixedDataSponsor?.DealReferenceNumber || Content.DealReferenceNumber || '',
      PayRouteCode: isDealMasterAdd ? { value: Number(Content.PayRouteCode) || '', label: Content.PayRouteName } : { value: dealFixedDataSponsor.PayRouteCode, label: dealFixedDataSponsor.PayRouteName },
      DealTypeCode: isDealMasterAdd ? { value: Number(Content.DealTypeCode) || '', label: Content.DealTypeName } : { value: dealFixedDataSponsor.dealtypecode, label: dealFixedDataSponsor.DealTypeName },
      CurrencyCode: isDealMasterAdd ? { value: Number(Content.CurrencyCode) || '', label: Content.CurrencyName } : { value: dealFixedDataSponsor.CurrencyCode, label: dealFixedDataSponsor.CurrencyName },
      ZoneCode: isDealMasterAdd ? { value: Number(Content.ZoneCode) || '', label: Content.ZoneName } : { value: dealFixedDataSponsor.ZoneCode, label: dealFixedDataSponsor.ZoneName },
      SalesExcutiveCode: isDealMasterAdd ? { value: Number(Content.SalesExcutiveCode) || '', label: Content.Emp_FirstName } : { value: dealFixedDataSponsor.EmployeeCode, label: dealFixedDataSponsor.Emp_FirstName },
      ClientCode: isDealMasterAdd ? { value: Number(Content.ClientCode) || '', label: Content.ClientName } : { value: dealFixedDataSponsor.ClientCode, label: dealFixedDataSponsor.ClientName },
      ClientPlaceCode: isDealMasterAdd ? { value: Number(Content.ClientPlaceCode) || '', label: Content.ClientPlaceName } : { value: dealFixedDataSponsor.clientplacecode, label: dealFixedDataSponsor.clientplacename },
      AgencyCode: isDealMasterAdd ? {
        value: Number(Content.AgencyCode) || '', label: Content.AgencyName,
        IsCredit: Content.IsCredit,
        CreditDays: Content.CreditDays,
        IsAdvPmt: Content.IsAdvPmt,
        IsPDC: Content.IsPDC,
        BusinessTypeName: Content.BusinessTypeName,
        BusinessTypeCode: Content.BusinessTypeCode,
      } : {
        value: dealFixedDataSponsor.AgencyCode,
        label: dealFixedDataSponsor.AgencyName,
        IsCredit: dealFixedDataSponsor.IsCredit,
        CreditDays: dealFixedDataSponsor.CreditDays,
        IsAdvPmt: dealFixedDataSponsor.IsAdvPmt,
        IsPDC: dealFixedDataSponsor.IsPDC,
        BusinessTypeName: dealFixedDataSponsor.BusinessTypeName,
        BusinessTypeCode: dealFixedDataSponsor.BusinessTypeCode,
      },
      AgencyPlaceCode: isDealMasterAdd ? {
        value: Number(Content.AgencyPlaceCode) || '', label: Content.AgencyPlaceName,
        Address1: Content.Address1,
        Address2: Content.Address2,
        GSTN_id: `${Content.GSTN_id}`,
      } : {
        value: dealFixedDataSponsor.PlaceCode,
        label: dealFixedDataSponsor.PlaceName,
        Address1: dealFixedDataSponsor.Address1,
        Address2: dealFixedDataSponsor.Address2,
        GSTN_id: `${dealFixedDataSponsor.GSTN_id}`,
      },
      DealPeriodFromDate: isDealMasterAdd && Content.DealPeriodFromDate ? Content.DealPeriodFromDate : null,
      DealPeriodToDate: isDealMasterAdd && Content.DealPeriodToDate ? Content.DealPeriodToDate : null,
      DealCreatedDate: isDealMasterAdd ? Content.DealCreatedDate ? Content.DealCreatedDate : null : new Date(),
      GSTN_id: isDealMasterAdd ? '1' : '0',
      IsWebDeal: Content.IsWebDeal || 1,
      DealNumber: Content.DealNumber || '',
      IPAddress: Content.IPAddress || '',
      Channels1: Content.Channels || channelsSelectorOptions.filter(opt => opt.ChannelCode === Channel.ChannelCode && opt.LocationCode === Channel.LocationCode),
    });
  };
  useEffect(() => {
    if (Content && !Array.isArray(Content)) {
      fetchClientCities(Content.ClientCode);
      fetchAgencyCities(Content.AgencyCode);
      fetchAgenciesByClient(Content.ClientCode);
      apiGetdealdetailId(Content.DealNumber).then((data1) => {
        setShowLoader(false);
        const transformedData = data1.data.map((item) => ({
          channel: channelOptions.find((ch) => ch.ChannelCode === item.ChannelCode),
          name: item.DealLineItemTypeCode,
          EndTime: item.EndTime,
          StartTime: item.StartTime,
          IsCommited: item.IsCommited,
          CommitedStartTime: item.CommitedStartTime,
          CommitedEndTime: item.CommitedEndTime,
          NTCTotalSpots: item.NTCTotalSpots,
          TotalSpots: item.TotalSpots,
          LineItemCancelStatus: item.LineItemCancelStatus,
          ConsumedAmount: item.ConsumedAmount,
          ConsumedSeconds: item.ConsumedSeconds,
          BalancedAmount: item.BalancedAmount,
          BalancedSeconds: item.BalancedSeconds,
          TimeBandCode: { value: item.TimeBandCode, label: item.TimeBandName || 'NA' },
          SponsorTypeCode: { value: item.SponsorTypeCode, label: item.SponsorTypeName || 'NA' },
          NTCTypeCode: { value: item.NTCTypeCode, label: item.NTCTypeName || 'NA' },
          ContentCode: { value: item.ContentCode, label: item.ContentName || 'NA' },
          OriginalRepeatCode: { value: item.OriginalRepeatCode, label: item.OriginalRepeatName || 'NA' },
          StartTimeDrop: { value: item.StartTime, label: item.StartTime || 'NA' },
          EndTimeDrop: { value: item.EndTime, label: item.EndTime || 'NA' },
          SpotTypeCode: { value: item.SpotTypeCode, label: item.SpotTypeName || 'NA' },
          NoWeeks: item.NoWeeks,
          WeekDayCode: { value: item.WeekdaysCode, label: item.WeekdaysName },
          IsNTC: item.IsNTC,
          Rate: item.Rate,
          Second: item.Seconds,
          Amount: item.Amount,
          NetAmount: item.NetAmount,
          InternalRate: item.InternalRate,
          LineItemRemark: item.LineItemRemark,
          DealLineItemNo: item.DealLineItemNo,
          SpotPreferenceCode: { value: item.SpotPreferenceCode, label: item.SpotPreferenceName },
          DealLineItemType: { value: item.DealLineItemTypeCode, label: item.DealLineItemTypeName },
        }));
        setDealDetails(transformedData);
      });
    }
  }, [Content]);

  useEffect(() => {
    const locationCode = formState.channel ? formState.channel.value.split('-')[1] : Channel.LocationCode;
    const channelCode = formState.channel ? formState.channel.value.split('-')[0] : Channel.ChannelCode;
    fetchContentList(locationCode, channelCode);
  }, [formState.channel]);

  useEffect(() => {
    if (formState.ContentCode?.value && formState.OriginalRepeatCode?.value) {
      Bindstartnendtime(
        formState.ContentCode.value,
        formState.OriginalRepeatCode.value,
        formState.channel?.value.split('-')[0] || Channel.ChannelCode,
      );
    }
  }, [formState.ContentCode?.value, formState.OriginalRepeatCode?.value]);

  useEffect(() => {
    if (formState.Rate && formState.Second && secondsForRate) {
      calculateValue(formState.Rate, formState.Second);
    }
  }, [secondsForRate]);

  useEffect(() => {
    if (location.state && location.state.mode) {
      setPageMode(location.state.mode);
    }
  }, [location]);

  useEffect(() => {
    fetchDropdownData();
  }, []);

  const fetchDropdownData = async () => {
    try {
      const results = await Promise.allSettled([
        apiGetclientmasterdropmaster(),
        apiGetPayroutemaster(),
        apiGetCurrencymasterdrop(),
        apiGetDealtypemasterDrop(),
        apiGetZonemasterDrop(),
        apiGetempmasterdropmaster(),
        apiGetsponsortypemasterdrop(),
        apiGetspottypemasterdrop(),
        apiGetNTCtypedropdown(),
        apiGetweekdaysweekendsmaster(),
        apiGetfpcorgrepmasterdrop(),
        apiGetSpotSpotPreferencedrop(),
        apiGetTimeBandmasterdrop3(),
      ]);

      const [
        clientsRes,
        payRoutesRes,
        currenciesRes,
        dealTypesRes,
        zonesRes,
        executivesRes,
        sponsorTypesRes,
        spotTypesRes,
        ntcTypesRes,
        weekdaysRes,
        timeBandsRes,
        spotPreferencesRes,
        rodpRes,
      ] = results;

      // Helper function: safely extract data only if fulfilled
      const getData = (res) => (res.status === "fulfilled" && res.value.data !== "" ? res.value.data : []);

      setClients(getData(clientsRes).map(opt => ({ value: opt.ClientCode, label: opt.ClientName })));
      setPayRoutes(getData(payRoutesRes).map(opt => ({ value: opt.PayRouteCode, label: opt.PayRouteName, AgencyShare: opt.AgencyShare })));
      setCurrencies(getData(currenciesRes).map(opt => ({ value: opt.CurrencyCode, label: opt.CurrencyName, symbol: opt.CurrencySymbol, shortName: opt.ShortName })));
      setDealTypes(getData(dealTypesRes).map(opt => ({ value: opt.DealTypeCode, label: opt.DealTypeName })));
      setZones(getData(zonesRes).map(opt => ({ value: opt.ZoneCode, label: opt.ZoneName })));
      setExecutives(getData(executivesRes).map(opt => ({ value: opt.EmployeeCode, label: opt.Emp_FirstName })));
      setSponsorTypes(getData(sponsorTypesRes).map(opt => ({ value: opt.SponsorTypeCode, label: opt.SponsorTypeName })));
      setSpotTypes(getData(spotTypesRes).map(opt => ({ value: opt.SpotTypeCode, label: opt.SpotTypeName })));
      setNtcTypes(getData(ntcTypesRes).map(opt => ({ value: opt.NTCTypeCode, label: opt.NTCTypeName })));
      setWeekdays(getData(weekdaysRes).map(opt => ({ value: opt.WeekdaysCode, label: opt.WeekdaysName })));
      setTimeBands(getData(timeBandsRes).map(opt => ({ value: opt.OriginalRepeatCode, label: opt.OriginalRepeatName })));
      setSpotPreferences(getData(spotPreferencesRes).map(opt => ({ value: opt.SpotPreferenceCode, label: opt.SpotPreferenceName })));
      setRodpOptions(getData(rodpRes).map(opt => ({ value: opt.TimeBandCode, StartTime: opt.StartTime, EndTime: opt.EndTime, label: opt.TimeBandName })));

      // Optionally log which failed
      results.forEach((res, i) => {
        if (res.status === "rejected") {
          console.error(`Dropdown API #${i + 1} failed:`, res.reason);
        }
      });
    } catch (error) {
      console.error("Unexpected error in fetchDropdownData:", error);
    }
  };


  const fetchDealLineItemTypes = async () => {
    const resp = await apiGetdeallineItemtypemasterDrop();
    const formatted = isDealMasterAdd ? resp.data.map(opt => ({ value: opt.DealLineItemTypeCode, label: opt.DealLineItemTypeName })) : [{ value: 1, label: 'Sponsor Wise' }];
    setDealLineItemTypes(formatted);
  };

  const fetchContentList = async (locationCode, channelCode) => {
    const resp = await apiCallstoreprocedure('USP_Deal_GetProgramList', {
      LocationCode: locationCode,
      ChannelCode: channelCode,
      FromDate: selectedDealData?.DealPeriodFromDate,
      ToDate: selectedDealData?.DealPeriodToDate,
    });
    setContentList(resp.data.map(opt => ({ value: opt.ContentCode, label: opt.ContentName })));
  };

  const fetchClientCities = async (id) => {
    const resp = await apiGetclientcitymasterdropmaster(id);
    setClientCities(resp.data.map(opt => ({ value: opt.Place.PlaceCode, label: opt.Place.PlaceName })));
  };

  const fetchAgenciesByClient = async (id) => {
    const resp = await apiGetAgencygetagencyasperclient(id);
    setAgencies(resp.data.map(opt => ({
      value: opt.AgencyCode,
      label: opt.AgencyName,
      IsCredit: opt.IsCredit,
      IsAdvPmt: opt.IsAdvPmt,
      IsPDC: opt.IsPDC,
      CreditDays: opt.CreditDays,
      BusinessTypeCode: opt.BusinessType.BusinessTypeCode,
      BusinessTypeName: opt.BusinessType.BusinessTypeName,
    })));
  };

  const fetchDeafultFormState = async () => {
    const resp = await getdefaultFormState(Channel);
    setDefaultFormState(resp.data);
  }


  const fetchAgencyCities = async (id) => {
    const resp = await apiGetAgencyCityIDCITY(id);
    setAgencyCities(resp.data.map(opt => ({
      value: opt.Place.PlaceCode,
      label: opt.Place.PlaceName,
      Country: opt.Country.CountryCode,
      State: opt.State.StateCode,
      Place: opt.Place.PlaceCode,
      Address1: opt.AddressLine1,
      Address2: opt.AddressLine2,
      PlaceName: opt.Place.PlaceName,
      StateName: opt.State.StateName,
      GSTN_id: opt.GSTN_id,
    })));
  };

  const handleDealAttachmentClick = async (bookingNumber) => {
    try {
      showCursorLoader();
      const response = await apidealattachmentBYID(bookingNumber);
      if (response.status === 200) {
        setDealAttachment(response.data);
      } else if (response.status === 204) {
        setDealAttachment([]);
      } else {
        setDealAttachment([]);
        openNotification('danger', `Something went wrong while fetching deal attachment. Server responded with status code ${response.status}`);
      }
    } catch (error) {
      openNotification('danger', 'Something went wrong while fetching deal attachment');
      console.error(error);
    } finally {
      hideCursorLoader();
    }
  };

  const handleDownloadAndView = async (filename) => {
    try {
      const response = await fetch(`${appConfig.apiPrefix}/dealmaster/readuploadedfile/${filename}`, {
        method: 'GET',
        headers: {
          [REQUEST_HEADER_AUTH_KEY]: `${TOKEN_TYPE}${token}`,
          'Content-Type': 'application/json',
        },
      });
      if (response.status === 204) {
        throw new Error(`Server Error: ${response.status}`);
      }
      const contentType = response.headers.get('content-type');
      if (contentType.includes('application/json')) {
        const data = await response.json();
        alert(`Text File Content:\n${data.content}`);
      } else {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }
    } catch (error) {
      console.error('Error downloading file:', error);
    }
  };

  const openNotification = (message, type, duration) => {
    toa.push(<NotificationToast message={message} type={type} duration={duration} />);
  };

  const triggerMessage = (msg) => {
    toa.push(
      <Notification type="success" duration={2000}>
        {msg}
      </Notification>,
      { placement: 'top-center' },
    );
  };

  const beforeUpload = (file, fileList) => {
    let valid = true;
    const MAX_FILE_SIZE = 500000;
    if (fileList.length === 0) {
      triggerMessage('Your file has been uploaded');
      setSelectedFile(file[0]);
    }
    if (fileList.length >= maxUpload) {
      return `You can only upload ${maxUpload} file(s)`;
    }
    for (const f of file) {
      if (f.size >= MAX_FILE_SIZE) {
        setSelectedFile(null);
        valid = 'Upload image cannot more then 500kb!';
      }
    }
    return valid;
  };

  const uploadFolder = async (DealCode, DealNumber) => {
    const headersList = {
      Accept: '*/*',
      Authorization: `Bearer ${token}`,
    };
    const bodyContent = new FormData();
    try {
      const arrayBuffer = await selectedFile.arrayBuffer();
      const blob = new Blob([arrayBuffer], { type: selectedFile.type });
      bodyContent.append('files', blob, selectedFile.name);

      const response = await fetch(
        `${appConfig.apiPrefix}/dealmaster/uploadattachment/${DealNumber}?Dealcode=${DealCode}`,
        {
          method: 'POST',
          body: bodyContent,
          headers: headersList,
        },
      );

      if (response.status === 200) {
        closeAfter2000ms();
      } else {
        console.error('Error uploading file:', response.statusText);
      }
    } catch (error) {
      console.error('Error uploading file:', error);
    }
  };

  const getChannelsSelectorOptions = async () => {
    try {
      let options = [];
      const resp = await apiGetChannelmasterdrop(LoginId);
      if (resp.status === 200) {
        options = resp.data.map((item) => ({
          value: item.ChannelCode + '-' + item.LocationCode,
          label: item.LocationName + ' ' + item.ChannelName,
          ChannelCode: item.ChannelCode,
          LocationCode: item.LocationCode,
          ChannelName: item.ChannelName,
          ColorClass: 'bg-rose-500',
          LocationName: item.LocationName,
          imgPath: item.Channel_Image,
        }));
      } else if (resp.status !== 204) {
        openNotification('danger', `Unable to fetch channels. Server responded with status code ${resp.status}`);
      }
      return options;
    } catch (error) {
      throw error;
    }
  };

  const DealLineAddValidation = (LineData, currentTab) => {
    if (currentTab === 1) {
      if (!LineData?.SponsorTypeCode?.value) return openNotification('Please Select Sponsor Type!!', 'danger'), false;
      if (!LineData.ContentCode?.value) return openNotification('Please Select Program!!', 'danger'), false;
      if (!LineData.OriginalRepeatCode?.value) return openNotification('Please Select Original/Repeat!!', 'danger'), false;
      if (!LineData.StartTime) return openNotification('Please Select Start Time!!', 'danger'), false;
      if (!LineData.EndTime) return openNotification('Please Select End Time!!', 'danger'), false;
      if (!LineData?.Rate && LineData?.SpotTypeCode?.value !== 2) return openNotification('Please enter Rate Per Slot!!', 'danger'), false;
      if (!LineData?.NoWeeks) return openNotification('Please Select No of Week!!', 'danger'), false;
      if (!LineData?.TotalSpots) return openNotification('Please Insert Slot ', 'danger'), false;
    }
    if (currentTab === 2) {
      if (LineData?.IsCommited === 1 && (!LineData?.CommitedStartTime || !LineData?.CommitedEndTime)) return openNotification('Please enter Commited Time !!', 'danger'), false;
      if (!LineData?.Second) return openNotification('Please enter Seconds!!', 'danger'), false;
      if (!LineData.TimeBandCode?.value) return openNotification('Please Select TimeBand!!', 'danger'), false;
      if (LineData?.SpotPreferenceCode <= 0) return openNotification('Please select Spot Preference !!', 'danger'), false;
    }
    if (currentTab === 3) {
      if (!LineData.ContentCode?.value) return openNotification('Please Select Program!!', 'danger'), false;
      if (!LineData.OriginalRepeatCode?.value) return openNotification('Please Select Original/Repeat!!', 'danger'), false;
      if (!LineData.StartTime) return openNotification('Please Select Start Time!!', 'danger'), false;
      if (!LineData.EndTime) return openNotification('Please Select End Time!!', 'danger'), false;
    }
    if (currentTab === 4) {
      if (!LineData.TimeBandCode?.value) return openNotification('Please Select TimeBand!!', 'danger'), false;
      if (!LineData.NTCTypeCode?.value) return openNotification('Please Select NTC Type!!', 'danger'), false;
    }
    if (currentTab === 5) {
      if (!LineData.ContentCode?.value) return openNotification('Please Select Program!!', 'danger'), false;
      if (!LineData?.TotalSpots) return openNotification('Please enter Slot!!', 'danger'), false;
      if (!LineData.OriginalRepeatCode?.value) return openNotification('Please Select Original/Repeat!!', 'danger'), false;
      if (!LineData.StartTime) return openNotification('Please Select Start Time!!', 'danger'), false;
      if (!LineData.EndTime) return openNotification('Please Select End Time!!', 'danger'), false;
    }
    if (currentTab === 6) {
      if (!LineData.TimeBandCode?.value) return openNotification('Please Select TimeBand!!', 'danger'), false;
      if (!LineData?.TotalSpots) return openNotification('Please enter Slot!!', 'danger'), false;
      if (LineData?.SpotPreferenceCode <= 0) return openNotification('Please select Spot Preference !!', 'danger'), false;
    }
    if (!LineData.SpotTypeCode?.value) return openNotification('Please Select Spot Type!!', 'danger'), false;
    if (LineData?.SpotTypeCode?.value === 1 && (!LineData.Rate || LineData.Rate <= 0)) return openNotification('Rate should be greater than 0 !!', 'danger'), false;
    if (!LineData.WeekDayCode?.value) return openNotification('Please Select WeekDays!!', 'danger'), false;
    return true;
  };

  const calculateValue = (inputValue, Second) => {
    const result = (Number(Second) / secondsForRate) * Number(inputValue);
    const roundedResult = parseFloat(result.toFixed(2));
    setFormState((prev) => ({ ...prev, Amount: roundedResult, NetAmount: roundedResult }));
    return roundedResult;
  };

  const calculateValueX = (inputValue, Second) => {
    const result = Number(Second) * Number(inputValue);
    setFormState((prev) => ({ ...prev, Amount: result, NetAmount: result }));
    return result;
  };

  const calculateValueXSpot = (inputValue, Second) => {
    const result = Number(Second) * Number(inputValue);
    setFormState((prev) => ({ ...prev, Amount: result, NetAmount: result }));
    return result;
  };

  const Bindstartnendtime = async (Prog, Org, ChannelCode) => {
    if (Prog && Org) {
      const resp = await apiGetbindstartnendtime(
        selectedDealData.DealPeriodToDate,
        selectedDealData.DealPeriodFromDate,
        Prog,
        Org,
        Channel.LocationCode,
        ChannelCode,
      );
      if (resp.status === 204) {
        openNotification('Start Time & End Time Not Found Please Change Org/Rep ', 'info');
        setStartTimes([]);
        setEndTimes([]);
        return;
      }
      setStartTimes(resp.data.TelecastStartTime.map(time => ({ value: time, label: time })));
      setEndTimes(resp.data.TelecastEndTime.map(time => ({ value: time, label: time })));
    }
  };

  const handleInputChange = (value, name) => {
    setFormState((prev) => ({ ...prev, [name]: value }));
  };

  const handleBlur = (event) => {
    const { name, value } = event.target;
    const formattedValue = formatOnHHMMSSBlur(value);
    if (name === 'CommitedStartTime' || name === 'CommitedEndTime') {
      if (isTimeBetween(formattedValue, formState.StartTime, formState.EndTime)) {
        setFormState((prev) => ({ ...prev, [name]: formattedValue }));
      } else {
        openNotification('Please enter correct Commited Time', 'danger');
        setFormState((prev) => ({ ...prev, [name]: '' }));
      }
    } else {
      setFormState((prev) => ({ ...prev, [name]: formattedValue }));
    }
  };

  const handleSwitchChange = (value, name) => {
    setFormState((prev) => ({ ...prev, [name]: !value ? 1 : 0 }));
  };

  const handleSelectChange = (value, name) => {
    if (name === 'TimeBandCode') {
      setFormState((prev) => ({
        ...prev,
        EndTime: value.EndTime,
        StartTime: value.StartTime,
        TimeBandCode: value,
        CommitedStartTime: value.StartTime,
        CommitedEndTime: value.EndTime,
      }));
      return;
    }
    if (name === 'SpotTypeCode' && value.value === 2) {
      setFormState((prev) => ({ ...prev, Rate: 0, Amount: 0, SpotTypeCode: value }));
      return;
    }
    setFormState((prev) => ({ ...prev, [name]: value }));
  };

  const validationSchema = Yup.object({
    PayRouteCode: Yup.object().shape({ value: Yup.string().required('Pay Route is required') }).required('Pay Route is required'),
    AgencyPlaceCode: Yup.object().shape({ value: Yup.string().required('Agency City is required') }).required('Agency City is required'),
    CurrencyCode: Yup.object().shape({ value: Yup.string().required('Currency is required') }).required('Currency is required'),
    DealTypeCode: Yup.object().shape({ value: Yup.string().required('Deal type is required') }).required('Deal type is required'),
    AgencyCode: Yup.object().shape({ value: Yup.string().required('Agency is required') }).required('Agency is required'),
    ZoneCode: Yup.object().shape({ value: Yup.string().required('Zone is required') }).required('Zone is required'),
    SalesExcutiveCode: Yup.object().shape({ value: Yup.string().required('Sales Excutive is required') }).required('Sales Excutive is required'),
    ClientCode: Yup.object().shape({ value: Yup.string().required('Client is required') }).required('Client is required'),
    ClientPlaceCode: Yup.object().shape({ value: Yup.string().required('Client Place is required') }).required('Client Place is required'),
    DealPeriodFromDate: Yup.string().nullable().required('From Date Required'),
    DealPeriodToDate: Yup.string().nullable().required('To Date Required'),
    DealCreatedDate: Yup.string().nullable().required('Deal Date Required'),
    DealReferenceNumber: Yup.string().min(1, 'Too Short!').max(20, 'Too Long!').required('Deal Reference Required'),
    // Channels1: Yup.array().min(1, 'Channel Required'),
  });

  const compareDatesV = (form) => {
    if (!isDateValid) {
      form.setFieldValue('DealPeriodFromDate', null);
      form.setFieldValue('DealPeriodToDate', null);
      setIsDateValid(true);
    }
  };

  const onChange = (nextStep) => {
    setStep(Math.max(0, Math.min(nextStep, 3)));
  };


  const onNext = () => {
    formikRef.current.submitForm();
  };

  const createParams = (dealDetails, resp) => {
    return dealDetails.flatMap(item =>
      item.selectedDeal.map(selected => ({
        DealDetailID: selected.DealDetailId,
        SponsorDealNumber: resp.data.DealNumber,
        DealNumber: selected.DealNumber,
        SponsorDealLineIteamNo: item.DealLineItemNo
      }))
    );
  };

  const onFinalSave = async () => {
    const res = pageMode === 'edit' ? DealDetailsComponentEdit(selectedDealData, dealDetails, actualExchRatesForBaseCur) : DealDetailsComponentAdd(selectedDealData, dealDetails, actualExchRatesForBaseCur);
    setStep2(4);
    if (pageMode === 'edit' && res.Deal && parseInt(res.Deal.DealNumber) > 0) {
      const resp = await PutDealMaster(res, token);
      if (resp.status === 200) {
        uploadFolder(Content.DealCode, Content.DealNumber);
        openNotification('Deal Update Successfully.', 'success', 1000);
        await apisendnotification({
          NotificationId: (Math.random() + 1).toString(36).substring(7),
          user_ids: [2],
          message: Content.DealCode + ' Deal Modified.',
          image: '',
          type: '1',
          location: 'Deal Modified.',
          locationLabel: Username,
          Status: '1',
          isGroup: 1,
          Ispriority: 1,
          readed: 0,
        });
        navigate(isDealMasterAdd ? '/DealMaster' : '/SponsoredDeal');
        setStep2(3);
      }
    } else {
      const resp = await PostDealMaster(res, token);
      if (resp.status === 200) {
        if (!isDealMasterAdd) {
          const prams = createParams(dealDetails, resp)
          await PostSponsorDealMapping(prams, token)
        }
        uploadFolder(resp.data.DealCode, resp.data.DealNumber);
        openNotification('Deal Added Successfully.\n' + resp.data.DealCode, 'success', 1000);
        await apisendnotification({
          NotificationId: (Math.random() + 1).toString(36).substring(7),
          user_ids: [2],
          message: Content.DealCode + ' Deal Added.',
          image: '',
          type: '1',
          location: 'Deal Added.',
          locationLabel: Username,
          Status: '1',
          isGroup: 1,
          Ispriority: 1,
          readed: 0,
        });
        navigate(isDealMasterAdd ? '/DealMaster' : '/SponsoredDeal');
        setStep2(3);
      }
    }
    setStep2(3);
  };

  const onDialogClose = () => {
    setFormState({ channel: Channel });
    setCurrentTab(0);
    setEditIndex(null);
  };

  const onCollapse = () => {
    setIsCollapsed(!isCollapsed);
  };

  const closeAfter2000ms = () => {
    toa.push(<Notification closable type="success" duration={2000}>Success</Notification>);
  };

  const addDetails = () => {
    const menuIndex = dealLineItemTypes.findIndex(opt => opt.value === currentTab);
    if (editIndex !== null) {
      const updatedItem = {
        ...dealDetails[editIndex],
        name: currentTab,
        DealLineItemType: { value: currentTab, label: dealLineItemTypes[menuIndex].label },
        DealLineItemNo: editIndex,
        ...formState,
      };
      const updatedDetails = [...dealDetails];
      updatedDetails[editIndex] = updatedItem;
      setDealDetails(updatedDetails);
      setEditIndex(null);
      onDialogClose();
      setFormStateCopy({ channel: Channel });
    } else if (DealLineAddValidation(formState, currentTab)) {
      setDealDetails([
        ...dealDetails,
        {
          name: currentTab,
          DealLineItemType: { value: currentTab, label: dealLineItemTypes[menuIndex].label },
          DealLineItemNo: dealDetails.length + 1,
          ID: dealDetails.length + 1,
          ...formState,
        },
      ]);
      onDialogClose();
      setFormStateCopy({ channel: Channel });
    }
  };
  const addDetailSponsorWise = () => {
    const menuIndex = dealLineItemTypes.findIndex(opt => opt.value === currentTab);
    if (editIndex !== null) {
      const updatedItem = {
        ...dealDetails[editIndex],
        name: currentTab,
        DealLineItemType: { value: currentTab, label: dealLineItemTypes[menuIndex].label },
        DealLineItemNo: editIndex,
        ...formState,
      };
      const updatedDetails = [...dealDetails];
      updatedDetails[editIndex] = updatedItem;
      setDealDetails(updatedDetails);
      setEditIndex(null);
      onDialogClose();
      setFormStateCopy({ channel: Channel });
    } else if (DealLineAddValidation(formState, currentTab)) {
      if (selectedDeal.length === 0) return openNotification('Please select at least one Deal ', 'danger');
      setDealDetails([
        ...dealDetails,
        {
          name: currentTab,
          DealLineItemType: { value: currentTab, label: dealLineItemTypes[menuIndex].label },
          DealLineItemNo: dealDetails.length + 1,
          ID: dealDetails.length + 1,
          OriginalRepeatCode: {
            value: selectedDeal[0].OriginalRepeatCode || formState.OriginalRepeatCode.value,
            label: selectedDeal[0].OriginalRepeatName || formState.OriginalRepeatCode.label,
          },
          Rate: 0,
          Amount: 0,
          SpotTypeCode: {
            value: formState.SpotTypeCode.value,
            label: formState.SpotTypeCode.label,
          },
          NoWeeks: selectedDeal[0].NoWeeks || formState.NoWeeks,
          WeekDayCode: {
            value: selectedDeal[0].WeekdaysCode || formState.WeekDayCode.value
            ,
            label: selectedDeal[0].WeekdaysName || formState.WeekDayCode.label,
          },
          StartTime: selectedDeal[0].StartTime || formState.StartTime,
          EndTime: selectedDeal[0].EndTime || formState.EndTime,
          InternalRate: 0,
          TotalSpots: selectedDeal.reduce((sum, deal) => sum + (deal.TotalSpots || 0), 0),
          ContentCode: {
            value: formState.ContentCode.value,
            label: formState.ContentCode.label,
          },
          SponsorTypeCode: {
            value: formState.SponsorTypeCode.value,
            label: formState.SponsorTypeCode.label,
          },
          channel: Channel,
          selectedDeal
        },
      ]);

      onDialogClose();
      setFormStateCopy({ channel: Channel });
      setSelectedDeal([])
    }
  };

  const calculateTotalRow = (dataRows) => {
    let totalSpots = 0, totalRate = 0, totalAmount = 0, totalDurInSec = 0;
    dataRows.forEach(row => {
      const label = row.DealLineItemType?.label;
      const spots = label === 'NTC' ? parseInt(row.NTCTotalSpots) || 0 : label === 'RODP Wise' ? parseInt(row.Second) || 0 : parseInt(row.TotalSpots) || 0;
      totalSpots += spots;
      totalRate += parseFloat(row.Rate) || 0;
      totalAmount += parseFloat(row.Amount) || 0;
      totalDurInSec += parseFloat(row.DurInSec) || 0;
    });
    return { count: totalSpots, Rate: totalRate, Amount: totalAmount, DurInSec: totalDurInSec };
  };

  const dealPrint = async () => {
    try {
      setShowLoader(true);
      const totalRow = calculateTotalRow(dealDetails);
      const pdf = await generateDeal(Content, dealDetails, totalRow, Channel.imgPath);
      pdf.download(`${Content.DealCode}.pdf`);
      setShowLoader(false);
    } catch (error) {
      openNotification('danger', 'Something went wrong. Unable to generate PDFs.');
      setShowLoader(false);
      console.error(error);
    }
  };

  const setExchRatesForBaseCurFn = async (baseCurShortName) => {
    try {
      showCursorLoader();
      const response = await apiGetExchangeRatesForBaseCurrency(baseCurShortName);
      if (response.status === 200) {
        setFetchedExchRatesForBaseCur(response.data);
      } else throw new Error(response);
    } catch (error) {
      console.error(error);
      setFetchedExchRatesForBaseCur(null);
    } finally {
      hideCursorLoader();
    }
  };

  let totalSeconds = 0;
  let totalSlotAndNTC = 0;
  let totalAmount = 0;
  dealDetails.forEach(item => {
    if (item.LineItemCancelStatus !== 1) {
      totalSeconds += Number(item.Second) || 0;
      totalSlotAndNTC += Number(item.NTCTotalSpots) || Number(item.TotalSpots) || 0;
      totalAmount += Number(item.Amount) || 0;
    }
  });

  const onPrevious = () => onChange(step - 1);

  const onPrevious2 = () => setStep(0);

  const getSponsorTableData = async (fromDate, toDate) => {
    try {
      if (!fromDate || !toDate)
        openNotification('danger', 'Please Select From Date and To Date')
      else {
        setShowLoader(true)
        setIsSponsorDialogOpen(true)
        let response = await apiCallstoreprocedure(
          'Sp_sponsorwise_Report',
          {
            Channelcode: Channel.ChannelCode,
            FromDate: fromDate,
            ToDate: toDate
          },
        );
        if (response.status === 200) {
          setSponsorTableData(response.data);
          const columns = Object.keys(response.data[0]).map((column) => ({
            accessorKey: column,
            header: column,
          }));
          setSponsorTableColumns(columns);

        } else if (response.status === 204) {
          setSponsorTableData([])
        } else {
          setSponsorTableData([])
          openNotification(
            'danger',
            `Unable to fetch Sponsors. Server responded with status code ${response.status}`,
          );
        }
        setShowLoader(false);
      }
    } catch (error) {
      openNotification(
        'danger',
        'Something went wrong while fetching Sponsors',
      );
      setSponsorTableData([])
      setShowLoader(false);
    }
  }

  return (
    <>
      {initialValues.isRender &&
        <>
          <Loader showLoader={showLoader} />
          <Card className="mb-2">
            <Steps current={step}>
              <Steps.Item title="Make Deal" />
              <Steps.Item title="Deal Details" />
              <Steps.Item title="Attachments" />
              <Steps.Item title="Approved" />
            </Steps>
          </Card>
          <Card>
            {step === 0 && channelsSelectorOptions.length > 0 && (
              <Formik
                innerRef={formikRef}
                initialValues={initialValues}
                validationSchema={validationSchema}
                onSubmit={(values, { setSubmitting }) => {
                  setSubmitting(true);
                  setSelectedDealData(values);
                  onChange(step + 1);
                  if (step === 0) {
                    setFormState(!isDealMasterAdd ? defaultFormState : { channel: Channel });
                    setFormStateCopy({ channel: Channel });
                  }
                }}
              >
                {({ values, touched, errors, }) => (
                  <Form>
                    <FormContainer>
                      {Content.DealCode && pageMode === 'edit' && (
                        <div className="dark:!bg-[#1d2939] !bg-[#fff] dark:!border-[#374558] dark:!border mb-2 p-2 rounded flex items-center">
                          <p className="font-medium mr-2 text-white">Deal Number</p>
                          <div className="dark:text-gray-300 text-white">{Content.DealCode}</div>
                        </div>
                      )}

                      <div className="grid grid-cols-3 gap-3">
                        <div className="col-span-2 dark:!bg-[#1d2939] !bg-[#fff] dark:!border-[#374558] dark:!border p-2 rounded">
                          <div className="grid grid-cols-4 gap-3 mt-2">
                            <FormItem asterisk label="Deal Type" invalid={errors.DealTypeCode?.value && touched.DealTypeCode?.value} errorMessage={errors.DealTypeCode?.value}>
                              <Field name="DealTypeCode">
                                {({ field, form }) => (
                                  <Select
                                    isDisabled={!isDealMasterAdd}
                                    options={dealTypes}
                                    value={dealTypes.find(opt => opt.value === values.DealTypeCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>

                            <FormItem asterisk label="Ref No" invalid={errors.DealReferenceNumber && touched.DealReferenceNumber} errorMessage={errors.DealReferenceNumber}>
                              <Field name="DealReferenceNumber">
                                {({ field, form }) => (
                                  <Input
                                    type="text"
                                    disabled={!isDealMasterAdd}
                                    placeholder="Ref No"
                                    maxLength={20}
                                    size="sm"
                                    value={values.DealReferenceNumber}
                                    onChange={(e) => form.setFieldValue(field.name, e.target.value)}
                                  />
                                )}
                              </Field>
                            </FormItem>

                            <FormItem asterisk label="Executive" invalid={errors.SalesExcutiveCode?.value && touched.SalesExcutiveCode?.value} errorMessage={errors.SalesExcutiveCode?.value}>
                              <Field name="SalesExcutiveCode">
                                {({ field, form }) => (
                                  <Select
                                    isDisabled={!isDealMasterAdd}
                                    options={executives}
                                    value={executives.find(opt => opt.value === values.SalesExcutiveCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>

                            <FormItem asterisk label="Zone" invalid={errors.ZoneCode?.value && touched.ZoneCode?.value} errorMessage={errors.ZoneCode?.value}>
                              <Field name="ZoneCode">
                                {({ field, form }) => (
                                  <Select
                                    options={zones}
                                    value={zones.find(opt => opt.value === values.ZoneCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>
                          </div>

                          <div className="grid grid-cols-4 gap-3 mt-2">
                            <div className="col-span-3">
                              <FormItem asterisk label="Client" invalid={errors.ClientCode?.value && touched.ClientCode?.value} errorMessage={errors.ClientCode?.value}>
                                <Field name="ClientCode">
                                  {({ field, form }) => (
                                    <Select
                                      options={clients}
                                      isDisabled={!isDealMasterAdd}

                                      value={clients.find(opt => opt.value === values.ClientCode?.value) || null}
                                      onChange={(opt) => {
                                        form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null);
                                        fetchClientCities(opt.value);
                                        fetchAgenciesByClient(opt.value);
                                      }}
                                    />
                                  )}
                                </Field>
                              </FormItem>
                            </div>
                            <FormItem asterisk label="Client City" invalid={errors.ClientPlaceCode?.value && touched.ClientPlaceCode?.value} errorMessage={errors.ClientPlaceCode?.value}>
                              <Field name="ClientPlaceCode">
                                {({ field, form }) => (
                                  <Select
                                    options={clientCities}
                                    isDisabled={!isDealMasterAdd}
                                    value={clientCities.find(opt => opt.value === values.ClientPlaceCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>

                            <div className="col-span-3 mt-2">
                              <FormItem asterisk label="Agency" invalid={errors.AgencyCode?.value && touched.AgencyCode?.value} errorMessage={errors.AgencyCode?.value}>
                                <Field name="AgencyCode">
                                  {({ field, form }) => (
                                    <Select
                                      options={agencies}
                                      isDisabled={!isDealMasterAdd}
                                      value={agencies.find(opt => opt.value === values.AgencyCode?.value) || null}
                                      onChange={(opt) => {
                                        form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label, ...opt } : null);
                                        form.setFieldValue('BusinessTypeCode', opt ? opt.BusinessTypeCode : null);
                                        fetchAgencyCities(opt.value);
                                      }}
                                    />
                                  )}
                                </Field>
                              </FormItem>
                            </div>
                            <FormItem asterisk label="Agency City" className="mt-2" invalid={errors.AgencyPlaceCode?.value && touched.AgencyPlaceCode?.value} errorMessage={errors.AgencyPlaceCode?.value}>
                              <Field name="AgencyPlaceCode">
                                {({ field, form }) => (
                                  <Select
                                    options={agencyCities}
                                    isDisabled={!isDealMasterAdd}
                                    value={agencyCities.find(opt => opt.value === values.AgencyPlaceCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>
                          </div>

                          <div className="grid grid-cols-4 gap-3 mt-2">
                            <FormItem asterisk label="Pay Route" invalid={errors.PayRouteCode?.value && touched.PayRouteCode?.value} errorMessage={errors.PayRouteCode?.value}>
                              <Field name="PayRouteCode">
                                {({ field, form }) => (
                                  <Select
                                    options={payRoutes}
                                    isDisabled={!isDealMasterAdd}
                                    value={payRoutes.find(opt => opt.value === values.PayRouteCode?.value) || null}
                                    onChange={(opt) => form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null)}
                                  />
                                )}
                              </Field>
                            </FormItem>

                            <FormItem asterisk label="Currency" invalid={errors.CurrencyCode?.value && touched.CurrencyCode?.value} errorMessage={errors.CurrencyCode?.value}>
                              <Field name="CurrencyCode">
                                {({ field, form }) => (
                                  <Select
                                    options={currencies}
                                    isDisabled={!isDealMasterAdd}
                                    value={currencies.find(opt => opt.value === values.CurrencyCode?.value) || null}
                                    onChange={(opt) => {
                                      form.setFieldValue(field.name, opt ? { value: opt.value, label: opt.label } : null);
                                      setCurrencySymbol(opt.symbol);
                                      setExchRatesForBaseCurFn(opt.shortName);
                                    }}
                                  />
                                )}
                              </Field>
                            </FormItem>
                            <div className="col-span-2">
                              <FormItem label=" ">
                                <MultiCurrencyDropdown
                                  currencyOptions={currencies}
                                  selectedCurrency={currencies.filter(opt => opt.value === Number(values.CurrencyCode1))}
                                  fetchedExchRatesForBaseCur={fetchedExchRatesForBaseCur}
                                  actualExchRatesForBaseCur={actualExchRatesForBaseCur}
                                  setActualExchRatesForBaseCur={setActualExchRatesForBaseCur}
                                />
                              </FormItem>
                            </div>
                            {isMultiChannelSelectionEnabled && (
                              <div className="col-span-2">
                                <FormItem asterisk label="Channels" invalid={errors.Channels1 && touched.Channels1} errorMessage={errors.Channels1}>
                                  <Field name="Channels1">
                                    {({ field, form }) => (
                                      <Select
                                        isMulti
                                        options={channelsSelectorOptions}
                                        value={values.Channels1}
                                        onChange={(opt) => {
                                          if (opt.length === 0) return;
                                          form.setFieldValue('Channels1', opt);
                                        }}
                                      />
                                    )}
                                  </Field>
                                </FormItem>
                              </div>
                            )}
                          </div>
                        </div>

                        <div className="dark:!bg-[#1d2939] !bg-[#fff] dark:!border-[#374558] dark:!border p-2 rounded">
                          <div className="grid grid-cols-2 gap-2 items-end">
                            <FormItem asterisk label="Deal Date" invalid={errors.DealCreatedDate && touched.DealCreatedDate} errorMessage={errors.DealCreatedDate}>
                              <Field name="DealCreatedDate">
                                {({ field, form }) => (
                                  <DatePicker
                                    size="sm"
                                    minDate={dayjs(new Date()).subtract(31, 'day').startOf('day').toDate()}
                                    value={validate(values.DealCreatedDate) ? new Date(values.DealCreatedDate) : null}
                                    onChange={(e) => form.setFieldValue(field.name, convertDateToYMD(e))}
                                  />
                                )}
                              </Field>
                            </FormItem>
                            <div className='text-right'>
                              <Button
                                variant="twoTone"
                                size="sm"
                                icon={<RiInformationFill />}
                                className="w-max"
                                type='button'
                                onClick={() => getSponsorTableData(values.DealPeriodFromDate, values.DealPeriodToDate)}
                              >
                                Sponsor
                              </Button>
                              <Dialog
                                isOpen={isSponsorDialogOpen}
                                onClose={handleSponsorDialogClose}
                                onRequestClose={handleSponsorDialogClose}
                                width={"60vw"}
                              >
                                <div className="flex flex-col h-full justify-between">
                                  <h5 className="mb-4">Sponsors</h5>
                                  <div className="h-[75vh] overflow-y-auto">
                                    <ReportsTable
                                      tableData={sponsorTableData}
                                      originalColumns={sponsorTableColumns}
                                      managedColumns={sponsorTableManagedColumns}
                                      setManagedColumns={setSponsorTableManagedColumns}
                                      exportFileName="Sponsors"
                                      tableName="SponsorsTable"
                                    />
                                  </div>
                                </div>
                              </Dialog>
                            </div>
                          </div>


                          <div className="grid grid-cols-2 gap-2">
                            <FormItem asterisk label="From Date" className="mt-2" invalid={errors.DealPeriodFromDate && touched.DealPeriodFromDate} errorMessage={errors.DealPeriodFromDate}>
                              <Field name="DealPeriodFromDate">
                                {({ field, form }) => (
                                  <DatePicker
                                    size="sm"
                                    minDate={dayjs(new Date()).subtract(10, 'day').startOf('day').toDate()}
                                    value={validate(values.DealPeriodFromDate) ? new Date(values.DealPeriodFromDate) : null}
                                    onChange={(e) => {
                                      form.setFieldValue(field.name, convertDateToYMD(e));
                                      if (values.DealPeriodToDate) setIsDateValid(compareDates(e, values.DealPeriodToDate));
                                    }}
                                    onBlur={() => compareDatesV(form)}
                                  />
                                )}
                              </Field>
                            </FormItem>
                            <FormItem asterisk className="mt-2" label="To Date" invalid={errors.DealPeriodToDate && touched.DealPeriodToDate} errorMessage={errors.DealPeriodToDate}>
                              <Field name="DealPeriodToDate">
                                {({ field, form }) => (
                                  <DatePicker
                                    size="sm"
                                    minDate={dayjs(new Date(values.DealPeriodFromDate)).subtract(0, 'day').startOf('day').toDate()}
                                    value={validate(values.DealPeriodToDate) ? new Date(values.DealPeriodToDate) : null}
                                    onChange={(e) => {
                                      form.setFieldValue(field.name, convertDateToYMD(e));
                                      if (values.DealPeriodFromDate) setIsDateValid(compareDates(values.DealPeriodFromDate, e));
                                    }}
                                    onBlur={() => compareDatesV(form)}
                                  />
                                )}
                              </Field>
                            </FormItem>
                          </div>

                          <div className="mt-2 mb-1 bg-gray-800 p-2 border border-gray-600 rounded">
                            <p className="text-[#54E4CB]">Payment Terms:- {values.AgencyCode?.IsCredit ? `${values.AgencyCode?.CreditDays} Days Credit Period` : null} {values.AgencyCode?.IsAdvPmt ? `Advance Payment` : null} {values.AgencyCode?.IsPDC ? `PDC` : null}</p>
                            <p className="text-[#54E4CB]">Address:- {values.AgencyPlaceCode?.Address1} {values.AgencyPlaceCode?.Address2}</p>
                            <p className="text-[#54E4CB]">Business Type:- {values.AgencyCode?.BusinessTypeName}</p>
                            <p className="text-[#54E4CB]">{values.AgencyPlaceCode?.GSTN_id}</p>
                          </div>
                          <FormItem label="Cancel Status" invalid={errors.CancelStatus && touched.CancelStatus} errorMessage={errors.CancelStatus}>
                            <Field name="CancelStatus" component={Switcher} />
                          </FormItem>
                        </div>
                      </div>
                    </FormContainer>
                  </Form>
                )}
              </Formik>
            )}

            {step === 1 && (
              <div>
                <DealHeader
                  selectedDealData={selectedDealData}
                  onPrevious={onPrevious2}
                  onCollapse={onCollapse}
                  onDialogClose={onDialogClose}
                  collapse={isCollapsed}
                  handleAddDealClick={() => {
                    setCurrentTab(1);
                    setFormState(!isDealMasterAdd ? defaultFormState : { channel: Channel });
                  }}
                  currentTab={currentTab}
                  step={step}
                />

                <div className="mt-2">
                  <Tabs value={currentTab} variant="pill" onChange={(val) => {
                    setCurrentTab(val);
                    setFormState({ channel: Channel });
                    setEditIndex(null);
                    setFormStateCopy({ channel: Channel });
                    setSecondsForRate(10);
                  }}>
                    <div className="flex justify-between">
                      <div>
                        {currentTab !== 0 && (
                          <TabList>
                            {dealLineItemTypes.map((item, key) => (
                              <TabNav
                                value={item.value}
                                key={key}
                                disabled={editIndex !== null && formState?.DealLineItemType?.value !== item.value}
                              >
                                {item.label}
                              </TabNav>
                            ))}
                          </TabList>
                        )}
                      </div>
                    </div>

                    <div className="p-2">
                      <TabContent value={1}>
                        <div className="dark:!bg-[#1f2639] !bg-gray-100 dark:!border-[#374558] dark:!border p-2 rounded">
                          <div className={isDealMasterAdd ? "grid grid-cols-3 gap-1" : "grid grid-cols-4 gap-1"}>
                            <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                              <FormContainer>
                                <div className="grid grid-cols-2 gap-2">
                                  <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
                                    {isDealMasterAdd && (<>{IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                      <FormItem asterisk label="Channel">
                                        <Select
                                          options={channelOptions}
                                          onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                          value={formState.channel}
                                        />
                                      </FormItem>
                                    )}</>)}
                                    <FormItem asterisk label="Sponsor Type">
                                      <Select
                                        options={sponsorTypes}
                                        onChange={(e) => handleSelectChange(e, 'SponsorTypeCode')}
                                        value={sponsorTypes.filter(opt => opt.value === formState.SponsorTypeCode?.value)}
                                      />
                                    </FormItem>
                                    <div className='flex'>

                                      <FormItem asterisk label="Content" style={{ width: '300px' }}>
                                        <Select
                                          options={contentList}
                                          style={{ width: '300px' }}
                                          isDisabled={editIndex !== null && !isDealMasterAdd}
                                          onChange={(e) => {
                                            handleSelectChange(e, 'ContentCode');
                                            if (formState.OriginalRepeatCode?.value) {
                                              Bindstartnendtime(e.value, formState.OriginalRepeatCode.value, formState.channel?.value.split('-')[0]);
                                            }
                                          }}
                                          value={contentList.filter(opt => opt.value === formState.ContentCode?.value)}
                                        />
                                      </FormItem>
                                      {!isDealMasterAdd && (<Button className="ltr:mr-2 rtl:ml-2"
                                        size="sm"
                                        variant="solid"
                                        style={{ padding: '10px', marginTop: '30px', marginLeft: '10px' }}
                                        disabled={formState.ContentCode?.value && formState.SponsorTypeCode?.value ? false : true}
                                        onClick={() => setisDialogbox(true)}
                                        icon={<HiOutlineEye />}
                                      ></Button>)}</div>
                                  </div>

                                  {isDealMasterAdd && (
                                    <FormItem asterisk label="Org/Rep">
                                      <Select
                                        options={timeBands}
                                        onChange={(e) => {
                                          handleSelectChange(e, 'OriginalRepeatCode');
                                          if (formState.ContentCode.value) {
                                            Bindstartnendtime(formState.ContentCode.value, e.value, formState.channel?.value.split('-')[0]);
                                          }
                                        }}
                                        value={timeBands.filter(opt => opt.value === formState.OriginalRepeatCode?.value)}
                                      />
                                    </FormItem>)}
                                  {isDealMasterAdd && (
                                    <FormItem asterisk label="Spot Type">
                                      <Select
                                        options={spotTypes}
                                        onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                        value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                      />
                                    </FormItem>)}
                                  <div className={isDealMasterAdd ? `col-span-2` : `col-span-1`}>
                                    <FormItem label="Remark">
                                      <Input
                                        value={formState.LineItemRemark}
                                        onChange={(e) => {
                                          if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                            handleInputChange(e.target.value, 'LineItemRemark');
                                          }
                                        }}
                                      />
                                    </FormItem>
                                  </div>
                                  {!isDealMasterAdd &&
                                    <div className="col-span-1">
                                      <FormItem label="Cancel Line Item">
                                        <Switcher
                                          checked={formState.LineItemCancelStatus === 1}
                                          onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                        />
                                      </FormItem>
                                    </div>}
                                </div>
                              </FormContainer>
                            </div>

                            {!isDealMasterAdd && (<div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                              <label class="form-label mb-2">Selected Deal List</label>
                              <div className="flex flex-wrap gap-2 mt-4">

                                {selectedDeal.map((deal) => (
                                  <div
                                    key={deal.value}
                                    className="bg-gray-700 text-sm px-2 py-1 text-white rounded flex items-center gap-2"
                                  >
                                    <span>{deal.label}</span>
                                    <button
                                      onClick={() => {
                                        setSelectedDeal((prev) =>
                                          prev.filter((d) => d.value !== deal.value)
                                        );
                                      }

                                      }
                                      className="text-red-500"
                                    >
                                      
                                    </button>
                                  </div>
                                ))}
                              </div></div>)}
                            {isDealMasterAdd &&
                              <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                                <FormContainer>
                                  <div className="grid grid-cols-2 gap-2">
                                    <FormItem asterisk label="Start Time">
                                      <Select
                                        options={startTimes}
                                        onChange={(e) => handleSelectChange(e.value, 'StartTime')}
                                        value={startTimes.filter(opt => opt.value === formState.StartTime)}
                                      />
                                    </FormItem>
                                    <FormItem asterisk label="End Time">
                                      <Select
                                        options={endTimes}
                                        onChange={(e) => handleSelectChange(e.value, 'EndTime')}
                                        value={endTimes.filter(opt => opt.value === formState.EndTime)}
                                      />
                                    </FormItem>
                                    <FormItem asterisk label="No Of Week">
                                      <Input
                                        size="sm"
                                        value={formState.NoWeeks}
                                        onChange={(e) => {
                                          if (e.target.value.length < 4 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                            handleInputChange(e.target.value, 'NoWeeks');
                                          }
                                        }}
                                      />
                                    </FormItem>
                                    <FormItem asterisk label="Week Part">
                                      <Select
                                        options={weekdays}
                                        onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                        value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                      />
                                    </FormItem>

                                    <div className="col-span-1">
                                      <FormItem label="Cancel Line Item">
                                        <Switcher
                                          checked={formState.LineItemCancelStatus === 1}
                                          onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                        />
                                      </FormItem>
                                    </div>
                                  </div>
                                </FormContainer>
                              </div>}
                          </div>
                          {isDealMasterAdd &&
                            <div className="col-span-3 mt-2">
                              <FormContainer>
                                <div className="grid grid-cols-6 gap-2">
                                  <div />
                                  <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per Slot</p>}>
                                    <Input
                                      size="lg"
                                      value={formState.Rate}
                                      style={{ fontSize: 25, fontWeight: 600 }}
                                      disabled={formState.SpotTypeCode?.value === 2}
                                      onChange={(e) => {
                                        if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'Rate');
                                        }
                                        if (formState.TotalSpots) calculateValueXSpot(e.target.value, formState.TotalSpots);
                                      }}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label={<p style={{ fontSize: 16 }}>Slot</p>}>
                                    <Input
                                      size="lg"
                                      value={formState.TotalSpots}
                                      onChange={(e) => {
                                        if (e.target.value.length <= 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'TotalSpots');
                                        }
                                        if (formState.Rate) calculateValueXSpot(formState.Rate, e.target.value);
                                      }}
                                      onBlur={() => {
                                        if (formStateCopy.TotalSpots > formState.TotalSpots) {
                                          openNotification('Error ', 'danger', 1000);
                                          setFormState(formStateCopy);
                                        }
                                      }}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                    <Input
                                      size="lg"
                                      value={formState.Amount}
                                      disabled
                                      onChange={(e) => {
                                        if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'Amount');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                  <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                    <Input
                                      size="lg"
                                      value={formState.InternalRate}
                                      onChange={(e) => {
                                        if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'InternalRate');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                  <div />
                                </div>
                              </FormContainer>
                            </div>}
                        </div>
                      </TabContent>

                      <TabContent value={2}>
                        <div className="grid grid-cols-3 gap-1 dark:!border-[#374558] dark:!border dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                          <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-5' : 'grid-cols-2'} gap-2`}>
                                  {IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                    <FormItem asterisk label="Channel" className="col-span-2">
                                      <Select
                                        options={channelOptions}
                                        onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                        value={formState.channel}
                                      />
                                    </FormItem>
                                  )}
                                  <FormItem asterisk label="RODP Category" className={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'col-span-2' : 'col-span-1'}>
                                    <Select
                                      options={rodpOptions}
                                      onChange={(e) => handleSelectChange(e, 'TimeBandCode')}
                                      value={rodpOptions.filter(opt => opt.value === formState.TimeBandCode?.value)}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label="Spot Type" className="col-span-1">
                                    <Select
                                      options={spotTypes}
                                      onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                      value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                    />
                                  </FormItem>
                                </div>
                                <FormItem asterisk label="Spot Preference">
                                  <Select
                                    options={spotPreferences}
                                    onChange={(e) => handleSelectChange(e, 'SpotPreferenceCode')}
                                    value={spotPreferences.filter(opt => opt.value === formState.SpotPreferenceCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Remark">
                                    <Input
                                      size="sm"
                                      value={formState.LineItemRemark}
                                      onChange={(e) => {
                                        if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'LineItemRemark');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                </div>
                                <div className="col-span-1 flex mb-2">
                                  <Checkbox
                                    value={formState.IsCommited === 1}
                                    onChange={(e) => handleSwitchChange(e, 'IsCommited')}
                                  />
                                  Is Commited Time
                                </div>
                                <div className="col-span-1">
                                  {formState.IsCommited === 0 && (
                                    <div className="grid grid-cols-2 gap-2">
                                      <FormItem label="Commited Start Time">
                                        <Input
                                          size="sm"
                                          name="CommitedStartTime"
                                          maxLength={8}
                                          placeholder="HH:MM:SS"
                                          value={formState.CommitedStartTime}
                                          onChange={(e) => handleChangeWithOutFrameNew(e, setFormState)}
                                          onBlur={handleBlur}
                                        />
                                      </FormItem>
                                      <FormItem label="Commited End Time">
                                        <Input
                                          size="sm"
                                          name="CommitedEndTime"
                                          maxLength={8}
                                          placeholder="HH:MM:SS"
                                          value={formState.CommitedEndTime}
                                          onChange={(e) => handleChangeWithOutFrameNew(e, setFormState)}
                                          onBlur={handleBlur}
                                        />
                                      </FormItem>
                                    </div>
                                  )}
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2 mb-4">
                                <FormItem asterisk label="Start Time">
                                  <Input
                                    size="sm"
                                    value={formState.StartTime}
                                    disabled
                                    onChange={(e) => handleInputChange(e.target.value, 'StartTime')}
                                  />
                                </FormItem>
                                <FormItem asterisk label="End Time">
                                  <Input
                                    size="sm"
                                    value={formState.EndTime}
                                    disabled
                                    onChange={(e) => handleInputChange(e.target.value, 'EndTime')}
                                  />
                                </FormItem>
                              </div>
                              <div className="grid grid-cols-2 gap-2">
                                <FormItem asterisk label="Week Part">
                                  <Select
                                    options={weekdays}
                                    onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                    value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                  />
                                </FormItem>
                                <FormItem label="Cancel Line Item">
                                  <Switcher
                                    checked={formState.LineItemCancelStatus === 1}
                                    onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                  />
                                </FormItem>
                              </div>
                            </FormContainer>
                          </div>
                          <div className="col-span-3 mt-2">
                            <FormContainer>
                              <div className="grid grid-cols-6 gap-2">
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Seconds</p>}>
                                  <Select
                                    placeholder="Select"
                                    isDisabled
                                    styles={{
                                      control: (base) => ({ ...base, height: '3.5rem!important' }),
                                      singleValue: (base) => ({ ...base, fontSize: '15px!important' }),
                                      menuList: (base) => ({ ...base, fontSize: '15px!important' }),
                                    }}
                                    options={SECONDS_FOR_RATE_OPTIONS}
                                    onChange={(e) => setSecondsForRate(e.value)}
                                    value={SECONDS_FOR_RATE_OPTIONS.filter(item => item.value === secondsForRate)}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per {secondsForRate}[sec]</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Rate}
                                    style={{ fontSize: 25, fontWeight: 600 }}
                                    disabled={formState.SpotTypeCode?.value === 2}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Rate');
                                      }
                                      if (formState.Second) calculateValue(e.target.value, formState.Second);
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Seconds</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Second}
                                    onChange={(e) => {
                                      if (e.target.value.length <= 8 && /^[0-9]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Second');
                                      }
                                      if (formState.Rate) calculateValue(formState.Rate, e.target.value);
                                    }}
                                    onBlur={() => {
                                      if (formStateCopy.Second > formState.Second) {
                                        openNotification('Error ', 'danger', 1000);
                                        setFormState(formStateCopy);
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Amount}
                                    disabled
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Amount');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.InternalRate}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'InternalRate');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <div />
                              </div>
                            </FormContainer>
                          </div>
                        </div>
                      </TabContent>

                      <TabContent value={3}>
                        <div className="grid grid-cols-3 gap-1 dark:!border-[#374558] dark:!border dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                          <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
                                  {IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                    <FormItem asterisk label="Channel">
                                      <Select
                                        options={channelOptions}
                                        onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                        value={formState.channel}
                                      />
                                    </FormItem>
                                  )}
                                  <FormItem asterisk label="Content">
                                    <Select
                                      options={contentList}
                                      onChange={(e) => {
                                        handleSelectChange(e, 'ContentCode');
                                        if (formState.OriginalRepeatCode?.value) {
                                          Bindstartnendtime(e.value, formState.OriginalRepeatCode.value, formState.channel?.value.split('-')[0]);
                                        }
                                      }}
                                      value={contentList.filter(opt => opt.value === formState.ContentCode?.value)}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label="Org/Rep">
                                    <Select
                                      options={timeBands}
                                      onChange={(e) => {
                                        handleSelectChange(e, 'OriginalRepeatCode');
                                        if (formState.ContentCode.value) {
                                          Bindstartnendtime(formState.ContentCode.value, e.value, formState.channel?.value.split('-')[0]);
                                        }
                                      }}
                                      value={timeBands.filter(opt => opt.value === formState.OriginalRepeatCode?.value)}
                                    />
                                  </FormItem>
                                </div>
                                <FormItem asterisk label="Spot Type">
                                  <Select
                                    options={spotTypes}
                                    onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                    value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Remark">
                                    <Input
                                      value={formState.LineItemRemark}
                                      onChange={(e) => {
                                        if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'LineItemRemark');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <FormItem asterisk label="Start Time">
                                  <Select
                                    options={startTimes}
                                    onChange={(e) => handleSelectChange(e.value, 'StartTime')}
                                    value={startTimes.filter(opt => opt.value === formState.StartTime)}
                                  />
                                </FormItem>
                                <FormItem asterisk label="End Time">
                                  <Select
                                    options={endTimes}
                                    onChange={(e) => handleSelectChange(e.value, 'EndTime')}
                                    value={endTimes.filter(opt => opt.value === formState.EndTime)}
                                  />
                                </FormItem>
                                <FormItem asterisk label="Week Part">
                                  <Select
                                    options={weekdays}
                                    onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                    value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Cancel Line Item">
                                    <Switcher
                                      checked={formState.LineItemCancelStatus === 1}
                                      onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-3 mt-2">
                            <FormContainer>
                              <div className="grid grid-cols-6 gap-2">
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Seconds</p>}>
                                  <Select
                                    isDisabled
                                    placeholder="Select"
                                    styles={{
                                      control: (base) => ({ ...base, height: '3.5rem!important' }),
                                      singleValue: (base) => ({ ...base, fontSize: '15px!important' }),
                                      menuList: (base) => ({ ...base, fontSize: '15px!important' }),
                                    }}
                                    options={SECONDS_FOR_RATE_OPTIONS}
                                    onChange={(e) => setSecondsForRate(e.value)}
                                    value={SECONDS_FOR_RATE_OPTIONS.filter(item => item.value === secondsForRate)}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per {secondsForRate}[sec]</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Rate}
                                    style={{ fontSize: 25, fontWeight: 600 }}
                                    disabled={formState.SpotTypeCode?.value === 2}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Rate');
                                      }
                                      if (formState.Second) calculateValue(e.target.value, formState.Second);
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Seconds</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Second}
                                    onChange={(e) => {
                                      if (e.target.value.length <= 8 && /^[0-9]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Second');
                                      }
                                      if (formState.Rate) calculateValue(formState.Rate, e.target.value);
                                    }}
                                    onBlur={() => {
                                      if (formStateCopy.Second > formState.Second) {
                                        openNotification('Error ', 'danger', 1000);
                                        setFormState(formStateCopy);
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Amount}
                                    disabled
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Amount');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.InternalRate}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'InternalRate');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <div />
                              </div>
                            </FormContainer>
                          </div>
                        </div>
                      </TabContent>

                      <TabContent value={4}>
                        <div className="grid grid-cols-3 gap-1 dark:!border-[#374558] dark:!border dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                          <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-5' : 'grid-cols-2'} gap-2`}>
                                  {IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                    <FormItem asterisk label="Channel" className="col-span-2">
                                      <Select
                                        options={channelOptions}
                                        onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                        value={formState.channel}
                                      />
                                    </FormItem>
                                  )}
                                  <FormItem asterisk label="RODP Category" className={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'col-span-2' : 'col-span-1'}>
                                    <Select
                                      options={rodpOptions}
                                      onChange={(e) => handleSelectChange(e, 'TimeBandCode')}
                                      value={rodpOptions.filter(opt => opt.value === formState.TimeBandCode?.value)}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label="NTC Type" className="col-span-1">
                                    <Select
                                      options={ntcTypes}
                                      onChange={(e) => {
                                        handleSelectChange(e, 'NTCTypeCode');
                                        setFormState((prev) => ({ ...prev, IsNTC: 1 }));
                                      }}
                                      value={ntcTypes.filter(opt => opt.value === formState.NTCTypeCode?.value)}
                                    />
                                  </FormItem>
                                </div>
                                <FormItem asterisk label="Spot Type">
                                  <Select
                                    options={spotTypes}
                                    onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                    value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Remark">
                                    <Input
                                      value={formState.LineItemRemark}
                                      onChange={(e) => {
                                        if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'LineItemRemark');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <FormItem asterisk label="Start Time">
                                  <Input
                                    size="sm"
                                    disabled
                                    value={formState.StartTime}
                                    onChange={(e) => handleInputChange(e.target.value, 'StartTime')}
                                  />
                                </FormItem>
                                <FormItem asterisk label="End Time">
                                  <Input
                                    size="sm"
                                    disabled
                                    value={formState.EndTime}
                                    onChange={(e) => handleInputChange(e.target.value, 'EndTime')}
                                  />
                                </FormItem>
                                <FormItem asterisk label="Week Part">
                                  <Select
                                    options={weekdays}
                                    onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                    value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Cancel Line Item">
                                    <Switcher
                                      checked={formState.LineItemCancelStatus === 1}
                                      onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>
                          <div className="col-span-3 mt-2">
                            <FormContainer>
                              <div className="grid grid-cols-6 gap-2">
                                <div />
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per [spot]</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Rate}
                                    style={{ fontSize: 25, fontWeight: 600 }}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Rate');
                                      }
                                      if (formState.NTCTotalSpots) calculateValue(e.target.value, formState.NTCTotalSpots);
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>NTC Spots</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.NTCTotalSpots}
                                    onChange={(e) => {
                                      if (e.target.value.length <= 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'NTCTotalSpots');
                                        if (formState.Rate) calculateValueX(formState.Rate, e.target.value);
                                      }
                                    }}
                                    onBlur={() => {
                                      if (formStateCopy.NTCTotalSpots > formState.NTCTotalSpots) {
                                        openNotification('Error ', 'danger', 1000);
                                        setFormState(formStateCopy);
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Amount}
                                    disabled
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Amount');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.InternalRate}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'InternalRate');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <div />
                              </div>
                            </FormContainer>
                          </div>
                        </div>
                      </TabContent>

                      <TabContent value={5}>
                        <div className="grid grid-cols-3 gap-1 dark:!border-[#374558] dark:!border dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                          <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
                                  {IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                    <FormItem asterisk label="Channel">
                                      <Select
                                        options={channelOptions}
                                        onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                        value={formState.channel}
                                      />
                                    </FormItem>
                                  )}
                                  <FormItem asterisk label="Content">
                                    <Select
                                      options={contentList}
                                      onChange={(e) => {
                                        handleSelectChange(e, 'ContentCode');
                                        if (formState.OriginalRepeatCode?.value) {
                                          Bindstartnendtime(e.value, formState.OriginalRepeatCode.value, formState.channel?.value.split('-')[0]);
                                        }
                                      }}
                                      value={contentList.filter(opt => opt.value === formState.ContentCode?.value)}
                                    />
                                  </FormItem>
                                  <FormItem asterisk label="Org/Rep">
                                    <Select
                                      options={timeBands}
                                      onChange={(e) => {
                                        handleSelectChange(e, 'OriginalRepeatCode');
                                        if (formState.ContentCode.value) {
                                          Bindstartnendtime(formState.ContentCode.value, e.value, formState.channel?.value.split('-')[0]);
                                        }
                                      }}
                                      value={timeBands.filter(opt => opt.value === formState.OriginalRepeatCode?.value)}
                                    />
                                  </FormItem>
                                </div>
                                <FormItem asterisk label="Spot Type">
                                  <Select
                                    options={spotTypes}
                                    onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                    value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Remark">
                                    <Input
                                      value={formState.LineItemRemark}
                                      onChange={(e) => {
                                        if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'LineItemRemark');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <FormItem asterisk label="Start Time">
                                  <Select
                                    options={startTimes}
                                    onChange={(e) => handleSelectChange(e.value, 'StartTime')}
                                    value={startTimes.filter(opt => opt.value === formState.StartTime)}
                                  />
                                </FormItem>
                                <FormItem asterisk label="End Time">
                                  <Select
                                    options={endTimes}
                                    onChange={(e) => handleSelectChange(e.value, 'EndTime')}
                                    value={endTimes.filter(opt => opt.value === formState.EndTime)}
                                  />
                                </FormItem>
                                <FormItem asterisk label="Week Part">
                                  <Select
                                    options={weekdays}
                                    onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                    value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Cancel Line Item">
                                    <Switcher
                                      checked={formState.LineItemCancelStatus === 1}
                                      onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-3 mt-2">
                            <FormContainer>
                              <div className="grid grid-cols-6 gap-2">
                                <div />
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per Slot</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Rate}
                                    style={{ fontSize: 25, fontWeight: 600 }}
                                    disabled={formState.SpotTypeCode?.value === 2}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Rate');
                                      }
                                      if (formState.TotalSpots) calculateValueXSpot(e.target.value, formState.TotalSpots);
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Slot</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.TotalSpots}
                                    onChange={(e) => {
                                      if (e.target.value.length <= 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'TotalSpots');
                                      }
                                      if (formState.Rate) calculateValueXSpot(formState.Rate, e.target.value);
                                    }}
                                    onBlur={() => {
                                      if (formStateCopy.TotalSpots > formState.TotalSpots) {
                                        openNotification('Error ', 'danger', 1000);
                                        setFormState(formStateCopy);
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Amount}
                                    disabled
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Amount');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.InternalRate}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'InternalRate');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <div />
                              </div>
                            </FormContainer>
                          </div>
                        </div>
                      </TabContent>

                      <TabContent value={6}>
                        <div className="grid grid-cols-3 gap-1 dark:!border-[#374558] dark:!border dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                          <div className="col-span-2 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <div className={`col-span-2 grid ${IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'grid-cols-5' : 'grid-cols-2'} gap-2`}>
                                  {IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS && (
                                    <FormItem asterisk label="Channel" className="col-span-2">
                                      <Select
                                        options={channelOptions}
                                        onChange={(e) => setFormState((prev) => ({ ...prev, channel: e }))}
                                        value={formState.channel}
                                      />
                                    </FormItem>
                                  )}
                                  <FormItem asterisk label="RODP Category" className={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS ? 'col-span-2' : 'col-span-1'}>
                                    <Select
                                      options={rodpOptions}
                                      onChange={(e) => handleSelectChange(e, 'TimeBandCode')}
                                      value={rodpOptions.filter(opt => opt.value === formState.TimeBandCode?.value)}
                                    />
                                  </FormItem>

                                  <FormItem asterisk label="Spot Type" className="col-span-1">
                                    <Select
                                      options={spotTypes}
                                      onChange={(e) => handleSelectChange(e, 'SpotTypeCode')}
                                      value={spotTypes.filter(opt => opt.value === formState.SpotTypeCode?.value)}
                                    />
                                  </FormItem>
                                </div>
                                <div className="col-span-2">
                                  <FormItem label="Remark">
                                    <Input
                                      value={formState.LineItemRemark}
                                      onChange={(e) => {
                                        if (e.target.value.length < 50 && /^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
                                          handleInputChange(e.target.value, 'LineItemRemark');
                                        }
                                      }}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>

                          <div className="col-span-1 dark:!bg-[#1f2639] bg-gray-100 p-2 rounded">
                            <FormContainer>
                              <div className="grid grid-cols-2 gap-2">
                                <FormItem asterisk label="Start Time">
                                  <Input
                                    size="sm"
                                    value={formState.StartTime}
                                    disabled
                                    onChange={(e) => handleInputChange(e.target.value, 'StartTime')}
                                  />
                                </FormItem>
                                <FormItem asterisk label="End Time">
                                  <Input
                                    size="sm"
                                    value={formState.EndTime}
                                    disabled
                                    onChange={(e) => handleInputChange(e.target.value, 'EndTime')}
                                  />
                                </FormItem>
                                <FormItem asterisk label="Week Part">
                                  <Select
                                    options={weekdays}
                                    onChange={(e) => handleSelectChange(e, 'WeekDayCode')}
                                    value={weekdays.filter(opt => opt.value === formState.WeekDayCode?.value)}
                                  />
                                </FormItem>
                                <div className="col-span-1">
                                  <FormItem label="Cancel Line Item">
                                    <Switcher
                                      checked={formState.LineItemCancelStatus === 1}
                                      onChange={(e) => handleSwitchChange(e, 'LineItemCancelStatus')}
                                    />
                                  </FormItem>
                                </div>
                              </div>
                            </FormContainer>
                          </div>
                          <div className="col-span-3 mt-2">
                            <FormContainer>
                              <div className="grid grid-cols-6 gap-2">
                                <div />
                                <FormItem asterisk label={<p style={{ fontSize: 16, fontWeight: 600 }}>Rate Per Slot</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Rate}
                                    style={{ fontSize: 25, fontWeight: 600 }}
                                    disabled={formState.SpotTypeCode?.value === 2}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Rate');
                                      }
                                      if (formState.TotalSpots) calculateValueXSpot(e.target.value, formState.TotalSpots);
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Slot</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.TotalSpots}
                                    onChange={(e) => {
                                      if (e.target.value.length <= 5 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'TotalSpots');
                                      }
                                      if (formState.Rate) calculateValueXSpot(formState.Rate, e.target.value);
                                    }}
                                    onBlur={() => {
                                      if (formStateCopy.TotalSpots > formState.TotalSpots) {
                                        openNotification('Error ', 'danger', 1000);
                                        setFormState(formStateCopy);
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem asterisk label={<p style={{ fontSize: 16 }}>Amount</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.Amount}
                                    disabled
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'Amount');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <FormItem label={<p style={{ fontSize: 16 }}>Internal Rate</p>}>
                                  <Input
                                    size="lg"
                                    value={formState.InternalRate}
                                    onChange={(e) => {
                                      if (e.target.value.length < 8 && /^[0-9.\s]*$/.test(e.target.value)) {
                                        handleInputChange(e.target.value, 'InternalRate');
                                      }
                                    }}
                                  />
                                </FormItem>
                                <div />
                              </div>
                            </FormContainer>
                          </div>
                        </div>
                      </TabContent>
                    </div>
                  </Tabs>
                </div>
                {currentTab !== 0 && isDealMasterAdd && (
                  <div className="text-right px-6 py-3 rounded-bl-lg rounded-br-lg">
                    <Button variant="solid" size="sm" onClick={addDetails}>
                      {editIndex !== null ? 'Edit' : 'Add'}
                    </Button>
                  </div>
                )}
                {currentTab !== 0 && !isDealMasterAdd && (
                  <div className="text-right px-6 py-3 rounded-bl-lg rounded-br-lg">
                    <Button variant="solid" size="sm" onClick={addDetailSponsorWise}>
                      {editIndex !== null ? 'Edit' : 'Add'}
                    </Button>
                  </div>
                )}
                <DealCard
                  CurrencySysmbol={currencySymbol}
                  DataDisplay={dealDetails}
                  setFormState={setFormState}
                  setfindId={setEditIndex}
                  setCurrentTab={setCurrentTab}
                  step={step}
                  setFormStateCopy={setFormStateCopy}
                  isChannelSelEnabledForDealDetails={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS}
                />
              </div>
            )}

            {step === 2 && (
              <div>
                <DealHeader
                  selectedDealData={selectedDealData}
                  onPrevious={onPrevious2}
                  onCollapse={onCollapse}
                  onDialogClose={onDialogClose}
                  collapse={isCollapsed}
                  setCurrentTab={setCurrentTab}
                />
                <DealCard
                  CurrencySysmbol={currencySymbol}
                  DataDisplay={dealDetails}
                  setFormState={setFormState}
                  setfindId={setEditIndex}
                  setCurrentTab={setCurrentTab}
                  step={step}
                  setFormStateCopy={setFormStateCopy}
                  isChannelSelEnabledForDealDetails={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS}
                />

                {dealAttachment && (
                  <div className="w-full mb-2">
                    <AttachmentRow
                      Attachment={dealAttachment}
                      setAttachment={setDealAttachment}
                      handleDownloadAndView={handleDownloadAndView}
                    />
                  </div>
                )}
                <Upload beforeUpload={beforeUpload} uploadLimit={maxUpload} draggable>
                  <div className="text-center">
                    <div className="text-6xl mb-4 flex justify-center" />
                    <p className="font-semibold">
                      <span className="text-gray-800 dark:text-white">Drop & browse your file here</span>
                    </p>
                  </div>
                </Upload>
              </div>
            )}

            {step === 3 && (
              <>
                <DealHeader
                  selectedDealData={selectedDealData}
                  onPrevious={onPrevious2}
                  onCollapse={onCollapse}
                  onDialogClose={onDialogClose}
                  collapse={isCollapsed}
                  setCurrentTab={setCurrentTab}
                />
                <DealCard
                  CurrencySysmbol={currencySymbol}
                  DataDisplay={dealDetails}
                  setFormState={setFormState}
                  setfindId={setEditIndex}
                  setCurrentTab={setCurrentTab}
                  step={step}
                  setFormStateCopy={setFormStateCopy}
                  isChannelSelEnabledForDealDetails={IS_CHANNEL_SEL_ENABLED_FOR_DEAL_DETAILS}
                />
                {selectedFile && (
                  <div className="upload-file-list">
                    {[selectedFile].map((file, index) => (
                      <FileItem file={file} key={file.name + index} />
                    ))}
                  </div>
                )}
              </>
            )}

            <StickyFooter className="-mx-8 px-8 flex items-center justify-between py-4" stickyClass="border-t bg-white dark:bg-gray-800 border-gray-200 dark:border-gray-700">
              <div className="md:flex items-center">
                <Button className="mx-2" size="sm" icon={<HiBackspace />} onClick={() => {
                  if (step === 0) navigate(isDealMasterAdd ? '/DealMaster' : '/SponsoredDeal');
                  else onPrevious();
                }}>
                  {step === 0 ? 'Discard' : 'Previous'}
                </Button>

                {step === 1 ? (
                  <Button
                    disabled={step === 3}
                    variant="solid"
                    type='button'
                    icon={step === 3 ? <AiOutlineSave /> : <IoMdArrowRoundForward />}
                    size="sm"
                    onClick={() => {
                      if (currentTab !== 0) {
                        DealLineAddValidation(formState, currentTab);
                        setFormStateCopy({ channel: Channel });
                        return;
                      }
                      if (dealDetails.length > 0) {
                        onChange(step + 1);
                        setFormStateCopy({ channel: Channel });
                      } else {
                        openNotification('Please add atleast one Deal Line!!', 'danger');
                      }
                    }}
                  >
                    {step === 3 ? 'Completed' : 'Next'}
                  </Button>
                ) : step === 2 ? (
                  <Button
                    disabled={step === 3}
                    variant="solid"
                    type='button'
                    size="sm"
                    icon={step === 3 ? <AiOutlineSave /> : <IoMdArrowRoundForward />}
                    onClick={() => onChange(step + 1)}
                  >
                    {step === 3 ? 'Completed' : 'Next'}
                  </Button>
                ) : (
                  <Button
                    disabled={step2 === 4}
                    variant="solid"
                    size="sm"
                    icon={step === 3 ? <AiOutlineSave /> : <IoMdArrowRoundForward />}
                    onClick={() => {
                      if (step === 3) {
                        onFinalSave();
                      } else {
                        onNext();
                      }
                    }}
                  >
                    {step === 3 ? 'Completed' : 'Next'}
                  </Button>
                )}

                {Content.DealNumber && (
                  <Button className="mx-2" variant="solid" type="button" size="sm" icon={<HiPrinter />} onClick={dealPrint}>
                    Print
                  </Button>
                )}
              </div>

              <div id="myblock" className="grid grid-cols-3 md:grid-cols-3 lg:grid-cols-6 gap-4 p-4 pt-0 pb-1 bg-gray-100 dark:bg-gray-800">
                <div />
                <div />
                <div />
                <div className="flex flex-col">
                  <span className="font-medium text-gray-600 dark:text-gray-300 text-sm">Total Amount</span>
                  <span className="text-lg font-bold lblColor">{currencySymbol} {totalAmount.toLocaleString('en-IN')}</span>
                </div>
                <div className="flex flex-col">
                  <span className="font-medium text-gray-600 dark:text-gray-300 text-sm">Total Seconds</span>
                  <span className="text-lg font-bold lblColor">{totalSeconds}</span>
                </div>
                <div className="flex flex-col">
                  <span className="font-medium text-gray-600 dark:text-gray-300 text-sm">Total Spot/NTC</span>
                  <span className="text-lg font-bold lblColor">{totalSlotAndNTC}</span>
                </div>
              </div>
            </StickyFooter>
          </Card>
        </>}
      {isDialogbox &&
        <DealListShowDialogBox
          Channel={Channel}
          formState={formState}
          isDialogbox={isDialogbox}
          setisDialogbox={setisDialogbox}
          selectedDealData={selectedDealData}
          setSelectedDeal={setSelectedDeal}
          selectedDeal={selectedDeal} />}
    </>
  );
});

export default DealMasterAdd;