import React, { useContext, useEffect, useRef, useState } from 'react';
import { IoMdClose, IoMdSearch } from 'react-icons/io';
import {
  Button,
  Card,
  Input,
  InputGroup,
  Spinner,
  Tooltip,
} from 'components/ui';
import {
  droppableIdsEnum,
  featuresEnum,
  rowDataTypesEnum,
  secondaryTableTypesEnum,
  tableTypesEnum,
} from 'views/Scheduling/Scheduler/enum';
import {
  getAllColumnsOfTable,
  getColumnSettingsFromAPI,
  handleFeatureClose,
} from '../../utils/utils';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';
import { closeDropDowns } from './utils';
import { useSelector } from 'react-redux';
import DraggableTable from '../DraggableTable/DraggableTable';
import { TbGridDots } from 'react-icons/tb';
import ManageColumns from '../Dropdowns/ManageColumns/ManageColumns';
import classNames from 'classnames';
import SecondaryTableToolbar from '../SecondaryTableToolbar/SecondaryTableToolbar';
import { TABLE_NAMES } from 'views/Scheduling/Scheduler/constants';
import SchedulerContext from 'views/Scheduling/SchedulerOld/context/SchedulerContext';
// import SchedulerContext from 'views/Scheduling/Scheduler/context/SchedulerContext';

function InsertDroppedSpot() {
  /* REDUX */
  const token = useSelector((state) => state.auth.session.token);

  /* CONTEXT */
  const {
    setSecondaryTableType,
    secondaryTableData,
    setSecondaryTableData,
    secondaryTableManagedColumns,
    setSecondaryTableManagedColumns,
    setActiveFeatures,
    secTableToolbarState,
    setSecTableToolbarState,
    secondaryTableOffset,
    secondaryTableSelectedRows,
    setSecondaryTableSelectedRows,
    secondaryTableRef,
    dropBucket,
    resetSecondaryTableStates,
  } = useContext(SchedulerContext);

  /* STATES */
  const [searchInputValue, setSearchInputValue] = useState('');
  const [filteredSecondaryTableData, setFilteredSecondaryTableData] = useState(
    [],
  );
  const [showLoader, setShowLoader] = useState(false);

  /* HOOKS */
  const dropdownRef = useRef(null);

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        setSecondaryTableData([...dropBucket]);
        setSecondaryTableType(secondaryTableTypesEnum.DROPPED_SPOTS);
      } catch (error) {
        openNotification(
          'danger',
          'Something went wrong while fetching Dropped Spots',
        );
        setShowLoader(false);
        console.error(error);
      }
    })();
  }, []);

  useEffect(() => {
    try {
      if (Array.isArray(dropBucket)) {
        setSecondaryTableData([...dropBucket]);
      }
    } catch (error) {
      console.error(error);
    }
  }, [dropBucket]);

  useEffect(() => {
    (async () => {
      try {
        if (secondaryTableManagedColumns.originalColumns.length === 0) {
          const { visibleColumns, removedColumns } =
            await getColumnSettingsFromAPI(
              TABLE_NAMES.SECONDARY_TABLE_NAMES.INSERT_DROPPED_SPOTS,
              secondaryTableData,
              token,
            );
          setSecondaryTableManagedColumns({
            originalColumns: getAllColumnsOfTable(secondaryTableData),
            visibleColumns,
            removedColumns,
          });
        }
        if (searchInputValue) handleSearch();
        else setFilteredSecondaryTableData([...secondaryTableData]);
      } catch (error) {
        openNotification(
          'danger',
          'Something went wrong while setting columns for Dropped Spots',
        );
        console.error(error);
      }
    })();
  }, [secondaryTableData]);

  useEffect(() => {
    document.addEventListener('mousedown', (event) =>
      closeDropDowns(event, dropdownRef, setSecTableToolbarState),
    );
    return () => {
      document.removeEventListener('mousedown', (event) =>
        closeDropDowns(event, dropdownRef, setSecTableToolbarState),
      );
    };
  }, [dropdownRef]);

  useEffect(() => {
    try {
      if (searchInputValue.length === 0) {
        setFilteredSecondaryTableData(secondaryTableData);
      }
    } catch (error) {
      console.error(error);
    }
  }, [searchInputValue]);

  /* EVENT HANDLERS */
  const handleSearchByEnterKey = (event) => {
    try {
      if (
        event.key.toLowerCase() === 'enter' ||
        event.key.toLowerCase() === 'tab'
      ) {
        handleSearch();
      }
    } catch (error) {
      console.error(error);
    }
  };

  const handleSearch = async () => {
    try {
      setShowLoader(true);
      const tableData = secondaryTableData.filter((row) =>
        row.Event_Name.toLowerCase().includes(searchInputValue.toLowerCase()),
      );
      if (tableData.length === 0) {
        setFilteredSecondaryTableData([]);
        openNotification('info', 'No dropped spots found');
      } else
        setFilteredSecondaryTableData([secondaryTableData[0], ...tableData]);
      setShowLoader(false);
    } catch (error) {
      openNotification('danger', 'Something went wrong while searching');
      setShowLoader(false);
      console.error(error);
    }
  };

  return (
    <div className="h-full w-full flex flex-col overflow-auto no-scrollbar bg-gray-800 p-3 pt-2 rounded-lg">
      <div className="flex justify-between items-center mb-2">
        <div className="flex items-center gap-3">
          <h5>Drop Box</h5>
          {filteredSecondaryTableData.length > 0 && (
            <h6 className="p-1 rounded-full  text-sm font-black bg-emerald-600 text-white mr-2 w-8 text-center">
              {filteredSecondaryTableData.length - 1}
            </h6>
          )}
        </div>
        <div className="flex gap-1.5">
          {filteredSecondaryTableData.length > 0 && (
            <Tooltip title="Manage Columns" wrapperClass="relative">
              <Button
                size="xs"
                icon={<TbGridDots />}
                className={classNames(
                  secondaryTableManagedColumns.removedColumns.length > 0
                    ? '!bg-teal-700 hover:!bg-teal-700'
                    : 'hover:!bg-teal-800',
                  'transition-all',
                )}
                onClick={() =>
                  setSecTableToolbarState({
                    ...secTableToolbarState,
                    isManageColumnsDropdownVisible: true,
                  })
                }
              />
              {secTableToolbarState.isManageColumnsDropdownVisible && (
                <ManageColumns
                  tableType={tableTypesEnum.SECONDARY}
                  dropdownRef={dropdownRef}
                  position="right-1/2"
                />
              )}
            </Tooltip>
          )}
          <Tooltip title="Close">
            <Button
              size="xs"
              icon={<IoMdClose />}
              onClick={() =>
                handleFeatureClose(
                  setActiveFeatures,
                  featuresEnum.INSERT,
                  resetSecondaryTableStates,
                )
              }
            />
          </Tooltip>
        </div>
      </div>
      <InputGroup className="mb-3 flex">
        <Input
          placeholder="Search Drop Box"
          size="sm"
          className="h-[38px]"
          onChange={(event) => setSearchInputValue(event.target.value)}
          value={searchInputValue}
          autoFocus={true}
          onKeyDown={handleSearchByEnterKey}
        />
        <Button
          icon={<IoMdSearch />}
          className="h-[40px] px-2"
          size="sm"
          onClick={handleSearch}
        />
      </InputGroup>
      <div className="h-[92%] flex flex-col gap-3">
        {filteredSecondaryTableData.length > 0 ? (
          <>
            <div className="grow">
              <DraggableTable
                tableName={
                  TABLE_NAMES.SECONDARY_TABLE_NAMES.INSERT_DROPPED_SPOTS
                }
                tableType={tableTypesEnum.SECONDARY}
                tableData={filteredSecondaryTableData}
                columns={secondaryTableManagedColumns.visibleColumns}
                droppableId={droppableIdsEnum.SECONDARY}
                selectedRows={secondaryTableSelectedRows}
                setSelectedRows={setSecondaryTableSelectedRows}
                scrolledOffset={secondaryTableOffset}
                tableRef={secondaryTableRef}
              />
            </div>
            <SecondaryTableToolbar insertType={rowDataTypesEnum.COMMERCIAL} />
          </>
        ) : (
          <Card
            className="h-full"
            bodyClass="h-full flex justify-center items-center"
          >
            {showLoader ? <Spinner size="45px" /> : 'No dropped spots to show'}
          </Card>
        )}
      </div>
    </div>
  );
}

export default InsertDroppedSpot;
