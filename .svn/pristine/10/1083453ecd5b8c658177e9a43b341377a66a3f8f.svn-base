import { Button, Dialog, Input } from 'components/ui';
import React, { useEffect, useState } from 'react';
import SelectableTable from './SelectableTable';
import {
  apiGetContentmasterDrop,
  apiGetTeamMasterDrop,
} from 'services/ProgrammingService';
import {
  getMissingObjectsInSubJSONArray,
  openNotification,
} from 'views/Controls/GLOBALFUNACTION';
import { entityTypeCodeEnum } from '../enum';

/* CONSTANTS */
const CONTENT_COLUMNS = [
  {
    header: 'Content Name',
    accessorKey: 'ContentName',
  },
];

const TEAM_COLUMNS = [
  {
    header: 'Team Name',
    accessorKey: 'TeamName',
    cell: ({ cell, row }) => {
      return (
        <div className="flex items-center gap-2 py-1">
          <img
            alt="Team"
            src={row.original.Team_Image}
            style={{ height: '25px', width: '25px', borderRadius: '50%' }}
          ></img>
          {row.original.TeamName}
        </div>
      );
    },
  },
];

function DebouncedInput({
  value: initialValue,
  onChange,
  debounce = 500,
  ...props
}) {
  const [value, setValue] = useState(initialValue);

  useEffect(() => {
    setValue(initialValue);
  }, [initialValue]);

  useEffect(() => {
    const timeout = setTimeout(() => {
      onChange(value);
    }, debounce);
    return () => clearTimeout(timeout);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [value]);

  return (
    <Input
      {...props}
      value={value}
      onChange={(e) => setValue(e.target.value)}
    />
  );
}

function SelectEntityDialog({
  channel,
  isSelectEntityDialogOpen,
  setIsSelectEntityDialogOpen,
  selectedEventGroup,
  setSelectedEventGroup,
  groupWiseSelectedEntities,
  setGroupWiseSelectedEntities,
  entityTypeCode,
  setShowLoader,
}) {
  /* STATES */
  const [entityList, setEntityList] = useState([]);
  const [selectedRows, setSelectedRows] = useState([]);
  const [selectedRowIndexes, setSelectedRowIndexes] = useState({});
  const [globalFilter, setGlobalFilter] = useState('');

  /* USE EFFECTS */
  useEffect(() => {
    (async () => {
      try {
        if (isSelectEntityDialogOpen) {
          setSelectedEntityListFromAPI();
        }
      } catch (error) {
        console.error(error);
      }
    })();
  }, [isSelectEntityDialogOpen]);

  /* EVENT HANDLERS */
  const handleAdd = () => {
    try {
      updateSelectedEntities();
      handleClose();
    } catch (error) {
      console.error(error);
    }
  };

  const handleClose = () => {
    try {
      setIsSelectEntityDialogOpen(false);
      setSelectedRows([]);
      setSelectedEventGroup('');
      setSelectedRowIndexes({});
      setGlobalFilter('');
    } catch (error) {
      console.error(error);
    }
  };

  /* HELPER FUNCTIONS */
  const setSelectedEntityListFromAPI = async () => {
    try {
      setShowLoader(true);
      let response;
      if (entityTypeCode === entityTypeCodeEnum.CONTENT) {
        response = await apiGetContentmasterDrop(
          undefined,
          channel.LocationCode,
          channel.ChannelCode,
          0,
        );
      } else {
        response = await apiGetTeamMasterDrop();
      }
      if (response.status === 200) {
        let selectedEntityList = getNotSelectedEntities(
          response.data,
          groupWiseSelectedEntities,
        );
        if (groupWiseSelectedEntities[selectedEventGroup]) {
          let selectedRowIndexes = {};
          groupWiseSelectedEntities[selectedEventGroup].forEach(
            (selectedEntity) => {
              let index;
              if (entityTypeCode === entityTypeCodeEnum.CONTENT) {
                index = selectedEntityList.findIndex(
                  (content) =>
                    content.ContentCode === selectedEntity.ContentCode,
                );
              } else {
                index = selectedEntityList.findIndex(
                  (team) => team.TeamCode === selectedEntity.TeamCode,
                );
              }
              if (index !== -1) {
                selectedRowIndexes[index] = true;
              }
            },
          );
          setSelectedRowIndexes(selectedRowIndexes);
        }
        setEntityList(selectedEntityList);
      } else if (response.status === 204) {
        setEntityList([]);
      } else {
        openNotification(
          'danger',
          `Unable to fetch ${
            entityTypeCode === entityTypeCodeEnum.CONTENT ? 'Contents' : 'Teams'
          }. Server responsed with status code ${response.status}`,
        );
      }
      setShowLoader(false);
    } catch (error) {
      setShowLoader(false);
      throw error;
    }
  };

  const getNotSelectedEntities = (allEntities, groupWiseSelectedEntities) => {
    try {
      let alreadySelectedEntities = [];
      Object.keys(groupWiseSelectedEntities).forEach((group) => {
        if (group !== selectedEventGroup) {
          groupWiseSelectedEntities[group].forEach((entity) => {
            alreadySelectedEntities.push(entity);
          });
        }
      });
      return getMissingObjectsInSubJSONArray(
        allEntities,
        alreadySelectedEntities,
        entityTypeCode === entityTypeCodeEnum.CONTENT
          ? 'ContentCode'
          : 'TeamCode',
      );
    } catch (error) {
      console.error(error);
    }
  };

  const updateSelectedEntities = () => {
    try {
      const newSelectedEntities = { ...groupWiseSelectedEntities };
      newSelectedEntities[selectedEventGroup] = selectedRows;
      if (newSelectedEntities[selectedEventGroup].length === 0) {
        delete newSelectedEntities[selectedEventGroup];
      }
      setGroupWiseSelectedEntities(newSelectedEntities);
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <Dialog
      isOpen={isSelectEntityDialogOpen}
      onClose={handleClose}
      contentClassName="flex flex-col pr-8 pt-8"
      height="80vh"
    >
      <div className="flex justify-between items-center mb-4">
        <h5>
          {entityTypeCode === entityTypeCodeEnum.CONTENT ? 'Contents' : 'Teams'}
        </h5>
        <DebouncedInput
          value={globalFilter ?? ''}
          className="p-2 w-5/12 font-lg shadow border border-block"
          placeholder="Search"
          onChange={(value) => setGlobalFilter(String(value))}
          size="sm"
        />
      </div>
      <div className="grow">
        {!entityList ? (
          <div className="h-full flex justify-center items-center">
            No{' '}
            {entityTypeCode === entityTypeCodeEnum.CONTENT
              ? 'contents'
              : 'teams'}{' '}
            to show
          </div>
        ) : (
          <SelectableTable
            data={entityList}
            columns={
              entityTypeCode === entityTypeCodeEnum.CONTENT
                ? CONTENT_COLUMNS
                : TEAM_COLUMNS
            }
            selectedRowIndexes={selectedRowIndexes}
            setSelectedRows={setSelectedRows}
            globalFilter={globalFilter}
            setGlobalFilter={setGlobalFilter}
          />
        )}
      </div>
      <div className="text-right mt-4 flex items-center justify-end">
        <Button
          className="ltr:mr-2 rtl:ml-2"
          variant="plain"
          onClick={handleClose}
        >
          Cancel
        </Button>
        <Button variant="solid" onClick={handleAdd}>
          Add
        </Button>
      </div>
    </Dialog>
  );
}

export default SelectEntityDialog;
