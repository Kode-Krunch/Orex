import React, { useState, useRef, useEffect } from 'react'
import classNames from 'classnames'
import withHeaderItem from 'utils/hoc/withHeaderItem'
import { Dialog, Button } from 'components/ui'
import useThemeClass from 'utils/hooks/useThemeClass'
import navigationIcon from 'configs/navigation-icon.config'
import debounce from 'lodash/debounce'
import { HiOutlineSearch, HiChevronRight } from 'react-icons/hi'
import { Link, useNavigate } from 'react-router-dom'
import Highlighter from 'react-highlight-words'
import { logright } from 'services/MasterService'
import { useSelector } from 'react-redux'

const recommendedSearch = [];

const ListItem = (props) => {
    const { icon, label, url = '', isLast, keyWord, onNavigate } = props

    const { textTheme } = useThemeClass()

    return (
        <Link to={url} onClick={onNavigate}>
            <div
                className={classNames(
                    'flex items-center justify-between rounded-lg p-3.5 cursor-pointer user-select',
                    'bg-gray-50 dark:bg-gray-700/60 hover:bg-gray-100 dark:hover:bg-gray-700/90',
                    !isLast && 'mb-3'
                )}
            >
                <div className="flex items-center">
                    <div
                        className={classNames(
                            'mr-4 rounded-md ring-1 ring-slate-900/5 shadow-sm text-xl group-hover:shadow h-6 w-6 flex items-center justify-center bg-white dark:bg-gray-700',
                            textTheme,
                            'dark:text-gray-100'
                        )}
                    >
                        {icon && navigationIcon[icon]}
                    </div>
                    <div className="text-gray-900 dark:text-gray-300">
                        <Highlighter
                            autoEscape
                            highlightClassName={classNames(
                                textTheme,
                                'underline bg-transparent font-semibold dark:text-white'
                            )}
                            searchWords={[keyWord]}
                            textToHighlight={label}
                        />
                    </div>
                </div>
                <HiChevronRight className="text-lg" />
            </div>
        </Link>
    )
}

export const Search = ({ className }) => {
    const LoginId = useSelector((state) => state.auth.session.LoginId);
    const { token, signedIn } = useSelector((state) => state.auth.session);

    const navigate = useNavigate()
    const [searchDialogOpen, setSearchDialogOpen] = useState(false)
    const [searchResult, setSearchResult] = useState(recommendedSearch)
    const [searchModuleList, setSearchModuleList] = useState([])
    const [noResult, setNoResult] = useState(false)
    const inputRef = useRef()

    const debounceFn = debounce(handleDebounceFn, 200)

    const handleReset = () => {
        setNoResult(false)
        setSearchResult(recommendedSearch)
    }

    const handleSearchOpen = () => {
        setSearchDialogOpen(true)
    }

    const handleSearchClose = () => {
        setSearchDialogOpen(false)
        debounceFn('')
        if (noResult) {
            setTimeout(() => {
                handleReset()
            }, 300)
        }
    }

    async function handleDebounceFn(query) {
        if (!query) {
            setSearchResult(recommendedSearch)
            return
        }

        if (noResult) {
            setNoResult(false)
        }
        const respond = filterMenuData(searchModuleList, query)
        if (respond) {
            if (respond.length === 0) {
                setNoResult(true)
            }
            setSearchResult(respond)
        }
    }

    const handleSearch = (e) => {
        debounceFn(e.target.value)
    }

    useEffect(() => {
        if (searchDialogOpen) {
            let timeout = setTimeout(() => inputRef.current?.focus(), 100)
            return () => {
                clearTimeout(timeout)
            }
        }
    }, [searchDialogOpen])

    useEffect(() => {
        (async (values) => {
            const resp = await logright(LoginId, token);
            setSearchModuleList(transformMenuData(resp.data));
        })();
    }, []);

    const filterMenuData = (menuData, query) => {
        const result = [];
        menuData.forEach(item => {
            if (item.title.toLowerCase().includes(query.toLowerCase())) {
                const filteredData = item.data
                    ? item.data.filter(subItem => subItem.title.toLowerCase().includes(query.toLowerCase()))
                    : [];
                if (filteredData.length > 0) {
                    result.push({
                        title: item.title,
                        data: filteredData
                    });
                }
            } else if (item.data) {
                const filteredData = item.data.filter(subItem => subItem.title.toLowerCase().includes(query.toLowerCase()));
                if (filteredData.length > 0) {
                    result.push({
                        title: item.title,
                        data: filteredData
                    });
                }
            }
        });
        return result;
    };

    const transformMenuData = (menu) => {
        let result = [];
        const processSubMenu = (subMenu, parentKey) => {
            let data = [];
            subMenu.forEach(item => {
                if (item.path) {
                    data.push({
                        title: item.title,
                        url: item.path,
                        icon: parentKey, // Parent key used as icon
                        category: parentKey, // Parent key used as category
                        categoryTitle: parentKey // Parent key used as categoryTitle
                    });
                }
                if (item.subMenu && item.subMenu.length > 0) {
                    data = data.concat(processSubMenu(item.subMenu, parentKey));
                }
            });
            return data;
        };
        menu.forEach(item => {
            if (item.subMenu && item.subMenu.length > 0) {
                let parent = {
                    title: item.title, // Parent title
                    data: [] // Array to hold child items
                };
                parent.data = processSubMenu(item.subMenu, item.key);
                result.push(parent);
            }
        });
        return result;
    };

    const handleNavigate = (e) => {
        navigate(e.url)
        handleSearchClose()
    }

    return (
        <>
            <div
                className={classNames(className, 'text-2xl')}
                onClick={handleSearchOpen}
            >
                <HiOutlineSearch />
            </div>
            <Dialog
                contentClassName="p-0"
                isOpen={searchDialogOpen}
                closable={false}
                onRequestClose={handleSearchClose}
            >
                <div>
                    <div className="px-4 flex items-center justify-between border-b border-gray-200 dark:border-gray-600">
                        <div className="flex items-center">
                            <HiOutlineSearch className="text-xl" />
                            <input
                                ref={inputRef}
                                className="ring-0 outline-none block w-full p-4 text-base bg-transparent text-gray-900 dark:text-gray-100"
                                placeholder="Search..."
                                onChange={handleSearch}
                            />
                        </div>
                        <Button size="xs" onClick={handleSearchClose}>
                            Esc
                        </Button>
                    </div>
                    <div className="py-6 px-5 max-h-[550px] overflow-y-auto">
                        {searchResult.map((result) => (
                            <div className="mb-6" key={result.title}>
                                <h6 className="mb-3">{result.title}</h6>
                                {result.data.map((data, index) => (
                                    <ListItem
                                        key={data.title + index}
                                        icon={data.icon}
                                        label={data.title}
                                        url={data.url}
                                        keyWord={inputRef.current?.value || ''}
                                        onNavigate={() => handleNavigate(data)}
                                    />
                                ))}
                            </div>
                        ))}
                        {searchResult.length === 0 && noResult && (
                            <div className="my-10 text-center text-lg">
                                <span>No results for </span>
                                <span className="heading-text">
                                    '{inputRef.current?.value}'
                                </span>
                            </div>
                        )}
                    </div>
                </div>
            </Dialog>
        </>
    )
}

export default withHeaderItem(Search)
