import React, { useEffect, useState } from 'react';
import { Menu, ScrollBar } from 'components/ui';
import {
  NAV_MODE_DARK,
  NAV_MODE_THEMED,
  NAV_MODE_TRANSPARENT,
} from 'constants/theme.constant';
import { NAV_ITEM_TYPE_ITEM } from 'constants/navigation.constant';
import { AuthorityCheck } from 'components/shared';
import navigationConfig from 'configs/navigation.config';
import navigationIcon from 'configs/navigation-icon.config';
import useMenuActive from 'utils/hooks/useMenuActive';
import isEmpty from 'lodash/isEmpty';
import { Link, useNavigate } from 'react-router-dom';
import { useDispatch, useSelector } from 'react-redux';
import { ADMIN, USER } from 'constants/roles.constant';
import { logright } from 'services/MasterService';
import { setModuleList, setModuletitle } from 'store/auth/userSlice';
import { protectedRoutes } from 'configs/routes.config';

const StackedSideNavMini = (props) => {
  const {
    navMode,
    onChange,
    routeKey,
    activeKeys,
    onSetActiveKey,
    userAuthority,
    mode,
    direction,
    ...rest
  } = props;
  const dispatch = useDispatch();
  const LoginId = useSelector((state) => state.auth.session.LoginId);
  // const module = useSelector((state) => state.auth.session.module)
  const { token, signedIn } = useSelector((state) => state.auth.session);
  const [data, setdata] = useState(['']);

  const HomeArray = [
    {
      key: 'home',
      path: '/home',
      title: 'Home',
      translateKey: 'nav.Dashboard',
      icon: 'Home',
      type: NAV_ITEM_TYPE_ITEM,
      authority: [ADMIN, USER],
      subMenu: [],
    },
  ];

  const transformArray = (array) => {
    return array.map((item) => {
      const { key, path, title, translateKey, type, icon, authority, subMenu } =
        item;

      if (subMenu && subMenu.length > 0) {
        return {
          key,
          path: '',
          title,
          translateKey,
          icon,
          type,
          authority,
          subMenu: subMenu.map((subItem) => {
            const { key, title, translateKey, type, subMenu } = subItem;

            if (subMenu && subMenu.length > 0) {
              return {
                key,
                path: '',
                icon: key,
                title,
                translateKey,
                type,
                authority,
                subMenu: subMenu.map((subSubMenu) => {
                  const { key, title, translateKey, rights, path, FormCode } =
                    subSubMenu;
                  return {
                    key: `${path}`,
                    path: `/${path}`,
                    title,
                    canread: rights[0].CanRead,
                    translateKey,
                    icon: key,
                    type: 'NAV_ITEM_TYPE_ITEM',
                    authority,
                    FormCode: FormCode,
                    subMenu: [],
                  };
                }),
              };
            } else {
              // Handle case where subMenu is empty
              return {
                key: `${path}`,
                path: `/${path}`,
                title,
                FormCode: 0,
                translateKey,
                icon: 'FcFilingCabinet',
                type: 'NAV_ITEM_TYPE_ITEM',
                authority,
                subMenu: [],
              };
            }
          }),
        };
      } else {
        // Handle case where subMenu is not present or is an empty array
        return {
          key,
          path: `/${key}`,
          title,
          translateKey,
          icon: 'FcFilingCabinet',
          type: 'NAV_ITEM_TYPE_ITEM',
          authority,
          subMenu: [],
        };
      }
    });
  };

  const transformedArray = transformArray(data);

  let red = [...HomeArray, ...transformedArray];
  useEffect(() => {
    const fetchRightsAndFlattenMenu = async () => {
      try {
        const resph = await logright(LoginId, token);

        // Set the data in the state
        setdata(resph.data);
      } catch (error) {
        console.error('Error fetching rights or flattening menu:', error);
        // Handle errors if needed
      }
    };

    fetchRightsAndFlattenMenu();
  }, []);

  useEffect(() => {
    const flattenMenu = (menu, protectedRoutes) => {
      const result = [];

      // Create a map of lowercase keys to paths from protectedRoutes for quick lookup
      const protectedRoutesMap = protectedRoutes.reduce((acc, route) => {
        const key = route.key.toLowerCase();
        if (!acc[key]) {
          acc[key] = [];
        }
        acc[key].push(route.path, route.title);
        return acc;
      }, {});

      const traverse = (items) => {
        items.forEach((item) => {
          const itemKey = item.key?.toLowerCase(); // Convert item key to lowercase
          // Check if the lowercase item key exists in the protectedRoutesMap
          if (protectedRoutesMap[itemKey]) {
            // Push all paths associated with the lowercase key
            protectedRoutesMap[itemKey].forEach((path, FormCode, title) => {
              result.push({ key: item.key, path, FormCode, title });
            });
          }
          if (item.subMenu && item.subMenu.length > 0) {
            traverse(item.subMenu);
          }
        });
      };

      traverse(menu);
      return result;
    };

    // Flatten the menu using the fetched rights
    const flattenedMenu = flattenMenu(red, protectedRoutes);
    dispatch(
      setModuleList([
        ...flattenedMenu,
        { key: 'access-denied', path: '/access-denied' },
        { key: 'ActiveLog', path: '/ActiveLog' },
        { key: 'cloudPlayout', path: '/cloudPlayout' },
      ]),
    );
  }, [red]);

  const { includedRouteTree } = useMenuActive(red, routeKey);

  const logoMode = () => {
    if (navMode === NAV_MODE_THEMED) {
      return NAV_MODE_DARK;
    }

    if (navMode === NAV_MODE_TRANSPARENT) {
      return mode;
    }

    return navMode;
  };

  const handleMenuItemSelect = ({ key, title, menu, translateKey }) => {
    onChange({ title, menu, translateKey });
    onSetActiveKey([key]);
  };

  const handleLinkMenuItemSelect = ({ key }) => {
    onChange({});
    onSetActiveKey([key]);
  };

  useEffect(() => {
    if (
      includedRouteTree.type !== NAV_ITEM_TYPE_ITEM &&
      !isEmpty(includedRouteTree)
    ) {
      onChange({
        key: includedRouteTree.key,
        title: includedRouteTree.title,
        menu: includedRouteTree.subMenu,
        translateKey: includedRouteTree.translateKey,
      });
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [includedRouteTree.key]);

  return (
    <div {...rest}>
      {/* <Logo
                mode={logoMode()}
                type="streamline"
                gutter={SIDE_NAV_CONTENT_GUTTER}
            /> */}
      <ScrollBar autoHide direction={direction}>
        <Menu
          className=""
          variant={navMode}
          defaultActiveKeys={activeKeys || [includedRouteTree.key]}
        >
          <div
            style={
              mode == 'dark'
                ? { borderTop: '1px solid #304050' }
                : { borderTop: '1px solid #e5e7eb' }
            }
          >
            {LoginId == 8
              ? navigationConfig.map((nav) => (
                <AuthorityCheck
                  key={nav.key}
                  authority={nav.authority}
                  userAuthority={userAuthority}
                >
                  {nav.subMenu && nav.subMenu.length > 0 ? (
                    <Menu.MenuItem
                      eventKey={nav.key}
                      className="mb-2"
                      onSelect={() =>
                        handleMenuItemSelect({
                          key: nav.key,
                          title: nav.title,
                          menu: nav.subMenu,
                          translateKey: nav.translateKey,
                        })
                      }
                    >
                      <div className="text-2xl">
                        {navigationIcon[nav.icon]}
                      </div>
                    </Menu.MenuItem>
                  ) : (
                    <Link
                      to={nav.path}
                      className="flex items-center h-full w-full"
                      onClick={() =>
                        handleLinkMenuItemSelect({
                          key: nav.key,
                        })
                      }
                    >
                      <Menu.MenuItem eventKey={nav.key} className="mb-2">
                        <div className="text-2xl">
                          {navigationIcon[nav.icon]}
                        </div>
                      </Menu.MenuItem>
                    </Link>
                  )}
                </AuthorityCheck>
              ))
              : red.map((nav) => (
                <AuthorityCheck
                  key={nav.key}
                  authority={nav.authority}
                  userAuthority={userAuthority}
                >
                  {nav.subMenu && nav.subMenu.length > 0 ? (
                    <Link
                      to={nav.title
                        .toLowerCase()
                        .replace(/\b\w/g, (char) => char.toUpperCase())
                        .replace(/\s/g, '')}
                      className=" py-5 flex justify-center w-full"
                      style={
                        mode == 'dark'
                          ? { borderBottom: '1px solid #304050' }
                          : { borderBottom: '1px solid #e5e7eb' }
                      }
                      onClick={() => {
                        // alert(nav.key)
                        dispatch(setModuletitle(nav.title));
                        handleMenuItemSelect({
                          key: nav.key,
                          title: nav.title,
                          menu: nav.subMenu,
                          translateKey: nav.translateKey,
                        });
                      }}
                    >
                      <Menu.MenuItem
                        eventKey={nav.key}
                        className="flex justify-center"
                      >
                        <div>
                          <div className="text-2xl flex justify-center  mb-2 ">
                            {navigationIcon[nav.title.replace(' ', '')]}
                          </div>
                          <p className="text-xs font-normal capitalize">
                            {nav.title}
                          </p>
                        </div>
                      </Menu.MenuItem>
                    </Link>
                  ) : (
                    //   </Link>
                    <Link
                      to={nav.path}
                      className=" py-2 flex items-center w-full"
                      style={
                        mode == 'dark'
                          ? { borderBottom: '1px solid #304050' }
                          : { borderBottom: '1px solid #e5e7eb' }
                      }
                      onClick={() =>
                        handleLinkMenuItemSelect({
                          key: nav.key,
                        })
                      }
                    >
                      <Menu.MenuItem
                        eventKey={nav.key}
                        className="flex justify-center"
                      >
                        <div>
                          <div className="text-2xl flex justify-center  mb-2">
                            {navigationIcon[nav.icon]}
                          </div>
                          <p className="text-xs font-normal capitalize">
                            {nav.title}
                          </p>
                        </div>
                      </Menu.MenuItem>
                    </Link>
                  )}
                </AuthorityCheck>
              ))}
          </div>
        </Menu>
      </ScrollBar>
    </div>
  );
};

export default StackedSideNavMini;
