import { Button, Tooltip } from 'components/ui';
import { convertDateToYMD, isNumbers } from 'components/validators';
import React, { useEffect, useRef, useState } from 'react';
import { IoMdInformationCircleOutline } from 'react-icons/io';
import { RxReset } from 'react-icons/rx';
import { openNotification } from 'views/Controls/GLOBALFUNACTION';


const removeKeysStartingWith = (obj, keyPrefix) => {
  // Create a shallow copy of the object to avoid mutation
  const newObj = { ...obj };

  // Loop over all keys of the object
  Object.keys(newObj).forEach(key => {
    // If the key matches the prefix pattern, delete it
    if (key.startsWith(keyPrefix)) {
      delete newObj[key];
    }
  });

  return newObj;
};
const DateRangeInputs = ({
  date1,
  date2,
  formState,
  setFormState,
  checkedItems,
  CommercialMasterData,
  setThe_data_I_want_To_Upload,
  trafficDayList,
  generateCustomArray
}) => {


  const formatDate = (date) => {
    const options = { day: '2-digit' };
    const day = new Intl.DateTimeFormat('en-US', options).format(date);
    const month = date
      .toLocaleString('en-US', { month: 'short' })
      .substring(0, 3);
    return `${day}-${month}`;
  };
  const formatDate2 = (date) => {
    const options = { day: '2-digit' };
    const day = new Intl.DateTimeFormat('en-US', options).format(date);
    const month = date
      .toLocaleString('en-US', { month: 'short' })
      .substring(0, 3);
    const year = date.toLocaleString('en-US', { year: 'numeric' });
    return `${day}-${month}-${year}`;
  };
  const updateFormState = (newFormState, currentYear, currentDate, Name) => {
    const updatedCopyFormState = {};
    for (const key in newFormState) {
      if (!key.endsWith('total') && key[0] !== 'Y') {
        const parts = key.split('|');
        if (parts.length >= 3) {
          const [dealLineItemNo, commId, date] = parts;
          const dateParts = date.split('-');
          if (dateParts.length === 2) {
            const [day, month] = dateParts;
            const updatedKey = `${dealLineItemNo}|${commId}|${day}-${month}-${Name.split('-')[2]
              }|${formState.MID}|${formState.position}`;
            updatedCopyFormState[updatedKey] = newFormState[key];
          }
        }
      }
    }
    for (const key in updatedCopyFormState) {
      const value = updatedCopyFormState[key];
      updatedCopyFormState[key] = `${key}|${value}`;
    }

    const stringFromArray = JSON.stringify(updatedCopyFormState).replace(
      /[%{}]/g,
      '',
    );

    setThe_data_I_want_To_Upload(stringFromArray);
  };

  const transformData = (data) => {
    const result = {};
    const { MID, position } = data;

    // Iterate through keys of the data
    Object.keys(data).forEach((key) => {
      const parts = key.split('|');

      // Ensure the key has the expected format
      if (parts.length === 3) {
        const prefix = parts[0]; // Y2 or 2
        const datePart = parts[2]; // Extract the date part
        const valuePart = data[key]; // Get the value directly

        // Check if valuePart is a number, to avoid [object Object]
        if (
          typeof valuePart === 'number' ||
          (typeof valuePart === 'object' &&
            valuePart !== null &&
            'total' in valuePart)
        ) {
          const valueToUse =
            typeof valuePart === 'number' ? valuePart : valuePart.value;

          // Prepare the new key and value

          if (
            (typeof prefix === 'string' &&
              !prefix.includes('Y') &&
              datePart !== 'total') ||
            typeof prefix === 'number'
          ) {
            const newKey = `${prefix}|${parts[1]
              }|${datePart}-${new Date().getFullYear()}|${MID}|${position}`;
            const newValue = `${newKey}|${valueToUse}`;

            // Assign to the result object
            result[newKey] = newValue;
          }
        }
      }
    });

    return result;
  };
  const handleChange = (
    e,
    DealLineItemNo,
    commId,
    DurInSec,
    BalancedSeconds,
    BalancedSpots,
    NTCBalanceSpots,
    currentDate,
    DealLineItemTypeCode,
    Name,
  ) => {
    const { value, name } = e.target;

    const totalKey = name.split('|').slice(0, 2).join('|');
    const limit = getLimit(
      DealLineItemTypeCode,
      NTCBalanceSpots,
      BalancedSpots,
      BalancedSeconds,
    );

    if (value !== '') {
      const valueInInt = parseInt(value);

      const totalConsumedBalance = calculateTotalConsumedBalance(
        formState,
        DealLineItemNo,
      );
      const totalValue = calculateTotalValuSep(formState, name);
      const isWithinLimit =
        DealLineItemTypeCode === 6 || DealLineItemTypeCode === 5 || DealLineItemTypeCode === 4
          ? totalValue + valueInInt <= limit
          : totalConsumedBalance + valueInInt * DurInSec <= limit;

      if (isWithinLimit) {
        updateFormStateWithNewValue(
          name,
          valueInInt,
          DurInSec,
          totalKey,
          currentDate,
          Name,
        );
      } else {
        openNotification(
          'info',
          DealLineItemTypeCode === 6 || DealLineItemTypeCode === 5
            ? 'Booking not allowed due to insufficient Spots.'
            : 'Booking not allowed due to insufficient balance.',
        );
      }
    } else {
      removeFormStateEntry(name, totalKey, currentDate, Name);
    }
  };

  // Helper Functions
  const getLimit = (
    DealLineItemTypeCode,
    NTCBalanceSpots,
    BalancedSpots,
    BalancedSeconds,
  ) => {
    return DealLineItemTypeCode === 4
      ? NTCBalanceSpots
      : DealLineItemTypeCode === 5 || DealLineItemTypeCode === 6
        ? BalancedSpots
        : BalancedSeconds;
  };

  const calculateTotalConsumedBalance = (formState, DealLineItemNo) => {
    const allRowsDataKeys = Object.keys(formState).filter(
      (key) =>
        key[1] === DealLineItemNo.toString() &&
        key[0] === 'Y' &&
        !key.includes('total'),
    );

    return allRowsDataKeys.reduce(
      (total, key) => total + formState[key].total,
      0,
    );
  };

  const calculateTotalValue = (formState, totalKey) => {
    const relevantKeys = Object.keys(formState).filter(
      (key) => key.startsWith('Y' + totalKey) && !key.endsWith('|total'),
    );

    return relevantKeys.reduce((sum, key) => sum + formState[key].value, 0);
  };
  const calculateTotalValuSep = (formState, name) => {
    const relevantKeys = Object.keys(formState).filter(
      (key) =>
        key.startsWith('Y') && !key.endsWith('|total') && key !== `Y${name}`, // Exclude this specific key
    );
    return relevantKeys.reduce((sum, key) => sum + formState[key].value, 0);
  };

  const updateFormStateWithNewValue = (
    name,
    valueInInt,
    DurInSec,
    totalKey,
    currentDate,
    Name,
  ) => {
    setFormState((prevFormState) => {
      const newFormState = { ...prevFormState };
      newFormState['Y' + name] = {
        value: valueInInt,
        date: Name,
        total: valueInInt * DurInSec,
      };
      newFormState[name] = valueInInt;

      const totalValue = calculateTotalValue(newFormState, totalKey);
      newFormState[`${totalKey}|total`] = totalValue;

      updateFormState(
        newFormState,
        currentDate.getFullYear(),
        currentDate,
        Name,
      );

      return newFormState;
    });
  };

  const removeFormStateEntry = (name, totalKey, currentDate, Name) => {
    if (name in formState) {
      setFormState((prevFormState) => {
        const newFormState = { ...prevFormState };
        delete newFormState['Y' + name];
        delete newFormState[name];

        const totalValue = calculateTotalValue(newFormState, totalKey);
        newFormState[`${totalKey}|total`] = totalValue;

        updateFormState(
          newFormState,
          currentDate.getFullYear(),
          currentDate,
          Name,
        );

        return newFormState;
      });
    }
  };

  const inputGridRef = useRef([]);

  const handleKeyDownNavigation = (e, rowIndex, dateFieldIndex, totalDays) => {
    const currentInput = e.target;

    // Cursor position
    const cursorAtStart = currentInput.selectionStart === 0;
    const cursorAtEnd =
      currentInput.selectionStart === currentInput.value.length;

    switch (e.key) {
      case 'ArrowLeft':
        if (dateFieldIndex > 0 && cursorAtStart) {
          inputGridRef.current[rowIndex][dateFieldIndex - 1].focus();
        }
        break;
      case 'ArrowRight':
        if (dateFieldIndex < totalDays && cursorAtEnd) {
          inputGridRef.current[rowIndex][dateFieldIndex + 1].focus();
        }
        break;
      case 'ArrowUp':
        if (rowIndex > 0) {
          inputGridRef.current[rowIndex - 1][dateFieldIndex].focus();
        }
        break;
      case 'ArrowDown':
        if (rowIndex < totalRows) {
          inputGridRef.current[rowIndex + 1][dateFieldIndex].focus();
        }
        break;
      default:
        break;
    }
  };

  const createInputFields = (
    DealLineItemNo,
    BalancedSeconds,
    BalancedSpots,
    NTCBalanceSpots,
    commId,
    DurInSec,
    weekendsdetail,
    checkedItem,
    rowIndex,
    totalRows,
  ) => {
    const startDate = new Date(date1);
    const endDate = new Date(date2);
    const fields = [];

    // If date is not active, skip creating input field for it
    // if (!isActiveDate) {
    //   continue;
    // }
    let dateFieldIndex = 0;
    let totalDays = Math.floor(
      (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24),
    );
    for (
      let currentDate = new Date(startDate);
      currentDate <= endDate;
      currentDate.setDate(currentDate.getDate() + 1)
    ) {
      const currentDay = currentDate.getDay();
      const isWeekendDay = weekendsdetail.some(
        (weekend) => weekend.Day === currentDay,
      );

      // MYCODE
      if (trafficDayList.length !== 0) {
        const isActiveDate = trafficDayList.some(
          (item) =>
            item.date === convertDateToYMD(currentDate) && item.IsActive === 1,
        );
        if (!isActiveDate) {
          continue;
        }
      }
      // MYCODE

      ((dateFieldIndex) => {
        const fieldName = `${DealLineItemNo}|${commId}|${formatDate(
          currentDate,
        ).replace(/\s+/g, '-')}`;
        const Name1 = `${formatDate(currentDate).replace(/\s+/g, '-')}`;
        const Name = `${formatDate2(currentDate).replace(/\s+/g, '-')}`;
        fields.push(
          <input
            style={{
              width: 45,
              border: '1px solid rgb(75, 84, 97)',
              color: 'rgb(246, 247, 250)',
              height: 30,
              borderRadius: '.375rem',
              paddingLeft: 2,
              marginRight: 2,
              backgroundColor: !isWeekendDay ? '#5757578c' : 'initial',
              textAlign: 'center',
            }}
            size="xs"
            key={currentDate.getDate()}
            type="text"
            value={formState['Y' + fieldName]?.value || ''}
            name={fieldName}
            label={Name1}
            disabled={!isWeekendDay}
            data-index={`${rowIndex}-${dateFieldIndex}`}
            onKeyDown={(e) =>
              handleKeyDownNavigation(
                e,
                rowIndex,
                dateFieldIndex,
                totalDays,
                totalRows,
              )
            }
            ref={(el) => {
              if (!inputGridRef.current[rowIndex]) {
                inputGridRef.current[rowIndex] = [];
              }
              inputGridRef.current[rowIndex][dateFieldIndex] = el;
            }}
            onChange={(e) => {
              if (isNumbers(e.target.value)) {
                handleChange(
                  e,
                  DealLineItemNo,
                  commId,
                  DurInSec,
                  BalancedSeconds,
                  BalancedSpots,
                  NTCBalanceSpots,
                  currentDate,
                  checkedItem.DealLineItemTypeCode,
                  Name,
                );
              }
            }}
          />,
        );
      })(dateFieldIndex);
      dateFieldIndex = dateFieldIndex + 1;
    }
    return fields;
  };
  // Extract start and end dates
  const [result, setResult] = useState([]);
  const [CheckConditionForCommId, setCheckConditionForCommId] = useState(false);
  const [CommId, setCommId] = useState(0);
  const [DealId, setDealId] = useState(0);
  const [InsettedData, setInsettedData] = useState([]);
  let rowIndex = 0;
  let totalRows =
    Array.isArray(checkedItems) && Array.isArray(CommercialMasterData)
      ? checkedItems.length * CommercialMasterData.length
      : [];

  // Extract start and end dates
  useEffect(() => {
    const startDate = new Date(formState.datesrange[0]);
    const endDate = new Date(formState.datesrange[1]);

    const generateDateRange = (start, end) => {
      const dates = [];
      const currentDate = new Date(start);

      while (currentDate <= end) {
        dates.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
      }
      return dates;
    };
    const newResult = {};
    checkedItems.forEach((dealLineItem) => {
      const yearKey = `Y${dealLineItem.DealLineItemNo}`;
      newResult[yearKey] = {};

      formState.Commercial?.forEach((item) => {
        const commercialKey = item.value;
        newResult[yearKey][commercialKey] = [];

        const dates = generateDateRange(startDate, endDate);

        dates.forEach((date) => {
          const key = `${yearKey}|${commercialKey}|${formatDate(
            new Date(date),
          )}`;

          if (formState[key]) {
            newResult[yearKey][commercialKey].push({
              [key]: formState[key].value,
            });
          } else {
            newResult[yearKey][commercialKey].push({ [key]: '' });
          }
        });
      });
    });

    setResult(newResult);
  }, [formState]);
  function checkArray(arr) {
    // Check if the first three elements are numbers
    const firstThreeAreNumbers = arr
      .slice(0, 2)
      .every((element) => !isNaN(element) && element !== '-');

    // Check if there are any numbers after the third index
    const hasNumbersAfterIndexThree = arr
      .slice(2)
      .some((element) => !isNaN(element) && element !== '-');

    // Return false if the first three are numbers and there are numbers after index 3
    return firstThreeAreNumbers && !hasNumbersAfterIndexThree;
  }

  useEffect(() => {
    if (result) {
      Object.keys(result).forEach((yearKey) => {
        Object.keys(result[yearKey]).forEach((commercialCode) => {
          let Temp_string = '';

          result[yearKey][commercialCode].forEach((BookingValue) => {
            Temp_string =
              Temp_string +
              (BookingValue[Object.keys(BookingValue)[0]] === ''
                ? '-,'
                : BookingValue[Object.keys(BookingValue)[0]] + ',');
          });

          const key = Object.keys(result[yearKey][commercialCode][0])[0];

          // Extract '2' from the key
          const number = key.split('|')[0][1];
          if (
            checkArray(Temp_string.split(',').filter((item) => item !== ''))
          ) {
            setCheckConditionForCommId(true);
            setCommId(commercialCode);
            setDealId(number);
            setInsettedData(
              Temp_string.split(',').filter(
                (item) => item !== '' && item !== '-',
              ),
            );
          }
        });
      });
    }
  }, [result]);

  return (
    <div style={{ width: '100%', overflow: 'scroll' }} className="mt-5">
      {checkedItems.map((checkedItem, checkedIndex) => (
        <div key={checkedIndex}>
          <React.Fragment key={checkedIndex}>
            {CommercialMasterData?.map((comm, commIndex) => {
              const {
                DealLineItemNo,
                BalancedSeconds,
                BalancedSpots,
                NTCBalanceSpots,
                weekendsdetail,
                DealLineItemTypeCode,
              } = checkedItem;
              const jsx = (
                <div key={`${checkedIndex}-${commIndex}`}>
                  {checkedIndex === 0 && commIndex === 0 && (
                    <div className="flex" style={{ marginTop: 6 }}>
                      <p style={{ width: 150, fontSize: '10px' }}>
                        TimeBand/Program
                      </p>
                      <p style={{ width: 100, fontSize: '10px' }}>HouseID</p>
                      <p style={{ width: 40, fontSize: '10px' }}>Dur</p>
                      <p style={{ width: 60, fontSize: '10px' }}>Spots</p>
                      <p style={{ width: 60, fontSize: '10px' }}>Total Dur</p>
                    </div>
                  )}
                  <div className="flex mt-1 items-center">
                    <p style={{ width: 150, fontSize: '11px', marginTop: 2 }}>
                      {checkedItem.TimeBandName} {checkedItem.ContentName}
                    </p>

                    <Tooltip title={comm.CommercialCaption}>
                      <p
                        style={{
                          width: 100,
                          fontSize: '11px',
                          marginTop: 2,
                        }}
                        className="flex items-center"
                      >
                        {comm.VideoID}
                        <IoMdInformationCircleOutline className="text-gray-200 ml-1 text-xs" />
                      </p>
                    </Tooltip>

                    <p style={{ width: 60, fontSize: '11px', marginTop: 2 }}>
                      {comm.DurInSec}
                    </p>
                    <p style={{ width: 60, fontSize: '11px', marginTop: 2 }}>
                      {formState[`${DealLineItemNo}|${comm.value}|total`] ||
                        '0'}
                    </p>
                    <p style={{ width: 40, fontSize: '11px', marginTop: 2 }}>
                      {(
                        (formState[`${DealLineItemNo}|${comm.value}|total`] ||
                          0) * comm.DurInSec
                      ).toString()}
                    </p>
                    <div style={{ width: 70, marginTop: 2 }}>

                      <div className="flex">
                        {/* <Tooltip title="Repeat Pattern">
                              <Button
                                size="xs"
                                variant="twoTone"
                                icon={<PiRepeat />}
                                onClick={() => {
                                  if (!date1 || !date2 || !InsettedData.length)
                                    return; // Guard clause

                                  const startDate = new Date(date1);
                                  const endDate = new Date(date2);
                                  const updatedState = { ...formState };
                                  let totalSum = 0;
                                  const limit =
                                    DealLineItemTypeCode === 4
                                      ? NTCBalanceSpots
                                      : BalancedSeconds;
                                  const allRowsDataKeys = Object.keys(
                                    formState,
                                  ).filter(
                                    (key) =>
                                      key[1] === DealLineItemNo.toString() &&
                                      key[0] === 'Y' &&
                                      !key.includes('total'),
                                  );
                                  let totalConsumedBalance = 0;

                                  allRowsDataKeys.forEach((key) => {
                                    totalConsumedBalance +=
                                      updatedState[key].total;
                                  });

                                  for (
                                    let currentDate = new Date(startDate),
                                      i = 0;
                                    currentDate <= endDate;
                                    currentDate.setDate(
                                      currentDate.getDate() + 1,
                                    ),
                                      i++
                                  ) {
                                    const currentDay = currentDate.getDay();

                                    const isWeekendDay = weekendsdetail.some(
                                      (weekend) => weekend.Day === currentDay,
                                    );
                                    // Skip currentDay
                                    if (!isWeekendDay) continue;
                                    const formattedDate = formatDate(
                                      currentDate,
                                    ).replace(/\s+/g, '-');

                                    const fieldNameBase = `${DealLineItemNo}|${comm.value}|${formattedDate}`;

                                    // Remove old keys
                                    delete updatedState[fieldNameBase];
                                    delete updatedState[`Y${fieldNameBase}`];
                                    delete updatedState[
                                      `${DealLineItemNo}|${comm.value}|total`
                                    ];

                                    // Calculate value and total
                                    const value = Number(
                                      InsettedData[i % InsettedData.length],
                                    );
                                    const total = value * comm.DurInSec;
                                    totalSum += value;

                                    if (totalSum * comm.DurInSec <= limit) {
                                      // Update state if the condition is met
                                      updatedState[`Y${fieldNameBase}`] = {
                                        value,
                                        date: formattedDate,
                                        total,
                                      };
                                      updatedState[fieldNameBase] = value;
                                      updatedState[
                                        `${DealLineItemNo}|${comm.value}|total`
                                      ] = totalSum;
                                    } else {
                                      updatedState[
                                        `${DealLineItemNo}|${comm.value}|total`
                                      ] = totalSum - value;

                                      break;
                                    }
                                  }

                                  // Update the form state
                                  setFormState(updatedState);

                                  const stringFromArray = JSON.stringify(
                                    transformData(updatedState),
                                  ).replace(/[%{}]/g, '');

                                  setThe_data_I_want_To_Upload(stringFromArray);
                                }}
                              />
                            </Tooltip> */}
                        <Tooltip title="Reset Pattern">
                          <Button
                            size="xs"
                            className="ml-2"
                            variant="twoTone"
                            icon={<RxReset />}
                            onClick={() => {

                              // if (!date1 || !date2 || !InsettedData.length)
                              //   return; // Guard clause

                              const startDate = new Date(date1);
                              const endDate = new Date(date2);
                              const updatedState = { ...formState };
                              for (
                                let currentDate = new Date(startDate),
                                i = 0;
                                currentDate <= endDate;
                                currentDate.setDate(
                                  currentDate.getDate() + 1,
                                ),
                                i++
                              ) {
                                const formattedDate = formatDate(
                                  currentDate,
                                ).replace(/\s+/g, '-');
                                const fieldNameBase = `${DealLineItemNo}|${comm.value}|${formattedDate}`;

                                // Remove old keys
                                delete updatedState[fieldNameBase];
                                delete updatedState[`Y${fieldNameBase}`];
                                delete updatedState[
                                  `${DealLineItemNo}|${comm.value}|total`
                                ];
                              }
                              const removeKey = removeKeysStartingWith(updatedState, `${DealLineItemNo}|${comm.value}|`);
                              // Update the total field

                              setCheckConditionForCommId(false);
                              setCommId(0);
                              setDealId(0);
                              setInsettedData([]);
                              setResult([]);

                              setFormState(removeKey);
                              const formattedString = generateCustomArray(removeKey)
                                .map(obj => {
                                  let key = Object.keys(obj)[0];
                                  return `"${key}":"${obj[key]}"`;
                                })
                                .join(",");
                              setThe_data_I_want_To_Upload(formattedString);
                            }}
                          />
                        </Tooltip>
                      </div>

                    </div>
                    <div
                      className="flex items-center"
                      style={{
                        maxWidth: window.innerWidth - 1200,
                        marginTop: 2,
                      }}
                    >
                      {createInputFields(
                        DealLineItemNo,
                        BalancedSeconds,
                        BalancedSpots,
                        NTCBalanceSpots,
                        comm.value,
                        comm.DurInSec,
                        checkedItem.weekendsdetail,
                        checkedItem,
                        rowIndex,
                        totalRows,
                      ).map((inputField, inputIndex) => (
                        <React.Fragment key={inputIndex}>
                          <div>
                            {checkedIndex === 0 && commIndex === 0 && (
                              <p style={{ fontSize: '10px' }}>
                                {inputField.props.label}
                              </p>
                            )}
                            {inputField}
                          </div>
                        </React.Fragment>
                      ))}
                    </div>
                  </div>
                </div>
              );
              rowIndex = rowIndex + 1;
              return jsx;
            })}
          </React.Fragment>
        </div>
      ))}
      <br />
    </div>
  );
};

export default DateRangeInputs;
