import { useState, useEffect, useMemo } from 'react';
import { Alert, Badge } from 'components/ui';
import { apiGetEmployeemaster } from 'services/MasterService';
import { Button, Card } from 'components/ui';
import { HiPlusCircle } from 'react-icons/hi';
import useTimeOutMessage from 'utils/hooks/useTimeOutMessage';
import DisplayTableEmp from 'views/Controls/DisplayTableEmp';
import HeaderExtra from 'views/Controls/HeaderExtra';
import { Link, useNavigate } from 'react-router-dom';
import InputwithVoice from 'components/ui/Input/InputwithVoice';
import Loader from 'views/Controls/Loader';
import { useSelector } from 'react-redux';
import { CLIENT } from 'views/Controls/clientListEnum';

/* COMPONENTS */
const statusColor = {
  1: 'bg-emerald-500',
  0: 'bg-red-500',
};

const headerExtraContent = (globalFilter, setGlobalFilter, Path, channel) => {
  return (
    <span className="flex items-center">
      <span className="mr-1 font-semibold flex items-center">
        <InputwithVoice
          value={globalFilter ?? ''}
          className=" solid"
          placeholder="Search all columns..."
          size="sm"
          onChange={(e) => {
            if (/^[0-9a-zA-Z\s]*$/.test(e.target.value)) {
              setGlobalFilter(e.target.value);
            }
          }}
        />
      </span>

      {Path == 'UserMaster' && (
        <span className="mr-1 font-semibold">
          <Link
            to={
              channel.label === CLIENT.ANI_PLUS ? '/quickAddUser' : '/addUser'
            }
          >
            <Button block variant="solid" size="sm" icon={<HiPlusCircle />}>
              Add User
            </Button>
          </Link>
        </span>
      )}
    </span>
  );
};

const Employee = () => {
  /* REDUX */
  const channel = useSelector((state) => state.locale.selectedChannel);

  /* STATES */
  const currentHref = window.location.href; // Get the full URL
  const hashPart = currentHref.split('#')[1]; // Get the part after the '#'
  const Path = hashPart ? hashPart.split('/')[1] : '';
  // alert(Path);
  const [editData, seteditData] = useState(['']);
  const [globalFilter, setGlobalFilter] = useState('');
  const [sorting, setSorting] = useState([]);
  const [data, setdata] = useState(['']);
  const [log, setlog] = useState('');
  const [loader, setLoader] = useState(false);

  /* HOOKS */
  const navigate = useNavigate();
  const [message, setMessage] = useTimeOutMessage();
  const columns = useMemo(
    () => [
      {
        header: 'First Name',
        accessorKey: 'Emp_FirstName',
        cell: (props) => {
          const row = props.row.original;
          return (
            <div className="flex items-center">
              <Badge className={statusColor[row.IsActive]} />
              <span className="ml-2 rtl:mr-2 ">{row.Emp_FirstName}</span>
            </div>
          );
        },
      },
      {
        header: 'last Name',
        accessorKey: 'Emp_LastName',
      },
      {
        header: 'Email',
        accessorKey: 'Emp_Email',
      },
      {
        header: 'Contact',
        accessorKey: 'Emp_Contact1',
      },
      {
        header: 'Department',
        accessorKey: 'DepartmentName',
      },
    ],
    [],
  );

  useEffect(() => {
    const fetchEmployees = async () => {
      setLoader(true);
      try {
        const filterCondition =
          Path == 'UserMaster' ? 1 : Path == 'UserRejected' ? 2 : 0;
        const resp = await apiGetEmployeemaster();

        if (resp && resp.data) {
          const modifiedArray = resp.data
            .filter((item) => item.IsApproveLogin === filterCondition)
            .map((employee) => ({
              ...employee,
              EmployeeCode: String(employee.EmployeeCode),
            }));

          setdata(modifiedArray);
        } else {
          console.warn('Unexpected response structure:', resp);
        }
      } catch (error) {
        console.error('Error fetching employee data:', error);
        // Optional: set an error state here
      } finally {
        setLoader(false);
      }
    };

    fetchEmployees();
  }, [Path]);

  /* HELPER FUNCTIONS */
  const getemp = () => {
    setLoader(true);
    (async (values) => {
      const resp = await apiGetEmployeemaster(values);
      const modifiedArray = resp.data
        .filter(
          (item) =>
            item.IsApproveLogin ==
            (Path == 'UserMaster' ? 1 : Path == 'UserRejected' ? 2 : 0),
        )
        .map((employee) => ({
          ...employee,
          EmployeeCode: String(employee.EmployeeCode),
        }));
      setdata(modifiedArray);
      setLoader(false);
    })();
  };

  return (
    <>
      {message && (
        <Alert className="mb-4" type={log} showIcon>
          {message}
        </Alert>
      )}
      <Card
        header={<HeaderExtra Component={'User Master'} />}
        headerExtra={headerExtraContent(
          globalFilter,
          setGlobalFilter,
          Path,
          channel,
        )}
        className="flex flex-col h-[87vh]"
        bodyClass="grow"
      >
        <DisplayTableEmp
          data={data}
          columns={columns}
          sorting={sorting}
          globalFilter={globalFilter}
          setSorting={setSorting}
          setGlobalFilter={setGlobalFilter}
          seteditData={seteditData}
          link={
            channel.label === CLIENT.ANI_PLUS ? '/quickEditUser' : '/editUser'
          }
          link2={'/emp/EmplyeeView/'}
          getemp={getemp}
        />
        <Loader showLoader={loader} />
      </Card>
    </>
  );
};

export default Employee;
