import appConfig from 'configs/app.config';
import { useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { io } from 'socket.io-client';
import { Avatar, Notification, toast } from 'components/ui';
import { HiOutlineBell } from 'react-icons/hi';
import { setNodeJsNotifications } from 'store/locale/localeSlice';

const socket = io(appConfig.nodeJsServerHost);

function NodeJsNotificationListener() {
  /* REDUX */
  const userId = useSelector((state) => state.auth.session.LoginId);
  const nodeJsNotifications = useSelector(
    (state) => state.locale.nodeJsNotifications,
  );
  const dispatch = useDispatch();

  /* USE EFFECTS */
  useEffect(() => {
    if (!userId) return;
    // Register userId once connected
    socket.emit('register', userId);

    // Listen for notifications and display toast message
    socket.on('notification:new', (notification) => {
      toast.push(
        <Notification
          title="Bats"
          type={notification.metadata.severity}
          customIcon={
            <Avatar
              shape="circle"
              className=" bg-yellow-100 text-yellow-600 dark:bg-yellow-500/20 dark:text-yellow-100 "
              {...(notification.metadata.icon
                ? { src: notification.metadata.icon }
                : {
                    icon: <HiOutlineBell />,
                  })}
            />
          }
          duration={3000}
          closable={true}
        >
          {notification.message}
        </Notification>,
      );
      dispatch(setNodeJsNotifications([notification, ...nodeJsNotifications]));
    });

    return () => {
      socket.off('notification:new');
    };
  }, [userId, nodeJsNotifications, dispatch]);

  return null;
}

export default NodeJsNotificationListener;
